/**
 * AgoraWebSDK_N-v4.21.0-0-g16fdae2c-dirty Copyright AgoraInc.
 */

import{EventEmitter as t,setParameter as e,getParameter as s,VERSION as o,retryable as n,checkValidString as r,checkValidNumber as i,wait as a,AgoraRTCErrorCode as c,AgoraRTCError as p,throttleByKey as E,IS_GLOBAL_VERSION as d,BUILD as l,dividePackage as _,networkIndicator as u,NETWORK_STATE as h,DEFAULT_RETRY_CONFIG as T,post as I,postProtobuf as R,AgoraAPITag as S,getMessageEncoding as g,appendBuffer as O}from"@agora-js/shared";import A from"axios";function m(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,o)}return s}function P(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?m(Object(s),!0).forEach((function(e){v(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):m(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function v(t,e,s){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var o=s.call(t,e||"default");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const f=new class extends t{constructor(){super(...arguments),v(this,"currentUploadLogID",0)}reportLogUploadError(t){const{errorRange:e}=t;e[e.length-1]&&e[e.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=e[e.length-1],this.emit("REPORT_LOG_UPLOAD",t))}};class N{constructor(t){v(this,"logger",void 0),v(this,"prefixLists",[]),this.logger=t}debug(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];this.logger.debug(...this.prefixLists,...e)}info(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];this.logger.info(...this.prefixLists,...e)}warning(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];this.logger.warning(...this.prefixLists,...e)}error(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];this.logger.error(...this.prefixLists,...e)}prefix(t){return this.prefixLists.push(t),this}popPrefix(){return this.prefixLists.pop(),this}}function D(){const t=new Date;return t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}function U(){const t=new Date,e=/((\d+:){2}\d+)/.exec((new Date).toUTCString());return e?(null==e?void 0:e[0])+":"+t.getUTCMilliseconds():t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}const y={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},L=Date.now(),b=t=>{for(const e in y)if(Object.prototype.hasOwnProperty.call(y,e)&&y[e]===t)return e;return"DEFAULT"};class C{constructor(){v(this,"proxyServerURL",void 0),v(this,"logLevel",y.DEBUG),v(this,"uploadState","collecting"),v(this,"uploadLogWaitingList",[]),v(this,"uploadLogUploadingList",[]),v(this,"uploadErrorCount",0),v(this,"currentLogID",0),v(this,"url",void 0),v(this,"extLog",((t,e)=>{this.appendLogToWaitingList(t,...e)}))}debug(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];const o=[y.DEBUG].concat(e);this.log.apply(this,o)}info(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];const o=[y.INFO].concat(e);this.log.apply(this,o)}warning(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];const o=[y.WARNING].concat(e);this.log.apply(this,o)}warn(){this.warning(...arguments)}error(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];const o=[y.ERROR].concat(e);this.log.apply(this,o)}upload(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];const o=[y.DEBUG].concat(e);this.uploadLog.apply(this,o)}setLogLevel(t){t=Math.min(Math.max(0,t),4),this.logLevel=t}enableLogUpload(){e("UPLOAD_LOG",!0)}disableLogUpload(){e("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(t){this.proxyServerURL=t}prefix(t){return new N(this).prefix(t)}log(){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];if(Date.now()-L<100)return void setTimeout((()=>{this.log(...e)}),Date.now()-L);const n=Math.max(0,Math.min(4,e[0]));if(e[0]=D()+" Agora-SDK [".concat(b(n),"]:"),this.appendLogToWaitingList(n,...e),n<this.logLevel)return;const r=D()+" %cAgora-SDK [".concat(b(n),"]:");let i=[];if(!s("USE_NEW_LOG"))switch(n){case y.DEBUG:i=[r,"color: #64B5F6;"].concat(e.slice(1)),console.log.apply(console,i);break;case y.INFO:i=[r,"color: #1E88E5; font-weight: bold;"].concat(e.slice(1)),console.log.apply(console,i);break;case y.WARNING:i=[r,"color: #FB8C00; font-weight: bold;"].concat(e.slice(1)),console.warn.apply(console,i);break;case y.ERROR:i=[r,"color: #B00020; font-weight: bold;"].concat(e.slice(1)),console.error.apply(console,i)}}uploadLog(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];if(Date.now()-L<100)return void setTimeout((()=>{this.uploadLog(...e)}),Date.now()-L);const o=Math.max(0,Math.min(4,e[0]));e[0]=D()+" Agora-SDK [".concat(b(o),"]:"),this.appendLogToWaitingList(o,...e)}appendLogToWaitingList(t){if(!s("UPLOAD_LOG"))return;for(var e=arguments.length,o=new Array(e>1?e-1:0),n=1;n<e;n++)o[n-1]=arguments[n];Array.isArray(o[0])?o[0][0]=U()+" Agora-SDK [".concat(b(t),"]:"):o[0]=U()+" Agora-SDK [".concat(b(t),"]:");let r="";o.forEach((t=>{"object"==typeof t&&(t=JSON.stringify(t)),r+="".concat(t," ")})),this.uploadLogWaitingList.push({payload_str:r,log_level:t,log_item_id:this.currentLogID++}),"uploading"===this.uploadState&&0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}async uploadLogs(){const t=this.uploadLogUploadingList,e={sdk_version:o,process_id:s("PROCESS_ID"),payload:JSON.stringify(t)};return n((async()=>{const t=await A.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(s("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(s("LOG_UPLOAD_SERVER"),"/upload/v1")),e,{responseType:"text"});if("OK"!==t.data){const e=new Error("unexpected upload log response");throw e.response=t,e}}),(()=>(this.uploadLogUploadingList=[],!1)),(e=>{const s={status:-1,message:e.message,errorRange:t.map((t=>t.log_item_id))};return e.response?(s.status=e.response.status,s.data=e.response.data,s.headers=e.response.headers):e.request&&(s.status=e.request.status),f.reportLogUploadError(s),!0}),{timeout:s("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:s("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){0===this.uploadLogUploadingList.length&&0===this.uploadLogWaitingList.length||(0===this.uploadLogUploadingList.length&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,s("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then((()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout((()=>this.uploadLogInterval()),s("UPLOAD_LOG_INTERVAL"))})).catch((t=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout((()=>this.uploadLogInterval()),s("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout((()=>this.uploadLogInterval()),s("UPLOAD_LOG_RETRY_INTERVAL_V1"))})))}}const w=new C;let M=function(t){return t.FREE="free",t.UPLOADING="uploading",t}({}),W=function(t){return t[t.MISC=0]="MISC",t[t.INTERNAL_EVENT=1]="INTERNAL_EVENT",t[t.PUBLIC_EVENT=2]="PUBLIC_EVENT",t[t.WEB_EVENT=3]="WEB_EVENT",t[t.INTERNAL_API=4]="INTERNAL_API",t[t.WEB_API=5]="WEB_API",t[t.PUBLIC_API=6]="PUBLIC_API",t}({});function V(t){return r(t.reportId,"params.reportId",0,100,!1),r(t.category,"params.category",0,100,!1),r(t.event,"params.event",0,100,!1),r(t.label,"params.label",0,100,!1),i(t.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}const x={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let k=function(t){return t.PUBLISH="publish",t.SUBSCRIBE="subscribe",t.WS_COMPRESSOR_INIT="ws_compressor_init",t.SESSION_INIT="session_init",t.JOIN_CHOOSE_SERVER="join_choose_server",t.REQ_USER_ACCOUNT="req_user_account",t.JOIN_GATEWAY="join_gateway",t.REJOIN_GATEWAY="rejoin_gateway",t.STREAM_SWITCH="stream_switch",t.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",t.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",t.FIRST_VIDEO_RECEIVED="first_video_received",t.FIRST_AUDIO_RECEIVED="first_audio_received",t.FIRST_VIDEO_DECODE="first_video_decode",t.FIRST_AUDIO_DECODE="first_audio_decode",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_UPDATE_STREAM="on_update_stream",t.ON_REMOVE_STREAM="on_remove_stream",t.USER_ANALYTICS="req_user_analytics",t.PC_STATS="pc_stats",t.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",t}({}),B=function(t){return t.SESSION="io.agora.pb.Wrtc.Session",t.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",t.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",t.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",t.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",t.PUBLISH="io.agora.pb.Wrtc.Publish",t.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",t.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",t.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",t.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",t.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",t.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",t.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",t.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",t.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",t.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",t.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",t.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",t.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",t.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",t.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",t.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",t.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",t.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",t.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",t.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",t.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",t.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",t.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",t.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",t.PC_STATS="io.agora.pb.Wrtc.PCStats",t.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",t}({}),G=function(t){return t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",t}({}),F=function(t){return t[t.SESSION=26]="SESSION",t[t.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",t[t.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",t[t.JOIN_GATEWAY=28]="JOIN_GATEWAY",t[t.PUBLISH=30]="PUBLISH",t[t.SUBSCRIBE=29]="SUBSCRIBE",t[t.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",t[t.STREAM_SWITCH=32]="STREAM_SWITCH",t[t.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",t[t.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",t[t.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",t[t.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",t[t.API_INVOKE=41]="API_INVOKE",t[t.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",t[t.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",t[t.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",t[t.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",t[t.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",t[t.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",t[t.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",t[t.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",t[t.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",t[t.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",t[t.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",t[t.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",t[t.USER_ANALYTICS=1e4]="USER_ANALYTICS",t[t.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",t}({});class J{constructor(){v(this,"baseInfoMap",new Map),v(this,"proxyServer",void 0),v(this,"eventUploadTimer",void 0),v(this,"setSessionIdTimer",void 0),v(this,"url",void 0),v(this,"backupUrl",void 0),v(this,"_appId",void 0),v(this,"keyEventUploadPendingItems",[]),v(this,"normalEventUploadPendingItems",[]),v(this,"apiInvokeUploadPendingItems",[]),v(this,"apiInvokeCount",0),v(this,"ltsList",[]),v(this,"lastSendNormalEventTime",Date.now()),v(this,"customReportCounterTimer",void 0),v(this,"customReportCount",0),v(this,"extApiInvoke",(async t=>{for(const e of t){const t=P(P({},e),{},{sid:null,invokeId:++this.apiInvokeCount,tag:S.TRACER});this.sendApiInvoke(t)}})),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),s("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),s("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(t){return this.baseInfoMap.get(t)}adjustSessionStartTime(t){if(!this.baseInfoMap.has(t)&&!this.baseInfoMap.get(t))return void w.error("adjust session ".concat(t," start time, sid is not exist or info is undefined"));const e=this.baseInfoMap.get(t),s=Date.now(),o=e.startTime;e.startTime=s,w.debug("rewrite session ".concat(t," startTime: ").concat(s," , ").concat(s-o,"ms")),this.baseInfoMap.set(t,e)}setAppId(t){this._appId=t}reportApiInvoke(t,e,o){e.timeout=e.timeout||6e4,e.reportResult=void 0===e.reportResult||e.reportResult;const n=Date.now();this.apiInvokeCount+=1;const r=this.apiInvokeCount,i=()=>({tag:e.tag,invokeId:r,sid:t,name:e.name,apiInvokeTime:n,options:e.options,states:e.states||null}),d=!!s("SHOW_REPORT_INVOKER_LOG");d&&w.info("".concat(e.name," start"),e.options);let l=!1;a(e.timeout).then((()=>{l||(this.sendApiInvoke(P(P({},i()),{},{error:c.API_INVOKE_TIMEOUT,success:!1})),w.debug("".concat(e.name," timeout")))}));const _=new p(c.UNEXPECTED_ERROR,"".concat(e.name,": this api invoke is end"));return{onSuccess:t=>{const s=()=>{if(l)throw _;return l=!0,this.sendApiInvoke(P(P({},i()),{},{success:!0},e.reportResult&&{result:t})),d&&w.info("".concat(e.name," onSuccess")),t};return o?E(s,e.name+"Success",o,(()=>l=!0)):s()},onError:t=>{const s=()=>{if(l)throw t;l=!0,this.sendApiInvoke(P(P({},i()),{},{success:!1,error:t})),d&&w.info("".concat(e.name," onFailure"),t.toString())};return o?E(s,e.name+"Error",o,(()=>l=!0)):s()}}}sessionInit(t,e){if(this.baseInfoMap.has(t))return;const n=Date.now(),r=this.createBaseInfo(t,n);r.cname=e.cname;const i=Object.assign({},{willUploadConsoleLog:s("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:d?"global":"oversea",areas:s("AREAS")&&s("AREAS").join(",")},e.extend),{stringUid:a,channelProfile:c,channelMode:p,isABTestSuccess:E,lsid:_,clientRole:u}=e,h=Date.now(),T=P(P({},r),{},{eventType:k.SESSION_INIT,appid:e.appid,browser:navigator.userAgent,buildFormat:e.buildFormat,build:l,lts:h,elapse:h-n,extend:JSON.stringify(i),mode:e.mode,process:s("PROCESS_ID"),appType:s("APP_TYPE"),success:!0,version:o,stringUid:a,channelProfile:c,channelMode:p,isABTestSuccess:E,lsid:_,clientType:20,clientRole:u,serviceId:s("PROCESS_ID"),extensionID:s("PLUGIN_INFO").join(",")||"",preload:e.preload?1:0});this.send({type:B.SESSION,data:T},!0)}joinChooseServer(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,n=Date.now(),r=P(P({},o),{},{eventType:k.JOIN_CHOOSE_SERVER,lts:n,eventElapse:e.elapse||n-e.lts,chooseServerAddr:e.csAddr,errorCode:e.ec,elapse:n-s.startTime,success:e.succ,chooseServerAddrList:JSON.stringify(e.serverList),uid:e.uid?parseInt(e.uid):null,cid:e.cid?parseInt(e.cid):null,chooseServerIp:e.csIp||"",opid:e.opid,unilbsServerIds:e.unilbsServerIds,extend:e.extend||void 0,isHttp3:e.isHttp3});this.send({type:B.JOIN_CHOOSE_SERVER,data:r},!0)}reqUserAccount(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,n=Date.now(),r=P(P({},o),{},{eventType:k.REQ_USER_ACCOUNT,lts:n,success:e.success,serverAddress:e.serverAddr,stringUid:e.stringUid,uid:e.uid,errorCode:e.errorCode,elapse:e.elapse||n-s.startTime,eventElapse:n-e.lts,extend:JSON.stringify(e.extend)});this.send({type:B.REQ_USER_ACCOUNT,data:r},!0)}joinGateway(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info;e.vid&&(o.vid=e.vid),o.uid=e.uid,o.cid=e.cid;const n=Date.now(),{firstSuccess:r,avoidJoinStartTime:i,isProxy:a,addr:c}=e,p=n-(r&&i?i:s.startTime),E=P(P({},o),{},{eventType:k.JOIN_GATEWAY,lts:n,gatewayAddr:e.addr,success:e.succ,errorCode:e.ec,elapse:p,eventElapse:n-e.lts,firstSuccess:r,signalChannel:e.signalChannel}),d=E.success?1:0;if(e.succ&&(s.lastJoinSuccessTime=n),r)this.send({type:B.JOIN_GATEWAY,data:E},!0);else{let t;if(c)if(a){const e=c.match(/h=(\d{1,3}-){3}\d{1,3}/g),s=c.match(/p=[0-9]{1,6}/g);t={isSuccess:d,gatewayIp:e&&e.length?e[0].split("=")[1].replace(/-/g,"."):"",port:s&&s.length?s[0].split("=")[1]:"",isProxy:a?1:0}}else{const e=c.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),s=c.match(/(:|p=)[0-9]{1,6}/g);t={isSuccess:d,gatewayIp:e&&e.length?e[0].split("//")[1].replace(/-/g,"."):"",port:s&&s.length?s[0].split(/:|p=/g)[1]:"",isProxy:a?1:0}}else t={isSuccess:d,gatewayIp:"",port:"",isProxy:a?1:0};delete E.success,delete E.eventType,delete E.firstSuccess,E.vid=Number(E.vid);const e=Object.assign({},E,t,{eventType:k.REJOIN_GATEWAY});this.send({type:B.RE_JOIN_GATEWAY,data:e},!0)}}joinChannelTimeout(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=Date.now(),n=P(P({},s.info),{},{lts:o,timeout:e,elapse:o-s.startTime});this.send({type:B.JOIN_CHANNEL_TIMEOUT,data:n},!0)}publish(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,n=Date.now(),r=P(P({},o),{},{eventType:k.PUBLISH,lts:n,eventElapse:e.eventElapse,elapse:n-s.startTime,success:e.succ,errorCode:e.ec,videoName:e.videoName,audioName:e.audioName,screenName:e.screenName,screenshare:e.screenshare,audio:e.audio,video:e.video,p2pid:e.p2pid,publishRequestid:e.publishRequestid});this.send({type:B.PUBLISH,data:r},!0)}subscribe(t,e,s){const o=this.baseInfoMap.get(t);if(!o)return;const n=o.info,r=Date.now(),i=P(P({},n),{},{eventType:k.SUBSCRIBE,lts:r,eventElapse:e.eventElapse,elapse:r-o.startTime,success:e.succ,errorCode:e.ec,video:e.video,audio:e.audio,subscribeRequestid:e.subscribeRequestid,p2pid:e.p2pid},s&&{extend:JSON.stringify({isMassSubscribe:!0})});"string"==typeof e.peerid?i.peerSuid=e.peerid:i.peer=e.peerid,this.send({type:B.SUBSCRIBE,data:i},!0)}wsCompressorInit(t){const e=[...this.baseInfoMap.keys()],s=e.length?e[0]:"UnableToGetSid",o=this.baseInfoMap.get(s);if(!o)return;const n=o.info,r=Date.now(),i=P(P({},n),{},{eventType:k.WS_COMPRESSOR_INIT,lts:r,eventElapse:t.eventElapse,elapse:r-o.startTime,status:t.status?1:2});this.send({type:B.WS_COMPRESSOR_INIT,data:i},!0)}firstRemoteVideoDecode(t,e,s,o){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),a=P(P(P({},r),o),{},{elapse:i-n.startTime,eventType:e,lts:i,firstDecodeFrame:Math.max(i-n.startTime,0),apEnd:Math.max(o.apEnd-n.startTime,0),apStart:Math.max(o.apStart-n.startTime,0),joinGwEnd:Math.max(o.joinGwEnd-n.startTime,0),joinGwStart:Math.max(o.joinGwStart-n.startTime,0),pcEnd:Math.max(o.pcEnd-n.startTime,0),pcStart:Math.max(o.pcStart-n.startTime,0),subscriberEnd:Math.max(o.subscriberEnd-n.startTime,0),subscriberStart:Math.max(o.subscriberStart-n.startTime,0),videoAddNotify:Math.max(o.videoAddNotify-n.startTime,0)});this.send({type:s,data:a},!0)}firstRemoteFrame(t,e,s,o){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),a=P(P(P({},r),o),{},{elapse:i-n.startTime,eventType:e,lts:i});this.send({type:s,data:a},!0)}pcStats(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,n=Date.now(),r=P(P(P({},o),e),{},{vid:void 0===o.vid?0:Number(o.vid),elapse:n-s.startTime,eventType:k.PC_STATS,lts:n});this.send({type:B.PC_STATS,data:r},!0)}updateRemoteRTPCapabilities(t,e){if(t){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,n=Date.now(),r=P(P(P({},o),e),{},{vid:void 0===o.vid?0:Number(o.vid),eventType:k.UPDATE_REMOTE_RTPCAPABILITIES,lts:n});this.send({type:B.UPDATE_REMOTE_RTPCAPABILITIES,data:r},!0)}}onGatewayStream(t,e,s,o){const n=this.baseInfoMap.get(t);if(!n)return;const r=n.info,i=Date.now(),a=P(P(P({},r),o),{},{eventType:e,lts:i});this.send({type:s,data:a},!0)}streamSwitch(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,n=Date.now(),r=P(P({},o),{},{eventType:k.STREAM_SWITCH,lts:n,isDual:e.isdual,elapse:n-s.startTime,success:e.succ});this.send({type:B.STREAM_SWITCH,data:r},!0)}requestProxyAppCenter(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,n=Date.now(),r=P(P({},o),{},{eventType:k.REQUEST_PROXY_APPCENTER,lts:n,eventElapse:n-e.lts,elapse:n-s.startTime,APAddr:e.APAddr,workerManagerList:e.workerManagerList,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:B.REQUEST_PROXY_APPCENTER,data:r},!0)}requestProxyWorkerManager(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,n=Date.now(),r=P(P({},o),{},{eventType:k.REQUEST_PROXY_WORKER_MANAGER,lts:n,eventElapse:n-e.lts,elapse:n-s.startTime,workerManagerAddr:e.workerManagerAddr,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:B.REQUEST_PROXY_WORKER_MANAGER,data:r},!0)}setProxyServer(t){this.proxyServer=t,t?w.debug("reportProxyServerurl: ".concat(t)):w.debug("disable reportProxyServerurl: ".concat(t))}peerPublishStatus(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,n=Date.now(),r=P(P({},o),{},{subscribeElapse:e.subscribeElapse,peer:e.peer,peerPublishDuration:Math.max(e.audioPublishDuration,e.videoPublishDuration),audiotag:e.audioPublishDuration>0?1:-1,videotag:e.videoPublishDuration>0?1:-1,lts:n,elapse:n-s.startTime,joinChannelSuccessElapse:n-(s.lastJoinSuccessTime||n),peerPublishDurationVideo:e.videoPublishDuration,peerPublishDurationAudio:e.audioPublishDuration});this.send({type:B.PEER_PUBLISH_STATUS,data:r},!0)}workerEvent(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,n=Date.now(),r=P(P(P({},o),e),{},{elapse:n-s.startTime,lts:n,productType:"WebRTC"});_(r,"payload",1300).forEach((t=>this.send({type:B.WORKER_EVENT,data:t},!0)))}apworkerEvent(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,n=Date.now(),r=P(P(P({},o),e),{},{elapse:n-s.startTime,lts:n});this.send({type:B.AP_WORKER_EVENT,data:r},!0)}joinWebProxyAP(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,n=Date.now(),r=P(P(P({},o),e),{},{elapse:n-s.startTime,lts:n,extend:e.extend||void 0});this.send({type:B.JOIN_WEB_PROXY_AP,data:r},!0)}WebSocketQuit(t,e){const s=this.baseInfoMap.get(t);if(!s)return;const o=s.info,n=Date.now(),r=P(P(P({},o),e),{},{elapse:n-s.startTime,lts:n});this.send({type:B.WEBSOCKET_QUIT,data:r},!0)}async sendCustomReportMessage(t,e){if(this.customReportCount+=e.length,this.customReportCount>s("CUSTOM_REPORT_LIMIT"))throw new p(c.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval((()=>{this.customReportCount=0}),5e3));const o=Date.now(),n=e.map((e=>({type:B.USER_ANALYTICS,data:P(P({sid:t},e),{},{lts:o})})));try{s("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(n):await this.postDataToStatsCollector(n)}catch(t){throw w.error("send custom report message failed",t.toString()),new p(c.CUSTOM_REPORT_SEND_FAILED,t.message)}}sendApiInvoke(t){const e=s("NOT_REPORT_EVENT");if(t.tag&&e.includes&&e.includes(t.tag))return!1;if(null===t.sid)return this.apiInvokeUploadPendingItems.push(t),!1;const o=this.baseInfoMap.get(t.sid);if(!o)return this.apiInvokeUploadPendingItems.push(t),!1;const{cname:n,uid:r,cid:i}=o.info;let a;if(t.lts=t.lts||Date.now(),t.error)if(t.error instanceof p){const{code:e,message:s}=t.error;a=e||(s||t.error.toString())}else a=t.error.toString();const c={invokeId:t.invokeId,sid:t.sid,cname:n,cid:i,uid:r,lts:t.lts,success:t.success,elapse:t.lts-o.startTime,execElapse:t.lts-t.apiInvokeTime,apiName:t.name,options:t.options?JSON.stringify(t.options):void 0,execStates:t.states?JSON.stringify(t.states):void 0,execResult:t.result?JSON.stringify(t.result):void 0,errorCode:t.error?a:void 0,errorMsg:t.error?JSON.stringify(t.error):void 0};return this.send({type:B.API_INVOKE,data:c},!1),!0}appendSessionId(){J.__CLIENT_LIST__.forEach((t=>{if(t._sessionId){const e=this.apiInvokeUploadPendingItems.length;for(let s=0;s<e;s++){const e=this.apiInvokeUploadPendingItems.shift();e&&(e.sid=t._sessionId,this.sendApiInvoke(Object.assign({},e)))}}}))}send(t,e){if(e)return this.keyEventUploadPendingItems.push(t),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(t),this.normalEventUploadPendingItems.length>s("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(t,e){const o=[],n=[];for(;t.length;){const e=t.shift();o.length<20?o.push(e):n.push(e)}t.push(...n);for(const t of[...o])-1!==this.ltsList.indexOf(t.data.lts)?(t.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(t.data.lts)):(this.ltsList.push(t.data.lts),this.ltsList.sort(((t,e)=>t-e)));e||(this.lastSendNormalEventTime=Date.now());return s("ENABLE_EVENT_REPORT")?(o.length&&(s("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(o):this.postDataToStatsCollector(o)).catch((t=>o=>{s("EVENT_REPORT_RETRY")&&(e?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(t):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(t),this.normalEventUploadPendingItems.length>s("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-s("NORMAL_EVENT_QUEUE_CAPACITY")),w.warning("report: drop normal events"))))})(o)),t):t}async postDataToStatsCollector2(t){u.networkState===h.OFFLINE&&await Promise.race([u.onlineWaiter,a(2*T.maxRetryTimeout)]);const e=t=>{let e=new Uint8Array;return t.forEach((t=>{const s=g(JSON.stringify(t.data)),o=new ArrayBuffer(5),n=(t=>{let e=0;return Object.entries(B).forEach((s=>{let[o,n]=s;n===t.type&&(e=EventNameToID[o])})),e})(t),r=new DataView(o);r.setUint16(0,s.byteLength,!0),r.setUint8(2,255&n),r.setUint8(3,n>>>8&255),r.setUint8(4,n>>>16&255),e=O(e,new Uint8Array(o)),e=O(e,s)})),e},o="event";let n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(s("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(o):"https://".concat(s("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(o);for(let r=0;r<2;r+=1){1===r&&(n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(s("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(o):"https://".concat(s("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(o));try{await I(n,{timeout:1e4,data:e(t),headers:P(P({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(t){if(1===r)throw t;continue}return}}async postDataToStatsCollector(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const o={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:t.map((t=>JSON.stringify(t))),vid:(t=>{const e=t&&t.data.sid&&this.baseInfoMap.get(t.data.sid);return e&&e.info.vid&&+e.info.vid||0})(t[0])};u.networkState===h.OFFLINE&&await Promise.race([u.onlineWaiter,a(2*T.maxRetryTimeout)]);const n=e?"/events/proto-raws":"/events/messages";let r=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(s("EVENT_REPORT_DOMAIN"),"&p=").concat(s("STATS_COLLECTOR_PORT"),"&d=").concat(n):"https://".concat(s("EVENT_REPORT_DOMAIN"),":").concat(s("STATS_COLLECTOR_PORT")).concat(n));for(let t=0;t<2;t+=1){1===t&&(r=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(s("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(s("STATS_COLLECTOR_PORT"),"&d=").concat(n):"https://".concat(s("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(s("STATS_COLLECTOR_PORT")).concat(n)));try{e?await R(r,{timeout:1e4,data:o}):await I(r,{timeout:1e4,data:o})}catch(e){if(1===t)throw e;continue}return}}createBaseInfo(t,e){const s=Object.assign({},x);return s.sid=t,this.baseInfoMap.set(t,{info:s,startTime:e}),s}reportResourceTiming(t,e){const s=performance.getEntriesByName(t),o=s[s.length-1];o&&this.reportApiInvoke(e,{name:"Client.resourceTiming",options:o,tag:S.TRACER}).onSuccess()}}function Y(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(e,s,o){const n=o.value;if("function"==typeof n){const r=t.className||e.__className__||("AgoraRTCClient"===e.constructor.name?"Client":e.constructor.name);o.value=function(){for(var e=arguments.length,o=new Array(e),i=0;i<e;i++)o[i]=arguments[i];let a=o;if(t.argsMap)try{a=t.argsMap(this,...o)}catch(t){w.warning(t),a=[]}try{JSON.stringify(a)}catch(t){w.warning("arguments for method ".concat(r,".").concat(String(s)," not serializable for apiInvoke.")),a=[]}const c=(t.report||j).reportApiInvoke(this._sessionId||null,{name:"".concat(r,".").concat(String(s)),options:a,tag:S.TRACER,reportResult:t.reportResult},t.throttleTime);try{const e=n.apply(this,o);return e instanceof Promise?e.then((e=>(c.onSuccess(t.reportResult&&e),e))).catch((t=>{throw c.onError(t),t})):(c.onSuccess(t.reportResult&&e),e)}catch(t){throw c.onError(t),t}}}return o}}v(J,"__CLIENT_LIST__",[]);const j=new J;f.on("REPORT_LOG_UPLOAD",(t=>{t.networkState=u.networkState,j.reportApiInvoke(null,{name:"logUploadError",options:t,tag:S.TRACER}).onSuccess("logUploadError")}));export{G as AgoraEventUploadId,C as AgoraLogger,k as AgoraRTCEvent,J as AgoraRTCEventReport,B as AgoraRTCEventUploadType,x as EVENT_BASE_TEMPLATE,F as EventNameToID,W as LOG_TYPE,M as LOG_UPLOAD_STATE,Y as apiInvoke,V as isEventCustomReportParams,f as logReportBus,w as logger,j as report};
