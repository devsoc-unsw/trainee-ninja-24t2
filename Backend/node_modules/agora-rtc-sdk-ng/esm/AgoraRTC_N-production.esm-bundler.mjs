/**
 * AgoraWebSDK_N-v4.21.0-0-g16fdae2c-dirty Copyright AgoraInc.
 */

import"webrtc-adapter";import{AgoraRTCEventReport as e,logger as t,report as i,AgoraRTCEvent as n,AgoraRTCEventUploadType as s,apiInvoke as o,isEventCustomReportParams as a}from"@agora-js/report";import{IS_GLOBAL_VERSION as r,MUTABLE_PARAMS as c,MUTABLE_PARAMS_LOCAL_CACHE as d,AgoraRTCError as h,AgoraRTCErrorCode as l,isValidString as u,isEmpty as p,checkValidNumber as _,checkValidBoolean as E,checkValidEnum as m,checkValidString as S,checkValidArray as T,EventEmitter as C,getParameter as f,createDefer as R,isMacOS as g,isFirefox as I,PromiseMutex as v,NETWORK_STATE as A,networkIndicator as w,NETWORK_INDICATOR_EVENTS as y,getRetryWaitTime as N,wait as b,emitAsPromise as O,emitAsInvokerNoResponse as D,Rolling as P,ConnectionDisconnectedReason as L,WebSocketQuitReason as k,getRandomString as M,emitAsInvoker as U,SHA256 as x,setBigUint64 as V,getBigUint64 as F,uint8ArrayToBase64 as B,base64ToUint8Array as G,withTimeout as j,nextTick as W,VERSION as H,setParameter as K,getUTF8StringByteLength as q,getMultiUnilbsFormDataByteLength as Y,AgoraAPIName as J,AgoraAPITag as X,retryable as z,DEFAULT_RETRY_CONFIG as Q,getBrowserInfo as Z,jsonClone as $,BrowserName as ee,BrowserOS as te,P2PTransportType as ie,isRTCIceServerList as ne,isChromeKernel as se,emitAsPromiseNoResponse as oe,getUniqueList as ae,noop as re,generateSessionID as ce,VideoCodec as de,isSafari as he,isIOS as le,isChromeBelow90 as ue,isBelowIOS14_6 as pe,OVERUSE_DETECTOR_PARAMS as _e,isAboveIOS as Ee,isBelowIOS as me,isAboveSafari as Se,isBelowSafari as Te,isMobile as Ce,ClientEvents as fe,isWkWebview as Re,runOnce as ge,md5 as Ie,convertStringToFixedLengthUint8Array as ve,removeItemFromList as Ae,SDKStore as we,BUILD as ye,isClientRoleOptions as Ne,concurrent as be,isHttpsEnv as Oe,supportIsSecureContext as De,encryptRSA as Pe,generateIv as Le,generateKey as ke,isClientRole as Me,isTurnServerConfig as Ue,isEncryptionMode as xe,encryptAesGcm as Ve,CRYPTO_HEADER_LENGTH as Fe,decryptAesGcm as Be,isP2PTransport as Ge,isClientConfig as je,isBelowChrome as We,isWebKit as He,isSupportedWkWebview as Ke,isIpadOS as qe,isWechatBrowser as Ye,isQQBrowser as Je,generateProcessID as Xe}from"@agora-js/shared";export{AudienceLatencyLevelType,BUILD,ConnectionDisconnectedReason,VERSION,getParameter}from"@agora-js/shared";import ze from"axios";import"formdata-polyfill";import{MixingAudioTrack as Qe,LocalAudioTrack as Ze,LocalVideoTrack as $e,TrackHint as et,getCompatibility as tt,audioTimerLoop as it,MediaElementNumStatus as nt,visibilityWatcher as st,MediaElementStatus as ot,audioElementPlayCenter as at,MicrophoneAudioTrack as rt,RemoteAudioTrack as ct,RemoteVideoTrack as dt,TrackInternalEvent as ht,RemoteTrackEvents as lt,TrackEvents as ut,StreamType as pt,DEFAULT_LOCAL_AUDIO_TRACK_STATS as _t,DEFAULT_LOCAL_VIDEO_TRACK_STATS as Et,DEFAULT_REMOTE_AUDIO_TRACK_STATS as mt,DEFAULT_REMOTE_VIDEO_TRACK_STATS as St,DEFAULT_NETWORK_QUALITY_STATS as Tt,CameraVideoTrack as Ct,getOriginSenderConfig as ft,interceptRemoteVideoFrame as Rt,interceptRemoteAudioFrame as gt,interceptLocalVideoFrame as It,interceptLocalAudioFrame as vt,frameData2CryptoBuffer as At,LocalTrack as wt,LocalDataChannel as yt,isLowStreamParameter as Nt,RemoteDataChannel as bt,autoPlayGestureEventEmitter as Ot,deviceManager as Dt,DeviceManagerEvent as Pt,audioContextState as Lt,AUDIO_CONTEXT_EVENT as kt,__TRACK_LIST__ as Mt}from"@agora-js/media";export{RemoteStreamFallbackType,RemoteStreamType,__TRACK_LIST__,audioElementPlayCenter,createBufferSourceAudioTrack,createCameraVideoTrack,createCustomAudioTrack,createCustomVideoTrack,createMicrophoneAndCameraTracks,createMicrophoneAudioTrack,createScreenVideoTrack,getElectronScreenSources}from"@agora-js/media";const Ut=!0,xt=!1,Vt=!1,Ft=!1,Bt=["CHINA","GLOBAL"],Gt=function(){const e="us".concat("erna","me"),t="pa".concat("sswo","rd"),i=["t","s","t"];i.splice(1,0,"e");const n=i.join(""),s=[];for(let e=0;e<6;e++)s.push("1");const o=s.join(""),a={};return a[e]=n,a[t]=o,Object.assign(a,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=Gt,r||(c.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],c.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],c.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],c.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],c.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],c.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],c.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",c.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",c.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",c.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",c.AREAS=["NORTH_AMERICA","OVERSEA"]);const jt=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Wt=[];function Ht(e,t){return!!t&&Wt.some((i=>i.uid===e&&i.channelName===t))}function Kt(e){var t,i;function n(t,i){try{var o=e[t](i),a=o.value,r=a instanceof qt;Promise.resolve(r?a.v:a).then((function(i){if(r){var c="return"===t?"return":"next";if(!a.k||i.done)return n(c,i);i=e[c](i).value}s(o.done?"return":"normal",i)}),(function(e){n("throw",e)}))}catch(e){s("throw",e)}}function s(e,s){switch(e){case"return":t.resolve({value:s,done:!0});break;case"throw":t.reject(s);break;default:t.resolve({value:s,done:!1})}(t=t.next)?n(t.key,t.arg):i=null}this._invoke=function(e,s){return new Promise((function(o,a){var r={key:e,arg:s,resolve:o,reject:a,next:null};i?i=i.next=r:(t=i=r,n(e,s))}))},"function"!=typeof e.return&&(this.return=void 0)}function qt(e,t){this.v=e,this.k=t}function Yt(e){var t={},i=!1;function n(t,n){return i=!0,n=new Promise((function(i){i(e[t](n))})),{done:!1,value:new qt(n,1)}}return t["undefined"!=typeof Symbol&&Symbol.iterator||"@@iterator"]=function(){return this},t.next=function(e){return i?(i=!1,e):n("next",e)},"function"==typeof e.throw&&(t.throw=function(e){if(i)throw i=!1,e;return n("throw",e)}),"function"==typeof e.return&&(t.return=function(e){return i?(i=!1,e):n("return",e)}),t}function Jt(e){var t,i,n,s=2;for("undefined"!=typeof Symbol&&(i=Symbol.asyncIterator,n=Symbol.iterator);s--;){if(i&&null!=(t=e[i]))return t.call(e);if(n&&null!=(t=e[n]))return new Xt(t.call(e));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function Xt(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return Xt=function(e){this.s=e,this.n=e.next},Xt.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var i=this.s.return;return void 0===i?Promise.resolve({value:e,done:!0}):t(i.apply(this.s,arguments))},throw:function(e){var i=this.s.return;return void 0===i?Promise.reject(e):t(i.apply(this.s,arguments))}},new Xt(e)}function zt(e){return new qt(e,0)}function Qt(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Zt(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Qt(Object(i),!0).forEach((function(t){ei(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Qt(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function $t(e){return function(){return new Kt(e.apply(this,arguments))}}function ei(e,t,i){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function ti(e,t){if(null==e)return{};var i,n,s=function(e,t){if(null==e)return{};var i,n,s={},o=Object.keys(e);for(n=0;n<o.length;n++)i=o[n],t.indexOf(i)>=0||(s[i]=e[i]);return s}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)i=o[n],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(s[i]=e[i])}return s}function ii(e,t,i,n,s){var o={};return Object.keys(n).forEach((function(e){o[e]=n[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),o),s&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(s):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}e.__CLIENT_LIST__=Wt,Kt.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},Kt.prototype.next=function(e){return this._invoke("next",e)},Kt.prototype.throw=function(e){return this._invoke("throw",e)},Kt.prototype.return=function(e){return this._invoke("return",e)};let ni=function(e){return e.L1T1="L1T1",e.L1T2="L1T2",e.L1T3="L1T3",e.L2T1_KEY="L2T1_KEY",e.L2T2_KEY="L2T2_KEY",e.L2T3_KEY="L2T3_KEY",e.L3T1_KEY="L3T1_KEY",e.L3T2_KEY="L3T2_KEY",e.L3T3_KEY="L3T3_KEY",e}({}),si=function(e){return e.CERTIFICATE="certificate",e.CODEC="codec",e.CANDIDATE_PAIR="candidate-pair",e.LOCAL_CANDIDATE="local-candidate",e.REMOTE_CANDIDATE="remote-candidate",e.INBOUND="inbound-rtp",e.TRACK="track",e.OUTBOUND="outbound-rtp",e.PC="peer-connection",e.REMOTE_INBOUND="remote-inbound-rtp",e.REMOTE_OUTBOUND="remote-outbound-rtp",e.TRANSPORT="transport",e.CSRC="csrc",e.DATA_CHANNEL="data-channel",e.STREAM="stream",e.SENDER="sender",e.RECEIVER="receiver",e}({}),oi=function(e){return e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",e}({}),ai=function(e){return e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR",e}({}),ri=function(e){return e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",e}({}),ci=function(e){return e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",e}({}),di=function(e){return e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",e}({}),hi=function(e){return e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed",e}({}),li=function(e){return e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_CONNECTING="datachannel_connecting",e.DATACHANNEL_FAILBACK="datachannel_failback",e.P2P_CONNECTION="p2p_connection",e.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",e.P2P_SUBSCRIBE="p2p_subscribe",e.P2P_UNSUBSCRIBE="p2p_unsubscribe",e.P2P_EXCHANGE_SDP="p2p_exchange_sdp",e.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",e.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",e}({}),ui=function(e){return e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.PUBLISH_DATASTREAM="publish_datastream",e.UNPUBLISH="unpublish",e.UNPUBLISH_DATASTREAM="unpublish_datastream",e.SUBSCRIBE="subscribe",e.PRE_SUBSCRIBE="pre_subscribe",e.SUBSCRIBE_DATASTREAM="subscribe_datastream",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter",e.SET_RTM2_FLAG="set_rtm2_flag",e}({}),pi=function(e){return e.WRTC_STATS="wrtc_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats",e}({}),_i=function(e){return e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",e.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",e.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list",e}({}),Ei=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({}),mi=function(e){return e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",e}({});class Si extends h{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",arguments.length>2?arguments[2]:void 0),this.name="AgoraRTCException"}print(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error";return super.print(e,t)}throw(){super.throw(t)}}function Ti(e){if("string"!=typeof e||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(e))throw t.error("Invalid Channel Name ".concat(e)),new Si(l.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function Ci(e){if(!(i=e,"number"==typeof i&&Math.floor(i)===i&&0<=i&&i<=4294967295||u(e,1,255)))throw new Si(l.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var i;"string"==typeof e&&t.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let fi=function(e){return e.TRANSCODE="mix_streaming",e.RAW="raw_streaming",e.INJECT="inject_streaming",e}({}),Ri=function(e){return e[e.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",e[e.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",e[e.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",e[e.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",e[e.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",e[e.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",e[e.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",e[e.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",e[e.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN",e}({});const gi={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},Ii={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function vi(e,t){S(e.url,"".concat(t,".url"),1,1e3,!1),p(e.x)||_(e.x,"".concat(t,".x"),0,1e4),p(e.y)||_(e.y,"".concat(t,".y"),0,1e4),p(e.width)||_(e.width,"".concat(t,".width"),0,1e4),p(e.height)||_(e.height,"".concat(t,".height"),0,1e4),p(e.zOrder)||_(e.zOrder,"".concat(t,".zOrder"),0,255),p(e.alpha)||_(e.alpha,"".concat(t,".alpha"),0,1,!1)}const Ai={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},wi={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};let yi=function(e){return e.WARNING="@live_uap-warning",e.ERROR="@line_uap-error",e.PUBLISH_STREAM_STATUS="@live_uap-publish-status",e.INJECT_STREAM_STATUS="@live_uap-inject-status",e.WORKER_STATUS="@live_uap-worker-status",e.REQUEST_NEW_ADDRESS="@live_uap-request-address",e}({}),Ni=function(e){return e.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",e}({}),bi=function(e){return e[e.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",e[e.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",e[e.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",e[e.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",e[e.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",e[e.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",e[e.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",e[e.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",e[e.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",e[e.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",e[e.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",e[e.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",e[e.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",e[e.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",e[e.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",e[e.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",e}({});function Oi(e){if(!e.channelName)throw new Si(l.INVALID_PARAMS,"invalid channelName in info");if("number"!=typeof e.uid)throw new Si(l.INVALID_PARAMS,"invalid uid in info, uid must be a number");return e.token&&S(e.token,"info.token",1,2047),Ci(e.uid),Ti(e.channelName),!0}let Di=function(e){return e[e.SetSdkProfile=0]="SetSdkProfile",e[e.SetSourceChannel=1]="SetSourceChannel",e[e.SetSourceUserId=2]="SetSourceUserId",e[e.SetDestChannel=3]="SetDestChannel",e[e.StartPacketTransfer=4]="StartPacketTransfer",e[e.StopPacketTransfer=5]="StopPacketTransfer",e[e.UpdateDestChannel=6]="UpdateDestChannel",e[e.Reconnect=7]="Reconnect",e[e.SetVideoProfile=8]="SetVideoProfile",e}({}),Pi=function(e){return e.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",e.NETWORK_CONNECTED="NETWORK_CONNECTED",e.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",e.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",e.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",e.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",e.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",e.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",e.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",e.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",e}({}),Li=function(e){return e.RELAY_STATE_IDLE="RELAY_STATE_IDLE",e.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",e.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",e.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",e}({}),ki=function(e){return e.RELAY_OK="RELAY_OK",e.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",e.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",e.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",e}({}),Mi=function(e){return e.High="high",e.Low="low",e.Audio="audio",e.Screen="screen",e.ScreenLow="screen_low",e}({}),Ui=function(e){return e.DISCONNECT="disconnect",e.CONNECTION_STATE_CHANGE="connection-state-change",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGE="stream-type-change",e.IS_P2P_DISCONNECTED="is-p2p-dis",e.DISCONNECT_P2P="dis-p2p",e.REQUEST_NEW_GATEWAY_LIST="req-gate-url",e.NEED_RENEW_SESSION="need-sid",e.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",e.JOIN_RESPONSE="join-response",e.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",e.RESET_CONNECTION_EVENTS="reset-connection-events",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_FAILBACK="datachannel_failback",e.RESET_SIGNAL="reset-signal",e}({}),xi=function(e){return e.P2P_DISCONNECTED="P2P_DISCONNECTED",e.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",e.TIMEOUT="TIMEOUT",e.UNKNOWN_REASON="UNKNOWN_REASON",e}({}),Vi=function(e){return e[e.Nothing=0]="Nothing",e[e.Audio=1]="Audio",e[e.LwoVideo=2]="LwoVideo",e[e.Video=4]="Video",e[e.Data=8]="Data",e[e.DataStream0=256]="DataStream0",e[e.DataStream1=512]="DataStream1",e[e.DataStream2=1024]="DataStream2",e[e.DataStream3=2048]="DataStream3",e[e.DataStream4=4096]="DataStream4",e[e.DataStream5=8192]="DataStream5",e[e.DataStream6=16384]="DataStream6",e[e.DataStream7=32768]="DataStream7",e}({}),Fi=function(e){return e[e.websocket=0]="websocket",e[e.datachannel=1]="datachannel",e}({}),Bi=function(e){return e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS",e}({});const Gi=[Bi.AFRICA,Bi.ASIA,Bi.CHINA,Bi.EUROPE,Bi.GLOBAL,Bi.INDIA,Bi.JAPAN,Bi.NORTH_AMERICA,Bi.OCEANIA,Bi.OVERSEA,Bi.SOUTH_AMERICA];let ji=function(e){return e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL",e}({});const Wi={CHINA:{},ASIA:{CODE:ji.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:ji.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:ji.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:ji.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:ji.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:ji.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:ji.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:ji.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:ji.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:ji.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:ji.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:ji.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:ji.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};r&&(Wi.CHINA={CODE:ji.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let Hi=function(e){return e.UPDATE_BITRATE_LIMIT="update_bitrate_limit",e}({});class Ki extends C{constructor(e,t){super(),this.onICEConnectionStateChange=void 0,this.onConnectionStateChange=void 0,this.onDTLSTransportStateChange=void 0,this.onDTLSTransportError=void 0,this.onICETransportStateChange=void 0,this.onFirstAudioReceived=void 0,this.onFirstVideoReceived=void 0,this.onFirstAudioDecoded=void 0,this.onFirstVideoDecoded=void 0,this.onFirstVideoDecodedTimeout=void 0,this.onSelectedLocalCandidateChanged=void 0,this.onSelectedRemoteCandidateChanged=void 0,this.getLocalVideoStats=void 0}}class qi extends Ki{constructor(e,t){super(e,t),this.establishPromise=void 0}}let Yi=function(e){return e.VIDEO="video",e.AUDIO="audio",e}({}),Ji=function(e){return e[e.UDP=0]="UDP",e[e.TCP=1]="TCP",e[e.RELAY=2]="RELAY",e}({}),Xi=function(e){return e[e.FIRST_CONNECTION=0]="FIRST_CONNECTION",e[e.TCP_RESTART=1]="TCP_RESTART",e[e.RELAY_RESTART=2]="RELAY_RESTART",e[e.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",e[e.OLD_RESTART=11]="OLD_RESTART",e[e.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",e}({}),zi=function(e){return e.LocalVideoTrack="videoTrack",e.LocalAudioTrack="audioTrack",e.LocalVideoLowTrack="videoLowTrack",e}({}),Qi=function(e){return e.New="new",e.Connected="connected",e.Reconnecting="reconnecting",e.Disconnected="disconnected",e}({}),Zi=function(e){return e.StateChange="stateChange",e.IceConnectionStateChange="iceConnectionStateChange",e.RequestMuteLocal="requestMuteLocal",e.RequestUnmuteLocal="requestUnmuteLocal",e.RequestRePublish="requestRePublish",e.RequestRePublishDataChannel="requestRePublishDataChannel",e.RequestReSubscribe="requestReSubscribe",e.RequestUploadStats="requestUploadStats",e.RequestUpload="requestUpload",e.MediaReconnectStart="MediaReconnectStart",e.MediaReconnectEnd="MediaReconnectEnd",e.NeedSignalRTT="NeedSignalRTT",e.RequestRestartICE="RequestRestartIce",e.PeerConnectionStateChange="PeerConnectionStateChange",e.RequestReconnect="RequestReconnect",e.RequestReconnectPC="RequestReconnectPC",e.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",e.P2PLost="P2PLost",e.UpdateVideoEncoder="UpdateVideoEncoder",e.ConnectionTypeChange="ConnectionTypeChange",e.RequestLowStreamParameter="RequestLowStreamParameter",e.QueryClientConnectionState="QueryClientConnectionState",e.LocalCandidate="LocalCandidate",e.RequestP2PMuteLocal="requestP2PMuteLocal",e.RequestP2PUnPublish="RequestP2PUnPublish",e.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",e.RequestP2PMuteRemote="RequestP2PMuteRemote",e.RequestP2PRestartICE="RequestP2PRestartICE",e}({}),$i=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),en=function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e}({}),tn=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),nn=function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e}({}),sn=function(e){return e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback",e}({}),on=function(e){return e.CAMERA_CHANGED="camera-changed",e.MICROPHONE_CHANGED="microphone-changed",e.PLAYBACK_DEVICE_CHANGED="playback-device-changed",e.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",e.AUTOPLAY_FAILED="autoplay-failed",e.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",e.SECURITY_POLICY_VIOLATION="security-policy-violation",e}({}),an=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),rn=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),cn=function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e}({}),dn=function(e){return e.CALL="call",e.CANDIDATE="candidate",e.PUBLISH="publish",e.UNPUBLISH="unpublish",e.CONTROL="control",e.RESTART_ICE="restart_ice",e.ACK="ack",e.RESPONSE="response",e.JOIN="join",e.CHECK="check",e}({}),hn=function(e){return e.ABORT="abort",e}({}),ln=function(e){return e.MUTE_LOCAL_AUDIO="mute_local_audio",e.MUTE_LOCAL_VIDEO="mute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video",e}({}),un=function(e){return e.P2P_TOKEN_TIMEOUT="p2p_token_timeout",e.P2P_TOKEN_CHANGED="p2p_token_changed",e}({});const pn={[oi.ACCESS_POINT]:{[ci.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[ci.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[ci.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[ci.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[ci.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[ci.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[ci.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[ci.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[ci.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[ci.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[ci.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[ci.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[ci.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[ci.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[ci.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[ci.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[ci.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[ci.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[oi.UNILBS]:{[ri.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[ri.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[ri.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[ri.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[ri.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[ri.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[ri.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[ri.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[ri.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[ri.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[ri.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[ri.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[oi.STRING_UID_ALLOCATOR]:{[ai.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[ai.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[ai.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function _n(e){const t=pn[Math.floor(e/1e4)];if(!t)return{desc:"unknown error",retry:!1};const i=t[e%1e4];if(!i){if(Math.floor(e/1e4)===oi.ACCESS_POINT){const t=e%1e4;if("1"===t.toString()[0])return{desc:e.toString(),retry:!1};if("2"===t.toString()[0])return{desc:e.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return i}const En={[di.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[di.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[di.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[di.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[di.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[di.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[di.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[di.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[di.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[di.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[di.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[di.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[di.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[di.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[di.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[di.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[di.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[di.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[di.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[di.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[di.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[di.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[di.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[di.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[di.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[di.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[di.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[di.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[di.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[di.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[di.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[di.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[di.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[di.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[di.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[di.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[di.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[di.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[di.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[di.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[di.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[di.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[di.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[di.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[di.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[di.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[di.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[di.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[di.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[di.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[di.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[di.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[di.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[di.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[di.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[di.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[di.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[di.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[di.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[di.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[di.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[di.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[di.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function mn(e){const t=En[e];return t||{desc:"UNKNOW_ERROR_".concat(e),action:"failed"}}function Sn(e){return e.every((e=>e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING))}function Tn(e,t){if("string"==typeof e)return e;const{proxy:i,host:n,port:s}=e;if(t){const e=f("JOIN_GATEWAY_FALLBACK_PORT")||443;return 443===e?"wss://".concat(n,"/ws/?p=").concat(Number(s)+150):"wss://".concat(n,":").concat(e,"/ws/?p=").concat(Number(s)+150)}return i?"wss://".concat(i,"/ws/?h=").concat(n,"&p=").concat(s):"wss://".concat(n,":").concat(s)}const Cn=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,fn=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,Rn=/wss:\/\/(.+):([0-9]+)\/?/,gn=/wss:\/\/(.[^\/]+)\/?/;let In=0;class vn{constructor(e,t){this.id=0,this.store=void 0,this.recordIndex=void 0,this.websockets=[],this.try443PortDuration=2e3,this.forceCloseWSDuration=5e3,this.try443PortTimeout=null,this.forceCloseTimeout=null,this.isTry443PortFailed=!1,this.isNormalPortFailed=!1,this.useDoubleDomain=!1,this.useProxy=!1,this.startTime=Date.now(),this.id=++In,this.try443PortDuration=f("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=t}closeAllWebsockets(){this.websockets.forEach((e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()})),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var e;const i=Date.now()-this.startTime;for(var n=arguments.length,s=new Array(n),o=0;o<n;o++)s[o]=arguments[o];t.debug("[choose-best-ws ".concat(null===(e=this.store)||void 0===e?void 0:e.clientId," ").concat(this.id,"] ").concat(i,"ms:"),...s)}createWebSocket(e,t,i){this.logger("createWebSocket:",e,{isTry443Port:t,hasTimeoutDetection:i});const n=f("GATEWAY_DOMAINS"),s=Date.now(),o=[],a=n.find((t=>e.host.includes(t)));a||(this.useDoubleDomain=!1);const r=[];if(this.useDoubleDomain)n.forEach((i=>{r.push(Tn(Zt(Zt({},e),{},{host:e.host.replace(a,i)}),t))}));else{const i=Zt({},e);if(t&&a){const e=n.find((e=>e!==a));e&&(i.host=i.host.replace(a,e))}r.push(Tn(i,t))}try{r.forEach((e=>{const t=new WebSocket(e);t.binaryType="arraybuffer",o.push(t),this.logger("ws is connecting:",t.url)}))}catch(n){if(this.logger("ws create failed"),o.forEach((e=>e.close())),o.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,t,i);if(!t&&443!==Number(e.port))return this.createWebSocket(e,!0,i);throw new Si(l.WS_ERR,"init websocket failed! Error: ".concat(n.toString()))}const c=R();this.store&&this.store.recordJoinChannelService({urls:o.map((e=>e.url)),service:"gateway"},this.recordIndex),o.forEach((e=>{e.onopen=()=>{this.logger("onopen: ws ".concat(e.url," open cost ").concat(Date.now()-s,"ms")),this.websockets.forEach((t=>{t!==e&&(t.onopen=null,t.onclose=null,t.onmessage=null,t.close(),this.logger("close backup websocket: ".concat(t.url)))})),this.websockets.length=0,c.resolve(e)},e.onclose=i=>{this.logger("onclose: ws ".concat(e.url," closed cost ").concat(Date.now()-s,"ms state: ").concat(e.readyState)),t?this.isTry443PortFailed=Sn(o):this.isNormalPortFailed=Sn(o),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(t&&this.isTry443PortFailed||!t&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(i.reason)),c.reject({code:i.code,reason:xi.A_ROUND_WS_FAILED}))},e.onmessage=t=>this.logger("".concat(e.url," onmessage: ").concat(t.data))})),this.websockets.push(...o);return i||(()=>{const i=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",c.isResolved),this.websockets.forEach((e=>e.readyState!==WebSocket.OPEN&&e.close()))};if(t||this.useProxy)return this.logger("add 5s timeout at ".concat(t?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(i,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout((()=>{if(this.logger("2s timeout, isWebsocket created: ",c.isResolved),c.isResolved)return i();g()&&I()&&i(),this.createWebSocket(e,!0,!0).then((e=>c.resolve(e))).catch((e=>{this.isNormalPortFailed&&c.reject(e),this.logger("try 443 port to create ws failed")})),this.forceCloseTimeout=window.setTimeout(i,this.forceCloseWSDuration)}),this.try443PortDuration)})(),c.promise}chooseBestWebsocket(e,i,n,s){return this.useDoubleDomain=!!i,"string"==typeof e&&(e=function(e){let i,n,s;return[,i,n,s]=e.match(Cn)||[],i||([,n,s]=e.match(fn)||[]),n&&s||([,n,s]=e.match(Rn)||[]),n&&s||([,n]=e.match(gn)||[]),n||t.warning("un-destructible url: ",e),{proxy:i,host:n,port:s||"443"}}(e)),this.recordIndex=s,this.useProxy=!!e.proxy,n&&this.useProxy&&(t.warn("cannot use 443 only when use proxy"),n=!1),this.createWebSocket(e,!!n,!1).finally((()=>this.clearTimeout()))}}class An extends C{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){["tryNext","recover"].includes(e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(mi.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(mi.CONNECTED):"closed"===this._state?this.emit(mi.CLOSED):"failed"===this._state&&this.emit(mi.FAILED))}resetReconnectCount(e){t.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5?arguments[5]:void 0;super(),this.connectionID=0,this.currentURLIndex=0,this.urls=[],this._reconnectMode="tryNext",this.reconnectReason=void 0,this._initMutex=new v("websocket"),this.name=void 0,this._state="closed",this.reconnectInterrupter=void 0,this.websocket=void 0,this.retryConfig=void 0,this.reconnectCount=0,this.forceCloseTimeout=5e3,this.onlineReconnectListener=void 0,this.useCompress=void 0,this.tryDoubleDomain=!1,this.use443PortOnly=!1,this.wsInflateLength=0,this.wsDeflateLength=0,this.closeEstablishingWs=()=>{},this.store=void 0,this.joinGatewayRecordIndex=void 0,this.store=o,this.name=e,this.retryConfig=Zt({},t),this.useCompress=i,this.tryDoubleDomain=n,this.use443PortOnly=s;const{timeout:a,timeoutFactor:r}=t,c=Math.max(300,Math.floor(3*a/5)),d=Math.max(1.2,Math.floor(8*r)/10);A.ONLINE&&(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d),w.on(y.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===A.ONLINE?(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d):(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=r))}))}getConnection(){return this.websocket||void 0}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const i=await this._initMutex.lock();this.forceCloseTimeout=t,this.urls=e,this.state="connecting";try{const e=R(),t=this.urls[this.currentURLIndex];this.createWebSocketConnection(t).then(e.resolve).catch(e.reject),this.once(mi.CLOSED,(()=>{e.reject(new h(l.WS_DISCONNECT))})),this.once(mi.CONNECTED,e.resolve),await e.promise}catch(e){}finally{i()}}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const e=this.websocket;t?setTimeout((()=>e.close()),500):e.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,i){if(!this.websocket)return void t.warning("[".concat(this.name,"] can not reconnect, no websocket"));void 0!==e&&(this.reconnectMode=e),t.debug("[".concat(this.name,"] reconnect is triggered initiative")),"number"==typeof this.joinGatewayRecordIndex&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(i)]},this.joinGatewayRecordIndex);const n=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),n&&n.bind(this.websocket)({code:9999,reason:i})}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new h(l.WS_ABORT,"websocket is not ready");try{t||(e=JSON.stringify(e)),this.websocket.send(e)}catch(e){throw new h(l.WS_ERR,"send websocket message error"+e.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,t=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:t}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var i;const n=R();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const s=e=>{var i;null===(i=this.store)||void 0===i||i.signalChannelOpen(),t.debug("[".concat(this.name,"] websocket opened:"),e),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),n.resolve()},o=async e=>{var i;if(t.debug("[".concat(this.name,"] websocket close ").concat(null===(i=this.websocket)||void 0===i?void 0:i.url,", code: ").concat(e.code,", reason: ").concat(e.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)n.reject(new h(l.WS_DISCONNECT,"websocket close: ".concat(e.code))),this.close();else{"connected"===this.state&&(this.reconnectReason=e.reason,this.state="reconnecting");const i=D(this,mi.WILL_RECONNECT,this.reconnectMode,e.reason)||this.reconnectMode,s=await this.reconnectWithAction(i);if("closed"===this.state)return void t.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!s)return n.reject(new h(l.WS_DISCONNECT,"websocket reconnect failed: ".concat(e.code))),this.close(!0);n.resolve()}},a=e=>{this.emit(mi.ON_MESSAGE,e)},r=e=>{t.warn("[".concat(this.connectionID,"] ws open error ").concat(e))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),f("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=f("GATEWAY_WSS_ADDRESS")),t.debug("[".concat(this.name,"] start connect, url:"),e);const c=null===(i=this.store)||void 0===i?void 0:i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var d;const t=await this.chooseBestWebsocketConnection(e);this.websocket=t,s&&s(this.websocket.url),this.websocket.onclose=o,this.websocket.onmessage=a,this.websocket.onerror=r,null===(d=this.store)||void 0===d||d.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c}catch(e){const i="closed"===this.state,s=e instanceof h,a=s&&e.code===l.WS_ABORT,r=s&&e.code===l.WS_ERR,d=s?e.message:e&&(e.reason||e.toString());t.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(d)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:a?"aborted":"error",errors:[e]},c),i||r?(n.reject(i?new h(l.WS_DISCONNECT,"websocket is closed: ".concat(d)):new h(l.WS_ERR,"init websocket failed: ".concat(d))),r&&t.error("[".concat(this.name,"] init websocket failed: ").concat(d))):o&&o(e)}return n.promise}async reconnectWithAction(e){let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount)return!1;if(0===this.urls.length)return!1;if("closed"===this.state)return!1;t.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||w.isOnline||!w.onlineWaiter||(this.onlineReconnectListener=w.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let n=!0;if(this.reconnectInterrupter=()=>n=!1,i){const i=N(this.reconnectCount,this.retryConfig);t.debug("[".concat(this.name,"] wait ").concat(i,"ms to reconnect websocket, mode: ").concat(e)),await Promise.race([b(i),this.onlineReconnectListener||new Promise((()=>{}))])}if("closed"===this._state||!n)return!1;this.reconnectCount+=1;const s=async(e,t)=>{this.emit(mi.RECONNECT_CREATE_CONNECTION,t),await this.createWebSocketConnection(e)};try{if("retry"===e)this.emit(mi.RECONNECT_WAITTING_FINISH,e),await s(this.urls[this.currentURLIndex],e);else if("tryNext"===e){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);t.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(mi.RECONNECT_WAITTING_FINISH,e),await s(this.urls[this.currentURLIndex],e)}else"recover"===e&&(t.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(mi.RECONNECT_WAITTING_FINISH,e),this.urls=await O(this,mi.REQUEST_NEW_URLS),this.currentURLIndex=0,await s(this.urls[this.currentURLIndex],e))}catch(n){var o;t.error("[".concat(this.name,"] reconnect failed ").concat(n&&n.toString()));const s=null==n||null===(o=n.data)||void 0===o?void 0:o.desc;return Array.isArray(s)&&s.includes("dynamic key expired")?(this.emit(mi.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,i)}return!0}}class wn extends An{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,i){const n=R(),s=(o=this.forceCloseTimeout,a=this.store,new vn(o,a));var o,a;this.closeEstablishingWs=()=>{t.debug("[choose-best-ws] close establishing websockets"),s.closeAllWebsockets(),n.reject(new h(l.WS_ABORT,"choose best websocket aborted"))};const r=f("GATEWAY_DOMAINS");return t.debug("[choose-best-ws] currentDomain: ",e,", domains: ",r,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),s.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,i).then(n.resolve).catch(n.reject),n.promise.finally((()=>{this.closeEstablishingWs=void 0}))}}class yn extends An{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,i){return new Promise(((n,s)=>{let o=!1;const a=[];this.closeEstablishingWs=()=>{t.debug("[choose-best-ws] close establishing websockets"),a.forEach((e=>{e.onclose=null,e.onopen=null,e.onmessage=null,e.close()})),s(new h(l.WS_ABORT,"choose best websocket aborted"))};const r=f("GATEWAY_DOMAINS");let c;const d=e.indexOf("?h="),u=r.find((t=>-1!==d?e.includes(t,d):e.includes(t)));t.debug("[choose-best-ws] currentDomain: ",u,", domains: ",r);let p=!this.tryDoubleDomain||!u;if(!p&&u){var _;const h=Date.now();try{r.forEach((i=>{const n=-1===d?e.replace(u,i):e.substr(0,d)+e.substr(d).replace(u,i),s=new WebSocket(n);s.binaryType="arraybuffer",a.push(s),t.debug("[choose-best-ws] ws is connecting:",s.url)}))}catch(e){for(t.debug("[choose-best-ws] ws create failed, fallback to single url"),a.forEach((e=>e.close()));a.length;)a.pop();p=!0}null===(_=this.store)||void 0===_||_.recordJoinChannelService({urls:a.map((e=>e.url)),service:"gateway"},i),a.forEach((e=>{e.onopen=()=>{if(o)return;const i=Date.now()-h;t.debug("[choose-best-ws] ws open cost ".concat(i,"ms")),a.filter((t=>t!==e)).forEach((e=>{t.debug("[choose-best-ws]close backup websocket: ".concat(e.url)),e.close()})),o=!0,n(e)},e.onclose=e=>{if(c=e,o)return;a.find((e=>!(e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING)))||(t.debug("[choose-best-ws] all websocket is closed"),o=!0,s(c))},e.onmessage=i=>{t.debug("[choose-best-ws]".concat(e.url," onmessage: ").concat(i.data))}})),b(this.forceCloseTimeout).then((()=>{a.forEach((e=>{e.readyState!==WebSocket.OPEN&&e.close()}))}))}if(p){var E;let o;t.debug("[choose-best-ws] use single url: ",e),null===(E=this.store)||void 0===E||E.recordJoinChannelService({urls:[e],service:"gateway"},i);try{o=new WebSocket(e),a.push(o),o.binaryType="arraybuffer"}catch(e){const i=new h(l.WS_ERR,"init websocket failed! Error: ".concat(e.toString()));return t.error("[".concat(this.name,"]").concat(i)),void s(i)}o.onopen=()=>{n(o)},o.onclose=e=>{s(e)},o.onmessage=e=>{t.debug("[choose-best-ws]".concat(o.url," onmessage: ").concat(e.data))},b(this.forceCloseTimeout).then((()=>{o&&o.readyState!==WebSocket.OPEN&&o.close()}))}})).then((e=>(this.closeEstablishingWs=void 0,e))).catch((e=>{throw this.closeEstablishingWs=void 0,e}))}}class Nn extends C{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===hi.CONNECTED?this.emit(li.WS_CONNECTED):e===hi.RECONNECTING?this.emit(li.WS_RECONNECTING,this._websocketReconnectReason):e===hi.CLOSED&&this.emit(li.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=hi.CLOSED,this.reconnectToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new P(5),this.pingpongTimer=void 0,this.wsInflateDataTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this.onWebsocketMessage=e=>{if(e.data instanceof ArrayBuffer)return void this.emit(li.ON_BINARY_DATA,e.data);const t=JSON.parse(e.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")){if(this.emit(t._type,t._message),t._type===_i.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===_i.ON_USER_BANNED)switch(t._message.error_code){case 14:this.close(L.UID_BANNED);break;case 15:this.close(L.IP_BANNED);break;case 16:this.close(L.CHANNEL_BANNED)}if(t._type===_i.ON_USER_LICENSE_BANNED)switch(t._message.error_code){case di.ERR_LICENSE_MISSING:this.close(L.LICENSE_MISSING);break;case di.ERR_LICENSE_EXPIRED:this.close(L.LICENSE_EXPIRED);break;case di.ERR_LICENSE_MINUTES_EXCEEDED:this.close(L.LICENSE_MINUTES_EXCEEDED);break;case di.ERR_LICENSE_PERIOD_INVALID:this.close(L.LICENSE_PERIOD_INVALID);break;case di.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(L.LICENSE_MULTIPLE_SDK_SERVICE);break;case di.ERR_LICENSE_ILLEGAL:this.close(L.LICENSE_ILLEGAL);break;default:this.close()}}},this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new wn("gateway-".concat(this.clientId),this.spec.retryConfig,!0,f("JOIN_GATEWAY_USE_DUAL_DOMAIN"),f("JOIN_GATEWAY_USE_443PORT_ONLY"),t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===hi.CONNECTED&&this.reconnect("retry",k.OFFLINE)}))}async request(e,i,n,s){const o=M(6,""),a={_id:o,_type:e,_message:i},r=this.websocket.connectionID,c=()=>new Promise(((t,i)=>{if(this.connectionState===hi.CONNECTED)return t();const n=()=>{this.off(li.WS_CLOSED,s),t()},s=()=>{this.off(li.WS_CONNECTED,n),i(new Si(l.WS_ABORT))};this.once(li.WS_CONNECTED,n),this.once(li.WS_CLOSED,s),e!==ui.PUBLISH&&e!==ui.PUBLISH_DATASTREAM&&e!==ui.SUBSCRIBE&&e!==ui.SUBSCRIBE_DATASTREAM&&e!==ui.UNSUBSCRIBE&&e!==ui.UNSUBSCRIBE_DATASTREAM&&e!==ui.UNPUBLISH&&e!==ui.UNPUBLISH_DATASTREAM&&e!==ui.CONTROL&&e!==ui.RESTART_ICE||this.once(li.DISCONNECT_P2P,(()=>{i(new Si(l.DISCONNECT_P2P))})),e!==ui.PUBLISH&&e!==ui.RESTART_ICE||this.once(li.ABORT_P2P_EXECUTION,(()=>{i(new Si(l.DISCONNECT_P2P))}))}));if(this.connectionState!==hi.CONNECTING&&this.connectionState!==hi.RECONNECTING||e===ui.JOIN||e===ui.REJOIN||await c(),this.websocket.sendMessage(a,!0),s)return;const d=new Promise(((n,s)=>{let a=!1;const c=(t,s)=>{a=!0,n({isSuccess:"success"===t,message:s||{}}),this.off(li.WS_CLOSED,d),this.off(li.WS_RECONNECTING,d),this.emit(li.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(o),c);const d=()=>{s(new Si(l.WS_ABORT,"type: ".concat(e))),this.off(li.WS_CLOSED,d),this.off(li.WS_RECONNECTING,d),this.off("res-@".concat(o),c)};this.once(li.WS_CLOSED,d),this.once(li.WS_RECONNECTING,d),b(f("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==r||a||(t.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(li.REQUEST_TIMEOUT,e,i))}))}));let h=null;try{h=await d}catch(t){if(this.connectionState===hi.CLOSED||e===ui.LEAVE)throw new Si(l.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?t.throw():e===ui.JOIN||e===ui.REJOIN?null:(await c(),await this.request(e,i))}if(h.isSuccess)return h.message;const u=Number(h.message.error_code||h.message.code),p=mn(u),_=new Si(l.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(h.message.error_str),{code:u,data:h.message});return"success"===p.action?h.message:(t.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(u,", message: ").concat(p.desc,", action: ").concat(p.action)),u===di.ERR_TOO_MANY_BROADCASTERS?e===ui.JOIN||e===ui.REJOIN?(this.initError=_,this.close(),_.throw()):_.throw():"failed"===p.action?_.throw():"quit"===p.action?(this.initError=_,this.close(),_.throw()):(u===di.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=h.message.option,t.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",k.MULTI_IP)):this.reconnect(p.action,k.SERVER_ERROR),e===ui.JOIN||e===ui.REJOIN?null:await this.request(e,i)))}waitMessage(e,t){return new Promise((i=>{const n=s=>{(!t||t(s))&&(this.off(e,n),i(s))};this.on(e,n)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void t.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(pi.WRTC_STATS,i)}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=f("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==hi.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),f("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}init(e,t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Promise(((t,i)=>{this.once(li.WS_CONNECTED,(()=>t(this.joinResponse))),this.once(li.WS_CLOSED,(()=>i(this.initError||new Si(l.WS_ABORT)))),this.connectionState=hi.CONNECTING,this.websocket.init(e).catch(i),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval((()=>{this.handleWsInflateData()}),2e4)}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||L.LEAVE,this.connectionState=hi.CLOSED,t.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===L.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new wn("gateway-".concat(this.clientId),this.spec.retryConfig,!0,f("JOIN_GATEWAY_USE_DUAL_DOMAIN"),f("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(li.ABORT_P2P_EXECUTION);const e=await O(this,li.REQUEST_JOIN_INFO),t=await this.request(ui.JOIN,e);if(!t)return this.emit(li.REPORT_JOIN_GATEWAY,xi.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(li.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=hi.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new Si(l.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=U(this,li.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(ui.REJOIN,e);return!!t&&(this.connectionState=hi.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach((e=>{this.emit(_i.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(_i.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(_i.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(_i.MUTE_AUDIO,{uid:e.uid}):this.emit(_i.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(_i.MUTE_VIDEO,{uid:e.uid}):this.emit(_i.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(_i.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(_i.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(_i.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(_i.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(_i.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(e){t.debug("[".concat(this.clientId,"] receive notification: "),e);const i=mn(e.code);if("success"!==i.action){if("failed"!==i.action)return"quit"===i.action?("ERR_REPEAT_JOIN_CHANNEL"===i.desc&&this.close(L.UID_BANNED),void this.close()):void this.reconnect(i.action,k.SERVER_ERROR);t.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=f("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(t.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>f("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",k.TIMEOUT):this.request(ui.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-i;this.rttRolling.add(e),f("REPORT_STATS")&&this.send(ui.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:t}=this.websocket.getWsInflateData();0!==e&&0!==t&&this.upload(pi.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(mi.RECONNECT_WAITTING_FINISH,(e=>{this.emit(li.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(mi.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(li.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(mi.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(mi.CLOSED,(()=>{this.connectionState=hi.CLOSED})),this.websocket.on(mi.FAILED,(()=>{this._disconnectedReason=L.NETWORK_ERROR,this.connectionState=hi.CLOSED})),this.websocket.on(mi.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===hi.CONNECTED?this.connectionState=hi.RECONNECTING:this.connectionState=hi.CONNECTING})),this.websocket.on(mi.WILL_RECONNECT,((e,i,n)=>{const s=U(this,li.IS_P2P_DISCONNECTED),o=s||"retry"!==e;s&&"retry"===e&&(t.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",i=xi.P2P_DISCONNECTED),o&&(t.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(li.REPORT_JOIN_GATEWAY,i||xi.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(li.NEED_RENEW_SESSION,this.websocket.currentURLIndex>=this.websocket.urls.length-1?"recover":e),this.emit(li.DISCONNECT_P2P)),n(e)})),this.websocket.on(mi.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{t.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",k.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit(li.REPORT_JOIN_GATEWAY,e.message||e.code||xi.UNKNOWN_REASON,this.url||""),e instanceof Si){if(e.code===l.UNEXPECTED_RESPONSE&&e.data.code===di.ERR_NO_AUTHORIZED)return this.initError=new Si(l.CAN_NOT_GET_GATEWAY_SERVER,"AgoraRTCError CAN_NOT_GET_GATEWAY_SERVER: dynamic key expired"),t.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",k.SERVER_ERROR);t.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",k.SERVER_ERROR):(this.initError=e,this.close())}}))})),this.websocket.on(mi.REQUEST_NEW_URLS,((e,t)=>{O(this,li.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(mi.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(_i.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}let bn=function(e){return e[e.CHOOSE_SERVER=11]="CHOOSE_SERVER",e[e.CLOUD_PROXY=18]="CLOUD_PROXY",e[e.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",e[e.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",e}({});function On(e){return e.match(/^[\.\:\d]+$/)?"".concat(e.replace(/[^\d]/g,"-"),".").concat(f("TURN_DOMAIN")):(t.info("Unidentified as ip: ".concat(e,", use as host")),e)}function Dn(e,i){e.addresses||(e.addresses=[]);const n=function(e,i){if(f("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return e.map((e=>{let{ip:t,port:i}=e;return{address:"".concat(t,":").concat(i)}}));const n=f("GATEWAY_DOMAINS");let s=n[1]&&i.includes(n[1])?1:0;return e.map((e=>{let{domain_prefix:i,port:o,ip:a}=e;if(i)return{address:"".concat(i,".").concat(n[s++%n.length],":").concat(o)};const r=/^[\.\:\d]+$/.test(a),c=r?"".concat(a.replace(/[^\d]/g,"-"),".").concat(n[s++%n.length],":").concat(o):"".concat(a,":").concat(o);return r||t.info("Unidentified as ip: ".concat(a,", use as host")),{ip:a,port:o,address:c}}))}(e.addresses,i),s=Array.isArray(e.detail)&&e.detail[18];if(s&&"string"==typeof s){const e=s.split(";");for(let t=0;t<e.length;t++){const i=e[t].trim();n[t]&&i&&(n[t].ip6=i)}}return{gatewayAddrs:n,uid:e.uid,cid:e.cid,cert:e.cert,vid:e.detail&&e.detail[8],uni_lbs_ip:e.detail&&e.detail[1],res:e,csIp:e.detail&&e.detail[502]}}function Pn(e){return"number"==typeof e?e:e.exact||e.ideal||e.max||e.min||0}function Ln(e){const t=e._encoderConfig;if(!t)return{};const i={resolution:t.width&&t.height?"".concat(Pn(t.width),"x").concat(Pn(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return"number"==typeof t.frameRate?(i.maxFrameRate=t.frameRate,i.minFrameRate=t.frameRate):t.frameRate&&(i.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,i.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),i}function kn(e){return e>=0&&e<.17?1:e>=.17&&e<.36?2:e>=.36&&e<.59?3:e>=.59&&e<=1?4:e>1?5:0}function Mn(e,t){let i,n,s;switch(t){case bn.CHOOSE_SERVER:n=4096,s="choose server";break;case bn.CLOUD_PROXY:n=1048576,s="proxy";break;case bn.CLOUD_PROXY_5:n=4194304,s="proxy5";break;case bn.CLOUD_PROXY_FALLBACK:n=4194310,s="proxy fallback";break;default:throw new Si(l.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:e.detail&&e.detail[502],retry:!1})}if(e.response_body.forEach((t=>{t.buffer&&t.buffer.flag===n&&(i={code:t.buffer.code,addresses:(t.buffer.edges_services||[]).map((e=>Zt(Zt({},e),{},{ticket:t.buffer.cert}))),server_ts:e.enter_ts,uid:t.buffer.uid,cid:t.buffer.cid,cname:t.buffer.cname,detail:Zt(Zt({},t.buffer.detail),e.detail),flag:t.buffer.flag,opid:e.opid,cert:t.buffer.cert})})),!i)throw new Si(l.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(s," from multi unilbs response"),{csIp:e.detail&&e.detail[502]});return i}async function Un(e,t){return await Promise.all(e.addresses.map((async e=>({address:On(e.ip),tcpport:e.port,udpport:e.port,username:t&&f("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():Gt.username,password:t&&f("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await x(t.toString()):Gt.password}))))}function xn(e,i){const n=i.getMediaStreamTrack(!0).getSettings(),s=i.videoHeight||n.height,o=i.videoWidth||n.width;return s&&o?Math.max(Math.min(s,o)/Math.min(Pn(e.height),Pn(e.width)),1):(t.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function Vn(e){let{candidateType:t,relayProtocol:i,type:n,address:s,port:o,protocol:a}=e;return"local-candidate"===n?{candidateType:t,relayProtocol:i,protocol:a}:{candidateType:t,relayProtocol:i,address:s,port:o,protocol:a}}class Fn extends C{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){["tryNext","recover"].includes(e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(sn.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(sn.CONNECTED):"closed"===this._state?this.emit(sn.CLOSED):"failed"===this._state&&this.emit(sn.FAILED))}constructor(e,t,i,n){super(),this.connectionID=0,this.currentURLIndex=0,this.reconnectReason=void 0,this._reconnectMode="tryNext",this._initMutex=void 0,this._name=void 0,this._state="closed",this._reconnectInterrupter=void 0,this._url=void 0,this._retryConfig=void 0,this._reconnectCount=0,this._forceCloseTimeout=5e3,this._onlineReconnectListener=void 0,this._closeEstablishingTransmitter=()=>{},this._store=void 0,this._joinChannelServiceRecordIndex=void 0,this._transmitter=void 0,this._useCompress=void 0,this._inflateLength=0,this._deflateLength=0,this._store=n,this._name=e,this._retryConfig=Zt({},t),this._useCompress=i}resetReconnectCount(e){t.debug("".concat(this._name," reset reconnect count, reason: ").concat(e)),this._reconnectCount=0}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const e=this._transmitter;t?setTimeout((()=>e.close()),500):e.close(),this._transmitter=void 0}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(e,i){if(!this._transmitter)return void t.warning("[".concat(this._name,"] can not reconnect, no websocket"));var n;(void 0!==e&&(this.reconnectMode=e),t.debug("[".concat(this._name,"] reconnect is triggered initiative")),"number"==typeof this._joinChannelServiceRecordIndex)&&(null===(n=this._store)||void 0===n||n.recordJoinChannelService({status:"error",errors:[new Error(i)]},this._joinChannelServiceRecordIndex));const s=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),s&&s.bind(this._transmitter)({code:9999,reason:i})}getInflateData(){const e=this._inflateLength,t=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:t}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}let Bn=function(e){return e[e.Default=0]="Default",e[e.Ack=1]="Ack",e}({});class Gn{constructor(e,t,i){this.version=1,this.initialRTO=void 0,this.maxBatchAckCount=void 0,this.maxRTO=void 0,this.initialRTT=void 0,this.ID=void 0,this.rtt=void 0,this.packetNumber=1,this.rtoRatioMap=new Map,this.timeoutMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer=void 0,this.sendImpl=void 0,this.receiveImpl=void 0,this.sendImpl=e,this.receiveImpl=t,this.ID=M(7,"transmitter-"),this.initialRTO=void 0!==(null==i?void 0:i.initialRTO)?i.initialRTO:f("TRANSMITTER_INITIAL_RTO"),this.initialRTT=void 0!==(null==i?void 0:i.initialRTT)?i.initialRTT:f("TRANSMITTER_INITIAL_RTT"),this.rtt=void 0!==(null==i?void 0:i.initialRTT)?i.initialRTT:f("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=void 0!==(null==i?void 0:i.maxBatchAckCount)?i.maxBatchAckCount:f("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=void 0!==(null==i?void 0:i.maxRTO)?i.maxRTO:f("TRANSMITTER_MAX_RTO")}packetize(e,t){return{type:Bn.Default,version:this.version,packetNumber:t,payload:e}}serialize(e){switch(e.type){case Bn.Default:{let t;if("string"==typeof e.payload){t=(new TextEncoder).encode(e.payload)}else t=e.payload;const i=new ArrayBuffer(t.length+15),n=new DataView(i);n.setUint16(0,e.version),n.setUint8(2,e.type),n.setUint32(3,e.packetNumber),V(n,7,BigInt(e.sendTs));return new Uint8Array(n.buffer).set(t,15),i}case Bn.Ack:{const t=new ArrayBuffer(16),i=new DataView(t);return i.setUint16(0,e.version),i.setUint8(2,e.type),i.setUint32(3,e.maxAckPacketNumber),i.setUint8(7,e.shift),V(i,8,BigInt(e.ackSendTs)),t}}}deserialize(e){const i=new DataView(e),n=i.getUint16(0),s=i.getUint8(2);switch(s){case Bn.Default:{const t=i.getUint32(3),o=F(i,7),a=e.slice(15),r=(new TextDecoder).decode(a);return{version:n,type:s,packetNumber:t,sendTs:Number(o),payload:r}}case Bn.Ack:{const e=i.getUint32(3),t=i.getUint8(7),o=F(i,8);return{version:n,type:s,maxAckPacketNumber:e,shift:t,ackSendTs:Number(o)}}default:throw t.error("[".concat(this.ID,"] Unrecognized packet type ").concat(s)),new Error("Unrecognized packet type ".concat(s))}}sendMessage(e){const t=this.packetize(e,this.packetNumber);this.packetNumber=4294967295===this.packetNumber?1:this.packetNumber+1;const i=this.calculateRTO(t),n=window.setTimeout((()=>{this.resendMessage(t)}),i);this.timeoutMap.set(t.packetNumber,n),this.sendPacket(t)}onData(e){const t=this.deserialize(e);t.type===Bn.Default?this.ack(t):t.type===Bn.Ack&&(this.updateRTT(t,Math.round(performance.now())),this.clearRTO(t))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach((e=>{let[t,i]=e;window.clearTimeout(i)})),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,void 0!==this.batchAckTimer&&window.clearTimeout(this.batchAckTimer)}resendMessage(e){const t=this.calculateRTO(e),i=window.setTimeout((()=>{this.resendMessage(e)}),t);this.timeoutMap.set(e.packetNumber,i),this.sendPacket(e)}calculateRTO(e){const t=this.rtoRatioMap.get(e.packetNumber);if(void 0===t)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{const i=9*this.rtt/8*t;return this.rtoRatioMap.set(e.packetNumber,t+1),i>this.maxRTO?this.maxRTO:i}}updateRTT(e,t){const i=e.ackSendTs;this.rtt=this.rtt*(7/8)+(t-i-this.rtt)/8}ack(e){if(e.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(e):(this.batchAckPacketQueue.push(e),this.batchAckTimer=window.setTimeout((()=>{this.batchAck()}),this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(e.payload);;){const e=this.unorderedPacketQueue[0];if(!e){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(e.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(e.packetNumber<=this.lastOrderedPacketNumber){const t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:Bn.Ack,version:this.version};this.sendPacket(t)}else if(e.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[e.packetNumber-this.lastOrderedPacketNumber-2]=e;const t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:Bn.Ack,version:this.version};this.sendPacket(t)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const e={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:Bn.Ack,version:this.version};this.sendPacket(e),this.batchAckPacketQueue=[]}sendPacket(e){e.type===Bn.Default&&(e.sendTs=Math.round(performance.now()));const t=this.serialize(e);this.sendImpl(t)}clearRTO(e){for(let t=e.maxAckPacketNumber-e.shift;t<=e.maxAckPacketNumber;t++){const e=this.timeoutMap.get(t);void 0!==e&&window.clearTimeout(e),this.timeoutMap.delete(t),this.rtoRatioMap.delete(t)}}}class jn extends Fn{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3?arguments[3]:void 0),this._initMutex=void 0,this._reconnectInterrupter=void 0,this._url=void 0,this._transmitter=void 0,this._addresses=void 0,this._reliableTransmission=void 0,this._initMutex=new v("datachannel");const{timeout:i,timeoutFactor:n}=t,s=Math.max(300,Math.floor(3*i/5)),o=Math.max(1.2,Math.floor(8*n)/10);A.ONLINE&&(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o),w.on(y.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===A.ONLINE?(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o):(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=n))}))}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;this._forceCloseTimeout=t;const i=(t,i)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex((e=>e.fingerprint||f("FINGERPRINT")));const n=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(n).then(t).catch(i),this.once(sn.CLOSED,(()=>i(new Si(l.WS_DISCONNECT)))),this.once(sn.CONNECTED,(()=>t()))};return this._initMutex.lock().then((e=>new Promise(((e,t)=>{i(e,t)})).then((()=>{e()})).catch((()=>{e()}))))}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new Si(l.WS_ABORT,"datachannel is not ready");try{t||(e=JSON.stringify(e)),this._reliableTransmission.sendMessage(e)}catch(e){throw new Si(l.WS_ERR,"send datachannel signal message error"+e.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(e){const t=JSON.stringify(e);return{compressed:t,compressedLength:t.length,origin:e}}sendMessageWithUint8Array(e){return{compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(e){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(e.ip,":").concat(e.port),new Promise(((i,n)=>{var s;const o=()=>{t.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i()},a=async e=>{var s;if(null===(s=this._closeEstablishingTransmitter)||void 0===s||s.call(this),t.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(e.code,", reason: ").concat(e.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){"connected"===this.state&&(this.reconnectReason=e.reason,this.state="reconnecting");const s=D(this,sn.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,o=await this.reconnectWithAction(s);if("closed"===this.state)return void t.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!o)return n(new Si(l.WS_DISCONNECT,"datachannel reconnect failed: ".concat(e.code))),void this.close(!0);i()}else n(new Si(l.WS_DISCONNECT,"datachannel close: ".concat(e.code))),this.close()},r=e=>{var t;null===(t=this._reliableTransmission)||void 0===t||t.onData(e.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),t.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(e)));const c=null===(s=this._store)||void 0===s?void 0:s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),d=Date.now();O(this,sn.TO_CONNECT_DATACHANNEL,e).then((e=>{var i,n;if(!e)throw new Error("transmissonInfo not exist yet");const{transmitter:s,close:h}=e;this._transmitter=s,null===(i=this._store)||void 0===i||i.signalChannelOpen();const l=Date.now()-d;t.debug("[choose dc] dc open cost ".concat(l,"ms"));this._reliableTransmission=new Gn((e=>{var t;this._transmitter&&"open"===this._transmitter.readyState&&(null===(t=this._transmitter)||void 0===t||t.send(e))}),(e=>{"string"==typeof e&&this.emit(sn.ON_MESSAGE,e)})),this._closeEstablishingTransmitter=()=>{var e;null===(e=this._reliableTransmission)||void 0===e||e.close(),this._reliableTransmission=void 0,h()},o&&o(),s.onclose=a,s.onmessage=r,null===(n=this._store)||void 0===n||n.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this._joinChannelServiceRecordIndex=c})).catch((e=>{var i;if(null===(i=this._store)||void 0===i||i.recordJoinChannelService({endTs:Date.now(),status:e instanceof Si&&e.code===l.WS_ABORT?"aborted":"error",errors:[e]},c),"closed"!==this.state){if(e instanceof Si&&e.code===l.WS_ERR){const i=new Si(l.WS_ERR,"init datachannel failed! Error: ".concat(e.toString()));return t.error("[".concat(this._name,"]").concat(i)),void n(i)}a&&a(e)}else n(new Si(l.WS_DISCONNECT,"datachannel is closed: ".concat(e.toString())))}))}))}async reconnectWithAction(e){let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount)return!1;if(!this._addresses)return!1;if("closed"===this.state)return!1;this._onlineReconnectListener||w.networkState!==A.OFFLINE||(this._onlineReconnectListener=w.onlineWaiter&&w.onlineWaiter.then((()=>{this._onlineReconnectListener=void 0})));let n=!0;if(this._reconnectInterrupter=()=>{n=!1},i){const i=N(this._reconnectCount,this._retryConfig);t.debug("[".concat(this._name,"] wait ").concat(i,"ms to reconnect datachannel, mode: ").concat(e)),await Promise.race([b(i),this._onlineReconnectListener||new Promise((()=>{}))])}if("closed"===this.state||!n)return!1;this._reconnectCount+=1;const s=async(e,t)=>{this.emit(sn.RECONNECT_CREATE_CONNECTION,t),await this.createTransmitterConnection(e)};try{if("retry"===e){const t=this._addresses[this.currentURLIndex];this.emit(sn.RECONNECT_WAITTING_FINISH,e),await s(t,e)}else if("tryNext"===e){this.currentURLIndex+=1;for(let e=this.currentURLIndex;e<this._addresses.length;e++){if(this._addresses[e].fingerprint||f("FINGERPRINT")){this.currentURLIndex=e;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return t.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);t.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const i=this._addresses[this.currentURLIndex];this.emit(sn.RECONNECT_WAITTING_FINISH,e),await s(i,e)}else"recover"===e&&(t.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(sn.RECONNECT_WAITTING_FINISH,e),this.emit(sn.FAILBACK));return!0}catch(n){var o;return t.error("[".concat(this._name,"] reconnect failed"),n.toString()),null!=n&&null!==(o=n.data)&&void 0!==o&&o.desc&&Array.isArray(n.data.desc)&&n.data.desc.length&&n.data.desc.includes("dynamic key expired")?(this.emit(sn.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,i)}}}class Wn extends C{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===hi.CONNECTED?this.emit(li.WS_CONNECTED):e===hi.RECONNECTING?this.emit(li.WS_RECONNECTING,this._websocketReconnectReason):e===hi.CLOSED&&this.emit(li.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=hi.CLOSED,this.reconnectToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new P(5),this.pingpongTimer=void 0,this.inflateDataTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this.onWebsocketMessage=e=>{if(e instanceof ArrayBuffer)return void this.emit(li.ON_BINARY_DATA,e);const t=JSON.parse(e);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")&&(this.emit(t._type,t._message),t._type===_i.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===_i.ON_USER_BANNED))switch(t._message.error_code){case 14:this.close(L.UID_BANNED);break;case 15:this.close(L.IP_BANNED);break;case 16:this.close(L.CHANNEL_BANNED)}},this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new jn("gateway-".concat(this.clientId),this.spec.retryConfig,!0,t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===hi.CONNECTED&&this.reconnect("retry",nn.OFFLINE)}))}async request(e,i,n,s){const o=M(6,""),a={_id:o,_type:e,_message:i},r=this.websocket.connectionID,c=()=>new Promise(((t,i)=>{if(this.connectionState===hi.CONNECTED)return t();const n=()=>{this.off(li.WS_CLOSED,s),t()},s=()=>{this.off(li.WS_CONNECTED,n),i(new Si(l.WS_ABORT))};this.once(li.WS_CONNECTED,n),this.once(li.WS_CLOSED,s),e!==ui.PUBLISH&&e!==ui.SUBSCRIBE&&e!==ui.UNSUBSCRIBE&&e!==ui.UNPUBLISH&&e!==ui.CONTROL&&e!==ui.RESTART_ICE||this.once(li.DISCONNECT_P2P,(()=>{i(new Si(l.DISCONNECT_P2P))})),e!==ui.PUBLISH&&e!==ui.RESTART_ICE||this.once(li.ABORT_P2P_EXECUTION,(()=>{i(new Si(l.DISCONNECT_P2P))}))}));if(this.connectionState!==hi.CONNECTING&&this.connectionState!==hi.RECONNECTING||e===ui.JOIN||e===ui.REJOIN||await c(),e===ui.LEAVE&&(this.websocket.unbindDcCloseEventListener(),s=!0),this.websocket.sendMessage(a,!0,!1),s)return;const d=new Promise(((n,s)=>{let a=!1;const c=(t,s)=>{a=!0,n({isSuccess:"success"===t,message:s||{}}),this.off(li.WS_CLOSED,d),this.off(li.WS_RECONNECTING,d),this.emit(li.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(o),c);const d=()=>{s(new Si(l.WS_ABORT,"type: ".concat(e))),this.off(li.WS_CLOSED,d),this.off(li.WS_RECONNECTING,d),this.off("res-@".concat(o),c)};this.once(li.WS_CLOSED,d),this.once(li.WS_RECONNECTING,d),b(f("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==r||a||(t.warning("dc request timeout, type: ".concat(e)),this.emit(li.REQUEST_TIMEOUT,e,i))}))}));let h=null;try{h=await d}catch(t){if(this.connectionState===hi.CLOSED||e===ui.LEAVE)throw new Si(l.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?t.throw():e===ui.JOIN||e===ui.REJOIN?null:(await c(),await this.request(e,i))}if(h.isSuccess)return h.message;const u=Number(h.message.error_code||h.message.code),p=mn(u),_=new Si(l.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(h.message.error_str),{code:u,data:h.message});return"success"===p.action?h.message:(t.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(u,", message: ").concat(p.desc,", action: ").concat(p.action)),u===di.ERR_TOO_MANY_BROADCASTERS?e===ui.JOIN||e===ui.REJOIN?(this.initError=_,this.close(),_.throw()):_.throw():"failed"===p.action?_.throw():"quit"===p.action?(this.initError=_,this.close(),_.throw()):(u===di.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=h.message.option,t.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",nn.MULTI_IP)):this.reconnect(p.action,nn.SERVER_ERROR),e===ui.JOIN||e===ui.REJOIN?null:await this.request(e,i)))}waitMessage(e,t){return new Promise((i=>{const n=s=>{(!t||t(s))&&(this.off(e,n),i(s))};this.on(e,n)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void t.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(pi.WRTC_STATS,i)}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=f("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==hi.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),f("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}init(e,i){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Promise(((n,s)=>{this.once(li.WS_CONNECTED,(()=>n(this.joinResponse))),this.once(li.WS_CLOSED,(()=>s(this.initError||new Si(l.WS_ABORT)))),this.connectionState=hi.CONNECTING,this.websocket.init(e).catch(s),this.websocket.once(sn.FAILBACK,(()=>{void 0===this.openConnectionTime&&s(new Si(l.INIT_DATACHANNEL_TIMEOUT))})),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval((()=>{this.handleInflateData()}),2e4),setTimeout((()=>{i&&void 0===this.openConnectionTime&&(t.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),s(new Si(l.INIT_DATACHANNEL_TIMEOUT)))}),f("DC_JOIN_WITH_FAILBACK"))}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||L.LEAVE,this.connectionState=hi.CLOSED,t.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),e===L.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new jn("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(li.ABORT_P2P_EXECUTION);const e=await O(this,li.DATACHANNEL_CONNECTING),t=await this.request(ui.JOIN,e);if(!t)return this.emit(li.REPORT_JOIN_GATEWAY,l.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(li.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=hi.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new Si(l.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=U(this,li.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(ui.REJOIN,e);return!!t&&(this.connectionState=hi.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach((e=>{this.emit(_i.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(_i.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(_i.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(_i.MUTE_AUDIO,{uid:e.uid}):this.emit(_i.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(_i.MUTE_VIDEO,{uid:e.uid}):this.emit(_i.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(_i.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(_i.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(_i.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(_i.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(_i.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(e){t.debug("[".concat(this.clientId,"] receive notification: "),e);const i=mn(e.code);if("success"!==i.action){if("failed"!==i.action)return"quit"===i.action?("ERR_REPEAT_JOIN_CHANNEL"===i.desc&&this.close(L.UID_BANNED),void this.close()):void this.reconnect(i.action,nn.SERVER_ERROR);t.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=f("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(t.warning("PINGPONG Timeout. Last Socket Message: ".concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>f("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",nn.TIMEOUT):this.request(ui.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-i;this.rttRolling.add(e),f("REPORT_STATS")&&this.send(ui.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleInflateData(){const{inflateLength:e,deflateLength:t}=this.websocket.getInflateData();0!==e&&0!==t&&this.upload(pi.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(sn.RECONNECT_WAITTING_FINISH,(e=>{this.emit(li.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(sn.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(li.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(sn.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(sn.CLOSED,(()=>{this.connectionState=hi.CLOSED})),this.websocket.on(sn.FAILED,(()=>{this._disconnectedReason=L.NETWORK_ERROR,this.connectionState=hi.CLOSED})),this.websocket.on(sn.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===hi.CONNECTED?this.connectionState=hi.RECONNECTING:this.connectionState=hi.CONNECTING})),this.websocket.on(sn.WILL_RECONNECT,((e,i)=>{if(U(this,li.IS_P2P_DISCONNECTED)&&"retry"===e)return t.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(li.NEED_RENEW_SESSION),this.emit(li.DISCONNECT_P2P),i("tryNext");"retry"!==e&&(t.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(li.NEED_RENEW_SESSION),this.emit(li.DISCONNECT_P2P)),i(e)})),this.websocket.on(sn.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{t.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",nn.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit(li.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof Si&&e.code===l.UNEXPECTED_RESPONSE&&e.data.code===di.ERR_NO_AUTHORIZED)return t.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",nn.SERVER_ERROR);t.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",nn.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(sn.REQUEST_NEW_URLS,((e,t)=>{O(this,li.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(sn.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(_i.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(sn.TO_CONNECT_DATACHANNEL,(async(e,t,i)=>O(this,li.DATACHANNEL_PRECONNECT,e).then(t).catch(i))),this.websocket.on(sn.FAILBACK,(()=>{void 0!==this.openConnectionTime&&this.emit(li.DATACHANNEL_FAILBACK)}))}}class Hn extends C{constructor(e,t){super(),this.signal=void 0,this.token=void 0,this.tokenTimeout=void 0,this.tokenInterval=void 0,this._sequence=0,this.userMap=new Map,this.encoder=new TextEncoder,this.signal=e,this.token=t;const i=()=>{this.signal.connectionState===hi.CONNECTED&&this.check(),0===this.userMap.size?this.tokenInterval=window.setTimeout(i,1e3):this.tokenInterval=window.setTimeout(i,3*f("P2P_TOKEN_INTERVAL"))};i()}async send(e,i,n,s,o){var a,r;if(0===this.userMap.size)return;const c=Array.from(this.userMap.values())[0].token;"string"!=typeof i&&(i=JSON.stringify(i)),s=null!==(a=s)&&void 0!==a?a:M(6,""),o=null!==(r=o)&&void 0!==r?r:this._sequence++;const d={_id:s,_type:e,_seq:o,_message:i,token:"".concat(this.token,"_").concat(c)};f("SHOW_P2P_LOG")&&t.debug("send message",d,"noNeedResponse : ".concat(n));this.splitMessage(JSON.stringify(d)).forEach((e=>{this.signal.request(ui.DATA_STREAM,{payload:B(this.encoder.encode(e))})}));const u=new Promise(((i,o)=>{const a=window.setTimeout((()=>{this.off("res-@".concat(s,"_ack"),r),this.off("res-@".concat(s),u),this.off(hn.ABORT,c),t.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(s)),0===this.userMap.size?o(new h(l.INVALID_REMOTE_USER)):o(new h(l.TIMEOUT))}),f("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),r=()=>{a&&window.clearTimeout(a),this.off(hn.ABORT,c),n&&i()},c=()=>{a&&window.clearTimeout(a),this.off("res-@".concat(s,"_ack"),r),this.off("res-@".concat(s),u),o(new h(l.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(s)))};this.once(hn.ABORT,c),this.once("res-@".concat(s,"_ack"),r);const u=(t,n)=>{p=!0,a&&window.clearTimeout(a),this.off("res-@".concat(s,"_ack"),r),this.off(hn.ABORT,c),"success"===t?i(n):o(new h(l.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(s)))};let p=!1;n||(this.once("res-@".concat(s),u),b(f("SIGNAL_REQUEST_TIMEOUT")).then((()=>{p||t.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(s,", ").concat(d))})))}));try{return await u}catch(t){if(t.code===l.TIMEOUT)return await this.send(e,i,n,s,o);throw t}}onMessage(e){const{_uid:i}=e;let n,s=this.userMap.get(i);if(s)n=s.splitMessageMap;else{if(this.userMap.size>0||!("_type"in e)||e._type!==dn.CHECK)return;const{token:t}=e;n=new Map,s={uid:i,isStart:!0,token:t,splitMessageMap:n,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(i,s),this.signal.emit(_i.ON_USER_ONLINE,{uid:i}),this.handleUserOnline()}if("id"in e&&"total"in e){var o;const{id:t,total:s}=e,a=null!==(o=n.get(t))&&void 0!==o?o:[];if(a.push(e),n.has(t)||n.set(t,a),a.length!==s)return;{const s=a.sort(((e,t)=>e.index-t.index)).map((e=>e.payload)).join("");n.delete(t),(e=JSON.parse(s))._uid=i}}const{_type:a,token:r}=e;if([dn.ACK,dn.CHECK].includes(a))return a===dn.CHECK&&this.handleCheckToken(s,r),void this.receiveMessage(e);r==="".concat(s.token,"_").concat(this.token)?this.handleReceivedMessage(e):t.debug('Receive unexpected message", '.concat(r,", cur_token: ").concat(s.token,"_").concat(this.token),e)}check(){const e={_id:M(6,""),token:this.token,_type:dn.CHECK};f("SHOW_P2P_LOG")&&t.debug("send message",e),this.signal.request(ui.DATA_STREAM,{payload:B(this.encoder.encode(JSON.stringify(e)))})}ack(e){const i={_id:e,_type:dn.ACK,token:this.token};f("SHOW_P2P_LOG")&&t.debug("send message",i),this.signal.request(ui.DATA_STREAM,{payload:B(this.encoder.encode(JSON.stringify(i)))})}response(e,t,i){this.send(dn.RESPONSE,JSON.stringify({success:!i,message:t}),!0,e)}handleReceivedMessage(e){const i=()=>{this.userMap.forEach((e=>{const{receivedMessagesMap:t,nextExpectedSequenceNumber:i}=e;for(;t.has(i);){const n=t.get(i);t.delete(i),this.receiveMessage(n),e.nextExpectedSequenceNumber++}}))};if(!e)return void i();const{_uid:n,_seq:s}=e,o=this.userMap.get(n),{receivedMessagesMap:a,isStart:r,nextExpectedSequenceNumber:c}=o;if(s<c)return this.ack(e._id),void t.debug("[external-signal] receive old message, seq: ".concat(s,", ").concat(e._message));a.set(s,e),r&&s===c&&(this.receiveMessage(e),a.delete(c),o.nextExpectedSequenceNumber++,i())}receiveMessage(e){const{_id:i,_type:n,_message:s,_uid:o}=e;if(f("SHOW_P2P_LOG")&&t.debug("receive message",e),i){let t;switch(e._type!==dn.ACK&&(s&&(t=JSON.parse(s)),this.ack(e._id)),e._type){case dn.CANDIDATE:case dn.CONTROL:this.signal.emit(n,t,o);break;case dn.PUBLISH:case dn.UNPUBLISH:case dn.RESTART_ICE:case dn.CALL:t.uid=o,O(this.signal,n,t).then((t=>{this.response(e._id,t)})).catch((()=>{this.response(e._id,void 0,!0)}));break;case dn.ACK:this.getListeners("res-@".concat(i,"_ack")).length>0&&this.emit("res-@".concat(i,"_ack"));break;case dn.RESPONSE:{const{success:e,message:n}=t;this.emit("res-@".concat(i),e?"success":"failed",n);break}}}}splitMessage(e){if(e.length<Hn.MAX_MESSAGE_SIZE)return[e];const t=[],{remoteToken:i}=JSON.parse(e),n=M(6,"");let s=0,o=800;const a=Math.ceil(e.length/o);for(;e.length>0;){s++;const r={id:n,index:s,total:a,payload:e.slice(0,o),token:"".concat(this.token,"_").concat(i)};JSON.stringify(r).length>Hn.MAX_MESSAGE_SIZE?o-=50:(t.push(r),e=e.slice(o))}return t.map((e=>JSON.stringify(e)))}handleCheckToken(e,i){return e.token!==i?(t.debug("token changed, from ".concat(e.token," to ").concat(i)),this.reset(e.uid,i),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout((()=>{t.debug("token timeout, ".concat(i)),this.reset(e.uid)}),f("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const e=await O(this.signal,dn.CALL,void 0),t=await this.send(dn.CALL,e);this.signal.emit(li.P2P_CONNECTION,t,!0)}async reset(e,i){const n=this.userMap.get(e);n&&(this.emit(hn.ABORT),this.signal.emit(_i.ON_USER_OFFLINE,{uid:n.uid,reason:un.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),i||(t.debug("change local token from ".concat(i," to ").concat(i)),this.token=M(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(hn.ABORT)}}Hn.MAX_SIZE=1,Hn.MAX_MESSAGE_SIZE=1024;class Kn extends C{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===hi.CONNECTED?this.emit(li.WS_CONNECTED):e===hi.RECONNECTING?this.emit(li.WS_RECONNECTING,this._websocketReconnectReason):e===hi.CLOSED&&this.emit(li.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,i){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=hi.CLOSED,this.reconnectToken=void 0,this.p2pToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new P(5),this.pingpongTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this._external_signal=void 0,this.onWebsocketMessage=e=>{if(e.data instanceof ArrayBuffer)return void this.emit(li.ON_BINARY_DATA,e.data);const i=JSON.parse(e.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(i,"_id")){const e="res-@".concat(i._id);this.emit(e,i._result,i._message)}else if(Object.prototype.hasOwnProperty.call(i,"_type")){switch(i._type){case _i.ON_DATA_STREAM:return void this.handleDataStream(i._message);case _i.MUTE_AUDIO:case _i.MUTE_VIDEO:case _i.ON_P2P_LOST:case _i.ON_USER_ONLINE:return;case _i.ON_USER_OFFLINE:const{uid:e}=i._message;return t.debug("[".concat(this.clientId,"] user-offline uid: ").concat(e)),void this._external_signal.reset(e)}if(this.emit(i._type,i._message),i._type===_i.ON_NOTIFICATION&&this.handleNotification(i._message),i._type===_i.ON_USER_BANNED)switch(i._message.error_code){case 14:this.close(L.UID_BANNED);break;case 15:this.close(L.IP_BANNED);break;case 16:this.close(L.CHANNEL_BANNED)}if(i._type===_i.ON_USER_LICENSE_BANNED)switch(i._message.error_code){case di.ERR_LICENSE_MISSING:this.close(L.LICENSE_MISSING);break;case di.ERR_LICENSE_EXPIRED:this.close(L.LICENSE_EXPIRED);break;case di.ERR_LICENSE_MINUTES_EXCEEDED:this.close(L.LICENSE_MINUTES_EXCEEDED);break;case di.ERR_LICENSE_PERIOD_INVALID:this.close(L.LICENSE_PERIOD_INVALID);break;case di.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(L.LICENSE_MULTIPLE_SDK_SERVICE);break;case di.ERR_LICENSE_ILLEGAL:this.close(L.LICENSE_ILLEGAL);break;default:this.close()}}},this.clientId=e.clientId,this.spec=e,this.store=i,this.websocket=new wn("gateway-".concat(this.clientId),this.spec.retryConfig,!0,f("JOIN_GATEWAY_USE_DUAL_DOMAIN"),f("JOIN_GATEWAY_USE_443PORT_ONLY"),i),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===hi.CONNECTED&&this.reconnect("retry",k.OFFLINE)})),this.p2pToken=M(6,""),this._external_signal=new Hn(this,this.p2pToken)}async request(e,i,n,s){const o=M(6,""),a={_id:o,_type:e,_message:i},r=this.websocket.connectionID,c=()=>new Promise(((e,t)=>{if(this.connectionState===hi.CONNECTED)return e();const i=()=>{this.off(li.WS_CLOSED,n),e()},n=()=>{this.off(li.WS_CONNECTED,i),t(new h(l.WS_ABORT))};this.once(li.WS_CONNECTED,i),this.once(li.WS_CLOSED,n)}));if(this.connectionState!==hi.CONNECTING&&this.connectionState!==hi.RECONNECTING||e===ui.JOIN||e===ui.REJOIN||await c(),this.websocket.sendMessage(a,!0),s)return;const d=new Promise(((n,s)=>{let a=!1;const c=(t,s)=>{a=!0,n({isSuccess:"success"===t,message:s||{}}),this.off(li.WS_CLOSED,d),this.off(li.WS_RECONNECTING,d),this.emit(li.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(o),c);const d=()=>{s(new h(l.WS_ABORT,"type: ".concat(e))),this.off(li.WS_CLOSED,d),this.off(li.WS_RECONNECTING,d),this.off("res-@".concat(o),c)};this.once(li.WS_CLOSED,d),this.once(li.WS_RECONNECTING,d),b(f("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==r||a||(t.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(li.REQUEST_TIMEOUT,e,i))}))}));let u=null;try{u=await d}catch(t){if(this.connectionState===hi.CLOSED||e===ui.LEAVE)throw new h(l.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?t.throw():e===ui.JOIN||e===ui.REJOIN?null:(await c(),await this.request(e,i))}if(u.isSuccess)return u.message;const p=Number(u.message.error_code||u.message.code),_=mn(p),E=new h(l.UNEXPECTED_RESPONSE,"".concat(_.desc,": ").concat(u.message.error_str),{code:p,data:u.message});return"success"===_.action?u.message:(t.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(p,", message: ").concat(_.desc,", action: ").concat(_.action)),p===di.ERR_TOO_MANY_BROADCASTERS?e===ui.JOIN||e===ui.REJOIN?(this.initError=E,this.close(),E.throw()):E.throw():"failed"===_.action?E.throw():"quit"===_.action?(this.initError=E,this.close(),E.throw()):(p===di.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=u.message.option,t.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",k.MULTI_IP)):this.reconnect(_.action,k.SERVER_ERROR),e===ui.JOIN||e===ui.REJOIN?null:await this.request(e,i)))}waitMessage(e,t){return new Promise((i=>{const n=s=>{(!t||t(s))&&(this.off(e,n),i(s))};this.on(e,n)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void t.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(pi.WRTC_STATS,i)}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=f("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==hi.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),f("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}async sendExtensionMessage(e,t,i){return await this._external_signal.send(e,t,i)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Promise(((t,i)=>{this.once(li.WS_CONNECTED,(()=>t(this.joinResponse))),this.once(li.WS_CLOSED,(()=>i(this.initError||new h(l.WS_ABORT)))),this.connectionState=hi.CONNECTING,this.websocket.init(e).catch(i)}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||L.LEAVE,this.connectionState=hi.CLOSED,t.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===L.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new wn("gateway-".concat(this.clientId),this.spec.retryConfig,!0,f("JOIN_GATEWAY_USE_DUAL_DOMAIN"),f("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents()),this.p2pToken=M(6,""),this._external_signal.clear(),this._external_signal=new Hn(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(li.ABORT_P2P_EXECUTION);const e=await O(this,li.REQUEST_JOIN_INFO),t=await this.request(ui.JOIN,e);if(!t)return this.emit(li.REPORT_JOIN_GATEWAY,l.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(li.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=hi.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleDataStream(e){try{const t=G(e.payload),i=(new TextDecoder).decode(t),n=JSON.parse(i);"total"in n&&"id"in n||Object.values(dn).includes(n._type)?(n._uid=e.uid,this._external_signal.onMessage(n)):this.emit(_i.ON_DATA_STREAM,e)}catch(t){this.emit(_i.ON_DATA_STREAM,e)}}handleNotification(e){t.debug("[".concat(this.clientId,"] receive notification: "),e);const i=mn(e.code);if("success"!==i.action){if("failed"!==i.action)return"quit"===i.action?("ERR_REPEAT_JOIN_CHANNEL"===i.desc&&this.close(L.UID_BANNED),void this.close()):void this.reconnect(i.action,k.SERVER_ERROR);t.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=f("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(t.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>f("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",k.TIMEOUT):this.request(ui.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-i;this.rttRolling.add(e),f("REPORT_STATS")&&this.send(ui.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleWebsocketEvents(){this.websocket.on(mi.RECONNECT_WAITTING_FINISH,(e=>{this.emit(li.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(mi.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(li.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(mi.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(mi.CLOSED,(()=>{this.connectionState=hi.CLOSED})),this.websocket.on(mi.FAILED,(()=>{this._disconnectedReason=L.NETWORK_ERROR,this.connectionState=hi.CLOSED})),this.websocket.on(mi.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===hi.CONNECTED?this.connectionState=hi.RECONNECTING:this.connectionState=hi.CONNECTING})),this.websocket.on(mi.WILL_RECONNECT,((e,i,n)=>{"retry"!==e?(t.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(li.NEED_RENEW_SESSION)):t.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),n(e)})),this.websocket.on(mi.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.join().catch((e=>{if(this.emit(li.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof h&&e.code===l.UNEXPECTED_RESPONSE&&e.data.code===di.ERR_NO_AUTHORIZED)return t.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",k.SERVER_ERROR);t.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",k.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(mi.REQUEST_NEW_URLS,((e,t)=>{O(this,li.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(mi.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(_i.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}const qn=new Map;class Yn extends C{get state(){return this._state}set state(e){if(e===this._state)return;const t=this._state;this._state=e,"DISCONNECTED"===e&&this._disconnectedReason?this.emit(Ui.CONNECTION_STATE_CHANGE,e,t,this._disconnectedReason):this.emit(Ui.CONNECTION_STATE_CHANGE,e,t)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){t.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,t){super(),this.store=void 0,this.joinInfo=void 0,this.key=void 0,this.ntpOffset=0,this.signal=void 0,this.role=void 0,this.inChannelInfo={joinAt:null,duration:0},this.spec=void 0,this._state="DISCONNECTED",this._statsCollector=void 0,this._disconnectedReason=void 0,this.isSignalRecover=!1,this.hasChangeBGPAddress=!1,this.trafficStatsInterval=void 0,this.networkQualityInterval=void 0,this._joinGatewayStartTime=0,this._signalTimeout=!1,this._clientRoleOptions=void 0,this._isProactiveJoin=!1,this.store=e,this.spec=t,this.signal=this.store.useP2P?new Kn(Zt(Zt({},t),{},{retryConfig:t.websocketRetryConfig}),e):this.store.useDataChannel?new Wn(Zt(Zt({},t),{},{retryConfig:t.websocketRetryConfig}),e):new Nn(Zt(Zt({},t),{},{retryConfig:t.websocketRetryConfig}),e),this._statsCollector=t.statsCollector,this.role=t.role||"audience",this._clientRoleOptions=t.clientRoleOptions,this.handleSignalEvents()}async join(e,n,s){if(this.signal instanceof Wn){let i=!1;"disabled"!==e.cloudProxyServer?(t.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(e.cloudProxyServer,")")),i=!0):"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length>255||"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length<22?(t.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),i=!0):e.apResponse.addresses.some((e=>e.fingerprint))||f("FINGERPRINT")||(t.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),i=!0),i&&this.resetSignal()}this.store.joinGatewayStart(),"disabled"!==e.cloudProxyServer&&(this.hasChangeBGPAddress=!0);const o=Date.now();let a=qn.get(e.cname);if(a||(a=new Map,qn.set(e.cname,a)),this._isProactiveJoin=!0,a.has(e.uid)){const t=new Si(l.UID_CONFLICT);throw i.joinGateway(e.sid,{lts:o,succ:!1,ec:t.message,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!e.proxyServer,signalChannel:this.signal instanceof Wn?"1":"0"}),this._isProactiveJoin=!1,t}a.set(e.uid,!0),this.joinInfo=e,this.key=n;let r=0;this.joinGatewayStartTime=o;const c=e.proxyServer;try{let i;if(t.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof Wn?"datachannel":"websocket"," join uid ").concat(r)),this.signal instanceof Wn)i=await this.signal.init(e.apResponse.addresses,s);else{const t=e.gatewayAddrs.map((t=>{let{address:i}=t;const[n,s]=i.split(":"),o={host:n,port:s};return e.proxyServer&&(o.proxy=e.proxyServer),o}));i=await this.signal.init(t,s)}r=i.uid,t.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof Wn?"datachannel":"websocket"," join uid ").concat(r," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(n){if(n&&n.code===l.INIT_WEBSOCKET_TIMEOUT)throw t.warning("[".concat(this.store.clientId,"] User join failed"),n.toString()),n;if(n&&n.code===l.INIT_DATACHANNEL_TIMEOUT)throw t.warning("[".concat(this.store.clientId,"] User join datachannel failed"),n.toString()),this.resetSignal(),n;throw t.error("[".concat(this.store.clientId,"] User join failed"),n.toString()),i.joinGateway(e.sid,{lts:o,succ:!1,ec:n.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!c,signalChannel:this.signal instanceof Wn?"1":"0"}),this._isProactiveJoin=!1,a.delete(e.uid),this.signal.close(),n}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),t.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval((()=>{this.updateTrafficStats().catch((e=>{t.warning("[".concat(this.store.clientId,"] get traffic stats error"),e.toString())}))}),3e3),this.networkQualityInterval=window.setInterval((()=>{navigator&&void 0!==navigator.onLine&&!navigator.onLine?this.emit(Ui.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(Ui.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):"CONNECTED"===this.state&&this._statsCollector.trafficStats?this.emit(Ui.NETWORK_QUALITY,{uplinkNetworkQuality:kn(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:kn(this._statsCollector.trafficStats.B_dnq)}):this.emit(Ui.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})}),2e3),this.store.joinGatewayEnd(),r}async leave(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1?arguments[1]:void 0;if("DISCONNECTED"!==this.state){i!==L.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==hi.CONNECTED||await j(this.signal.request(ui.LEAVE,void 0,!0),3e3)}catch(e){t.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),e)}this.signal.close(i),i!==L.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Si(l.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const s={state:"offer",p2p_id:this.store.p2pId,ortc:i,mode:this.spec.mode,extend:f("PUB_EXTEND"),twcc:!!f("PUBLISH_TWCC"),rtx:!!f("USE_PUB_RTX")};try{return(await this.signal.request(ui.PUBLISH,s,!0))._message}catch(s){if(n&&s.data&&s.data.code===di.ERR_PUBLISH_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),s.toString()),await this.tryUnpubBeforeRepub(e,i),this.publish(e,i,!1);throw s}}async publishDataChannel(e,i,n){var s;if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Si(l.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const o={stream_id:i.streamId,ordered:i.ordered?1:0,max_retrans_times:null!==(s=i.maxRetransmits)&&void 0!==s?s:10,channel_id:i.channelId,metadata:i.metadata};try{await this.signal.request(ui.PUBLISH_DATASTREAM,o,!0)}catch(s){if(n&&s.data&&s.data.code===di.ERR_PUBLISH_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),s.toString()),await this.tryUnpubDataChannelBeforeRepub(e,i),this.publishDataChannel(e,i,!1);throw s}}async unpublish(e,i){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Si(l.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(ui.UNPUBLISH,{stream_id:i,ortc:e},!0)}catch(e){t.warning("[".concat(this.store.clientId,"] unpublish warning: "),e)}}async unpublishDataChannel(e){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Si(l.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Promise.all(e.map((e=>this.signal.request(ui.UNPUBLISH_DATASTREAM,{channel_id:e},!0))))}catch(e){t.warning("unpublish datachannels warning: ",e)}}async presubscribe(e,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Si(l.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const s={stream_id:e,stream_type:i,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!f("SUBSCRIBE_TWCC"),rtx:!!f("USE_SUB_RTX")||void 0,extend:f("SUB_EXTEND"),svc:Array.isArray(f("SVC"))&&0!==f("SVC").length?f("SVC"):void 0};try{return await this.signal.request(ui.PRE_SUBSCRIBE,s,!0)}catch(s){if(n&&s.data&&s.data.code===di.ERR_SUBSCRIBE_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),s.toString()),this.presubscribe(e,i,!1);throw s}}async subscribe(e,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Si(l.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const s={stream_id:e,stream_type:i.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!f("SUBSCRIBE_TWCC"),rtx:!!f("USE_SUB_RTX"),extend:f("SUB_EXTEND"),ssrcId:i.ssrcId,svc:Array.isArray(f("SVC"))&&0!==f("SVC").length?f("SVC"):void 0};try{return(await this.signal.request(ui.SUBSCRIBE,s,!0))._message}catch(s){if(n&&s.data&&s.data.code===di.ERR_SUBSCRIBE_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),s.toString()),await this.tryUnsubBeforeResub(e,i),await this.subscribe(e,i,!1);throw s}}async subscribeDataChannel(e,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Si(l.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const s={uid:e,stream_id:i.id,channel_id:i.datachannelId};try{return void await this.signal.request(ui.SUBSCRIBE_DATASTREAM,s,!0)}catch(s){if(n&&s.data&&s.data.code===di.ERR_SUBSCRIBE_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),s.toString()),await this.tryUnsubDataChannelBeforeResub(e,i),await this.subscribeDataChannel(e,i,!1);throw s}}async subscribeAll(e,i){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Si(l.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const n={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!f("USE_SUB_RTX"),twcc:!!f("SUBSCRIBE_TWCC"),svc:Array.isArray(f("SVC"))&&0!==f("SVC").length?f("SVC"):void 0};try{return await this.signal.request(ui.SUBSCRIBE_STREAMS,n,!0)}catch(n){if(i&&n.data&&n.data.code===di.ERR_SUBSCRIBE_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),n.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw n}}async setVideoProfile(e){const i=function(e){if(!(e.bitrateMax&&e.bitrateMin&&e.frameRate&&e.height&&e.width))return;let t=e.frameRate,i=e.width,n=e.height,s=!0;return"number"!=typeof t&&(t=t.exact||t.ideal||t.max||t.min||0,t||(s=!1)),"number"!=typeof i&&(i=i.exact||i.ideal||i.max||i.min||0,i||(s=!1)),"number"!=typeof n&&(n=n.exact||n.ideal||n.max||n.min||0,t||(s=!1)),s?{stream_type:0,width:i,height:n,fps:t,start_bps:1e3*e.bitrateMax,min_bps:1e3*e.bitrateMin,target_bps:1e3*e.bitrateMax}:void 0}(e);if(i)return this.signal.request(ui.SET_VIDEO_PROFILE,i);t.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,i){try{await this.signal.request(ui.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:i},!0)}catch(e){t.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),e)}}async unsubscribeDataChannel(e,i){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new Si(l.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Promise.all(e.map((e=>this.signal.request(ui.UNSUBSCRIBE_DATASTREAM,{stream_id:e,uid:i},!0))))}catch(e){t.warning("unsubscribeDataChannel warning: ",e)}}async massUnsubscribe(e){try{await this.signal.request(ui.UNSUBSCRIBE_STREAMS,e,!0)}catch(e){t.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),e)}}async reconnectPC(e){const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=e;return{gatewayEstablishParams:await this.signal.request(ui.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(ui.GATEWAY_INFO)}async renewToken(e){await this.signal.request(ui.RENEW_TOKEN,e),this.key=e.token}async setClientRole(e,t){if(t&&(this._clientRoleOptions=Object.assign({},t)),"CONNECTED"!==this.state)return void(this.role=e);let i,n=0;"audience"===e?this._clientRoleOptions&&this._clientRoleOptions.delay?(i=this._clientRoleOptions.delay,n=1):n=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:n=0,await this.signal.request(ui.SET_CLIENT_ROLE,{role:e,level:n,delay:i,client_ts:Date.now()}),this.role=e}async setRemoteVideoStreamType(e,t){await this.signal.request(ui.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:t})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(ui.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,t){await this.signal.request(ui.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:t})}async pickSVCLayer(e,t){await this.signal.request(ui.PICK_SVC_LAYER,{stream_id:e,spatial_layer:t.spatialLayer,temporal_layer:t.temporalLayer})}async setRTM2Flag(e){await this.signal.request(ui.SET_RTM2_FLAG,{rtm2_flag:e})}async sendExtensionMessage(e,t,i){if(this.signal instanceof Kn)return this.signal.sendExtensionMessage(e,t,i)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),Zt({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(ui.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const e=qn.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const e=function(e){let t;return t=e.startsWith("dc")?e.match(/(dc\:\/\/)?([^:]+):(\d+)/):e.match(/(wss\:\/\/)?([^:]+):(\d+)/),t?{username:Gt.username,password:Gt.password,turnServerURL:t[2],tcpport:parseInt(t[3])+30,udpport:parseInt(t[3])+30,forceturn:!1}:null}(("disabled"===this.joinInfo.cloudProxyServer?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&"off"!==this.joinInfo.turnServer.mode&&"disabled"===this.joinInfo.cloudProxyServer&&this.joinInfo.turnServer.serversFromGateway.push(Zt(Zt({},Gt),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if("CONNECTED"!==this.state)return;const e=await this.signal.request(ui.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),null!=e.ntp_offset&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach((e=>{const t=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find((t=>t.peer_uid===e.peer_uid));t&&t.B_st!==e.B_st&&W((()=>{this.emit(Ui.STREAM_TYPE_CHANGE,e.peer_uid,e.B_st)}))})),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new Si(l.UNEXPECTED_ERROR,"can not generate join message, no join info");const t=Object.assign({},this.joinInfo.apResponse);let i=f("REPORT_APP_SCENARIO");if("string"!=typeof i)try{i=JSON.stringify(i)}catch(e){i=void 0}i&&i.length>128&&(i=void 0);const n=Zt({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:H,browser:navigator.userAgent,process_id:f("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:t,extend:f("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:"proxy3"===this.joinInfo.cloudProxyServer?"1":"proxy5"===this.joinInfo.cloudProxyServer?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:i,attributes:{userAttributes:{enablePublishedUserList:f("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:f("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:"number"==typeof f("SUBSCRIBE_AUDIO_FILTER_TOPN")?f("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:"boolean"==typeof f("ENABLE_PUBLISH_AUDIO_FILTER")?f("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:"boolean"==typeof f("ENABLE_USER_LICENSE_CHECK")?f("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:!0===f("USE_PUB_RTX")||!0===f("USE_SUB_RTX")||void 0,disableFEC:f("DISABLE_FEC"),enableNTPReport:!!f("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!f("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:"boolean"==typeof f("ENABLE_DATASTREAM_2")?f("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:"number"==typeof this.joinInfo.rtmFlag?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!f("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:"boolean"==typeof f("USE_XR")?f("USE_XR"):void 0,enableLossbasedBwe:"boolean"==typeof f("ENABLE_LOSSBASED_BWE")?f("ENABLE_LOSSBASED_BWE"):void 0,enableAutCC:"boolean"==typeof f("ENABLE_AUT_CC")?f("ENABLE_AUT_CC"):void 0,enableCCFallback:"boolean"==typeof f("ENABLE_CC_FALLBACK")?f("ENABLE_CC_FALLBACK"):void 0}},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(n.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(n.aes_mode=this.joinInfo.aesmode,f("ENCRYPT_AES")?(n.aes_secret=this.joinInfo.aespassword,n.aes_encrypt=!0):n.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(n.aes_salt=this.joinInfo.aessalt)),t.addresses[this.signal.websocket.currentURLIndex]&&(n.ap_response.ticket=t.addresses[this.signal.websocket.currentURLIndex].ticket,delete t.addresses),void 0!==this.joinInfo.defaultVideoStream&&(n.default_video_stream=this.joinInfo.defaultVideoStream),n}getRejoinMessage(){if(!this.joinInfo)throw new Si(l.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(li.WS_RECONNECT_WAITTING_FINISH,(e=>{["tryNext","recover"].includes(e)&&this.joinInfo&&i.adjustSessionStartTime(this.joinInfo.sid)})),this.signal.on(li.WS_RECONNECT_CREATE_CONNECTION,(e=>{this.joinGatewayStartTime=Date.now()})),this.signal.on(li.WS_RECONNECTING,(e=>{this.joinInfo&&i.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||k.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",i.sessionInit(this.joinInfo.sid,{lts:(new Date).getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:"live"===this.spec.mode?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:"audience"===this.role?2:1,buildFormat:3}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())})),this.signal.on(li.WS_CLOSED,(e=>{let n;switch(e){case L.LEAVE:n=k.LEAVE;break;case L.UID_BANNED:case L.IP_BANNED:case L.CHANNEL_BANNED:case L.SERVER_ERROR:n=k.SERVER_ERROR;break;case L.FALLBACK:n=k.FALLBACK;break;case L.LICENSE_MISSING:case L.LICENSE_EXPIRED:case L.LICENSE_MINUTES_EXCEEDED:case L.LICENSE_PERIOD_INVALID:case L.LICENSE_MULTIPLE_SDK_SERVICE:case L.LICENSE_ILLEGAL:case L.TOKEN_EXPIRE:n=e;break;default:n=k.NETWORK_ERROR}t.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(n||"undefined -> "+k.NETWORK_ERROR)),this.joinInfo&&i.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===L.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:n}),this._disconnectedReason=e,e!==L.FALLBACK&&(this.state="DISCONNECTED"),this.reset()})),this.signal.on(li.WS_CONNECTED,(()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&("audience"===this.role&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(t.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),i.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Wn?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&1===this.joinInfo.setLocalAPVersion)){const e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void t.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));K("EVENT_REPORT_DOMAIN",e[1]),K("EVENT_REPORT_BACKUP_DOMAIN",e[1]),K("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}})),this.signal.on(_i.ON_UPLINK_STATS,(e=>{this._statsCollector.updateUplinkStats(e)})),this.signal.on(li.REQUEST_RECOVER,((e,t,i)=>{if(!this.joinInfo)return i(new Si(l.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,O(this,Ui.REQUEST_NEW_GATEWAY_LIST).then(t).catch(i)})),this.signal.on(li.REQUEST_JOIN_INFO,(async e=>{var t;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));const{iceParameters:i,dtlsParameters:n,rtpCapabilities:s}=await O(this,Ui.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:null===(t=this.joinInfo)||void 0===t?void 0:t.turnServer});e(this.getJoinMessage({ortc:{iceParameters:i,dtlsParameters:n,rtpCapabilities:s,version:"2"}}))})),this.signal.on(li.REQUEST_REJOIN_INFO,(e=>{e(this.getRejoinMessage())})),this.signal.on(li.REPORT_JOIN_GATEWAY,((e,t)=>{this.joinInfo&&(i.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:e,addr:t,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Wn?"1":"0"}),this._isProactiveJoin=!1)})),this.signal.on(li.IS_P2P_DISCONNECTED,(e=>{e(U(this,Ui.IS_P2P_DISCONNECTED))})),this.signal.on(li.DISCONNECT_P2P,(()=>{this.emit(Ui.DISCONNECT_P2P)})),this.signal.on(li.NEED_RENEW_SESSION,(e=>{this.emit(Ui.NEED_RENEW_SESSION,e)})),this.signal.on(li.REQUEST_SUCCESS,(()=>{this._signalTimeout=!1})),this.signal.on(li.REQUEST_TIMEOUT,(()=>{this._signalTimeout=!0})),this.signal.on(li.JOIN_RESPONSE,(e=>{const t=this.getCurrentGatewayAddress();this.emit(Ui.JOIN_RESPONSE,e,t)})),this.signal.on(li.DATACHANNEL_PRECONNECT,(async(e,t,i)=>{this.updateTurnConfigFromSignal();const n=this.getCurrentGatewayAddress();return O(this,Ui.DATACHANNEL_PRECONNECT,e,n).then(t).catch(i)})),this.signal.on(li.DATACHANNEL_CONNECTING,(async e=>{const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=await O(this,Ui.REQUEST_DC_CONNECTION_PARAMS);e(this.getJoinMessage({ortc:{iceParameters:t,dtlsParameters:i,rtpCapabilities:n,version:"2"}}))})),this.signal.on(li.DATACHANNEL_FAILBACK,(()=>{t.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(Ui.DATACHANNEL_FAILBACK)}))}async tryUnsubBeforeResub(e,i){try{await this.signal.request(ui.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[i]},!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),e),e}}async tryUnsubDataChannelBeforeResub(e,i){try{await this.signal.request(ui.UNSUBSCRIBE,{stream_id:i.id},!0)}catch(e){throw t.warning("unsubscribe datachannel warning",e),e}}async tryUnpubBeforeRepub(e,i){try{await this.signal.request(ui.UNPUBLISH,{stream_id:e,ortc:i},!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),e),e}}async tryUnpubDataChannelBeforeRepub(e,i){try{await this.signal.request(ui.UNPUBLISH_DATASTREAM,{channnel_id:i.channelId},!0)}catch(e){throw t.warning("unpublish datastream warning: ",e),e}}async tryMassUnsubBeforeResub(e){const i={users:e.map((e=>({stream_id:e.stream_id,stream_type:e.stream_type})))};try{await this.signal.request(ui.UNSUBSCRIBE_STREAMS,i,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),e),e}}async muteLocal(e,i){const n={action:e.find((e=>e.stream_type===Mi.Audio))?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:i};try{await this.signal.request(ui.CONTROL,n,!0,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),e),e}}async unmuteLocal(e,i){const n={action:e.find((e=>e.stream_type===Mi.Audio))?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:i};try{await this.signal.request(ui.CONTROL,n,!0,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),e),e}}async muteRemote(e,i){const n={action:e===Yi.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(ui.CONTROL,n,!0,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),e),e}}async unmuteRemote(e,i){const n={action:e===Yi.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(ui.CONTROL,n,!0,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),e),e}}uploadWRTCStats(e){this.signal.uploadWRTCStats(e)}upload(e,t){this.signal.upload(e,t)}getSignalRTT(){return this.signal.rtt}async restartICE(e){const i={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(ui.RESTART_ICE,i,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),e),e}}reconnect(){"CONNECTED"===this.state&&this.signal.reconnect(void 0,k.P2P_FAILED)}getCurrentGatewayAddress(){var e;if(!f("GATEWAY_WSS_ADDRESS"))return null!==(e=this.joinInfo)&&void 0!==e&&e.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(ui.SET_PARAMETER,{enablePublishAudioFilter:e})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(L.FALLBACK)),this.store.useDataChannel=!1,this.signal=new Nn(Zt(Zt({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(Ui.RESET_SIGNAL,Fi.websocket)}}let Jn=0,Xn=0;function zn(e,t,i,n){return new Promise(((s,o)=>{t.timeout=t.timeout||f("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!i?(t.data=JSON.stringify(t.data),Jn+=q(t.data)):i&&(t.data.size?Jn+=t.data.size:t.data instanceof FormData?Jn+=Y(t.data):Jn+=q(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,ze.request(t).then((e=>{"string"==typeof e.data?Xn+=q(e.data):e.data instanceof ArrayBuffer||e.data instanceof Uint8Array?Xn+=e.data.byteLength:Xn+=q(JSON.stringify(e.data)),n&&s({data:e.data,headers:e.headers}),s(e.data)})).catch((e=>{ze.isCancel(e)?o(new Si(l.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===e.code?o(new Si(l.NETWORK_TIMEOUT,e.message)):e.response?o(new Si(l.NETWORK_RESPONSE_ERROR,e.response.status)):o(new Si(l.NETWORK_ERROR,e.message))}))}))}const Qn=()=>{const e=f("AREAS");0===e.length&&e.push(Bi.GLOBAL);return e.reduce(((e,t,i)=>{const n=Zn(t);return n?0===i?n:"".concat(e,",").concat(n):e}),"")},Zn=e=>e===Bi.OVERSEA?"".concat(ji.ASIA,",").concat(ji.EUROPE,",").concat(ji.AFRICA,",").concat(ji.NORTH_AMERICA,",").concat(ji.SOUTH_AMERICA,",").concat(ji.OCEANIA):ji[e],$n=e=>{const t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return e.map((e=>{const i=Wi[e],n=Object.keys(i);n&&n.map((e=>{"CODE"!==e&&(t[e]=t[e].concat(i[e]))}))})),t},es={GLOBAL:{ASIA:[Bi.CHINA,Bi.JAPAN,Bi.INDIA,Bi.KOREA,Bi.HKMC],EUROPE:[],NORTH_AMERICA:[Bi.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},ts=Object.keys(es[Bi.GLOBAL]),is=[Bi.CHINA,Bi.NORTH_AMERICA,Bi.EUROPE,Bi.ASIA,Bi.JAPAN,Bi.INDIA,Bi.OCEANIA,Bi.SOUTH_AMERICA,Bi.AFRICA,Bi.KOREA,Bi.HKMC,Bi.US],ns=function(e,t){let i=[];if(e.includes(Bi.GLOBAL)){const o=[Bi.GLOBAL,Bi.OVERSEA],a=Object.keys(Wi);if(t===Bi.GLOBAL)throw new Si(l.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===Bi.CHINA)i=[Bi.OVERSEA];else if(s=t,ts.includes(s)){const e=(n=t,es[Bi.GLOBAL][n]||[]),s=[...o,t,...e];i=a.filter((e=>!s.includes(e)))}else if(function(e){let t=!1;return ts.forEach((i=>{es[Bi.GLOBAL][i].includes(e)&&(t=!0)})),t}(t)){const e=function(e){let t;return ts.forEach((i=>{es[Bi.GLOBAL][i].includes(e)&&(t=i)})),t}(t),n=[...o,e,t];i=a.filter((e=>!n.includes(e)))}else i=e;i=function(e){const t=[];return is.forEach((i=>{e.includes(i)&&t.push(i)})),t.concat(e.filter((e=>!is.includes(e))))}(i)}else i=e;var n,s;return i};function ss(e){if(!e&&f("AREAS").includes(Bi.EXTENSIONS))return t.debug("update area from ap : reset"),void os(Bt,!0);if(!f("AREAS").includes(Bi.GLOBAL)||!e)return;let i=Wi.EXTENSIONS;i&&(i={CODE:Zn(Bi.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(e,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(e,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(e,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(e,".agora.io"),"cds-ap-web-2-".concat(e,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(e,".agora.io"),"sua-ap-web-2-".concat(e,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(e,".agora.io"),"uap-ap-web-2-".concat(e,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(e,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(e,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(e,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(e,".agora.io")]},t.debug("update area from ap success: ".concat(e,",config is "),i),K("AREAS",[Bi.EXTENSIONS],!0),Object.keys(i).map((e=>{if("LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e){const t=i[e];K(e,t[0])}else K(e,i[e])})))}function os(e){let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const s=i.reportApiInvoke(null,{name:J.SET_AREA,options:e,tag:X.TRACER});try{let i=[];if("string"==typeof e&&(i=[e]),Array.isArray(e)&&(e.forEach((e=>{if(!Gi.includes(e))throw new Si(l.INVALID_PARAMS,"invalid area code")})),i=e),"[object Object]"===Object.prototype.toString.call(e)){const{areaCode:t,excludedArea:n}=e;if(!t)throw new Si(l.INVALID_PARAMS,"area code is needed");let s=t;"string"==typeof t&&(s=[t]),i=n?ns(s,n):s}if(!n){if(d.AREAS){const e=new Si(l.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return s.onError(e),void t.warning("setArea is prohibited because of config-distribute")}if(i.includes(Bi.GLOBAL)&&f("AREAS")===Bi.EXTENSIONS){const e=new Si(l.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return s.onError(e),void t.warning("setArea is prohibited because of ap extensions")}}K("AREAS",i,n);const o=$n(i);Object.keys(o).map((e=>{if("LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e){const t=o[e];K(e,t[0])}else K(e,o[e])})),t.debug("set area success:",i.join(","))}catch(e){throw s.onError(e),e}s.onSuccess()}let as=1;function rs(e,n,s,o,a){as+=1;const r={sid:s.sid,command:"convergeAllocateEdge",uid:"666",appId:s.appId,ts:Math.floor(Date.now()/1e3),seq:as,requestId:as,version:H,cname:s.cname},c={service_name:n,json_body:JSON.stringify(r)};let d,h,u=e[0];return z((async()=>{d=Date.now();const e=await zn(u,{data:c,cancelToken:o,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(h=Date.now()-d,0!==e.code){const i=new Si(l.UNEXPECTED_RESPONSE,"live streaming ap error, code"+e.code,{retry:!0,responseTime:h});throw t.error(i.toString()),i}const i=JSON.parse(e.json_body);if(200!==i.code){const e=new Si(l.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(i.code,", reason: ").concat(i.reason),{code:i.code,responseTime:h});throw t.error(e.toString()),e}if(!i.servers||0===i.servers.length){const e=new Si(l.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:i.code,responseTime:h});throw t.error(e.toString()),e}const s=function(e,t){return{addressList:e.servers.map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(f("WORKER_DOMAIN"),":").concat(e.wss,"?serviceName=").concat(encodeURIComponent(t)))),workerToken:e.workerToken,vid:e.vid}}(i,n);return f("LIVE_STREAMING_ADDRESS")&&(s.addressList=f("LIVE_STREAMING_ADDRESS")instanceof Array?f("LIVE_STREAMING_ADDRESS"):[f("LIVE_STREAMING_ADDRESS")]),Zt(Zt({},s),{},{responseTime:h})}),((t,o)=>(i.apworkerEvent(s.sid,{success:!0,sc:200,serviceName:n,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===o,responseTime:h,serverIp:e[o%e.length]}),!1)),((t,o)=>(i.apworkerEvent(s.sid,{success:!1,sc:t.data&&t.data.code||200,serviceName:n,responseTime:h,serverIp:e[o%e.length]}),!!(t.code!==l.OPERATION_ABORTED&&t.code!==l.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(u=e[(o+1)%e.length],!0))),a)}let cs=1;function ds(e,n,s,o){let{url:a,areaCode:r}=e;const{clientId:c,sid:d}=n,h=Date.now();let u;const[p,_]=_s(n,r,[bn.CHOOSE_SERVER]);let E=w.networkState;return z((async()=>{E&&w.networkState===A.OFFLINE&&w.onlineWaiter&&await Promise.race([w.onlineWaiter,b(o&&o.maxRetryTimeout||Q.maxRetryTimeout)]),E=w.networkState;const{data:e,headers:t}=await zn(a,{data:p,cancelToken:s,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);u="1"===t.http3?1:-1,i.reportResourceTiming(a,d),ls(e,a,n,h,[bn.CHOOSE_SERVER],u);const r=Mn(e,bn.CHOOSE_SERVER);return us(r),Dn(r,a)}),(e=>(e&&i.joinChooseServer(d,{lts:h,succ:!0,csAddr:a,opid:_,serverList:e.gatewayAddrs.map((e=>e.address)),ec:null,cid:e.cid.toString(),uid:e.uid.toString(),csIp:e.csIp,unilbsServerIds:[bn.CHOOSE_SERVER].toString(),isHttp3:u}),!1)),(e=>e.code!==l.OPERATION_ABORTED&&(e.code===l.CAN_NOT_GET_GATEWAY_SERVER?e.data.retry:(i.joinChooseServer(d,{lts:h,succ:!1,csAddr:a,serverList:null,opid:_,ec:e.code,csIp:e.data&&e.data.csIp,unilbsServerIds:[bn.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:E}),isHttp3:u}),t.warning("[".concat(c||"sid-".concat(d.slice(0,6)),"] Choose server network error, retry"),e),!0))),o)}function hs(e,n,s,o){let a,{url:r,areaCode:c,serviceIds:d}=e;const h=Date.now(),[u,p]=_s(n,c,d);let _;return z((async()=>{_&&w.networkState===A.OFFLINE&&w.onlineWaiter&&await Promise.race([w.onlineWaiter,b(o&&o.maxRetryTimeout||Q.maxRetryTimeout)]),_=w.networkState;const{data:e,headers:t}=await zn(r,{data:u,cancelToken:s,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);a="1"===t.http3?1:-1,i.reportResourceTiming(r,n.sid),ls(e,r,n,h,d,a);const c=Mn(e,bn.CHOOSE_SERVER),l=Mn(e,"proxy5"===n.cloudProxyServer?bn.CLOUD_PROXY_5:"proxy3"===n.cloudProxyServer||"proxy4"===n.cloudProxyServer?bn.CLOUD_PROXY:bn.CLOUD_PROXY_FALLBACK);return us(c),{gatewayInfo:Dn(c,r),proxyInfo:l,url:r}}),(e=>(e.gatewayInfo&&i.joinChooseServer(n.sid,{lts:h,succ:!0,csAddr:r,serverList:e.gatewayInfo.gatewayAddrs.map((e=>e.address)),ec:null,opid:p,cid:e.gatewayInfo.cid.toString(),uid:e.gatewayInfo.uid.toString(),csIp:e.gatewayInfo.csIp,unilbsServerIds:d.toString(),isHttp3:a}),e.proxyInfo&&i.joinWebProxyAP(n.sid,{lts:h,sucess:1,apServerAddr:r,turnServerAddrList:e.proxyInfo.addresses.map((e=>e.ip)).join(","),errorCode:null,eventType:n.cloudProxyServer,unilbsServerIds:d.toString()}),!1)),(e=>e.code!==l.OPERATION_ABORTED&&(e.code===l.CAN_NOT_GET_GATEWAY_SERVER?e.data.retry:(i.joinWebProxyAP(n.sid,{lts:h,sucess:0,apServerAddr:r,turnServerAddrList:null,errorCode:e.code,eventType:n.cloudProxyServer,unilbsServerIds:d.toString(),extend:JSON.stringify({networkState:_})}),t.warning("[".concat(n.clientId,"] multi unilbs network error, retry"),e),!0))),o)}const ls=(e,n,s,o,a,r)=>{const{sid:c,clientId:d,cloudProxyServer:h}=s,u=[],p=t=>{4096===t.flag?i.joinChooseServer(c,{lts:o,succ:!1,csAddr:n,opid:e.opid,serverList:null,ec:t.error.message,csIp:t.error.data&&t.error.data.csIp,unilbsServerIds:a.toString(),isHttp3:r}):1048576!==t.flag&&4194304!==t.flag&&4194310!==t.flag||i.joinWebProxyAP(c,{lts:o,sucess:0,apServerAddr:n,turnServerAddrList:null,errorCode:t.error.code,eventType:h,unilbsServerIds:a.toString()})};if(e.response_body.forEach((i=>{const n=i.buffer.code;if(23===i.uri&&0===n&&!i.buffer.edges_services)if(4194310===i.buffer.flag)t.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),i.buffer.edges_services=[];else{const t={error:new Si(l.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:e.detail[502]}),flag:i.buffer.flag};u.push(t),p(t)}if(0!==n){const s=_n(n),o={error:new Si(l.CAN_NOT_GET_GATEWAY_SERVER,s.desc,{desc:s.desc,retry:s.retry,csIp:e.detail[502]}),flag:i.buffer.flag};4194310===i.buffer.flag?t.warning(o.error.toString()):u.push(o),p(o)}})),u.length)throw t.warning("[".concat(d||"sid-".concat(c.slice(0,6)),"] multi unilbs ").concat(n," failed, ").concat(u.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message,", retry: ").concat(e.error.data.retry))).join(" | "))),new Si(l.CAN_NOT_GET_GATEWAY_SERVER,u.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message))).join(" | "),{retry:!!u.find((e=>e.error.data.retry)),csIp:e.detail[502],desc:[...new Set(u.map((e=>{var t;return null==e||null===(t=e.error)||void 0===t||null===(t=t.data)||void 0===t?void 0:t.desc})).filter((e=>!!e)))]})},us=e=>{var i,n,s,o;if(e.addresses&&0===e.addresses.length&&0===e.code)throw new Si(l.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:e.detail&&e.detail[502]});f("AP_AREA")&&(null!==(s=e.detail)&&void 0!==s&&s[23]&&"string"==typeof(null===(o=e.detail)||void 0===o?void 0:o[23])?ss(e.detail[23].toLowerCase()):ss());if(null!==(i=e.detail)&&void 0!==i&&i[19]&&"string"==typeof(null===(n=e.detail)||void 0===n?void 0:n[19])){const t=e.detail[19],i=null==t?void 0:t.split(";");for(let t=0;t<i.length;t++){const n=i[t].trim();e.addresses[t]&&i&&(e.addresses[t].fingerprint=n)}}if(f("GATEWAY_ADDRESS")&&f("GATEWAY_ADDRESS").length>0){t.debug("assign gateway address to",f("GATEWAY_ADDRESS"));const i=f("GATEWAY_ADDRESS").map((t=>{var i,n;const s=null!==(i=null===(n=e.addresses.find((e=>e.ip===t.ip&&e.port===t.port)))||void 0===n?void 0:n.fingerprint)&&void 0!==i?i:"";return{ip:t.ip,port:t.port,ticket:e.addresses[0]&&e.addresses[0].ticket,fingerprint:s}}));e.addresses=i}},ps=(e,i)=>{if(e.response_body&&e.response_body.length){const t=e.response_body[0];if(0!==t.buffer.code){const e=_n(t.buffer.code);throw new Si(l.UPDATE_TICKET_FAILED,"[".concat(t.buffer.code,"]: ").concat(e.desc),{retry:e.retry})}return t.buffer.ticket}throw t.debug("update ticket request received ap response without response body:",i),new Si(l.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},_s=(e,t,i)=>{const n=Math.floor(Math.random()*10**12),s={appid:e.appId,client_ts:Date.now(),opid:n,sid:e.sid,request_bodies:[{uri:22,buffer:{cname:e.cname,detail:Zt({6:e.stringUid,11:t,12:f("USE_NEW_TOKEN")?"1":void 0,22:t},e.apRTM?{26:"RTM2"}:{}),key:e.token,service_ids:i,uid:e.uid||0}}]};s.request_bodies.forEach((t=>{e.multiIP&&e.multiIP.gateway_ip&&(t.buffer.detail[5]=JSON.stringify({vocs_ip:[e.multiIP.uni_lbs_ip],vos_ip:[e.multiIP.gateway_ip]}))}));const o=new FormData;return o.append("request",JSON.stringify(s)),[o,n]},Es=(e,t)=>{const i=Math.floor(Math.random()*10**12),n={appid:e.appId,client_ts:Date.now(),opid:i,sid:e.sid,request_bodies:[{uri:28,buffer:{cname:e.cname,detail:{1:"",6:e.stringUid,12:"1"},token:e.token,service_ids:t,uid:e.uid||0,edges_services:e.apResponse.addresses.map((e=>({ip:e.ip,port:e.port})))}}]},s=new FormData;return s.append("request",JSON.stringify(n)),[s,i]};let ms=0;function Ss(e){return Promise.all(e.map((e=>e.then((e=>{throw e}),(e=>e))))).then((e=>{throw e}),(e=>e))}const Ts=async e=>{let{fragementLength:t,referenceList:i,asyncMapHandler:n,allFailedhandler:s,promisesCollector:o}=e,a=0;const r=t;let c,d=0;const h=async()=>{const e=(()=>{const e=a*r,t=e+r;return i.slice(e,t).map(n)})();o&&o.push(...e);try{c=await Ss(e)}catch(e){if(d+=r,a++,!(d>=i.length))return void await h();s(e)}e.forEach((e=>e.cancel()))};return await h(),c},Cs=async e=>{let{referenceList:t,asyncMapHandler:i,closeFn:n}=e;const s=t.length;let o=0;const a=async()=>{const e=i(t.shift());try{return await e}catch(e){if(o++,o>=s||null!=n&&n(e))throw e;return a()}};return a()};async function fs(e,i,n,s){const o=async function(e,i,n,s){let o=null;const a=[],r=async()=>{const o=f("WEBCS_DOMAIN").slice(0,f("AJAX_REQUEST_CONCURRENT")).map((t=>({url:e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2"),areaCode:Qn()}))),r=s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:o.map((e=>e.url))}),c=await Ts({fragementLength:f("FRAGEMENT_LENGTH"),referenceList:o,asyncMapHandler:s=>(t.debug("[".concat(e.clientId,"] Connect to choose_server:"),s.url),ds(s,e,i,n)),allFailedhandler:e=>{throw s.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},r),e[0]},promisesCollector:a});return s.recordJoinChannelService({endTs:Date.now(),status:"success"},r),c},c=async()=>{if(await b(1e3),null!==o)return o;const r=f("WEBCS_DOMAIN_BACKUP_LIST").map((t=>({url:e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2"),areaCode:Qn()}))),c=s.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:r.map((e=>e.url))}),d=await Ts({fragementLength:f("FRAGEMENT_LENGTH"),referenceList:r,asyncMapHandler:s=>(t.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),s.url),ds(s,e,i,n)),allFailedhandler:e=>{throw s.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},c),e[0]},promisesCollector:a});return s.recordJoinChannelService({endTs:Date.now(),status:"success"},c),d};try{return o=await Ss([r(),c()]),a.length&&a.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),o}catch(e){throw e[0]}}(e,i,n,s);return{gatewayInfo:await o}}async function Rs(e,i,n,s,o){const a=e.cloudProxyServer;if("disabled"===a){if(!s)return;if(e.useLocalAccessPoint)return await fs(e,i,n,o);if(f("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:t,proxyInfo:s}=await ws(e,i,n,o);if(e.turnServer&&"auto"!==e.turnServer.mode)return{gatewayInfo:t};const a=s.map((e=>({turnServerURL:e.address,tcpport:e.tcpport||Gt.tcpport,udpport:e.udpport||Gt.udpport,username:e.username||Gt.username,password:e.password||Gt.password,forceturn:!1,security:!0})));if(o.useP2P){var r;const i=null!==(r=e.uid)&&void 0!==r?r:t.uid,n="glb:".concat(i.toString()),o=await x(n),c=s.map((e=>({turnServerURL:e.address,tcpport:e.tcpport||Gt.tcpport,udpport:e.udpport||Gt.udpport,username:n,password:o,forceturn:!1,security:!0})));a.push(...c)}return e.turnServer={mode:"manual",servers:a},{gatewayInfo:t}}return await fs(e,i,n,o)}const{proxyInfo:c,gatewayInfo:d}=await ws(e,i,n,o),h={gatewayInfo:d},l=c.map((e=>({turnServerURL:e.address,tcpport:"proxy3"===a?void 0:e.tcpport?e.tcpport:Gt.tcpport,udpport:"proxy4"===a?void 0:e.udpport?e.udpport:Gt.udpport,username:e.username||Gt.username,password:e.password||Gt.password,forceturn:"proxy4"!==a,security:"proxy5"===a})));if(o.useP2P){var u;const t=null!==(u=e.uid)&&void 0!==u?u:d.uid,i="glb:".concat(t.toString()),n=await x(i),s=c.map((e=>({turnServerURL:e.address,tcpport:"proxy3"===a?void 0:e.tcpport||Gt.tcpport,udpport:"proxy4"===a?void 0:e.udpport||Gt.udpport,username:i,password:n,forceturn:"proxy4"!==a,security:"proxy5"===a})));l.push(...s)}return e.turnServer={mode:"manual",servers:l},t.debug("[".concat(e.clientId,"] set proxy server: ").concat(e.proxyServer,", mode: ").concat(a)),h}async function gs(e,n,s,o,a){const r=f("ACCOUNT_REGISTER").slice(0,f("AJAX_REQUEST_CONCURRENT"));let c=[];c=n.proxyServer?r.map((e=>"https://".concat(n.proxyServer,"/ap/?url=").concat(e+"/api/v1"))):r.map((e=>"https://".concat(e,"/api/v1")));const d=null==a?void 0:a.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:c});try{const r=await async function(e,n,s,o,a){const r=Date.now(),c={sid:s.sid,opid:10,appid:s.appId,string_uid:n};let d=e[0];const h=await z((()=>zn(d+"".concat(-1===d.indexOf("?")?"?":"&","action=stringuid"),{data:c,cancelToken:o,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}})),((s,o)=>{if(0===s.code){if(s.uid<=0||s.uid>=Math.pow(2,32))throw t.error("Invalid Uint Uid ".concat(n," => ").concat(s.uid),s),i.reqUserAccount(c.sid,{lts:r,success:!1,serverAddr:d,stringUid:c.string_uid,uid:s.uid,errorCode:l.INVALID_UINT_UID_FROM_STRING_UID,extend:c}),new Si(l.INVALID_UINT_UID_FROM_STRING_UID);return i.reqUserAccount(c.sid,{lts:r,success:!0,serverAddr:d,stringUid:c.string_uid,uid:s.uid,errorCode:null,extend:c}),!1}const a=_n(s.code);return a.retry&&(d=e[(o+1)%e.length]),i.reqUserAccount(c.sid,{lts:r,success:!1,serverAddr:d,stringUid:c.string_uid,uid:s.uid,errorCode:a.desc,extend:c}),a.retry}),((t,n)=>t.code!==l.OPERATION_ABORTED&&(i.reqUserAccount(c.sid,{lts:r,success:!1,serverAddr:d,stringUid:c.string_uid,uid:null,errorCode:t.code,extend:c}),d=e[(n+1)%e.length],!0)),a);if(0!==h.code){const e=_n(h.code);throw new Si(l.UNEXPECTED_RESPONSE,e.desc)}return h}(c,e,n,s,o);return null==a||a.recordJoinChannelService({status:"success",endTs:Date.now()},d),r.uid}catch(e){throw null==a||a.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[e]},d),e}}async function Is(e,t,i){const n=f("ACCOUNT_REGISTER");let s=[];s=t.proxyServer?n.map((e=>"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1"))):n.map((e=>"https://".concat(e,"/api/v1")));try{const n=await Cs({referenceList:s,asyncMapHandler:n=>async function(e,t,i,n){const s=Date.now(),o={sid:i.sid,opid:10,appid:i.appId,string_uid:t};try{const t=await zn(e+"".concat(-1===e.indexOf("?")?"?":"&","action=stringuid"),{data:o,cancelToken:n,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(0!==t.code){const e=_n(t.code);throw new Si(l.UNEXPECTED_RESPONSE,"preload sua error:".concat(e.desc),e)}if(t.uid<=0||t.uid>=Math.pow(2,32))throw new Si(l.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:s,url:e,req:o,uid:t.uid,elapse:Date.now()-s}}catch(e){throw e}}(n,e,t,i),closeFn:e=>e.code===l.OPERATION_ABORTED||e.code===l.UNEXPECTED_RESPONSE&&!e.data.retry});return n}catch(e){throw e}}async function vs(e,t,n){const s=f("CDS_AP").slice(0,f("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1"):"https://".concat(t,"/api/v1?action=config"))).map((i=>function(e,t,i,n){const s=Z(),o={flag:64,cipher_method:0,features:{device:s.name,system:s.os,system_general:navigator.userAgent,vendor:t.appId,version:H,cname:t.cname,sid:t.sid,session_id:t.sid,detail:"",proxyServer:t.proxyServer}};return z((()=>zn(e,{data:o,timeout:1e3,cancelToken:i,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}})),void 0,(e=>e.code!==l.OPERATION_ABORTED),n)}(i,e,t,n)));let o=null,a=null,r={};try{o=await Ss(s)}catch(e){if(e.code===l.OPERATION_ABORTED)throw e;a=e}s.forEach((e=>e.cancel()));if(i.reportApiInvoke(e.sid,{name:J.REQUEST_CONFIG_DISTRIBUTE,options:{error:a,res:o}}).onSuccess(),o&&o.test_tags)try{r=function(e){if(!e.test_tags)return{};const t=e.test_tags,i=Object.keys(t),n={};return i.forEach((e=>{const i=e.slice(4).trim(),s=JSON.parse(t[e])[1];n[i]=s})),n}(o)}catch(e){}return r}async function As(e,i){const n=f("WEBCS_DOMAIN").concat(f("WEBCS_DOMAIN_BACKUP_LIST")).map((e=>({url:"https://".concat(e,"/api/v2/transpond/webrtc?v=2"),areaCode:Qn(),serviceIds:[bn.CHOOSE_SERVER,bn.CLOUD_PROXY_FALLBACK]})));try{const s=await Cs({referenceList:n,asyncMapHandler:n=>async function(e,i,n){let s,{url:o,areaCode:a,serviceIds:r}=e;const c=Date.now(),[d,h]=_s(i,a,r);let u=w.networkState;try{u&&w.networkState===A.OFFLINE&&w.onlineWaiter&&await Promise.race([w.onlineWaiter,b(Q.maxRetryTimeout)]),u=w.networkState;const{data:e,headers:i}=await zn(o,{data:d,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);s="1"===i.http3?1:-1,(e=>{const i=[];if(e.response_body.forEach((n=>{const s=n.buffer.code;if(23===n.uri&&0===s&&!n.buffer.edges_services)if(4194310===n.buffer.flag)n.buffer.edges_services=[];else{const t={error:new Si(l.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:e.detail[502]}),flag:n.buffer.flag};i.push(t)}if(0!==s){const o=_n(s),a={error:new Si(l.CAN_NOT_GET_GATEWAY_SERVER,o.desc,{desc:o.desc,retry:o.retry,csIp:e.detail[502]}),flag:n.buffer.flag};4194310===n.buffer.flag?t.warning(a.error.toString()):i.push(a)}})),i.length)throw new Si(l.CAN_NOT_GET_GATEWAY_SERVER,i.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message))).join(" | "),{retry:!!i.find((e=>e.error.data.retry)),csIp:e.detail[502],desc:[...new Set(i.map((e=>{var t;return null==e||null===(t=e.error)||void 0===t||null===(t=t.data)||void 0===t?void 0:t.desc})).filter((e=>!!e)))]})})(e);const a=Mn(e,bn.CHOOSE_SERVER),r=Mn(e,bn.CLOUD_PROXY_FALLBACK);return us(a),{gatewayInfo:Dn(a,o),proxyInfo:r,opid:h,requestTime:c,url:o,isHttp3:s,elapse:Date.now()-c}}catch(e){throw e}}(n,e,i),closeFn:e=>e.code===l.OPERATION_ABORTED||e.code===l.CAN_NOT_GET_GATEWAY_SERVER&&!e.data.retry});return s}catch(e){throw e}}async function ws(e,n,s,o){const a=f("PROXY_SERVER_TYPE3"),r=(e,t,i)=>{let n=i||a;return Array.isArray(n)&&(n=t%2==0?a[1]:a[0]),"https://".concat(n,"/ap/?url=").concat(e)};let c=null;const d=[],h=async()=>{const i=f("WEBCS_DOMAIN").slice(0,f("AJAX_REQUEST_CONCURRENT")).map(((t,i)=>{let n;return n="disabled"===e.cloudProxyServer&&e.proxyServer?r("".concat(t,"/api/v2/transpond/webrtc?v=2"),i,e.proxyServer):"disabled"===e.cloudProxyServer||"fallback"===e.cloudProxyServer?"https://".concat(t,"/api/v2/transpond/webrtc?v=2"):r("".concat(t,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:Qn(),serviceIds:[bn.CHOOSE_SERVER,"proxy5"===e.cloudProxyServer?bn.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?bn.CLOUD_PROXY:bn.CLOUD_PROXY_FALLBACK]}})),a=o.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:i.map((e=>e.url))}),c=await Ts({fragementLength:f("FRAGEMENT_LENGTH"),referenceList:i,asyncMapHandler:i=>(t.debug("[".concat(e.clientId,"] Connect to choose_server:"),i.url),hs(i,e,n,s)),allFailedhandler:e=>{throw o.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},a),e[0]},promisesCollector:d});return o.recordJoinChannelService({endTs:Date.now(),status:"success"},a),c},u=async()=>{if(await b(1e3),null!==c)return c;const i=f("WEBCS_DOMAIN_BACKUP_LIST").map(((t,i)=>{let n;return n="disabled"===e.cloudProxyServer&&e.proxyServer?r("".concat(t,"/api/v2/transpond/webrtc?v=2"),i,e.proxyServer):"disabled"===e.cloudProxyServer||"fallback"===e.cloudProxyServer?"https://".concat(t,"/api/v2/transpond/webrtc?v=2"):r("".concat(t,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:Qn(),serviceIds:[bn.CHOOSE_SERVER,"proxy5"===e.cloudProxyServer?bn.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?bn.CLOUD_PROXY:bn.CLOUD_PROXY_FALLBACK]}})),a=o.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:i.map((e=>e.url))}),h=await Ts({fragementLength:f("FRAGEMENT_LENGTH"),referenceList:i,asyncMapHandler:i=>(t.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),i.url),hs(i,e,n,s)),allFailedhandler:e=>{throw o.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},a),e[0]},promisesCollector:d});return o.recordJoinChannelService({endTs:Date.now(),status:"success"},a),h};let p,_,E;try{({gatewayInfo:p,proxyInfo:_,url:E}=await Ss([h(),u()]))}catch(e){throw e[0]}if(d.length&&d.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),!p||!_)throw new Si(l.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(e.apUrl=E,"disabled"!==e.cloudProxyServer&&Array.isArray(a)&&E){const n=/^https?:\/\/(.+?)(\/.*)?$/.exec(E)[1];a.includes(n)&&(e.proxyServer=n,t.setProxyServer(n),i.setProxyServer(n))}return c={gatewayInfo:p,proxyInfo:await Un(_,p.uid)},c}async function ys(e,t,i,n){const s=f("UAP_AP").slice(0,f("AJAX_REQUEST_CONCURRENT")).map((e=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1?action=uap"):"https://".concat(e,"/api/v1?action=uap")));return await rs(s,e,t,i,n)}async function Ns(e,i,n){const s=f("UAP_AP").slice(0,f("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1?action=uap"):"https://".concat(t,"/api/v1?action=uap"))).map((s=>function(e,i,n,s){const o={command:"convergeAllocateEdge",sid:i.sid,appId:i.appId,token:i.token,ts:Date.now(),version:H,cname:i.cname,uid:i.uid.toString(),requestId:cs,seq:cs};cs+=1;const a={service_name:"tele_channel",json_body:JSON.stringify(o)};return z((async()=>{const i=await zn(e,{data:a,cancelToken:n,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(0!==i.code){const e=new Si(l.UNEXPECTED_RESPONSE,"cross channel ap error, code"+i.code,{retry:!0});throw t.error(e.toString()),e}const s=JSON.parse(i.json_body);if(200!==s.code){const e=new Si(l.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(s.code,", reason: ").concat(s.reason));throw t.error(e.toString()),e}if(!s.servers||0===s.servers.length){const e=new Si(l.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw t.error(e.toString()),e}return{vid:s.vid,workerToken:s.workerToken,addressList:(f("CHANNEL_MEDIA_RELAY_SERVERS")||s.servers).map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(f("WORKER_DOMAIN"),":").concat(e.wss)))}}),void 0,(e=>!!(e.code!==l.OPERATION_ABORTED&&e.code!==l.UNEXPECTED_RESPONSE||e.data&&e.data.retry)),s)}(s,e,i,n)));try{const e=await Ss(s);return s.forEach((e=>e.cancel())),e}catch(e){throw e[0]}}async function bs(e,i,n){let s=null;const o=[],a=async a=>{const r=f(a?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2")));return a&&(await b(1e3),null!==s)?s:await Ts({fragementLength:f("FRAGEMENT_LENGTH"),referenceList:r,asyncMapHandler:s=>(t.debug("[".concat(e.clientId,"] update ticket, Connect to ").concat(a?"backup":""," choose_server:"),s),function(e,i,n,s){const[o]=Es(i,[bn.CHOOSE_SERVER]);let a=w.networkState;return z((async()=>{a&&w.networkState===A.OFFLINE&&w.onlineWaiter&&await Promise.race([w.onlineWaiter,b(s&&s.maxRetryTimeout||Q.maxRetryTimeout)]),a=w.networkState;const t=await zn(e,{data:o,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0);return ps(t,e)}),(()=>!1),(e=>e.code!==l.OPERATION_ABORTED&&(e.code===l.UPDATE_TICKET_FAILED?e.data.retry:(t.warning("[".concat(i.clientId,"] update ticket network error, retry"),e),!0))),s)}(s,e,i,n)),allFailedhandler:e=>{throw e[0]},promisesCollector:o})};try{return s=await Ss([a(!1),a(!0)]),o.length&&o.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),s}catch(e){throw e[0]}}class Os extends C{get isSuccess(){return!!this.configs}constructor(){super(),this.configs=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.retryConfig={timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4},this.interval=void 0,this.mutex=new v("config-distribute"),this.mutableParamsRead=!1}startGetConfigDistribute(e,t){this.joinInfo=e,this.cancelToken=t,this.interval&&this.stopGetConfigDistribute(),f("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval((()=>{this.updateConfigDistribute()}),f("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){if(!this.mutex.isLocked)return;(await this.mutex.lock())()}async updateConfigDistribute(){if(!this.mutableParamsRead){this.mutableParamsRead=!0;i.reportApiInvoke(null,{options:void 0,name:J.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:X.TRACER}).onSuccess(JSON.stringify(d))}if(!this.joinInfo||!this.cancelToken||!this.retryConfig)return void t.debug("[config-distribute] get config distribute interrupted have no joininfo");let e;const n=await this.mutex.lock();try{e=await vs(this.joinInfo,this.cancelToken,this.retryConfig),t.debug("[config-distribute] get config distribute",JSON.stringify(e)),e.limit_bitrate&&this.handleBitrateLimit(e.limit_bitrate),this.cacheGlobalParameterConfig(e),this.configs=e}catch(e){const i=new Si(l.NETWORK_RESPONSE_ERROR,e);t.warning("[config-distribute] ".concat(i.toString()))}finally{n()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(e){var t;(t=e)&&t.uplink&&t.id&&void 0!==t.uplink.max_bitrate&&void 0!==t.uplink.min_bitrate&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==e.id&&this.emit(Hi.UPDATE_BITRATE_LIMIT,e):this.emit(Hi.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&Zt({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(e){const i=Object.keys(e).filter((e=>/^webrtc_ng_global_parameter/.test(e))).sort();for(let t=0;t<i.length;t++)for(let n=i.length-1;n>t;n--){const t=i[n];if("number"==typeof e[t].__priority){const s=e[t].__priority,o=i[n-1];if("number"==typeof e[o].__priority){if(!(s>e[o].__priority))continue;{const e=t;i[n]=i[n-1],i[n-1]=e}}else{const e=t;i[n]=i[n-1],i[n-1]=e}}}const n={};i.forEach((t=>{const i=e[t],s=i.__expires;Object.keys(i).forEach((e=>{"__priority"===e||"__expires"===e||Object.prototype.hasOwnProperty.call(n,e)||(n[e]=Zt({value:i[e]},s&&{expires:s}))}))}));try{!function(e){try{const i=Date.now();Object.keys(e).forEach((n=>{switch(n){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":case"ENABLE_AG_ADAPTATION":case"FORCE_AG_HIGH_FRAMERATE":case"FORCE_SUPPORT_AG_ADAPTATION":case"ENCODER_CONFIG_LIMIT":case"CAMERA_CAPTURE_CONFIG":case"ENABLE_PRELOAD":if(Object.prototype.hasOwnProperty.call(c,n)){const{value:s,expires:o}=e[n];if(o&&o<=i)return;d[n]=s,c[n]=s,t.debug("Update global parameters from config distribute",n,s)}}}))}catch(i){t.error("Error update config immediately: ".concat(e),i.message)}}(n);const e=JSON.stringify(n),i=window.btoa(e);window.localStorage.setItem("websdk_ng_global_parameter",i),t.debug("Caching global parameters ".concat(e))}catch(e){t.error("Error caching global parameters:",e.message)}}}class Ds extends C{constructor(){super(...arguments),this.resultStorage=new Map}setLocalAudioStats(e,t,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(i,t)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(i,t))}setLocalVideoStats(e,t,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(i,t)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(i,t)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(i))}setRemoteAudioStats(e,t){const i=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(t))}setRemoteVideoStats(e,t){const i=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(t))}record(e,t,i){if(f("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const n=this.resultStorage.get(e);if(n&&(n.result.push(i),n.result.length>=5)){const i=n.result.includes(!0);n.isPrevNormal&&!i&&this.emit("exception",Ps[e],e,t),!n.isPrevNormal&&i&&this.emit("exception",Ps[e]+2e3,e+"_RECOVER",t),n.isPrevNormal=i,n.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&0===e.receiveLevel)}checkAudioInputLevel(e,t){return t instanceof Qe&&!t.isActive||(!!t.muted||0!==e.sendVolumeLevel)}checkFramerateInput(e,t){let i=null;t._encoderConfig&&t._encoderConfig.frameRate&&(i=Pn(t._encoderConfig.frameRate));const n=e.captureFrameRate;return!i||!n||!(i>10&&n<5||i<10&&i>=5&&n<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,t){return!!t.muted||0!==e.sendBitrate}checkSendAudioBitrate(e,t){return t instanceof Qe&&!t.isActive||(!!t.muted||0!==e.sendBitrate)}checkVideoDecode(e){return 0===e.receiveBitrate||0!==e.decodeFrameRate}}const Ps={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003};const Ls=new class{markSubscribeStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/subscribe-").concat(t))}markPublishStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/publish-").concat(t))}measureFromSubscribeStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/subscribe-").concat(t));if(i.length>0){const e=i[i.length-1];return Math.round(performance.now()-e.startTime)}return 0}measureFromPublishStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/publish-").concat(t));if(i.length>0){const e=i[i.length-1];return Math.round(performance.now()-e.startTime)}return 0}};"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var ks={exports:{}},Ms=ks.exports=(()=>{var e={8:(e,t,i)=>{i.r(t),i.d(t,{Parser:()=>g,Printer:()=>y,parse:()=>D,print:()=>P});const n="\n",s="".concat("\r").concat(n),o=" ";let a;function r(e){return e>="0"&&e<="9"}function c(e){return e>="!"&&e<="~"}function d(e){return c(e)||e>=""&&e<="ÿ"}function h(e){return"!"===e||e>="#"&&e<="'"||e>="*"&&e<="+"||e>="-"&&e<="."||e>="0"&&e<="9"||e>="A"&&e<="Z"||e>="^"&&e<="~"}function l(e){return e>="1"&&e<="9"}function u(e){return e>="A"&&e<="Z"||e>="a"&&e<="z"}function p(e){return"d"===e||"h"===e||"m"===e||"s"===e}function _(e){return e>""&&e<"\t"||e>"\v"&&e<"\f"||e>""&&e<"ÿ"}function E(e){return u(e)||r(e)||"+"===e||"/"===e}function m(e){return r(e)||u(e)||"+"===e||"/"===e||"-"===e||"_"===e}function S(e){return u(e)||r(e)||"+"===e||"/"===e}function T(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function C(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?T(Object(i),!0).forEach((function(t){f(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):T(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function f(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}!function(e){e.VERSION="v",e.ORIGIN="o",e.SESSION_NAME="s",e.INFORMATION="i",e.URI="u",e.EMAIL="e",e.PHONE="p",e.CONNECTION="c",e.BANDWIDTH="b",e.TIME="t",e.REPEAT="r",e.ZONE_ADJUSTMENTS="z",e.KEY="k",e.ATTRIBUTE="a",e.MEDIA="m"}(a||(a={}));class R{consumeText(e,t){let i=t;for(;i<e.length;){const t=e[i];if("\0"===t||"\r"===t||t===n)break;i+=1}if(i-t==0)throw new Error("Invalid text, at ".concat(e));return i}consumeUnicastAddress(e,t,i){return this.consumeTill(e,t,o)}consumeOneOrMore(e,t,i){let n=t;for(;i(e[n]);)n++;if(n-t==0)throw new Error("Invalid rule at ".concat(t,"."));return n}consumeSpace(e,t){if(e[t]===o)return t+1;throw new Error("Invalid space at ".concat(t,"."))}consumeIP4Address(e,t){let i=t;for(let t=0;t<4;t++)if(i=this.consumeDecimalUChar(e,i),3!==t){if("."!==e[i])throw new Error("Invalid IP4 address.");i++}return i}consumeDecimalUChar(e,t){let i=t;for(let t=0;t<3&&r(e[i]);t++,i++);if(i-t==0)throw new Error("Invalid decimal uchar.");const n=parseInt(e.slice(t,i));if(n>=0&&n<=255)return i;throw new Error("Invalid decimal uchar")}consumeIP6Address(e,t){let i=this.consumeHexpart(e,t);return":"===e[i]?(i+=1,i=this.consumeIP4Address(e,i),i):i}consumeHexpart(e,t){let i=t;if(":"===e[i]&&":"===e[i+1]){i+=2;try{i=this.consumeHexseq(e,i)}catch(e){}return i}if(i=this.consumeHexseq(e,i),":"===e[i]&&":"===e[i+1]){i+=2;try{i=this.consumeHexseq(e,i)}catch(e){}return i}return i}consumeHexseq(e,t){let i=t;for(;i=this.consumeHex4(e,i),":"===e[i]&&":"!==e[i+1];)i+=1;return i}consumeHex4(e,t){let i=0;for(;i<4;i++)if(!((n=e[t+i])>="0"&&n<="9"||n>="a"&&n<="f"||n>="A"&&n<="F")){if(0===i)throw new Error("Invalid hex 4");break}var n;return t+i}consumeFQDN(e,t){let i=t;for(;r(e[i])||u(e[i])||"-"===e[i]||"."===e[i];)i+=1;if(i-t<4)throw new Error("Invalid FQDN");return i}consumeExtnAddr(e,t){return this.consumeOneOrMore(e,t,d)}consumeMulticastAddress(e,t,i){switch(i){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(e,t);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(e,t);default:try{return this.consumeFQDN(e,t)}catch(i){return this.consumeExtnAddr(e,t)}}}consumeIP6MulticastAddress(e,t){const i=this.consumeHexpart(e,t);return"/"===e[i]?this.consumeInteger(e,i+1):i}consumeIP4MulticastAddress(e,t){let i=t+3;const n=e.slice(t,i),s=parseInt(n);if(s<224||s>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let t=0;t<3;t++){if("."!==e[i])throw new Error("Invalid IP4 multicast address.");i+=1,i=this.consumeDecimalUChar(e,i)}return"/"===e[i]&&(i+=1),i=this.consumeTTL(e,i),"/"===e[i]&&(i=this.consumeInteger(e,i)),i}consumeInteger(e,t){if(!l(e[t]))throw new Error("Invalid integer.");for(t+=1;r(e[t]);)t+=1;return t}consumeTTL(e,t){if("0"===e[t])return t+1;if(!l(e[t]))throw new Error("Invalid TTL.");t+=1;for(let i=0;i<2&&r(e[t]);i++)t+=1;return t}consumeToken(e,t){return this.consumeOneOrMore(e,t,h)}consumeTime(e,t){let i=t;if("0"===e[i])return i+1;for(l(e[i])&&(i+=1);r(e[i]);)i++;if(i-t<10)throw new Error("Invalid time");return i}consumeAddress(e,t){return this.consumeTill(e,t,o)}consumeTypedTime(e,t){let i=t;return i=this.consumeOneOrMore(e,i,r),p(e[i])?i+1:i}consumeRepeatInterval(e,t){if(!l(e[t]))throw new Error("Invalid repeat interval");for(t+=1;r(e[t]);)t+=1;return p(e[t])&&(t+=1),t}consumePort(e,t){return this.consumeOneOrMore(e,t,r)}consume(e,t,i){for(let n=0;n<i.length;n++){if(t+n>=e.length)throw new Error("consume exceeding value length");if(e[t+n]!==i[n])throw new Error("consume ".concat(i," failed at ").concat(n))}return t+i.length}consumeTill(e,t,i){let n=t;for(;n<e.length&&("string"!=typeof i||e[n]!==i)&&("function"!=typeof i||!i(e[n]));)n++;return n}}class g extends R{constructor(){super(),f(this,"records",[]),f(this,"currentLine",0)}parse(e){const t=this.probeEOL(e);this.records=e.split(t).filter((e=>!!e.trim())).map(this.parseLine),this.currentLine=0;const i=this.parseVersion(),n=this.parseOrigin(),s=this.parseSessionName(),o=this.parseInformation(),a=this.parseUri(),r=this.parseEmail(),c=this.parsePhone(),d=this.parseConnection(),h=this.parseBandWidth(),l=this.parseTimeFields(),u=this.parseKey(),p=this.parseSessionAttribute(),_=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:i,origin:n,sessionName:s,information:o,uri:a,emails:r,phones:c,connection:d,bandwidths:h,timeFields:l,key:u,attributes:p,mediaDescriptions:_}}getCurrentRecord(){const e=this.records[this.currentLine];if(!e)throw new Error("Record doesn't exit.");return e}probeEOL(e){for(let t=0;t<e.length;t++)if(e[t]===n)return"\r"===e[t-1]?s:n;throw new Error("Invalid newline character.")}parseLine(e,t){if(e.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const i=e[0];if("="!==e[1])throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:i,value:e.slice(2),line:t,cur:0}}parseSessionAttribute(){const e=new v;for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==a.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(t,(e=>h(e)&&":"!==e)),_cur:0};":"===t.value[t.cur]&&(t.cur+=1,i.attValue=this.extractOneOrMore(t,_)),e.parse(i),this.currentLine++}return e.digest()}parseMediaAttributes(e){const t=new A(e);for(;this.currentLine<this.records.length;){const e=this.getCurrentRecord();if(e.type!==a.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(e,(e=>h(e)&&":"!==e)),_cur:0};":"===e.value[e.cur]&&(e.cur+=1,i.attValue=this.extractOneOrMore(e,_)),t.parse(i),this.currentLine++}return t.digest()}parseKey(){const e=this.getCurrentRecord();if(e.type===a.KEY){if("prompt"===e.value||"clear:"===e.value||"base64:"===e.value||"uri:"===e.value)return e.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const e=this.getCurrentRecord();if(e.type===a.ZONE_ADJUSTMENTS){const t=[];for(;;)try{const i=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);let n=!1;"-"===e.value[e.cur]&&(n=!0,e.cur+=1);const s=this.extract(e,this.consumeTypedTime);t.push({time:i,typedTime:s,back:n})}catch(e){break}if(0===t.length)throw new Error("Invalid zone adjustments");return this.currentLine++,t}return[]}parseRepeat(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==a.REPEAT)break;{const i=this.extract(t,this.consumeRepeatInterval),n=this.parseTypedTime(t);e.push({repeatInterval:i,typedTimes:n}),this.currentLine++}}return e}parseTypedTime(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeTypedTime))}catch(e){break}if(0===t.length)throw new Error("Invalid typed time.");return t}parseTime(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);const i=this.extract(e,this.consumeTime);return this.currentLine++,{startTime:t,stopTime:i}}parseBandWidth(){const e=[];for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==a.BANDWIDTH)break;{const i=this.extractOneOrMore(t,h);if(":"!==t.value[t.cur])throw new Error("Invalid bandwidth field.");t.cur++;const n=this.extractOneOrMore(t,r);e.push({bwtype:i,bandwidth:n}),this.currentLine++}}return e}parseVersion(){const e=this.getCurrentRecord();if(e.type!==a.VERSION)throw new Error("first sdp record must be version");const t=e.value.slice(0,this.consumeOneOrMore(e.value,0,r));if(t.length!==e.value.length)throw new Error('invalid proto version, "v='.concat(e.value,'"'));return this.currentLine++,t}parseOrigin(){const e=this.getCurrentRecord();if(e.type!==a.ORIGIN)throw new Error("second line of sdp must be origin");const t=this.extractOneOrMore(e,d);this.consumeSpaceForRecord(e);const i=this.extractOneOrMore(e,r);this.consumeSpaceForRecord(e);const n=this.extractOneOrMore(e,r);this.consumeSpaceForRecord(e);const s=this.extractOneOrMore(e,h);this.consumeSpaceForRecord(e);const o=this.extractOneOrMore(e,h);this.consumeSpaceForRecord(e);const c=this.extract(e,this.consumeUnicastAddress);return this.currentLine++,{username:t,sessId:i,sessVersion:n,nettype:s,addrtype:o,unicastAddress:c}}parseSessionName(){const e=this.getCurrentRecord();if(e.type===a.SESSION_NAME){const t=this.extract(e,this.consumeText);return this.currentLine++,t}}parseInformation(){const e=this.getCurrentRecord();if(e.type!==a.INFORMATION)return;const t=this.extract(e,this.consumeText);return this.currentLine++,t}parseUri(){const e=this.getCurrentRecord();if(e.type===a.URI)return this.currentLine++,e.value}parseEmail(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==a.EMAIL)break;e.push(t.value),this.currentLine++}return e}parsePhone(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==a.PHONE)break;e.push(t.value),this.currentLine++}return e}parseConnection(){const e=this.getCurrentRecord();if(e.type===a.CONNECTION){const t=this.extractOneOrMore(e,h);this.consumeSpaceForRecord(e);const i=this.extractOneOrMore(e,h);this.consumeSpaceForRecord(e);const n=this.extract(e,this.consumeAddress);return this.currentLine++,{nettype:t,addrtype:i,address:n}}}parseMedia(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeToken);this.consumeSpaceForRecord(e);let i=this.extract(e,this.consumePort);"/"===e.value[e.cur]&&(e.cur+=1,i+=this.extract(e,this.consumeInteger)),this.consumeSpaceForRecord(e);const n=[];for(n.push(this.extract(e,this.consumeToken));"/"===e.value[e.cur];)e.cur+=1,n.push(this.extract(e,this.consumeToken));if(0===n.length)throw new Error("Invalid proto");const s=this.parseFmt(e);return this.currentLine++,{mediaType:t,port:i,protos:n,fmts:s}}parseTimeFields(){const e=[];for(;this.getCurrentRecord().type===a.TIME;){const t=this.parseTime(),i=this.parseRepeat(),n=this.parseZone();e.push({time:t,repeats:i,zones:n})}return e}parseMediaDescription(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===a.MEDIA;){const t=this.parseMedia(),i=this.parseInformation(),n=this.parseConnections(),s=this.parseBandWidth(),o=this.parseKey(),a=this.parseMediaAttributes(t);e.push({media:t,information:i,connections:n,bandwidths:s,key:o,attributes:a})}return e}parseConnections(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===a.CONNECTION;)e.push(this.parseConnection());return e}parseFmt(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeToken))}catch(e){break}if(0===t.length)throw new Error("Invalid fmts");return t}extract(e,t){for(var i=arguments.length,n=new Array(i>2?i-2:0),s=2;s<i;s++)n[s-2]=arguments[s];const o=t.call(this,e.value,e.cur,...n),a=e.value.slice(e.cur,o);return e.cur=o,a}extractOneOrMore(e,t){const i=this.consumeOneOrMore(e.value,e.cur,t),n=e.value.slice(e.cur,i);return e.cur=i,n}consumeSpaceForRecord(e){if(e.value[e.cur]!==o)throw new Error("Invalid space at ".concat(e.cur,"."));e.cur+=1}}class I extends R{constructor(){super(...arguments),f(this,"attributes",void 0),f(this,"digested",!1)}extractOneOrMore(e,t,i){const n=this.consumeOneOrMore(e.attValue,e._cur,t),s=e.attValue.slice(e._cur,n),[o,a]=i||[];if("number"==typeof o&&s.length<o)throw new Error("error in length, should be more or equal than ".concat(o," characters."));if("number"==typeof a&&s.length>a)throw new Error("error in length, should be less or equal than ".concat(a," characters."));return e._cur=n,s}consumeAttributeSpace(e){if(e.attValue[e._cur]!==o)throw new Error("Invalid space at ".concat(e._cur,"."));e._cur+=1}extract(e,t){if(!e.attValue)throw new Error("Nothing to extract from attValue.");for(var i=arguments.length,n=new Array(i>2?i-2:0),s=2;s<i;s++)n[s-2]=arguments[s];const o=t.call(this,e.attValue,e._cur,...n),a=e.attValue.slice(e._cur,o);return e._cur=o,a}atEnd(e){if(!e.attValue)throw new Error;return e._cur>=e.attValue.length}peekChar(e){if(!e.attValue)throw new Error;return e.attValue[e._cur]}peek(e,t){if(!e.attValue)throw new Error;for(let i=0;i<t.length;i++)if(t[i]!==e.attValue[e._cur+i])return!1;return!0}parseIceUfrag(e){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(e,E,[4,256])}parseIcePwd(e){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(e,E,[22,256])}parseIceOptions(e){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const t=[];for(;!this.atEnd(e);){t.push(this.extractOneOrMore(e,E));try{this.consumeAttributeSpace(e)}catch(t){if(this.atEnd(e))break;throw t}}this.attributes.iceOptions=t}parseFingerprint(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill);this.attributes.fingerprints.push({hashFunction:t,fingerprint:i})}parseExtmap(e){const t=this.extractOneOrMore(e,r);let i;"/"===this.peekChar(e)&&(this.extract(e,this.consume,"/"),i=this.extract(e,this.consumeToken)),this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeTill,o),s=C(C({entry:parseInt(t,10)},i&&{direction:i}),{},{extensionName:n});this.peekChar(e)===o&&(this.consumeAttributeSpace(e),s.extensionAttributes=this.extract(e,this.consumeTill)),this.attributes.extmaps.push(s)}parseSetup(e){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const t=this.extract(e,this.consumeTill);if("active"!==t&&"passive"!==t&&"actpass"!==t&&"holdconn"!==t)throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=t}}class v extends I{constructor(){super(...arguments),f(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"group":this.parseGroup(e);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"fingerprint":this.parseFingerprint(e);break;case"setup":this.parseSetup(e);break;case"tls-id":this.parseTlsId(e);break;case"identity":this.parseIdentity(e);break;case"extmap":this.parseExtmap(e);break;case"msid-semantic":this.parseMsidSemantic(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing session attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(e){const t=this.extract(e,this.consumeToken),i=[];for(;!this.atEnd(e)&&this.peekChar(e)===o;)this.consumeAttributeSpace(e),i.push(this.extract(e,this.consumeToken));this.attributes.groups.push({semantic:t,identificationTag:i})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(e){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(e,m)}parseIdentity(e){const t=this.extractOneOrMore(e,S),i=[];for(;!this.atEnd(e)&&this.peekChar(e)===o;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.extract(e,this.consume,"=");const n=this.extractOneOrMore(e,(e=>e!==o&&_(e)));i.push({name:t,value:n})}this.attributes.identities.push({assertionValue:t,extensions:i})}parseMsidSemantic(e){this.peekChar(e)===o&&this.consumeAttributeSpace(e);const t={semantic:this.extract(e,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(e)}catch(e){break}if("*"===this.peekChar(e)){this.extract(e,this.consume,"*"),t.applyForAll=!0;break}{const i=this.extract(e,this.consumeTill,o);t.identifierList.push(i)}}this.attributes.msidSemantic=t}}class A extends I{constructor(e){super(),f(this,"attributes",void 0),-1!==e.protos.indexOf("RTP")||e.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"extmap":this.parseExtmap(e);break;case"setup":this.parseSetup(e);break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"candidate":this.parseCandidate(e);break;case"remote-candidate":this.parseRemoteCandidate(e);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(e);break;case"rtpmap":this.parseRtpmap(e);break;case"ptime":this.parsePtime(e);break;case"maxptime":this.parseMaxPtime(e);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(e);break;case"ssrc":this.parseSSRC(e);break;case"fmtp":this.parseFmtp(e);break;case"rtcp-fb":this.parseRtcpFb(e);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(e);break;case"mid":this.parseMid(e);break;case"msid":this.parseMsid(e);break;case"imageattr":this.parseImageAttr(e);break;case"rid":this.parseRid(e);break;case"simulcast":this.parseSimulcast(e);break;case"sctp-port":this.parseSctpPort(e);break;case"max-message-size":this.parseMaxMessageSize(e);break;case"ssrc-group":this.parseSSRCGroup(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing media attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}parseCandidate(e){const t=this.extractOneOrMore(e,E,[1,32]);this.consumeAttributeSpace(e);const i=this.extractOneOrMore(e,r,[1,5]);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const s=this.extractOneOrMore(e,r,[1,10]);this.consumeAttributeSpace(e);const a=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const d=this.extract(e,this.consumePort);this.consumeAttributeSpace(e),this.extract(e,this.consume,"typ"),this.consumeAttributeSpace(e);const h={foundation:t,componentId:i,transport:n,priority:s,connectionAddress:a,port:d,type:this.extract(e,this.consumeToken),extension:{}};for(this.peek(e," raddr")&&(this.extract(e,this.consume," raddr"),this.consumeAttributeSpace(e),h.relAddr=this.extract(e,this.consumeAddress)),this.peek(e," rport")&&(this.extract(e,this.consume," rport"),this.consumeAttributeSpace(e),h.relPort=this.extract(e,this.consumePort));this.peekChar(e)===o;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e),h.extension[t]=this.extractOneOrMore(e,c)}this.attributes.candidates.push(h)}parseRemoteCandidate(e){const t=[];for(;;){const i=this.extractOneOrMore(e,r,[1,5]);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const s=this.extract(e,this.consumePort);t.push({componentId:i,connectionAddress:n,port:s});try{this.consumeAttributeSpace(e)}catch(e){break}}this.attributes.remoteCandidatesList.push(t)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,"/");this.extract(e,this.consume,"/");const n={encodingName:i,clockRate:this.extractOneOrMore(e,r)};this.atEnd(e)||"/"!==this.peekChar(e)||(this.extract(e,this.consume,"/"),n.encodingParameters=parseInt(this.extract(e,this.consumeTill),10));const s=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));s?s.rtpMap=n:this.attributes.payloads.push({payloadType:parseInt(t,10),rtpMap:n,rtcpFeedbacks:[]})}parsePtime(e){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(e,this.consumeTill)}parseMaxPtime(e){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(e,this.consumeTill)}parseDirection(e){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=e.attField}parseSSRC(e){const t=this.extractOneOrMore(e,r);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,":");let n;":"===this.peekChar(e)&&(this.extract(e,this.consume,":"),n=this.extract(e,this.consumeTill));const s=this.attributes.ssrcs.find((e=>e.ssrcId===parseInt(t,10)));s?s.attributes[i]=n:this.attributes.ssrcs.push({ssrcId:parseInt(t,10),attributes:{[i]:n}})}parseFmtp(e){const t=this.extract(e,this.consumeTill,o);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill),n={};i.split(";").forEach((e=>{let[t,i]=e.split("=");t=t.trim();const s="string"==typeof i?i.trim():null;"string"==typeof t&&t.length>0&&(n[t]=s)}));const s=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));s?s.fmtp={parameters:n}:this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[],fmtp:{parameters:n}})}parseFmtParameters(e){const t={},i=this.extract(e,this.consumeTill,"=");e._cur++;const n=this.extract(e,this.consumeTill,";");for(t[i]=n;";"===e.attValue[e._cur];){const i=this.extract(e,this.consumeTill,"=");e._cur++;const n=this.extract(e,this.consumeTill,";");t[i]=n}return t}parseRtcpFb(e){let t="";t="*"===this.peekChar(e)?this.extract(e,this.consume,"*"):this.extract(e,this.consumeTill,o),this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,o);let n;if("trr-int"===i)n={type:i,interval:this.extract(e,this.consumeTill)};else{const t={type:i};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.parameter=this.extract(e,this.consumeToken),this.peekChar(e)===o&&(t.additional=this.extract(e,this.consumeTill))),n=t}if("*"===t)this.attributes.rtcpFeedbackWildcards.push(n);else{const e=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));e?e.rtcpFeedbacks.push(n):this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[n]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(e){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const t={port:this.extract(e,this.consumePort)};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.netType=this.extractOneOrMore(e,h),this.consumeAttributeSpace(e),t.addressType=this.extractOneOrMore(e,h),this.consumeAttributeSpace(e),t.address=this.extract(e,this.consumeAddress)),this.attributes.rtcp=t}parseMsid(e){const t={id:this.extractOneOrMore(e,h,[1,64])};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.appdata=this.extractOneOrMore(e,h,[1,64])),this.attributes.msids.push(t)}parseImageAttr(e){this.attributes.imageattr.push(e.attValue)}parseRid(e){const t=this.extractOneOrMore(e,(e=>u(e)||r(e)||"_"===e||"-"===e));this.consumeAttributeSpace(e);const i={id:t,direction:this.extract(e,this.consumeToken),params:[]};if(this.peekChar(e)===o){if(this.consumeAttributeSpace(e),this.peek(e,"pt=")){this.extract(e,this.consume,"pt=");const t=[];for(;;){const i=this.extract(e,this.consumeToken);t.push(i);try{this.extract(e,this.consume,",")}catch(e){break}}i.payloads=t,this.peekChar(e)===o&&this.extract(e,this.consume,o)}for(;;){const t=this.extract(e,this.consumeToken);switch(t){case"depend":{const n={type:t,rids:this.extract(e,this.consume,"=").split(",")};i.params.push(n);break}default:{const n={type:t};"="===this.peekChar(e)&&(this.extract(e,this.consume,"="),n.val=this.extract(e,this.consumeTill,";")),i.params.push(n)}}try{this.extract(e,this.consume,";")}catch(e){break}}}this.attributes.rids.push(i)}parseSimulcast(e){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=e.attValue,this.extract(e,this.consumeTill)}parseSctpPort(e){this.attributes.sctpPort=this.extractOneOrMore(e,r,[1,5])}parseMaxMessageSize(e){this.attributes.maxMessageSize=this.extractOneOrMore(e,r,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(e){this.attributes.mid=this.extract(e,this.consumeToken)}parseSSRCGroup(e){const t=this.extract(e,this.consumeToken),i=[];for(;;)try{this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeInteger);i.push(parseInt(t,10))}catch(e){break}this.attributes.ssrcGroups.push({semantic:t,ssrcIds:i})}}function w(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class y{constructor(){w(this,"eol",s)}print(e,t){let i="";return t&&(this.eol=t),i+=this.printVersion(e.version),i+=this.printOrigin(e.origin),i+=this.printSessionName(e.sessionName),i+=this.printInformation(e.information),i+=this.printUri(e.uri),i+=this.printEmail(e.emails),i+=this.printPhone(e.phones),i+=this.printConnection(e.connection),i+=this.printBandwidth(e.bandwidths),i+=this.printTimeFields(e.timeFields),i+=this.printKey(e.key),i+=this.printSessionAttributes(e.attributes),i+=this.printMediaDescription(e.mediaDescriptions),i}printVersion(e){return"v=".concat(e).concat(this.eol)}printOrigin(e){return"o=".concat(e.username," ").concat(e.sessId," ").concat(e.sessVersion," ").concat(e.nettype," ").concat(e.addrtype," ").concat(e.unicastAddress).concat(this.eol)}printSessionName(e){return e?"s=".concat(e).concat(this.eol):""}printInformation(e){return e?"i=".concat(e).concat(this.eol):""}printUri(e){return e?"u=".concat(e).concat(this.eol):""}printEmail(e){let t="";for(const i of e)t+="e=".concat(i).concat(this.eol);return t}printPhone(e){let t="";for(const i of e)t+="e=".concat(i).concat(this.eol);return t}printConnection(e){return e?"c=".concat(e.nettype," ").concat(e.addrtype," ").concat(e.address).concat(this.eol):""}printBandwidth(e){let t="";for(const i of e)t+="b=".concat(i.bwtype,":").concat(i.bandwidth).concat(this.eol);return t}printTimeFields(e){let t="";for(const i of e){t+="t=".concat(i.time.startTime," ").concat(i.time.startTime).concat(this.eol);for(const e of i.repeats)t+="r=".concat(e.repeatInterval," ").concat(e.typedTimes.join(" ")).concat(this.eol);i.zoneAdjustments&&(t+="z=",t+="z=".concat(i.zoneAdjustments.map((e=>"".concat(e.time," ").concat(e.back?"-":""," ").concat(e.typedTime))).join(" ")).concat(this.eol),t+=this.eol)}return t}printKey(e){return e?"k=".concat(e).concat(this.eol):""}printAttributes(e){let t="";for(const i of e)t+="a=".concat(i.attField).concat(i.attValue?":".concat(i.attValue):"").concat(this.eol);return t}printMediaDescription(e){let t="";for(const i of e)t+=this.printMedia(i.media),t+=this.printInformation(i.information),t+=this.printConnections(i.connections),t+=this.printBandwidth(i.bandwidths),t+=this.printKey(i.key),t+=this.printMediaAttributes(i);return t}printConnections(e){let t="";for(const i of e)t+=this.printConnection(i);return t}printMedia(e){return"m=".concat(e.mediaType," ").concat(e.port," ").concat(e.protos.join("/")," ").concat(e.fmts.join(" ")).concat(this.eol)}printSessionAttributes(e){return new b(this.eol).print(e)}printMediaAttributes(e){return new O(this.eol).print(e)}}class N{constructor(e){w(this,"eol",void 0),this.eol=e}printIceUfrag(e){return void 0===e?"":"a=ice-ufrag:".concat(e).concat(this.eol)}printIcePwd(e){return void 0===e?"":"a=ice-pwd:".concat(e).concat(this.eol)}printIceOptions(e){return void 0===e?"":"a=ice-options:".concat(e.join(o)).concat(this.eol)}printFingerprints(e){return e.length>0?e.map((e=>"a=fingerprint:".concat(e.hashFunction).concat(o).concat(e.fingerprint))).join(this.eol)+this.eol:""}printExtmap(e){return e.map((e=>"a=extmap:".concat(e.entry).concat(e.direction?"/".concat(e.direction):"").concat(o).concat(e.extensionName).concat(e.extensionAttributes?"".concat(o).concat(e.extensionAttributes):"").concat(this.eol))).join("")}printSetup(e){return void 0===e?"":"a=setup:".concat(e).concat(this.eol)}printUnrecognized(e){return e.map((e=>"a=".concat(e.attField).concat(e.attValue?":".concat(e.attValue):"").concat(this.eol))).join("")}}class b extends N{print(e){let t="";return t+=this.printGroups(e.groups),t+=this.printMsidSemantic(e.msidSemantic),t+=this.printIceLite(e.iceLite),t+=this.printIceUfrag(e.iceUfrag),t+=this.printIcePwd(e.icePwd),t+=this.printIceOptions(e.iceOptions),t+=this.printFingerprints(e.fingerprints),t+=this.printSetup(e.setup),t+=this.printTlsId(e.tlsId),t+=this.printIdentity(e.identities),t+=this.printExtmap(e.extmaps),t+=this.printUnrecognized(e.unrecognized),t}printGroups(e){let t="";return e.length>0&&(t+=e.map((e=>"a=group:".concat(e.semantic).concat(e.identificationTag.map((e=>"".concat(o).concat(e))).join("")).concat(this.eol))).join("")),t}printIceLite(e){return void 0===e?"":"a=ice-lite"+this.eol}printTlsId(e){return e?"a=tls-id:".concat(e).concat(this.eol):""}printIdentity(e){return 0===e.length?"":e.map((e=>"a=identity:".concat(e.assertionValue).concat(e.extensions.map((e=>"".concat(o).concat(e.name).concat(e.value?"=".concat(e.value):"")))))).join(this.eol)+this.eol}printMsidSemantic(e){if(!e)return"";let t="a=msid-semantic:".concat(e.semantic);return e.applyForAll?t+="".concat(o,"*"):e.identifierList.length>0&&(t+=e.identifierList.map((e=>"".concat(o).concat(e)))),t+this.eol}}class O extends N{print(e){const t=e.attributes;let i="";return i+=this.printRTCP(t.rtcp),i+=this.printIceUfrag(t.iceUfrag),i+=this.printIcePwd(t.icePwd),i+=this.printIceOptions(t.iceOptions),i+=this.printCandidates(t.candidates),i+=this.printRemoteCandidatesList(t.remoteCandidatesList),i+=this.printEndOfCandidates(t.endOfCandidates),i+=this.printFingerprints(t.fingerprints),i+=this.printSetup(t.setup),i+=this.printMid(t.mid),i+=this.printExtmap(t.extmaps),i+=this.printRTPRelated(t),i+=this.printPtime(t.ptime),i+=this.printMaxPtime(t.maxPtime),i+=this.printDirection(t.direction),i+=this.printSSRCGroups(t.ssrcGroups),i+=this.printSSRC(t.ssrcs),i+=this.printRTCPMux(t.rtcpMux),i+=this.printRTCPMuxOnly(t.rtcpMuxOnly),i+=this.printRTCPRsize(t.rtcpRsize),i+=this.printMSId(t.msids),i+=this.printImageattr(t.imageattr),i+=this.printRid(t.rids),i+=this.printSimulcast(t.simulcast),i+=this.printSCTPPort(t.sctpPort),i+=this.printMaxMessageSize(t.maxMessageSize),i+=this.printUnrecognized(t.unrecognized),i}printCandidates(e){return e.map((e=>"a=candidate:".concat(e.foundation).concat(o).concat(e.componentId).concat(o).concat(e.transport).concat(o).concat(e.priority).concat(o).concat(e.connectionAddress).concat(o).concat(e.port).concat(o,"typ").concat(o).concat(e.type).concat(e.relAddr?"".concat(o,"raddr").concat(o).concat(e.relAddr):"").concat(e.relPort?"".concat(o,"rport").concat(o).concat(e.relPort):"").concat(Object.keys(e.extension).map((t=>"".concat(o).concat(t).concat(o).concat(e.extension[t]))).join("")).concat(this.eol))).join("")}printRemoteCandidatesList(e){return e.map((e=>"a=remote-candidates:".concat(e.join(o)).concat(this.eol))).join("")}printEndOfCandidates(e){return void 0===e?"":"a=end-of-candidates"+this.eol}printRTPRelated(e){if(!e.payloads)return"";const t=e.payloads;let i="";i+=e.rtcpFeedbackWildcards.map((e=>this.printRTCPFeedback("*",e))).join("");for(const e of t)i+=this.printRtpMap(e.payloadType,e.rtpMap),i+=this.printFmtp(e.payloadType,e.fmtp),i+=e.rtcpFeedbacks.map((t=>this.printRTCPFeedback(e.payloadType,t))).join("");return i}printFmtp(e,t){if(!t)return"";const i=Object.keys(t.parameters);return 1===i.length&&null===t.parameters[i[0]]?"a=fmtp:".concat(e).concat(o).concat(i[0]).concat(this.eol):"a=fmtp:".concat(e).concat(o).concat(Object.keys(t.parameters).map((e=>"".concat(e,"=").concat(t.parameters[e]))).join(";")).concat(this.eol)}printRtpMap(e,t){return t?"a=rtpmap:".concat(e).concat(o).concat(t.encodingName,"/").concat(t.clockRate).concat(t.encodingParameters?"/".concat(t.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(e,t){let i="a=rtcp-fb:".concat(e).concat(o),n=t;return"trr-int"===n.type?i+="ttr-int".concat(o).concat(n.interval):(i+="".concat(n.type),n.parameter&&(i+="".concat(o).concat(n.parameter),n.additional&&(i+="".concat(o).concat(n.additional)))),i+this.eol}printPtime(e){return void 0===e?"":"a=ptime:".concat(e).concat(this.eol)}printMaxPtime(e){return void 0===e?"":"a=maxptime:".concat(e).concat(this.eol)}printDirection(e){return void 0===e?"":"a=".concat(e).concat(this.eol)}printSSRC(e){return e.map((e=>Object.keys(e.attributes).map((t=>"a=ssrc:".concat(e.ssrcId.toString(10)).concat(o).concat(t).concat(e.attributes[t]?":".concat(e.attributes[t]):"").concat(this.eol))).join(""))).join("")}printRTCPMux(e){return void 0===e?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(e){return void 0===e?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(e){return void 0===e?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(e){if(void 0===e)return"";let t="a=rtcp:".concat(e.port);return e.netType&&(t+="".concat(o).concat(e.netType)),e.addressType&&(t+="".concat(o).concat(e.addressType)),e.address&&(t+="".concat(o).concat(e.address)),t+this.eol}printMSId(e){return e.map((e=>"a=msid:".concat(e.id).concat(e.appdata?"".concat(o).concat(e.appdata):"").concat(this.eol))).join("")}printImageattr(e){return e.map((e=>"a=imageattr:".concat(e).concat(this.eol))).join("")}printRid(e){return e.map((e=>{let t="a=rid:".concat(e.id).concat(o).concat(e.direction);return e.payloads&&(t+="".concat(o,"pt=").concat(e.payloads.join(","))),e.params.length>0&&(t+="".concat(o).concat(e.params.map((e=>"depend"===e.type?"depend=".concat(e.rids.join(",")):"".concat(e.type,"=").concat(e.val))).join(";"))),t+this.eol})).join("")}printSimulcast(e){return void 0===e?"":"a=simulcast:".concat(e).concat(this.eol)}printSCTPPort(e){return void 0===e?"":"a=sctp-port:".concat(e).concat(this.eol)}printMaxMessageSize(e){return void 0===e?"":"a=max-message-size:".concat(e).concat(this.eol)}printMid(e){return void 0===e?"":"a=mid:".concat(e).concat(this.eol)}printSSRCGroups(e){return e.map((e=>"a=ssrc-group:".concat(e.semantic).concat(e.ssrcIds.map((e=>"".concat(o).concat(e.toString(10)))).join("")).concat(this.eol))).join("")}}function D(e){return(new g).parse(e)}function P(e,t){return(new y).print(e,t)}}},t={};function i(n){if(t[n])return t[n].exports;var s=t[n]={exports:{}};return e[n](s,s.exports,i),s.exports}return i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i(8)})();function Us(e){if(Array.isArray(e))return e.map((e=>e));if(!xs(e))return e;const t={};for(const i in e){const n=e[i];xs(n)||Array.isArray(n)?t[i]=Us(n):t[i]=n}return t}function xs(e){return!("object"!=typeof e||Array.isArray(e)||!e)}class Vs{constructor(e){this.input=[],this.size=void 0,this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return 0===this.input.length?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const Fs={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},Bs={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:Fs,remoteCandidate:Fs}},Gs={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0},js={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},Ws={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},Hs={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};class Ks{constructor(e,t){this.onFirstVideoReceived=void 0,this.onFirstVideoDecoded=void 0,this.onFirstAudioReceived=void 0,this.onFirstVideoDecodedTimeout=void 0,this.onFirstAudioDecoded=void 0,this.onSelectedLocalCandidateChanged=void 0,this.onSelectedRemoteCandidateChanged=void 0,this.videoIsReady=!1,this.videoIsReady2={},this.pc=void 0,this.options=void 0,this.intervalTimer=void 0,this.stats=Us(Bs),this.isFirstVideoReceived={},this.isFirstVideoDecoded={},this.isFirstAudioReceived={},this.isFirstAudioDecoded={},this.isFirstVideoDecodedTimeout={},this.lossRateWindowStats=[],this.pc=e,this.options=t,this.intervalTimer=window.setInterval((async()=>{this.updateStats()}),this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new Promise((e=>{e({local:Zt({},Fs),remote:Zt({},Fs)})}))}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,t){this.videoIsReady2[e]=t}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const t=this.lossRateWindowStats.length,i=["videoSend","audioSend","videoRecv","audioRecv"];let n=0,s=0,o=0,a=0;for(const r of i)e[r].forEach(((e,i)=>{if(!this.lossRateWindowStats[t-1][r][i]||!this.lossRateWindowStats[0][r][i])return;const c=this.lossRateWindowStats[t-1][r][i].packets-this.lossRateWindowStats[0][r][i].packets,d=this.lossRateWindowStats[t-1][r][i].packetsLost-this.lossRateWindowStats[0][r][i].packetsLost;"videoSend"===r||"audioSend"===r?(n+=c,o+=d):(s+=c,a+=d),Number.isNaN(c)||Number.isNaN(c)?e.packetLostRate=0:e.packetLostRate=c<=0||d<=0?0:d/(c+d)}));e.sendPacketLossRate=n<=0||o<=0?0:o/(n+o),e.recvPacketLossRate=s<=0||a<=0?0:a/(s+a)}}class qs extends Ks{constructor(){super(...arguments),this._stats=Bs,this.lastDecodeVideoReceiverStats=new Map}async updateStats(){const e=await this._getStats(),t=this.statsResponsesToObjects(e);this._stats=Us(Bs);const i=t.filter((e=>"ssrc"===e.type));this.processSSRCStats(i);const n=t.find((e=>"VideoBwe"===e.type));n&&this.processBandwidthStats(n),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach((e=>{const t=e.id.includes("send");switch("".concat(e.mediaType,"_").concat(t?"send":"recv")){case"video_send":{const t=Us(js);t.codec=e.googCodecName,t.adaptionChangeReason="none",e.googCpuLimitedResolution&&(t.adaptionChangeReason="cpu"),e.googBandwidthLimitedResolution&&(t.adaptionChangeReason="bandwidth"),t.avgEncodeMs=Number(e.googAvgEncodeMs),t.inputFrame={width:Number(e.googFrameWidthInput)||Number(e.googFrameWidthSent),height:Number(e.googFrameHeightInput)||Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.sentFrame={width:Number(e.googFrameWidthSent),height:Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.firsCount=Number(e.googFirReceived),t.nacksCount=Number(e.googNacksReceived),t.plisCount=Number(e.googPlisReceived),t.frameCount=Number(e.framesEncoded),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.videoSend.push(t),this._stats.rtt=t.rttMs;break}case"video_recv":{const t=Us(Gs),i=this.lastDecodeVideoReceiverStats.get(Number(e.ssrc));if(t.codec=e.googCodecName,t.targetDelayMs=Number(e.googTargetDelayMs),t.renderDelayMs=Number(e.googRenderDelayMs),t.currentDelayMs=Number(e.googCurrentDelayMs),t.minPlayoutDelayMs=Number(e.googMinPlayoutDelayMs),t.decodeMs=Number(e.googDecodeMs),t.maxDecodeMs=Number(e.googMaxDecodeMs),t.receivedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateReceived)},t.decodedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateDecoded)},t.decodeFrameRate=Number(e.googFrameRateDecoded),t.outputFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateOutput)},t.jitterBufferMs=Number(e.googJitterBufferMs),t.firsCount=Number(e.googFirsSent),t.nacksCount=Number(e.googNacksSent),t.plisCount=Number(e.googPlisSent),t.framesDecodeCount=Number(e.framesDecoded),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,t.decodedFrame.width,t.decodedFrame.height),this.isFirstVideoDecoded[t.ssrc]=!0),i){const n=i.stats,s=Date.now()-i.lts;t.framesDecodeFreezeTime=n.framesDecodeFreezeTime,t.framesDecodeInterval=n.framesDecodeInterval,t.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(i.lts=Date.now(),t.framesDecodeInterval=s,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc,10))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<i.stats.framesDecodeCount&&(t.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:Zt({},t),lts:Date.now()}),this._stats.videoRecv.push(t);break}case"audio_recv":{const t=Us(Hs);t.codec=e.googCodecName,t.outputLevel=Math.abs(Number(e.audioOutputLevel))/32767,t.decodingCNG=Number(e.googDecodingCNG),t.decodingCTN=Number(e.googDecodingCTN),t.decodingCTSG=Number(e.googDecodingCTSG),t.decodingNormal=Number(e.googDecodingNormal),t.decodingPLC=Number(e.googDecodingPLC),t.decodingPLCCNG=Number(e.googDecodingPLCCNG),t.expandRate=Number(e.googExpandRate),t.accelerateRate=Number(e.googAccelerateRate),t.preemptiveExpandRate=Number(e.googPreemptiveExpandRate),t.secondaryDecodedRate=Number(e.googSecondaryDecodedRate),t.speechExpandRate=Number(e.googSpeechExpandRate),t.preferredJitterBufferMs=Number(e.googPreferredJitterBufferMs),t.jitterBufferMs=Number(e.googJitterBufferMs),t.jitterMs=Number(e.googJitterReceived),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.receivedFrames=Number(e.googDecodingCTN)||Number(e.packetsReceived),t.droppedFrames=Number(e.googDecodingPLC)+Number(e.googDecodingPLCCNG)||Number(e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.decodingNormal>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),this._stats.audioRecv.push(t);break}case"audio_send":{const t=Us(Ws);t.codec=e.googCodecName,t.inputLevel=Math.abs(Number(e.audioInputLevel))/32767,t.aecReturnLoss=Number(e.googEchoCancellationReturnLoss||0),t.aecReturnLossEnhancement=Number(e.googEchoCancellationReturnLossEnhancement||0),t.residualEchoLikelihood=Number(e.googResidualEchoLikelihood||0),t.residualEchoLikelihoodRecentMax=Number(e.googResidualEchoLikelihoodRecentMax||0),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.rtt=t.rttMs,this._stats.audioSend.push(t);break}}}))}_getStats(){return new Promise(((e,t)=>{this.pc.getStats(e,t)}))}statsResponsesToObjects(e){const t=[];return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp.valueOf().toString(),type:e.type};e.names().forEach((t=>{i[t]=e.stat(t)})),t.push(i)})),t}}class Ys extends Ks{constructor(){super(...arguments),this._stats=Bs,this.report=void 0,this.lastDecodeVideoReceiverStats=new Map,this.lastVideoFramesRecv=new Map,this.lastVideoFramesSent=new Map,this.lastVideoFramesDecode=new Map,this.lastVideoFramesOutput=new Map,this.lastVideoJBDelay=new Map,this.lastAudioJBDelay=new Map,this.mediaBytesSent=new Map,this.mediaBytesRetransmit=new Map,this.mediaBytesTargetEncode=new Map,this.lastEncoderMs=new Map}async updateStats(){this.report=await this.pc.getStats(),this._stats=Us(Bs),this.report.forEach((e=>{switch(e.type){case si.OUTBOUND:case si.INBOUND:{const t=e.mediaType||e.kind,i=!t&&"frameWidth"in e,n=!t&&!("frameWidth"in e);e.type===si.OUTBOUND?"audio"===t||n?this.processAudioOutboundStats(e):("video"===t||i)&&this.processVideoOutboundStats(e):e.type===si.INBOUND&&("audio"===t||n?this.processAudioInboundStats(e):("video"===t||i)&&this.processVideoInboundStats(e));break}case si.TRANSPORT:{const t=this.report.get(e.selectedCandidatePairId);t&&this.processCandidatePairStats(t);break}case si.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}})),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const e=await this.pc.getStats(),t={local:Zt({},Fs),remote:Zt({},Fs)};return e.forEach((i=>{let n;if(i.type===si.TRANSPORT&&(n=e.get(i.selectedCandidatePairId)),i.type===si.CANDIDATE_PAIR&&i.selected&&(n=i),n){const i=(e,t)=>{e.type=t.type,e.id=t.id,t.address&&(e.address=t.address),t.candidateType&&(e.candidateType=t.candidateType),t.port&&(e.port=t.port),t.priority&&(e.priority=t.priority),t.protocol&&(e.protocol=t.protocol),t.relayProtocol&&(e.relayProtocol=t.relayProtocol)};if(n.localCandidateId){const s=e.get(n.localCandidateId);s&&i(t.local,s)}if(n.remoteCandidateId){const s=e.get(n.remoteCandidateId);s&&i(t.remote,s)}}})),t}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.audioSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const t=this.report.get(e.localCandidateId);t&&this.processCandidateStats(t)}if(e.remoteCandidateId){const t=this.report.get(e.remoteCandidateId);t&&this.processCandidateStats(t)}}processCandidateStats(e){let t;e.type===si.LOCAL_CANDIDATE&&(t=this._stats.selectedCandidatePair.localCandidate),e.type===si.REMOTE_CANDIDATE&&(t=this._stats.selectedCandidatePair.remoteCandidate),t&&(t.type=e.type,t.id=e.id,e.address&&(t.address=e.address),e.candidateType&&(t.candidateType=e.candidateType),e.port&&(t.port=e.port),e.priority&&(t.priority=e.priority),e.protocol&&(t.protocol=e.protocol),e.relayProtocol&&(t.relayProtocol=e.relayProtocol),e.type===si.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==t.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(Zt({},t),Zt({},this.stats.selectedCandidatePair.localCandidate)),e.type===si.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==t.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(Zt({},t),Zt({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let t=this._stats.audioRecv.find((t=>t.ssrc===e.ssrc));t||(t=Us(Hs),this._stats.audioRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.jitterMs=1e3*e.jitter,this.processAudioTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),t.receivedFrames||(t.receivedFrames=e.packetsReceived),t.droppedFrames||(t.droppedFrames=e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.outputLevel&&t.outputLevel>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),"number"==typeof e.concealedSamples&&(t.concealedSamples=e.concealedSamples)}processVideoInboundStats(e){let t=this._stats.videoRecv.find((t=>t.ssrc===e.ssrc));t||(t=Us(Gs),this._stats.videoRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.framesDecodeCount=e.framesDecoded,t.framesDroppedCount=e.framesDropped,t.totalInterFrameDelay=e.totalInterFrameDelay,t.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay,t.totalFreezesDuration=e.totalFreezesDuration;const i=this.lastDecodeVideoReceiverStats.get(t.ssrc),n=this.lastVideoFramesDecode.get(t.ssrc),s=this.lastVideoFramesOutput.get(t.ssrc),o=Date.now();if(t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]){const e=t.decodedFrame?t.decodedFrame.width:0,i=t.decodedFrame?t.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,e,i),this.isFirstVideoDecoded[t.ssrc]=!0}if(i){const n=i.stats,s=o-i.lts;t.framesDecodeFreezeTime=n.framesDecodeFreezeTime,t.framesDecodeInterval=n.framesDecodeInterval,!this.isFirstVideoDecoded[t.ssrc]&&s>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[t.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(t.ssrc),this.isFirstVideoDecodedTimeout[t.ssrc]=!0),t.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(i.lts=Date.now(),t.framesDecodeInterval=s,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<n.framesDecodeCount&&(t.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(i.stats.framesDecodeCount>e.framesDecoded?t.qpSumPerFrame=e.qpSum/e.framesDecoded:t.qpSumPerFrame=(e.qpSum-i.qpSum)/(e.framesDecoded-i.stats.framesDecodeCount))}n&&o-n.lts>=800?(t.decodeFrameRate=Math.round((t.framesDecodeCount-n.count)/((o-n.lts)/1e3)),this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:o,rate:t.decodeFrameRate})):n?t.decodeFrameRate=n.rate:this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:o,rate:0}),t.framesDroppedCount&&e.framesReceived&&(s&&o-s.lts>=800?(t.outputFrameRate=Math.round((e.framesReceived-t.framesDroppedCount-s.count)/((o-s.lts)/1e3)),this.lastVideoFramesOutput.set(t.ssrc,{count:e.framesReceived-t.framesDroppedCount,lts:o,rate:Math.max(t.outputFrameRate,0)})):s?t.outputFrameRate=s.rate:this.lastVideoFramesOutput.set(t.ssrc,{count:e.framesReceived-t.framesDroppedCount,lts:o,rate:0})),e.totalDecodeTime&&(t.decodeMs=1e3*e.totalDecodeTime),this.processVideoTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(t.framesRateFirefox=e.framerateMean),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:Zt({},t),lts:i?i.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let t=this._stats.videoSend.find((t=>t.ssrc===e.ssrc));t||(t=Us(js),this._stats.videoSend.push(t));const i=this.mediaBytesSent.get(e.ssrc);if(i)i.add(e.bytesSent);else{const t=new Vs(10);t.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,t)}if(void 0!==e.retransmittedBytesSent){const t=this.mediaBytesRetransmit.get(e.ssrc);if(t)t.add(e.retransmittedBytesSent);else{const t=new Vs(10);t.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,t)}}if(e.totalEncodedBytesTarget){const t=this.mediaBytesTargetEncode.get(e.ssrc);if(t)t.add(e.totalEncodedBytesTarget);else{const t=new Vs(10);t.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,t)}}if(t.ssrc=e.ssrc,t.bytes=e.bytesSent,t.packets=e.packetsSent,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.frameCount=e.framesEncoded,t.adaptionChangeReason=e.qualityLimitationReason,t.scalabilityMode=e.scalabilityMode,e.totalEncodeTime&&e.framesEncoded){const i=this.lastEncoderMs.get(e.ssrc);if(!i||i.lastFrameCount>e.framesEncoded)t.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const n=e.framesEncoded-i.lastFrameCount,s=e.totalEncodeTime-i.lastEncoderTime;t.avgEncodeMs=1e3*s/n}}if(e.framesEncoded&&e.qpSum){const i=this.lastEncoderMs.get(e.ssrc);!i||i.lastFrameCount>e.framesEncoded?t.qpSumPerFrame=e.qpSum/e.framesEncoded:t.qpSumPerFrame=(e.qpSum-i.lastQpSum)/(e.framesEncoded-i.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,t),this.processVideoTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const i=this.findRemoteStatsId(e.ssrc,si.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,t)}}processAudioOutboundStats(e){let t=this._stats.audioSend.find((t=>t.ssrc===e.ssrc));if(t||(t=Us(Ws),this._stats.audioSend.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsSent,t.bytes=e.bytesSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const i=this.findRemoteStatsId(e.ssrc,si.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,t)}}findRemoteStatsId(e,t){const i=Array.from(this.report.values()).find((i=>i.type===t&&i.ssrc===e));return i?i.id:null}processVideoMediaSource(e,t){const i=this.report.get(e);i&&i.width&&i.height&&i.framesPerSecond&&(t.inputFrame={width:i.width,height:i.height,frameRate:i.framesPerSecond})}processAudioMediaSource(e,t){const i=this.report.get(e);i&&(t.inputLevel=i.audioLevel)}processVideoTrackSenderStats(e,t,i){var n,s,o,a;const r=t?this.report.get(t):void 0,c=null!==(n=null==r?void 0:r.framesSent)&&void 0!==n?n:e.framesSent;if("number"!=typeof c)return;let d=null!==(s=null==r?void 0:r.frameWidth)&&void 0!==s?s:e.frameWidth,h=null!==(o=null==r?void 0:r.frameHeight)&&void 0!==o?o:e.frameHeight,l=null!==(a=null==r?void 0:r.framesPerSecond)&&void 0!==a?a:e.framesPerSecond;if("number"==typeof d&&"number"==typeof h||(d=0,h=0),null==l){const e=Date.now(),t=this.lastVideoFramesSent.get(i.ssrc);t&&e-t.lts>=800?(l=Math.round((c-t.count)/((e-t.lts)/1e3)),this.lastVideoFramesSent.set(i.ssrc,{count:c,lts:e,rate:l})):t?l=t.rate:this.lastVideoFramesSent.set(i.ssrc,{count:c,lts:e,rate:0})}i.sentFrame={width:d,height:h,frameRate:Math.max(0,l)}}processVideoTrackReceiverStats(e,t,i){var n,s,o,a,r;const c=t?this.report.get(t):void 0,d=null!==(n=null==c?void 0:c.framesReceived)&&void 0!==n?n:e.framesReceived,h=null!==(s=null==c?void 0:c.frameWidth)&&void 0!==s?s:e.frameWidth,l=null!==(o=null==c?void 0:c.frameHeight)&&void 0!==o?o:e.frameHeight,u=null!==(a=null==c?void 0:c.jitterBufferDelay)&&void 0!==a?a:e.jitterBufferDelay,p=null!==(r=null==c?void 0:c.jitterBufferEmittedCount)&&void 0!==r?r:e.jitterBufferEmittedCount;if("number"==typeof d){const e=this.lastVideoFramesRecv.get(i.ssrc),t=Date.now();i.framesReceivedCount=d;let n=0;e&&t-e.lts>=800?(n=Math.round((d-e.count)/((t-e.lts)/1e3)),this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:t,rate:n})):e?n=e.rate:this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:t,rate:0}),i.receivedFrame={width:h||0,height:l||0,frameRate:n||0},i.decodedFrame={width:h||0,height:l||0,frameRate:i.decodeFrameRate||0},i.outputFrame={width:h||0,height:l||0,frameRate:i.outputFrameRate||i.decodeFrameRate||0}}if(u&&p){const e=this.lastVideoJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let t=e.jitterBufferMs;const n=p-e.jitterBufferEmittedCount;n>0&&(t=1e3*(u-e.jitterBufferDelay)/n),i.jitterBufferMs=t,i.currentDelayMs=Math.round(t),this.lastVideoJBDelay.set(i.ssrc,{jitterBufferDelay:u,jitterBufferEmittedCount:p,jitterBufferMs:i.currentDelayMs})}}processAudioTrackSenderStats(e,t,i){var n,s,o,a;const r=t?this.report.get(t):void 0,c=null!==(n=null!==(s=null==r?void 0:r.echoReturnLoss)&&void 0!==s?s:e.echoReturnLoss)&&void 0!==n?n:0,d=null!==(o=null!==(a=null==r?void 0:r.echoReturnLossEnhancement)&&void 0!==a?a:e.echoReturnLossEnhancement)&&void 0!==o?o:0;i.aecReturnLoss=c,i.aecReturnLossEnhancement=d}processAudioTrackReceiverStats(e,t,i){var n,s,o,a,r,c,d;const h=t?this.report.get(t):void 0,l=null!==(n=null==h?void 0:h.removedSamplesForAcceleration)&&void 0!==n?n:e.removedSamplesForAcceleration,u=null!==(s=null==h?void 0:h.totalSamplesReceived)&&void 0!==s?s:e.totalSamplesReceived,p=null!==(o=null==h?void 0:h.jitterBufferDelay)&&void 0!==o?o:e.jitterBufferDelay,_=null!==(a=null==h?void 0:h.jitterBufferEmittedCount)&&void 0!==a?a:e.jitterBufferEmittedCount,E=null!==(r=null==h?void 0:h.audioLevel)&&void 0!==r?r:null==e?void 0:e.audioLevel,m=null!==(c=null==h?void 0:h.totalSamplesDuration)&&void 0!==c?c:null==e?void 0:e.totalSamplesDuration,S=null!==(d=null==h?void 0:h.concealedSamples)&&void 0!==d?d:e.concealedSamples;if(l&&u&&(i.accelerateRate=l/u),p&&_){const e=this.lastAudioJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let t=e.jitterBufferMs;const n=_-e.jitterBufferEmittedCount;n>0&&(t=1e3*(p-e.jitterBufferDelay)/n),i.jitterBufferMs=Math.round(t),this.lastAudioJBDelay.set(i.ssrc,{jitterBufferDelay:p,jitterBufferEmittedCount:_,jitterBufferMs:i.jitterBufferMs})}i.outputLevel=E;let T=1920;m&&u&&(T=u/m/50,i.receivedFrames=Math.round(u/T)),S&&(i.droppedFrames=Math.round(S/T))}processRemoteInboundStats(e,t){const i=this.report.get(e);i&&(t.packetsLost=i.packetsLost,i.roundTripTime&&(t.rttMs=1e3*i.roundTripTime),i.jitter&&(t.jitterMs=1e3*i.jitter),i.timestamp&&(t.timestamp=i.timestamp))}getCodecFromCodecStats(e){const t=this.report.get(e);if(!t)return"";const i=t.mimeType.match(/\/(.*)$/);return i&&i[1]?i[1]:""}updateSendBitrate(){let e=0,t=null,i=null;this.mediaBytesSent.forEach((t=>{e+=t.diffMean()})),this.mediaBytesRetransmit.forEach((e=>{t=null===t?e.diffMean():t+e.diffMean()})),this.mediaBytesTargetEncode.forEach((e=>{i=null===i?e.diffMean():i+e.diffMean()}));const n=null!==t?e-t:e;this._stats.bitrate={actualEncoded:8*n/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},null!==t&&(this._stats.bitrate.retransmit=8*t/(this.options.updateInterval/1e3)),null!==i&&(this._stats.bitrate.targetEncoded=8*i/(this.options.updateInterval/1e3))}}class Js extends Ks{updateStats(){return Promise.resolve()}}function Xs(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e4;const o=function(){const e=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return e&&e[0]?Number(e[0].split("/")[1]):null}();return o?o<76?new qs(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new Ys(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):function(e){return!!window.RTCStatsReport&&e.getStats()instanceof Promise}(e)?new Ys(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new Js(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s})}function zs(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0;const{filterRTX:s,filterVideoFec:o,filterAudioFec:a,filterAudioCodec:r,filterVideoCodec:c}=t,{useXR:d}=i;let h=[],l=[],u=[],p=[],_=!1,E=!1;if(Ms.parse(e).mediaDescriptions.forEach((e=>{n&&n!==e.attributes.direction||("video"!==e.media.mediaType||_||(l=e.attributes.payloads,p=e.attributes.extmaps,_=!0),"audio"!==e.media.mediaType||E||(h=e.attributes.payloads,u=e.attributes.extmaps,E=!0))})),!p||0===l.length)throw new Error("Cannot get video capabilities from SDP.");if(!u||0===h.length)throw new Error("Cannot get audio capabilities from SDP.");if(l.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),d&&e.rtcpFeedbacks.push({type:"rrtr"})})),h.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),d&&e.rtcpFeedbacks.push({type:"rrtr"})})),s&&(h=h.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})),l=l.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())}))),o&&(l=l.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),a&&(h=h.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),r&&(null==r?void 0:r.length)>0&&(h=h.filter((e=>{var t;return r.includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}))),c&&(null==c?void 0:c.length)>0){const e=l.filter((e=>{var t;return c.includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}));l=e.concat(s?[]:Eo(e,l))}const m=f("UNSUPPORTED_VIDEO_CODEC");return m&&m.length>0&&(l=l.filter((e=>!(e.rtpMap&&m.includes(e.rtpMap.encodingName.toLowerCase()))))),{audioCodecs:h,videoCodecs:l,audioExtensions:u,videoExtensions:p}}function Qs(e){const t=Ms.parse(e);let i,n;for(const e of t.mediaDescriptions){if(!i){const t=e.attributes.iceUfrag,n=e.attributes.icePwd;if(!t||!n)throw new Error("Cannot get iceUfrag or icePwd from SDP.");i={iceUfrag:t,icePwd:n}}if(!n){const t=e.attributes.fingerprints;t.length>0&&(n={fingerprints:t})}}if(!n&&t.attributes.fingerprints.length>0&&(n={fingerprints:t.attributes.fingerprints}),!n||!i)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:i,dtlsParameters:n}}function Zs(e,t){const i=[],n=e.attributes.ssrcGroups.filter((e=>"FID"===e.semantic)),s=e.attributes.ssrcGroups.find((e=>"SIM"===e.semantic)),o=e.attributes.ssrcs;if(s)s.ssrcIds.forEach((e=>{var s;const o=null===(s=n.find((t=>t.ssrcIds[0]===e)))||void 0===s?void 0:s.ssrcIds[1];i.push({ssrcId:e,rtx:t?o:void 0})}));else if(n.length>0){const e=n[0].ssrcIds[0],s=n[0].ssrcIds[1];i.push({ssrcId:e,rtx:t?s:void 0})}else{if(0===o.length)throw new Error("No ssrcs found on local media description.");i.push({ssrcId:o[0].ssrcId})}return i}function $s(e,i){const{cname:n}=e;let s;i&&i.ip&&"number"==typeof i.port?(s=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:i.ip,port:i.port.toString(),type:"host",extension:{}}],t.debug("Using remote candidate from AP ".concat(i.ip,":").concat(i.port)),i.ip6&&(s.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:i.ip6,port:i.port.toString(),type:"host",extension:{}}),t.debug("Using IPV6 remote candidate from AP ".concat(i.ip6,":").concat(i.port)))):s=e.iceParameters.candidates.map((e=>({foundation:e.foundation,componentId:"1",transport:e.protocol,priority:e.priority.toString(),connectionAddress:e.ip,port:e.port.toString(),type:e.type,extension:{}})));const o={fingerprints:e.dtlsParameters.fingerprints.map((e=>({hashFunction:e.algorithm,fingerprint:e.fingerprint})))},a={iceUfrag:e.iceParameters.iceUfrag,icePwd:e.iceParameters.icePwd};let r;switch(e.dtlsParameters.role){case"server":r="passive";break;case"client":r="active";break;case"auto":r="actpass"}return{dtlsParameters:o,iceParameters:a,candidates:s,rtpCapabilities:lo(e.rtpCapabilities),setup:r,cname:n}}function eo(e,t,i){const n=[],s=[];return e.forEach((e=>{let{ssrcId:o,rtx:a}=e;const r=M(8,"track-"),c={ssrcId:o,attributes:Zt({label:r,mslabel:i=i||M(10,""),msid:"".concat(i," ").concat(r)},t&&{cname:t})};if(n.push(c),void 0!==a){const e={ssrcId:a,attributes:Zt({label:r,mslabel:i,msid:"".concat(i," ").concat(r)},t&&{cname:t})};n.push(e),s.push({semantic:"FID",ssrcIds:[o,a]})}})),e.length>1&&s.push({semantic:"SIM",ssrcIds:e.map((e=>{let{ssrcId:t}=e;return t}))}),{ssrcs:n,ssrcGroups:s}}function to(e,t){t instanceof Ze&&e.attributes.payloads.forEach((e=>{var i;const n=null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase();if(!n||-1===["opus","pcmu","pcma","g722"].indexOf(n))return;e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.minptime="10",e.fmtp.parameters.useinbandfec="1";const s=t._encoderConfig;s&&"pcmu"!==n&&"pcma"!==n&&"g722"!==n&&(s.bitrate&&!I()&&(e.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*s.bitrate))),s.sampleRate&&(e.fmtp.parameters.maxplaybackrate="".concat(s.sampleRate),e.fmtp.parameters["sprop-maxcapturerate"]="".concat(s.sampleRate)),s.stereo&&(e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"))}))}function io(e){const t=e.attributes.unrecognized.findIndex((e=>"x-google-flag"===e.attField&&"conference"===e.attValue));-1!==t&&e.attributes.unrecognized.splice(t,1)}function no(e,t){if(!(t instanceof $e&&t._encoderConfig&&-1===t._hints.indexOf(et.SCREEN_TRACK)))return;const i=t._encoderConfig;tt().supportMinBitrate&&i.bitrateMin&&e.attributes.payloads.forEach((e=>{var t;["h264","h265","vp8","vp9","av1"].includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-min-bitrate"]="".concat(i.bitrateMin))})),tt().supportMinBitrate&&!t._hints.includes(et.LOW_STREAM)&&i.bitrateMax&&e.attributes.payloads.forEach((e=>{var t;["h264","h265","vp8","vp9","av1"].includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-start-bitrate"]="".concat(f("X_GOOGLE_START_BITRATE")||Math.floor(i.bitrateMax)))}))}function so(e){if("video"!==e.media.mediaType)return;const t=Z();if(t.name!==ee.SAFARI&&t.os!==te.IOS)return;const i=e.attributes.extmaps.findIndex((e=>/video-orientation/g.test(e.extensionName)));-1!==i&&e.attributes.extmaps.splice(i,1)}function oo(e,t,i){if(!t)return;let n,s;if("video"===e.media.mediaType?(n=i.videoExtensions,s=i.videoCodecs):(n=i.audioExtensions,s=i.audioCodecs),!0===t.twcc){const t=n.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));if(t){e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"});const i=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))))))}(s,e.attributes.payloads);i.forEach((e=>{e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))||e.rtcpFeedbacks.push({type:"transport-cc"})}))}}else if(!1===t.twcc){const t=e.attributes.extmaps.findIndex((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}if(!0===t.remb){const t=n.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));if(t){e.attributes.extmaps.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"});const i=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))))))}(s,e.attributes.payloads);i.forEach((e=>{e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))||e.rtcpFeedbacks.push({type:"goog-remb"})}))}}else if(!1===t.remb){const t=e.attributes.extmaps.findIndex((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"goog-remb"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}}function ao(e,t,i){if(I())return;if("video"!==e.media.mediaType)return;if(!(t instanceof $e))return;if("vp9"!==i&&"vp8"!==i)return;if("vp8"===i&&!f("SIMULCAST"))return;if(void 0===t._scalabilityMode||t._scalabilityMode.numSpatialLayers<=1)return;const n="vp8"===i?2:t._scalabilityMode.numSpatialLayers,s=e.attributes.ssrcs[0],o=e.attributes.ssrcGroups.find((e=>"FID"===e.semantic&&e.ssrcIds[0]===s.ssrcId)),a={semantic:"SIM",ssrcIds:[s.ssrcId]};for(let t=1;t<n;t++)e.attributes.ssrcs.push({ssrcId:s.ssrcId+t,attributes:$(s.attributes)}),a.ssrcIds.push(s.ssrcId+t),o&&(e.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+t,attributes:$(s.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[s.ssrcId+t,o.ssrcIds[1]+t]}));e.attributes.ssrcGroups.unshift(a)}async function ro(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=new RTCPeerConnection;n.addTransceiver("video",{direction:"sendonly"}),n.addTransceiver("audio",{direction:"sendonly"}),n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});const s=(await n.createOffer()).sdp,{send:o,recv:a,sendrecv:r}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0;const s=zs(n,e,i,"sendonly"),o=zs(n,e,i,"recvonly"),a={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},c={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(ho(s,o,"videoExtensions",a,r,c),ho(s,o,"videoCodecs",a,r,c),ho(s,o,"audioExtensions",a,r,c),ho(s,o,"audioCodecs",a,r,c),f("RAISE_H264_BASELINE_PRIORITY")){const e=c.videoCodecs.findIndex((e=>{var t,i;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"===(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"])}));if(-1!==e){const i=c.videoCodecs.findIndex((e=>{var t;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())}));if(i<e){t.debug("raising H264 baseline profile priority");const n=c.videoCodecs[e];c.videoCodecs.splice(e,1),c.videoCodecs.splice(i,0,n)}-1!==i&&(r.videoCodecs=r.videoCodecs.filter((e=>{var t,i;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))}))),-1!==i&&f("FILTER_SEND_H264_BASELINE")&&(a.videoCodecs=a.videoCodecs.filter((e=>{var t,i;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))})))}}return{send:a,recv:r,sendrecv:c}}(e,i,s);try{n.close()}catch(e){}return{send:o,recv:a,sendrecv:r}}function co(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},i=zs(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"recvonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(ho(e,i,"videoExtensions",n,s,o),ho(e,i,"videoCodecs",n,s,o),ho(e,i,"audioExtensions",n,s,o),ho(e,i,"audioCodecs",n,s,o),f("RAISE_H264_BASELINE_PRIORITY")){const e=o.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"===e.fmtp.parameters["profile-level-id"]));if(-1!==e){const i=o.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()));if(i<e){t.debug("raising H264 baseline profile priority");const n=o.videoCodecs[e];o.videoCodecs.splice(e,1),o.videoCodecs.splice(i,0,n)}-1!==i&&(s.videoCodecs=s.videoCodecs.filter((e=>!(e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"!==e.fmtp.parameters["profile-level-id"]))))}}return{send:n,recv:s,sendrecv:o}}function ho(e,t,i,n,s,o){if("videoExtensions"===i||"audioExtensions"===i){const a=[];return e[i].forEach((e=>{t[i].some(((t,i)=>{if(e.entry===t.entry&&e.extensionName===t.extensionName)return a.push(i),!0}))?o[i].push(e):n[i].push(e)})),void t[i].forEach(((e,t)=>{-1===a.indexOf(t)&&s[i].push(e)}))}if("videoCodecs"===i||"audioCodecs"===i){const a=[];return e[i].forEach((e=>{t[i].some(((t,i)=>{if(e.payloadType===t.payloadType&&JSON.stringify(e)===JSON.stringify(t))return a.push(i),!0}))?o[i].push(e):n[i].push(e)})),void t[i].forEach(((e,t)=>{-1===a.indexOf(t)&&s[i].push(e)}))}}function lo(e){const{send:t,recv:i,sendrecv:n}=e;if(!n){if(!t||!i)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:i}}let s,o;return t?(s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s.audioCodecs=[...t.audioCodecs,...n.audioCodecs],s.videoCodecs=[...t.videoCodecs,...n.videoCodecs],s.audioExtensions=[...t.audioExtensions,...n.audioExtensions],s.videoExtensions=[...t.videoExtensions,...n.videoExtensions]):s=n,i?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...i.audioCodecs,...n.audioCodecs],o.videoCodecs=[...i.videoCodecs,...n.videoCodecs],o.audioExtensions=[...i.audioExtensions,...n.audioExtensions],o.videoExtensions=[...i.videoExtensions,...n.videoExtensions]):o=n,{send:s,recv:o}}function uo(e){if("audio"!==e.media.mediaType)return;e.attributes.payloads.filter((e=>{var t;return"opus"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})).forEach((e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"}))}function po(e){e.mediaDescriptions.forEach((e=>{"video"!==e.media.mediaType&&"audio"!==e.media.mediaType||e.attributes.payloads.forEach((e=>{-1===e.rtcpFeedbacks.findIndex((e=>"rrtr"===e.type))&&e.rtcpFeedbacks.push({type:"rrtr"})}))}))}function _o(e,i,n,s){let o=[];if(e===Yi.VIDEO){if(f("H264_PROFILE_LEVEL_ID")&&"h264"===s&&(o=i.videoCodecs.filter((e=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes(s)&&e&&e.fmtp&&e.fmtp.parameters["profile-level-id"]===f("H264_PROFILE_LEVEL_ID")))),!Array.isArray(o)||0===o.length){let e=[];const a=[],r=[],c=[];if(n.videoCodecs.forEach((t=>{const i=t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"";i.includes(s)?e.push(t):i.includes("vp9")?a.push(t):i.includes("vp8")?r.push(t):i.includes("h264")&&c.push(t)})),0===e.length){let i="";0!==a.length?(e=a,i="vp9"):0!==r.length?(e=r,i="vp8"):0!==c.length&&(e=c,i="h264"),t.warning("codec ".concat(s," not included in rtpCapabilities, fallback to default payloads: ").concat(i))}0!==e.length&&(o=i.videoCodecs.filter((t=>e.some((e=>e.payloadType===t.payloadType)))))}if(0===o.length&&(t.warning("codec ".concat(s," not included in rtpCapabilities, fallback to default payloads: ").concat(i.videoCodecs[0].rtpMap&&i.videoCodecs[0].rtpMap.encodingName)),o=i.videoCodecs),f("USE_PUB_RTX")||f("USE_SUB_RTX")){const e=Eo(o,i.videoCodecs);o=[...o,...e]}}else o=i.audioCodecs.filter((e=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes(s))),0===o.length&&(t.warning("codec ".concat(s," not included in rtpCapabilities, fallback to opus")),o=i.audioCodecs.filter((e=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes("opus"))));return o}function Eo(e,t){const i=e.map((e=>e.payloadType.toString()));return t.filter((e=>e.rtpMap&&"rtx"===e.rtpMap.encodingName&&e.fmtp&&e.fmtp.parameters.apt&&i.includes(e.fmtp&&e.fmtp.parameters.apt)))}let mo=class{get localCapabilities(){return $(this._localCapabilities)}get rtpCapabilities(){return $(this._rtpCapabilities)}get candidates(){return $(this._candidates)}get iceParameters(){return $(this._iceParameters)}get dtlsParameters(){return $(this._dtlsParameters)}constructor(e){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname="o/i14u9pJrxRKAsu",this.firefoxSsrcMidMap=new Map,e=$(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,localCapabilities:o,direction:a,setup:r,videoCodec:c,audioCodec:d}=e;let h;this.setup=r,h=a===Ei.RECEIVE_ONLY?Ms.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"):Ms.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"),this._rtpCapabilities=s,this._candidates=n,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=o;const l=a===Ei.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,u=a===Ei.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,p=a===Ei.RECEIVE_ONLY?s.send.videoCodecs:_o(Yi.VIDEO,l,u,c),_=a===Ei.RECEIVE_ONLY?s.send.audioCodecs:_o(Yi.AUDIO,l,u,d);for(const e of h.mediaDescriptions)e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=i.fingerprints,e.attributes.candidates=n,e.attributes.setup=this.setup,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType&&(e.media.fmts=p.map((e=>e.payloadType.toString(10))),e.attributes.payloads=p,e.attributes.extmaps=l.videoExtensions),"audio"===e.media.mediaType&&(e.media.fmts=_.map((e=>e.payloadType.toString(10))),e.attributes.payloads=_,e.attributes.extmaps=l.audioExtensions,uo(e));this.sessionDesc=h,this.currentMidIndex=h.mediaDescriptions.length-1}toString(){return Ms.print(this.sessionDesc)}hasMid(e){return Array.isArray(e)?e.every((e=>this.hasMid(e))):this.sessionDesc.mediaDescriptions.some((t=>t.attributes.mid===e))}send(e,t,i,n,s){i=i.replace(/ /g,"-");const{ssrcs:o,ssrcGroups:a}=eo(t,this.cname,f("SYNC_GROUP")?i:void 0),r=this.findPreloadMediaDesc(o);if(r){if(I()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,r.attributes.mid),s&&(s.twcc||s.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(r);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(r,s),{mid:r.attributes.mid,needExchangeSDP:!0}}return{mid:r.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,o,n);let i;return-1===t?(i=this.createOrRecycleSendMedia(e,o,a,"sendonly",n,s),this.updateBundleMids()):(i=$(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=o,i.attributes.ssrcGroups=a,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,s)),I()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,i.attributes.mid),{needExchangeSDP:!0,mid:i.attributes.mid}}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{e.attributes.ssrcs=[]})),this.updateBundleMids()}receive(e,t,i){const n=[];return e.forEach((e=>{const s=e._mediaStreamTrack.kind,o=this.findAvailableRecvMediaIndex(s);let a,r=!1;-1===o?(r=!0,a=this.createOrRecycleRecvMedia(e,[],"recvonly",t,i),this.updateBundleMids()):(a=$(this.sessionDesc.mediaDescriptions[o]),a.attributes.direction="recvonly"),n.push({mid:a.attributes.mid,needCreateTransceiver:r})})),n}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}addRemoteCandidate(e){const{foundation:t,protocol:i,address:n,port:s,type:o,relatedAddress:a,relatedPort:r,priority:c}=new RTCIceCandidate(e),d={foundation:null!=t?t:"",componentId:"1",transport:null!=i?i:"",priority:c?c+"":"",connectionAddress:null!=n?n:"",port:s?s+"":"",type:o?o+"":"",relAddr:null!=a?a:"",relPort:r?r+"":"",extension:{}};this.candidates.some((e=>e.priority===d.priority&&e.connectionAddress===d.connectionAddress&&e.port===d.port))||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach((e=>{e.attributes.candidates=this.candidates})))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(e,t,i,n,s){const o=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,r=_o(o,a,this.localCapabilities.send,o===Yi.AUDIO?s:n),c=o===Yi.VIDEO?a.videoExtensions:a.audioExtensions,d="".concat(++this.currentMidIndex);let h={media:{mediaType:o,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:r.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:r,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};h=this.mungRecvMediaDsec(h,e);const l=this.findFirstClosedMedia(o);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}findAvailableMediaIndex(e,t,i){return this.sessionDesc.mediaDescriptions.findIndex((n=>{const s=n.media.mediaType===e&&"0"!==n.media.port&&("sendonly"===n.attributes.direction||"sendrecv"===n.attributes.direction)&&0===n.attributes.ssrcs.length;if(I()){if(s){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==n.attributes.mid&&"1"!==n.attributes.mid)||!(!e||e!==n.attributes.mid)}return!1}return s&&n.attributes.mid===i}))}findAvailableRecvMediaIndex(e){return this.sessionDesc.mediaDescriptions.findIndex((t=>{const i=t.media.mediaType===e&&"0"!==t.media.port&&("recvonly"===t.attributes.direction||"sendrecv"===t.attributes.direction);return"0"!==t.attributes.mid&&"1"!==t.attributes.mid&&i}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}restartICE(e){e=$(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}createOrRecycleSendMedia(e,t,i,n,s,o){const a=this.rtpCapabilities.send,r=e===Yi.VIDEO?a.videoCodecs:a.audioCodecs,c=e===Yi.VIDEO?a.videoExtensions:a.audioExtensions;I()&&(s="".concat(++this.currentMidIndex));let d={media:{mediaType:e,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:r.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:r,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:s}};d=this.mungSendMediaDesc(d,o);const h=this.findFirstClosedMedia(e);if(h){const e=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(e,t,i){const n=$(e);return io(n),to(n,t),no(n,t),so(n),oo(n,i,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const i=$(e);return oo(i,t,this.localCapabilities.recv),uo(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i;return(null===(i=t.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===e[0].ssrcId}))}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>I()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}};const So=["sdp"];var To;let Co=(To=class e extends Ki{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}get localCodecs(){return[]}set isInRestartIce(e){this._isInRestartIce=e}get isInRestartIce(){return this._isInRestartIce}constructor(t,i,n){super(t,i),this.direction=void 0,this.name=void 0,this.store=void 0,this.spec=void 0,this.peerConnection=void 0,this.initialOffer=void 0,this.transport=void 0,this.statsFilter=void 0,this.localCandidateCount=0,this._isInRestartIce=!1,this.mutex=new v("P2PConnection-mutex"),this.onLocalCandidate=void 0,this.remoteSDP=void 0,this.pendingCandidates=[],this.localCapabilities=void 0,this.isReady=!1,this.restartCnt=0,this.curTurnServerIndex=0,this.store=i,this.spec=t,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t,i.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=null!=n?n:Ei.SEND_ONLY,this.name=this.direction===Ei.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=Xs(this.peerConnection,f("STATS_UPDATE_INTERVAL"),void 0,I()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(e){try{const i=await ro();if(this.localCapabilities=lo(i),e){const{sdp:i}=e,n=ti(e,So),s=function(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},i=zs(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"sendonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(ho(i,e,"videoExtensions",n,s,o),ho(i,e,"videoCodecs",n,s,o),ho(i,e,"audioExtensions",n,s,o),ho(i,e,"audioCodecs",n,s,o),f("RAISE_H264_BASELINE_PRIORITY")){const e=o.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"===e.fmtp.parameters["profile-level-id"]));if(-1!==e){const i=o.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()));if(i<e){t.debug("raising H264 baseline profile priority");const n=o.videoCodecs[e];o.videoCodecs.splice(e,1),o.videoCodecs.splice(i,0,n)}-1!==i&&f("FILTER_SEND_H264_BASELINE")&&(n.videoCodecs=n.videoCodecs.filter((e=>!(e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"!==e.fmtp.parameters["profile-level-id"]))))}}return{send:n,recv:s,sendrecv:o}}({},{},i);this.remoteSDP=new mo({remoteIceParameters:n.iceParameters,remoteDtlsParameters:n.dtlsParameters,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const o=await this.peerConnection.createAnswer();if(!o.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const a=Qs(o.sdp);await this.peerConnection.setLocalDescription(o);const r=await co({},{},o.sdp);this.localCapabilities=lo(r);const c=this.peerConnection.getTransceivers()[0];return null!=c&&c.receiver&&c.receiver.transport&&this.tryBindTransportEvents(c.receiver.transport),Zt(Zt({},a),{},{sdp:o.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=Qs(e.sdp);return this.initialOffer=e,Zt(Zt({},t),{},{sdp:e.sdp})}}catch(e){throw new h(l.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:t,iceParameters:i,dtlsParameters:n}=e,s=await co({},{},t);this.remoteSDP=new mo({remoteIceParameters:i,remoteDtlsParameters:n,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const o=this.peerConnection.getTransceivers()[0];null!=o&&o.sender&&o.sender.transport&&this.tryBindTransportEvents(o.sender.transport)}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}async addRemoteCandidate(e){try{e&&this.pendingCandidates.push(e),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach((e=>{this.peerConnection.addIceCandidate(e)})),this.pendingCandidates=[])}catch(e){throw new h(l.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(e.toString()))}}send(e,t,i){var n=this;return $t((function*(){const s=yield zt(n.mutex.lock("From P2PConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[],a=n.remoteSDP.receive(e,t,i);e.forEach(((e,t)=>{if(a[t].needCreateTransceiver){const t=n.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});o.push(t),e._updateRtpTransceiver(t)}else{const i=n.peerConnection.getTransceivers().find((e=>e.mid===a[t].mid));if(!i)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(a[t].mid));o.push(i),e._updateRtpTransceiver(i)}})),I()&&!0===f("SIMULCAST")&&(yield zt(n.applySimulcastForFirefox(o,e)));const r=a.map((e=>e.mid)),c=yield zt(n.peerConnection.createOffer()),d=n.mungSendOfferSDP(c.sdp,e,r),h=Ms.parse(d),l=r.map((e=>{const t=h.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return Zs(t,f("USE_PUB_RTX"))})),u=o.map(((e,t)=>{const i=r[t];return{localSSRC:l[t],id:i}}));yield zt(n.peerConnection.setLocalDescription({type:"offer",sdp:d}));try{yield u}catch(e){const t=n.remoteSDP.toString();throw yield zt(n.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield zt(n.peerConnection.setRemoteDescription({type:"answer",sdp:t})),yield zt(n.stopSending(r,!0)),e}yield zt(n.applySimulcastEncodings(o,e)),yield zt(n.applySendEncodings(o,e));const p=n.remoteSDP.toString(),_=n.logSDPExchange(d,"offer","local","send");return null==_||_(p),yield zt(n.setRemoteDescription({type:"answer",sdp:p})),o.map(((e,t)=>{const i=r[t];return{localSSRC:l[t],id:i}}))}catch(e){throw e instanceof h?e:new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{s()}}))()}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length (".concat(t.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const o=this.remoteSDP.toString();null==s||s(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async receive(e,i,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:a}=this.remoteSDP.send(e,i,n,s);if(a){const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:i});const s=await this.peerConnection.createAnswer(),a=this.mungReceiveAnswerSDP(s.sdp,o,e);null==n||n(a||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:a}),t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const r=this.peerConnection.getTransceivers().find((e=>e.mid===o));if(!r||null===r.mid)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:r.receiver.track,mid:r.mid,transceiver:r}}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async mockReceive(e,i,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:a}=this.remoteSDP.send(e,i,n,s);if(a){const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:i});const s=await this.peerConnection.createAnswer(),a=this.mungReceiveAnswerSDP(s.sdp,o,e);null==n||n(a||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:a}),t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."))}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async restartICE(t){try{if(this.store.p2pTransport===ie.Auto&&(this.store.p2pTransport=ie.SdRtn,tt().supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,tt().supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!t){this.restartCnt++,this.isReady=!1;const e=await this.peerConnection.createOffer({iceRestart:!0});if(!e.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:t}=Qs(e.sdp);return this.store.descriptionStart(),this.direction===Ei.SEND_ONLY&&await this.peerConnection.setLocalDescription(e),t}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(t),this.store.descriptionStart(),this.direction===Ei.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const e=await this.peerConnection.createAnswer();if(!e.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:t}=Qs(e.sdp);return await this.peerConnection.setLocalDescription(e),t}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const s=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==o||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?I()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:i,remote:n}=t.getSelectedCandidatePair();return{local:Zt(Zt({},Fs),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:Zt(Zt({},Fs),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;["connected","completed"].includes(this.peerConnection.iceConnectionState)&&(this.isReady=!1),null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;"connected"===this.peerConnection.connectionState&&(this.restartCnt=0),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{if(e.candidate){var i;if(e.candidate.candidate)null===(i=this.onLocalCandidate)||void 0===i||i.call(this,e.candidate.toJSON());this.localCandidateCount+=1}else t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(i,n){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const o={iceServers:[]};return i.iceServers?o.iceServers=i.iceServers:i.turnServer&&"off"!==i.turnServer.mode&&(ne(i.turnServer.servers)?o.iceServers=i.turnServer.servers:(o.iceServers&&o.iceServers.push(...e.turnServerConfigToIceServers(i.turnServer.servers,n,s)),f("USE_TURN_SERVER_OF_GATEWAY")&&o.iceServers&&i.turnServer.serversFromGateway&&o.iceServers.push(...e.turnServerConfigToIceServers(i.turnServer.serversFromGateway,n,s)),[ie.Relay,ie.SdRtn].includes(n)&&(o.iceTransportPolicy="relay"),f("FORCE_TURN_TCP")?o.iceTransportPolicy="relay":i.turnServer.servers.concat(i.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(o.iceTransportPolicy="relay")})))),f("ENABLE_ENCODED_TRANSFORM")&&tt().supportWebRTCEncodedTransform&&(o.encodedInsertableStreams=!0),t.debug("P2PConnection p2pTransport is ".concat(n)),o}static turnServerConfigToIceServers(e,i){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const s=[],o=e.filter((e=>e.tcpport));t.debug("P2PConnection turnServers is ".concat(o,", current index is ").concat(n));const a=o.length>n?o[n]:o[0];switch(i){case ie.SdRtn:const t=e.filter((e=>e.username.includes("glb:")&&e.turnServerURL==e.turnServerURL)),i=t.length>n?t[n]:t[0];i&&(s.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(On(i.turnServerURL),":").concat(i.tcpport,"?transport=udp")}),s.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(On(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}));break;case ie.Relay:a&&(s.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=udp")}),s.push({username:a.username,credential:a.password,credentialType:"password",urls:"turns:".concat(On(a.turnServerURL),":").concat(a.tcpport,"?transport=tcp")}));break;default:a&&(s.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=udp")}),s.push({username:a.username,credential:a.password,credentialType:"password",urls:"turns:".concat(On(a.turnServerURL),":").concat(a.tcpport,"?transport=tcp")}),s.push({username:a.username,credential:a.password,credentialType:"password",urls:"stun:".concat(a.turnServerURL,":").concat(a.tcpport)}))}return s}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var t;null!=e&&e.state&&(null===(t=this.onDTLSTransportStateChange)||void 0===t||t.call(this,e.state))},e.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const i=e.iceTransport;i&&(i.onstatechange=()=>{const t=null==e?void 0:e.iceTransport.state;var i;t&&(null===(i=this.onICETransportStateChange)||void 0===i||i.call(this,t))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:e,remote:n}=i.getSelectedCandidatePair();t.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol}),", remote ").concat(JSON.stringify({candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,i){var n;if(!i){i=this.peerConnection.getSenders().find((t=>t.track===e._mediaStreamTrack))}if(!i)return t.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return t.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!tt().supportSetRtpSenderParameters)return t.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},o={};switch(e._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;default:s.degradationPreference="balanced"}if(e._encoderConfig){const{bitrateMax:t,frameRate:i,scaleResolutionDownBy:n}=e._encoderConfig;t&&(o.maxBitrate=1e3*t),e._hints.includes(et.LOW_STREAM)&&(i&&(o.maxFramerate=Pn(i)),n&&n>=1&&(o.scaleResolutionDownBy=n))}if(f("DSCP_TYPE")&&se()){const e=f("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(o.networkPriority=e)}const a=i.getParameters(),r=null===(n=a.encodings)||void 0===n?void 0:n[0];I()&&!r&&(s.encodings=[o]),r&&Object.assign(r,o),Object.assign(a,s),t.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await i.setParameters(a)}async applySendEncodings(e,i){try{if(!tt().supportSetRtpSenderParameters)return;if(e.length!==i.length)return;for(let t=0;t<e.length;t++){const n=e[t],s=i[t];s instanceof $e&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,n.sender)}}catch(e){t.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,i){const n=Ms.parse(e);return t.forEach(((e,t)=>{const s=i[t],o=n.mediaDescriptions.find((e=>e.attributes.mid===s));o&&(to(o,e),ao(o,e,this.store.codec))})),Ms.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var i,n,s,o;const r=e[a],c=t[a];if(c instanceof $e&&!c._hints.includes(et.LOW_STREAM)&&null!==(i=c._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=c._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=c._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=c._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=r.sender.getParameters();await r.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!I()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof $e&&this.isVP8Simulcast(n)){const t=e[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const a=t.sender.getParameters();await t.sender.setParameters(Object.assign(a,s))}}}isVP8Simulcast(e){var t,i,n,s;return!!(e instanceof $e&&f("SIMULCAST")&&"vp8"===this.store.codec&&!e._hints.includes(et.LOW_STREAM)&&null!==(t=e._encoderConfig)&&void 0!==t&&t.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(n=e._scalabilityMode)&&void 0!==n&&n.numSpatialLayers&&(null===(s=e._scalabilityMode)||void 0===s?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,i,n,s){if(f("SDP_LOGGING"))return t.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(i," SDP during P2PConnection.").concat(s,"\n"),e),"offer"===i?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",s)}:void 0}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async e=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}async getRemoteSSRC(e,t){var i,n;if(t=null!==(i=t)&&void 0!==i?i:null===(n=this.currentRemoteDescription)||void 0===n?void 0:n.sdp){var s;const i=null===(s=Ms.parse(t).mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===s?void 0:s.attributes.ssrcs;return null==i?void 0:i[0].ssrcId}}async setRemoteDescription(e){await this.peerConnection.setRemoteDescription(e),["connected","completed"].includes(this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(e,t,i){const n=Ms.parse(e),s=n.mediaDescriptions.find((e=>e.attributes.mid===t));return s&&i===Yi.AUDIO&&"audio"===s.media.mediaType&&uo(s),Ms.print(n)}},ii(To.prototype,"establish",[fo],Object.getOwnPropertyDescriptor(To.prototype,"establish"),To.prototype),ii(To.prototype,"connect",[fo],Object.getOwnPropertyDescriptor(To.prototype,"connect"),To.prototype),ii(To.prototype,"receive",[fo],Object.getOwnPropertyDescriptor(To.prototype,"receive"),To.prototype),ii(To.prototype,"mockReceive",[fo],Object.getOwnPropertyDescriptor(To.prototype,"mockReceive"),To.prototype),ii(To.prototype,"stopReceiving",[fo],Object.getOwnPropertyDescriptor(To.prototype,"stopReceiving"),To.prototype),ii(To.prototype,"restartICE",[fo],Object.getOwnPropertyDescriptor(To.prototype,"restartICE"),To.prototype),ii(To.prototype,"close",[fo],Object.getOwnPropertyDescriptor(To.prototype,"close"),To.prototype),ii(To.prototype,"updateEncoderConfig",[fo],Object.getOwnPropertyDescriptor(To.prototype,"updateEncoderConfig"),To.prototype),ii(To.prototype,"updateSendParameters",[fo],Object.getOwnPropertyDescriptor(To.prototype,"updateSendParameters"),To.prototype),ii(To.prototype,"replaceTrack",[fo],Object.getOwnPropertyDescriptor(To.prototype,"replaceTrack"),To.prototype),ii(To.prototype,"muteLocal",[fo],Object.getOwnPropertyDescriptor(To.prototype,"muteLocal"),To.prototype),ii(To.prototype,"unmuteLocal",[fo],Object.getOwnPropertyDescriptor(To.prototype,"unmuteLocal"),To.prototype),To);function fo(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];return await n.apply(this,o)}finally{i()}},i}function Ro(e,i){let n=document.createElement("video"),s=document.createElement("canvas");n.setAttribute("style","display:none"),s.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),s.width=Pn(i.width),s.height=Pn(i.height);const o=Pn(i.framerate||15);document.body.append(n),document.body.append(s);let a=e._mediaStreamTrack;n.srcObject=new MediaStream([a]),n.play();const r=s.getContext("2d");if(!r)throw new Si(l.UNEXPECTED_ERROR,"can not get canvas context");const c=tt(),d=s.captureStream(c.supportRequestFrame?0:o).getVideoTracks()[0];d.canvas||(d.canvas=s),s.startCapture=()=>{if(!n)return s.stopCapture&&s.stopCapture();if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){const e=n.videoWidth,i=n.videoHeight/e,o=s.width*i;Math.abs(o-s.height)>=2&&(t.debug("adjust low stream resolution","".concat(s.width,"x").concat(s.height," -> ").concat(s.width,"x").concat(o)),s.height=o)}r.drawImage(n,0,0,s.width,s.height),d.requestFrame&&d.requestFrame(),a!==e._mediaStreamTrack&&(a=e._mediaStreamTrack,n.srcObject=new MediaStream([a]))},s.stopCapture=it((()=>s.startCapture&&s.startCapture()),o);const h=d.stop;return d.stop=()=>{h.call(d),n&&(n.remove(),n.srcObject=null,n=null),s&&(s.width=0,s.remove(),s.stopCapture&&s.stopCapture(),s.startCapture=void 0,s.stopCapture=void 0,s=null),t.debug("clean low stream renderer")},d}var go=function(e){return e[e.HEIGHT=2033]="HEIGHT",e[e.FRAME_RATE=2034]="FRAME_RATE",e[e.WIDTH=2035]="WIDTH",e}(go||{}),Io=function(e){return e[e.FRAME_RATE=2002]="FRAME_RATE",e[e.WIDTH=2003]="WIDTH",e[e.HEIGHT=2004]="HEIGHT",e[e.PACKAGE_LOST=2005]="PACKAGE_LOST",e[e.AVG_ENCODE=2007]="AVG_ENCODE",e[e.NACKS=2009]="NACKS",e[e.PLIS=2010]="PLIS",e[e.FIRS=2011]="FIRS",e[e.BITRATE=2012]="BITRATE",e[e.PACKAGE_RATE=2031]="PACKAGE_RATE",e[e.ADAPTATION=2032]="ADAPTATION",e[e.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",e[e.BANDWIDTH=2061]="BANDWIDTH",e[e.RETRANSMIT=2062]="RETRANSMIT",e[e.TARGET_ENCODED=2064]="TARGET_ENCODED",e[e.TRANSMIT=2066]="TRANSMIT",e[e.FREEZE=2082]="FREEZE",e[e.DISABLED=2095]="DISABLED",e[e.PLAYER_STATUS=2128]="PLAYER_STATUS",e[e.QP_SUM=2143]="QP_SUM",e}(Io||{}),vo=function(e){return e[e.BITRATE=2069]="BITRATE",e[e.PACKAGE_LOST=2070]="PACKAGE_LOST",e[e.PACKAGE_RATE=2071]="PACKAGE_RATE",e[e.HEIGHT=2073]="HEIGHT",e[e.FRAME_RATE=2075]="FRAME_RATE",e[e.WIDTH=2077]="WIDTH",e}(vo||{}),Ao=function(e){return e[e.JITTER=-1]="JITTER",e[e.PACKAGE_LOST=2014]="PACKAGE_LOST",e[e.WIDTH=2018]="WIDTH",e[e.HEIGHT=2019]="HEIGHT",e[e.FRAME_RATE=2020]="FRAME_RATE",e[e.JITTER_BUFFER=2023]="JITTER_BUFFER",e[e.CURRENT_DELAY=2024]="CURRENT_DELAY",e[e.NACKS=2026]="NACKS",e[e.PLIS=2027]="PLIS",e[e.FIRS=2028]="FIRS",e[e.BITRATE=2029]="BITRATE",e[e.PACKAGE_RATE=2078]="PACKAGE_RATE",e[e.FREEZE=2084]="FREEZE",e[e.DISABLED=2101]="DISABLED",e[e.PLAYER_STATUS=2129]="PLAYER_STATUS",e[e.QP_SUM=2144]="QP_SUM",e[e.I_FRAME_DELAY=2149]="I_FRAME_DELAY",e}(Ao||{}),wo=function(e){return e[e.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",e[e.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",e[e.FRAME_RATE_OUTPUT=2155]="FRAME_RATE_OUTPUT",e[e.FREEZE_TIME=2109]="FREEZE_TIME",e[e.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER",e[e.FREEZE_DURATION=2156]="FREEZE_DURATION",e}(wo||{}),yo=function(e){return e[e.PCM_LEVEL=2104]="PCM_LEVEL",e}(yo||{}),No=function(e){return e[e.PACKAGE_LOST=-1]="PACKAGE_LOST",e[e.LEVEL=2038]="LEVEL",e[e.BITRATE=2039]="BITRATE",e[e.PACKAGE_RATE=2040]="PACKAGE_RATE",e[e.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",e[e.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",e[e.FREEZE=2081]="FREEZE",e[e.DISABLED=2096]="DISABLED",e}(No||{}),bo=function(e){return e[e.BITRATE=2044]="BITRATE",e[e.PACKAGE_LOST=2045]="PACKAGE_LOST",e[e.PACKAGE_RATE=2046]="PACKAGE_RATE",e[e.CURRENT_DELAY=2047]="CURRENT_DELAY",e[e.JITTER_BUFFER=2054]="JITTER_BUFFER",e[e.JITTER=2055]="JITTER",e[e.FREEZE=2083]="FREEZE",e[e.DISABLED=2102]="DISABLED",e[e.PCM_LEVEL=2105]="PCM_LEVEL",e[e.PLAYER_STATUS=2130]="PLAYER_STATUS",e[e.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES",e}(bo||{}),Oo=function(e){return e[e.FREEZE_TIME=-1]="FREEZE_TIME",e[e.LEVEL=2043]="LEVEL",e}(Oo||{}),Do=function(e){return e[e.RTT=2006]="RTT",e[e.CONN_TYPE=801]="CONN_TYPE",e}(Do||{});const Po=1e3,Lo=3;function ko(e,t,i){null!=i&&Number.isFinite(i)&&(e[t]=Math.round(Math.max(0,i)))}function Mo(e){const t={[Do.CONN_TYPE]:0,[Do.RTT]:e.rtt};switch(e.selectedCandidatePair.localCandidate.candidateType){case"relay":{const i=e.selectedCandidatePair.localCandidate.relayProtocol;"udp"===i&&(t[Do.CONN_TYPE]=1),"tcp"===i&&(t[Do.CONN_TYPE]=3),"tls"===i&&(t[Do.CONN_TYPE]=4);break}case"srflx":t[Do.CONN_TYPE]=2}return t}function Uo(e){let t=0;switch(e){case"none":t=0;break;case"cpu":t=1;break;case"bandwidth":t=2;break;case"other":t=3}return t}class xo extends C{constructor(e){super(),this.store=void 0,this.uploadWRTCStatsTimer=void 0,this.uploadOutboundDenoiserStatsTimer=void 0,this.uploadExtStatsTimer=void 0,this.uploadExtUsageStatsTimer=void 0,this.uploadInboundExtStatsTimer=void 0,this.requestStats=void 0,this.requestTransportStats=void 0,this.requestLocalMedia=void 0,this.requestRemoteMedia=void 0,this.requestAllTracks=void 0,this.requestVideoIsReady=void 0,this.requestUploadStats=void 0,this.requestUpload=void 0,this.uploadOutboundStarted=!1,this.uploadInboundStarted=!1,this.uploadTransportStarted=!1,this.uploadExtensionUsageStarted=!1,this.lastRecvStats=void 0,this.lastSendStats=void 0,this.lastFullRecvStats=void 0,this.lastFullSendStats=void 0,this.needUploadRenderFreezeTime=!0,this.store=e}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;let t,i;if(this.uploadTransportStarted&&(t=this.requestStats(),this.store.useP2P&&(i=this.requestStats(!0))),!t&&this.uploadOutboundStarted&&(t=this.requestStats()),!i&&this.uploadInboundStarted&&(i=this.requestStats(!0)),t||i){const n={};if(this.uploadTransportStarted&&t){const s=this.getTransportStats(t,i,e);s&&(n.misc=[s])}if(this.uploadOutboundStarted&&t){const i=this.getOutboundStats(t,e?this.lastSendStats:this.lastFullSendStats,e);i&&(n.outbound=[i])}if(this.uploadInboundStarted&&i){const t=this.getInboundStats(i,e?this.lastRecvStats:this.lastFullRecvStats,e);t&&(n.inbound=t)}this.requestUploadStats(n)}this.lastRecvStats=i,this.lastSendStats=t,e||(this.lastFullRecvStats=i,this.lastFullSendStats=t)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let e=1;this.uploadWRTCStatsTimer=window.setInterval((()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(e!==Lo),++e===Lo+1&&(e=1)}),Po)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(e,t,i){if(!this.requestStats)return;if(i)return null==e.rtt?void 0:{addition:{[Do.RTT]:e.rtt,[Do.CONN_TYPE]:void 0}};const n=Mo(e);if(this.store.useP2P){if(t){const e=Mo(t);n[Do.CONN_TYPE]+=e[Do.CONN_TYPE]<<3}n[Do.CONN_TYPE]+=110}else n[Do.CONN_TYPE]+=100;return{addition:n}}getOutboundStats(e,t,i){if(!this.requestUploadStats||!this.requestLocalMedia)return;const n=this.requestLocalMedia();if(!n||0===n.length)return;let s,o,a;return n.forEach((n=>{let[r,{track:c,ssrcs:d}]=n;switch(r){case zi.LocalVideoLowTrack:case zi.LocalVideoTrack:if(r===zi.LocalVideoTrack){const n=function(e,t,i,n,s){const o=t.videoSend.find((t=>t.ssrc===e));if(!o)return;const a={},{sentFrame:r,inputFrame:c}=o;if(c&&r){const e=c.frameRate,t=r.frameRate;a[Io.FREEZE]=function(e,t){let i=!0;return i=!(e<=5)&&(e<=10?t<3:e<=20?t<4:t<5),i}(e,t)?1:0}if(ko(a,Io.QP_SUM,o.qpSumPerFrame),s)return a;switch(r&&(ko(a,Io.HEIGHT,r.height),ko(a,Io.WIDTH,r.width),ko(a,Io.FRAME_RATE,r.frameRate)),a[Io.DISABLED]=n._originMediaStreamTrack&&!n._originMediaStreamTrack.enabled||n._mediaStreamTrack&&!n._mediaStreamTrack.enabled?1:0,o.adaptionChangeReason){case"none":a[Io.ADAPTATION]=0;break;case"cpu":a[Io.ADAPTATION]=1;break;case"bandwidth":a[Io.ADAPTATION]=2;break;case"other":a[Io.ADAPTATION]=3}let d=0;o.adaptionChangeReason&&(d+=Uo(o.adaptionChangeReason)),t.qualityLimitationReason&&(d+=Uo(t.qualityLimitationReason)<<3),a[Io.ADAPTATION]=d,a[Io.PLAYER_STATUS]=nt[n._player?n._player.videoElementStatus:"uninit"],ko(a,Io.NACKS,o.nacksCount),ko(a,Io.PLIS,o.plisCount),ko(a,Io.FIRS,o.firsCount),ko(a,Io.AVG_ENCODE,o.avgEncodeMs);const h=i&&i.videoSend.find((t=>t.ssrc===e));if(h){let e=s?Po:Po*Lo;h.timestamp&&o.timestamp&&(e=o.timestamp-h.timestamp),null!=h.packets&&null!=o.packets&&ko(a,Io.PACKAGE_RATE,1e3*(o.packets-h.packets)/e),null!=o.packetsLost&&null!=h.packetsLost&&ko(a,Io.PACKAGE_LOST,o.packetsLost-h.packetsLost),null!=h.bytes&&null!=o.bytes&&ko(a,Io.BITRATE,8*(o.bytes-h.bytes)/e)}return a}(d[0].ssrcId,e,t,c,i),s=i?null:function(e,t,i){const n=t.videoSend.find((t=>t.ssrc===e));if(!n)return null;const s={},o=n.inputFrame,a=o&&o.height||i&&i.videoHeight||0,r=o&&o.width||i&&i.videoWidth||0,c=o&&o.frameRate||0;return ko(s,go.HEIGHT,a),ko(s,go.WIDTH,r),ko(s,go.FRAME_RATE,c),s}(d[0].ssrcId,e,c),a=i?null:function(e){const t={};return ko(t,Io.RETRANSMIT,e.bitrate.retransmit),ko(t,Io.TARGET_ENCODED,e.bitrate.targetEncoded),ko(t,Io.ACTUAL_ENCODED,e.bitrate.actualEncoded),ko(t,Io.TRANSMIT,e.bitrate.transmit),ko(t,Io.BANDWIDTH,e.sendBandwidth),t}(e);o=Object.assign({},n,s,a)}else a=i?void 0:function(e,t,i){const n=t.videoSend.find((t=>t.ssrc===e));if(!n)return;const s={},o=n.sentFrame;if(o&&(ko(s,vo.HEIGHT,o.height),ko(s,vo.WIDTH,o.width),ko(s,vo.FRAME_RATE,o.frameRate)),i){const t=i.videoSend.find((t=>t.ssrc===e));if(t){let e=Po*Lo;t.timestamp&&n.timestamp&&(e=n.timestamp-t.timestamp),null!=t.packets&&null!=n.packets&&ko(s,vo.PACKAGE_RATE,1e3*(n.packets-t.packets)/e),null!=n.packetsLost&&null!=t.packetsLost&&ko(s,vo.PACKAGE_LOST,n.packetsLost-t.packetsLost),null!=t.bytes&&null!=n.bytes&&ko(s,vo.BITRATE,8*(n.bytes-t.bytes)/e)}}return s}(d[0].ssrcId,e,t);break;case zi.LocalAudioTrack:s=i?void 0:function(e,t,i,n){const s=t.audioSend.find((t=>t.ssrc===e));if(!s)return;const o={};o[No.DISABLED]=n._originMediaStreamTrack&&!n._originMediaStreamTrack.enabled||n._mediaStreamTrack&&!n._mediaStreamTrack.enabled?1:0;const a=100*n._source.getAccurateVolumeLevel(),r=s.inputLevel;if(null!=r){const e=Math.ceil(50*Math.log10(100*r+1));ko(o,No.LEVEL,e)}ko(o,yo.PCM_LEVEL,a),ko(o,No.AEC_RETURN_LOSS,s.aecReturnLoss),ko(o,No.AEC_RETURN_LOSS_ENH,s.aecReturnLossEnhancement),o[No.FREEZE]=0;const c=i&&i.audioSend.find((t=>t.ssrc===e));if(c){let e=Po*Lo;c.timestamp&&s.timestamp&&(e=s.timestamp-c.timestamp),null!=c.bytes&&null!=s.bytes&&ko(o,No.BITRATE,8*(s.bytes-c.bytes)/e),null!=c.packets&&null!=s.packets&&ko(o,No.PACKAGE_RATE,1e3*(s.packets-c.packets)/e)}return o}(d[0].ssrcId,e,t,c)}})),{high:o,low:a,audio:s}}getInboundStats(e,t,i){if(!this.requestRemoteMedia)return;const n=this.requestRemoteMedia()||[],s=[];return n.forEach((n=>{let[o,a]=n;const r={peer:o.uid};if(a.has(Yi.VIDEO)&&o.videoTrack){const n=o._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(o._videoSSRC)||!1,s=o.videoTrack?function(e,t,i,n,s,o,a){var r;const c=t.videoRecv.find((t=>t.ssrc===e));if(!c)return;const d={},{receivedFrame:h,outputFrame:l,decodeFrameRate:u}=c,p=i&&i.videoRecv.find((t=>t.ssrc===e));if(d[Ao.FREEZE]=s&&na.isRemoteVideoFreeze(n,c,p)?1:0,ko(d,wo.FRAME_RATE_DECODE,u),ko(d,Ao.QP_SUM,c.qpSumPerFrame),c.framesRateFirefox&&ko(d,Ao.FRAME_RATE,c.framesRateFirefox),h&&ko(d,Ao.FRAME_RATE,h.frameRate),p){const e=t.timestamp-i.timestamp||(a?Po:Lo*Po);null!=c.packetsLost&&null!=p.packetsLost&&ko(d,Ao.PACKAGE_LOST,c.packetsLost-p.packetsLost),null!=p.bytes&&null!=c.bytes&&ko(d,Ao.BITRATE,8*(c.bytes-p.bytes)/e),null!=p.packets&&null!=c.packets&&ko(d,Ao.PACKAGE_RATE,1e3*(c.packets-p.packets)/e)}if(a)return d;h?(ko(d,Ao.HEIGHT,h.height),ko(d,Ao.WIDTH,h.width)):n&&(ko(d,Ao.HEIGHT,n._videoHeight||0),ko(d,Ao.WIDTH,n._videoWidth||0)),l&&ko(d,wo.FRAME_RATE_OUTPUT,l.frameRate);const _=null===(r=n._player)||void 0===r?void 0:r.rendFrameRate.toFixed(0);if(_&&ko(d,wo.FRAME_RATE_RENDER,+_),ko(d,Ao.JITTER_BUFFER,c.jitterBufferMs),ko(d,Ao.CURRENT_DELAY,c.currentDelayMs),ko(d,Ao.FIRS,c.firsCount),ko(d,Ao.NACKS,c.nacksCount),ko(d,Ao.PLIS,c.plisCount),n){d[Ao.DISABLED]=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?0:1;const e=n._player;if(e){const{freezeTimeCounterList:t,renderFreezeAccTime:i,videoElementStatus:n}=e;if(t&&t.length>0&&ko(d,wo.FREEZE_TIME,t.splice(0,1)[0]),o&&"visible"===st.visibility&&n===ot.PLAYING&&tt().supportRequestVideoFrameCallback){const t=Math.min(6e3,i);e.renderFreezeAccTime=Math.max(0,i-t),ko(d,wo.FREEZE_TIME_RENDER,t)}if("number"==typeof c.totalFreezesDuration){const e=p&&p.totalFreezesDuration?c.totalFreezesDuration-p.totalFreezesDuration:c.totalFreezesDuration;ko(d,wo.FREEZE_DURATION,1e3*e)}}}if(d[Ao.PLAYER_STATUS]=nt[n._player?n._player.videoElementStatus:"uninit"],p&&void 0!==c.totalInterFrameDelay&&void 0!==c.totalSquaredInterFrameDelay&&void 0!==p.totalInterFrameDelay&&void 0!==p.totalSquaredInterFrameDelay){const e=c.totalInterFrameDelay-p.totalInterFrameDelay,t=c.totalSquaredInterFrameDelay-p.totalSquaredInterFrameDelay,i=c.framesDecodeCount-p.framesDecodeCount,n=e/i*1e3,s=Math.round(1e3*Math.sqrt((t-Math.pow(e,2)/i)/i));!isNaN(s)&&n+s>Math.max(3*n,n+150)&&(d[Ao.I_FRAME_DELAY]=s)}return d}(o._videoSSRC,e,t,o.videoTrack,!0===n,this.needUploadRenderFreezeTime,i):void 0;s&&(r.video=s)}if(a.has(Yi.AUDIO)&&o.audioTrack){const n=o.audioTrack?function(e,t,i,n,s){const o=t.audioRecv.find((t=>t.ssrc===e));if(!o)return;const a={},r=i&&i.audioRecv.find((t=>t.ssrc===e)),{receivedFrames:c,droppedFrames:d}=o;var h,l;if(ko(a,bo.JITTER,o.jitterMs),null!=c&&null!=d&&(a[bo.FREEZE]=(l=d,0===(h=c)||100*l/h>20?1:0)),r){const e=t.timestamp-i.timestamp||(s?Po:Po*Lo);null!=o.packets&&null!=r.packets&&ko(a,bo.PACKAGE_RATE,1e3*(o.packets-r.packets)/e),null!=r.bytes&&null!=o.bytes&&ko(a,bo.BITRATE,8*(o.bytes-r.bytes)/e),null!=o.packetsLost&&null!=r.packetsLost&&ko(a,bo.PACKAGE_LOST,o.packetsLost-r.packetsLost)}if(s)return a;const u=100*n._source.getAccurateVolumeLevel(),p=o.outputLevel;if(null!=p){const e=Math.ceil(50*Math.log10(100*p+1));ko(a,Oo.LEVEL,e)}if(ko(a,bo.PCM_LEVEL,u),n&&(a[bo.DISABLED]=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?0:1),ko(a,bo.JITTER_BUFFER,o.jitterBufferMs),ko(a,bo.CURRENT_DELAY,o.jitterBufferMs),a[bo.PLAYER_STATUS]=nt[at.getPlayerState(n.getTrackId())],r){const e=o.concealedSamples-r.concealedSamples;e>0&&ko(a,bo.CONCEALED_SAMPLES,e)}return a}(o._audioSSRC,e,t,o.audioTrack,i):void 0;n&&(r.audio=n)}(r.video||r.audio)&&s.push(r)})),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,s}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval((()=>{if(!this.requestAllTracks||!this.requestUpload)return;const e=(this.requestAllTracks()||[]).find((e=>e instanceof rt));if(e&&e._external.getDenoiserStats){const t=e._external.getDenoiserStats();t&&this.requestUpload(pi.DENOISER_STATS,t)}}),2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval((()=>{if(!this.requestAllTracks||!this.requestUpload)return;this.requestAllTracks().forEach((e=>{e.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}))}),2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval((()=>{if(!this.requestUpload||!this.requestRemoteMedia)return;(this.requestRemoteMedia()||[]).forEach((e=>{let[t,i]=e;if(i.has(Yi.VIDEO)&&t.videoTrack){t.videoTrack.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}if(i.has(Yi.AUDIO)&&t.audioTrack){t.audioTrack.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}}))}),2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const e=new Map;this.uploadExtUsageStatsTimer=window.setInterval((async()=>{const t=Date.now(),i={connectionInterval:f("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:t};let n=[];const s=this.requestAllTracks&&this.requestAllTracks()||[];for(const e of s)!e.muted&&e.enabled&&(n=n.concat(await e.getProcessorUsage()));const o=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[e,t]of o)t.has(Yi.VIDEO)&&e.videoTrack&&(n=n.concat(await e.videoTrack.getProcessorUsage())),t.has(Yi.AUDIO)&&e.audioTrack&&(n=n.concat(await e.audioTrack.getProcessorUsage()));if(0===n.length)return;i.details=function(e,t){const i={};for(const{id:a,value:r,level:c,direction:d}of e){var n;const e=null!==(n=t.get(a))&&void 0!==n?n:0,h=2===r?e+f("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:e;var s,o;t.set(a,h),i[a]?(2===r&&(i[a].value=r),c>i[a].level&&(i[a].level=c),"remote"===d&&(i[a].remoteUidCount+=1),i[a].totalTs=null!==(s=t.get(a))&&void 0!==s?s:0):i[a]={value:r,level:c,remoteUidCount:"local"===d?0:1,totalTs:null!==(o=t.get(a))&&void 0!==o?o:0}}return Object.keys(i).map((e=>{const{level:t,value:n,totalTs:s}=i[e];return{id:e,level:t,value:n,totalTs:s}}))}(n,e);const a=Date.now(),r=a>t?a:t+1;this.requestUpload&&this.requestUpload(pi.EXTENSION_USAGE_STATS,{usageStats:i,sendTs:r})}),f("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}}class Vo{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,t){this.uid=void 0,this._uintid=void 0,this._trust_in_room_=!0,this._trust_audio_enabled_state_=!0,this._trust_video_enabled_state_=!0,this._trust_audio_mute_state_=!0,this._trust_video_mute_state_=!0,this._audio_muted_=!1,this._video_muted_=!1,this._audio_enabled_=!0,this._video_enabled_=!0,this._audio_added_=!1,this._video_added_=!1,this._is_pre_created=!1,this._video_pre_subscribed=!1,this._audio_pre_subscribed=!1,this._trust_video_stream_added_state_=!0,this._trust_audio_stream_added_state_=!0,this._audioTrack=void 0,this._videoTrack=void 0,this._dataChannels=[],this._audioSSRC=void 0,this._videoSSRC=void 0,this._audioOrtc=void 0,this._videoOrtc=void 0,this._cname=void 0,this._rtxSsrcId=void 0,this._videoMid=void 0,this._audioMid=void 0,this.uid=e,this._uintid=t}}let Fo=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({});function Bo(e,t){let i;switch(t){case zi.LocalAudioTrack:i=Mi.Audio;break;case zi.LocalVideoTrack:i=e._hints.includes(et.SCREEN_TRACK)?Mi.Screen:Mi.High;break;case zi.LocalVideoLowTrack:i=Mi.Low}return i}function Go(e){const t=tt();if(e.some((e=>e._bypassWebAudio)))throw new h(l.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!t.webAudioMediaStreamDest)throw new h(l.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function jo(e,t){Go(e);const i=t||new Qe;return e.forEach((e=>i.addAudioTrack(e))),i}var Wo,Ho,Ko,qo,Yo,Jo,Xo,zo,Qo,Zo,$o,ea;let ta=(Wo=ia(Fo.SEND_ONLY),Ho=ia(Fo.SEND_ONLY),Ko=ia(),qo=ia(Fo.RECEIVE_ONLY),Yo=ia(Fo.RECEIVE_ONLY),Jo=ia(Fo.RECEIVE_ONLY),Xo=ia(Fo.RECEIVE_ONLY),zo=ia(Fo.RECEIVE_ONLY),Qo=ia(Fo.RECEIVE_ONLY),Zo=ia(),$o=ia(Fo.RECEIVE_ONLY),ii((ea=class extends C{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(Zi.StateChange,t,this._state)}constructor(e,i){super(),this.store=void 0,this.statsUploader=void 0,this.sendConnection=void 0,this.recvConnection=void 0,this.localTrackMap=new Map,this.remoteUserMap=new Map,this.localDataChannels=[],this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.statsCollector=void 0,this.dtlsFailedCount=0,this.sendMutex=new v("P2PChannel2-send-mutex"),this.recvMutex=new v("P2PChannel2-recv-mutex"),this._state=Qi.Disconnected,this._restartStates=["disconnected","failed"],this.reconnectInterval=void 0,this.uploadUnplinkStarted=!1,this.uploadDownlinkStarted=!1,this.uplinkStateUploadInterval=void 0,this.downlinkStatsUploadInterval=void 0,this.handleMuteLocalTrack=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==Qi.Connected)return void i(new h(l.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const a=this.filterTobeMutedTracks(e);if(0===a.length)return void t();const r=a.find((e=>"videoLowTrack"===e[0]));if(r){r[1].track._originMediaStreamTrack.stop()}await this.sendConnection.muteLocal(a.map((e=>{let[,{id:t}]=e;return t})));let c=!1;var s,o;if("video"===e.trackMediaType)c=!(null===(s=this.localTrackMap.get(zi.LocalAudioTrack))||void 0===s||!s.track._muted);else c=void 0===(null===(o=this.localTrackMap.get(zi.LocalVideoTrack))||void 0===o?void 0:o.id);const d=this.createMuteMessage(a);await oe(this,Zi.RequestMuteLocal,d);const u="video"===e.trackMediaType?ln.MUTE_LOCAL_VIDEO:ln.MUTE_LOCAL_AUDIO;await oe(this,Zi.RequestP2PMuteLocal,{action:u,message:d,isMuteAll:c}),t()}catch(e){i(e)}finally{n()}},this.handleUnmuteLocalTrack=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==Qi.Connected)return void i(new h(l.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const s=this.filterTobeUnmutedTracks(e);if(0===s.length)return void t();await this.sendConnection.unmuteLocal(s.map((e=>{let[,{id:t}]=e;return t})));const o=this.createUnmuteMessage(s),a="video"===e.trackMediaType?ln.UNMUTE_LOCAL_VIDEO:ln.UNMUTE_LOCAL_AUDIO;await oe(this,Zi.RequestP2PMuteLocal,{action:a,message:o}),t()}catch(e){i(e)}finally{n()}},this.handleUpdateVideoEncoder=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{const i=this.localTrackMap.get(zi.LocalVideoTrack);if(!this.sendConnection||!i||i.track!==e||this.state!==Qi.Connected)return void t();const{id:s,track:o}=i;s&&(await this.sendConnection.updateSendParameters(s,o),await this.sendConnection.updateEncoderConfig(s,o),this.emit(Zi.UpdateVideoEncoder,o)),t()}catch(e){i(e)}finally{n()}},this.handleUpdateVideoSendParameters=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{const i=this.localTrackMap.get(zi.LocalVideoTrack);if(!this.sendConnection||!i||i.track!==e||this.state!==Qi.Connected)return void t();const{id:s,track:o}=i;s&&await this.sendConnection.updateSendParameters(s,o),t()}catch(e){i(e)}finally{n()}},this.handleReplaceTrack=async(e,i,n,s)=>{let o;t.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(e.getTrackId(),"]")),"boolean"==typeof s&&s||(o=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var a;const t=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(!this.sendConnection||!t||void 0===t[1].id||this.state!==Qi.Connected)return void i();if(await(null===(a=this.sendConnection)||void 0===a?void 0:a.replaceTrack(e,t[1].id)),t[0]===zi.LocalVideoTrack&&tt().supportDualStreamEncoding){const t=this.localTrackMap.get(zi.LocalVideoLowTrack);if(t){const i=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i,await new Promise(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}}i()}catch(e){n(e)}finally{var r;null===(r=o)||void 0===r||r()}},this.handleGetLocalVideoStats=e=>{e(this.statsCollector.getLocalVideoTrackStats())},this.handleGetLocalAudioStats=e=>{e(this.statsCollector.getLocalAudioTrackStats())},this.handleGetRemoteVideoStats=e=>this.statsCollector.getRemoteVideoTrackStats(e.uid)[e.uid],this.handleGetRemoteAudioStats=e=>this.statsCollector.getRemoteAudioTrackStats(e.uid)[e.uid],this.store=e,this.statsCollector=i,this.statsCollector.addP2PChannel(this),this.statsUploader=new xo(e),this.bindStatsUploaderEvents(),this.reconnectInterval=window.setInterval((()=>{[this.sendConnection,this.recvConnection].forEach((e=>{e&&("disconnected"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||this.handleDisconnect(e.direction))}))}),f("ICE_RESTART_INTERVAL"))}async startP2PConnection(e,t){throw new h(l.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e,t,i,n,s,o){throw new h(l.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,i){let n;try{if(i){this.recvConnection&&(t.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),n=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new Co(e,this.store,Ei.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const s=await this.recvConnection.establish(i);return{iceParameters:s.iceParameters,dtlsParameters:s.dtlsParameters,sdp:s.sdp}}{this.state=Qi.New,this.sendConnection&&(t.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),n=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new Co(e,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const i=await this.sendConnection.establish();return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}}finally{n&&n()}}async p2pConnect(e){if(!this.sendConnection)throw new h(l.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Qi.Connected}async addRemoteCandidate(e,t){if(t===Ei.RECEIVE_ONLY){if(!this.sendConnection)throw new h(l.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(e)}else{if(!this.recvConnection)throw new h(l.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e)}}publish(e,t,i){var n=this;return $t((function*(){const s=yield zt(n.sendMutex.lock("From P2PChannel.publish"));try{if(!n.sendConnection||n.state!==Qi.Connected){n.throwIfTrackTypeNotMatch(e);const t=e.filter((e=>-1===n.pendingLocalTracks.indexOf(e)));return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(t))}n.store.pubId=n.store.pubId+1,Ls.markPublishStart(n.store.clientId,n.store.pubId);const o=n.filterTobePublishedTracks(e,t,i);if(0===o.length)return void(yield zt(n.tryToUnmuteAudio(e)));o.forEach((e=>{let{track:t,type:i}=e;const s=Date.now();n.store.publish(t.getTrackId(),i===zi.LocalAudioTrack?"audio":"video",s)})),n.bindLocalTrackEvents(o);const a=yield zt(n.sendConnection.send(o.map((e=>{let{track:t}=e;return t})),n.store.codec,n.store.audioCodec)),r=(yield zt(a.next())).value,c=n.createGatewayPublishMessage(o,r);try{yield c}catch(e){throw a.throw(e),(null==e?void 0:e.code)===l.WS_ABORT&&o.forEach((e=>{let{track:t}=e;-1===n.pendingLocalTracks.indexOf(t)&&n.pendingLocalTracks.push(t)})),n.unbindLocalTrackEvents(o),e}yield zt(a.next()),o.forEach((e=>{let{type:t}=e;n.statsCollector.addLocalStats(t)})),n.statsUploader.startUploadOutboundStats(),n.assignLocalTracks(o,r),o.forEach((e=>{let{track:t,type:i}=e;const s=Date.now();n.store.publish(t.getTrackId(),i===zi.LocalAudioTrack?"audio":"video",void 0,s)})),n.startUploadUplinkState()}finally{s()}}))()}async unpublish(e){if(!this.sendConnection||this.state!==Qi.Connected)return void(0===e.length?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter((t=>!e.includes(t))));const t=this.filterTobeUnpublishedTracks(e);if(0===t.length)return;const i=t.find((e=>"videoLowTrack"===e[0]));if(i){i[1].track.close()}const n=this.createGatewayUnpublishMessage(t);if(await this.sendConnection.stopSending(t.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:i}]=e;return{type:t,track:i}}))),t.forEach((e=>{let[t]=e;this.statsCollector.removeLocalStats(t)})),0===this.localTrackMap.size&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===Qi.Connected){if(i){i[1].track.close()}return n}e.forEach((e=>{const t=this.pendingLocalTracks.indexOf(e);-1!==t&&this.pendingLocalTracks.splice(t,1)}))}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const e=()=>{const e=[],t=[];Array.from(this.localTrackMap.entries()).forEach((i=>{let[n,{track:s,ssrcs:o}]=i;const a={stream_type:Bo(s,n),ssrcs:o};s._muted||!s._enabled?e.push(a):t.push(a)})),e.length>0&&e.forEach((e=>{oe(this,Zi.RequestMuteLocal,[e])})),t.length>0&&t.forEach((e=>{oe(this,Zi.RequestUnmuteLocal,[e])}))};e(),this.uplinkStateUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(e){return $t((function*(){throw new h(l.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")}))()}async republish(){this.pendingLocalTracks.length>0&&(t.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await O(this,Zi.RequestRePublish,this.pendingLocalTracks),this.emit(Zi.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new h(l.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(e,i,n,s){var o;if(!this.recvConnection)throw new h(l.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if(null!==(o=this.remoteUserMap.get(e))&&void 0!==o&&o.has(i))return;const{track:a,mid:r,transceiver:c}=await this.recvConnection.receive(i,[{ssrcId:n}],String(e.uid),s);i===Yi.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(a):(e._audioTrack=new ct(a,e.uid,e._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),c&&e._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=n,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(a):(e._videoTrack=new dt(a,e.uid,e._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),c&&e._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._videoTrack));const d=this.remoteUserMap.get(e);d?d.set(i,r):this.remoteUserMap.set(e,new Map([[i,r]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const u=this.pendingRemoteTracks.findIndex((t=>{let{user:n,kind:s}=t;return n.uid===e.uid&&i===s}));-1!==u&&(this.pendingRemoteTracks.splice(u,1),this.emit(Zi.MediaReconnectEnd,e.uid))}async mockSubscribe(e,t,i,n){if(!this.recvConnection)throw new h(l.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(t,[{ssrcId:i}],String(e.uid),n)}async unsubscribe(e,t,i){const n=this.pendingRemoteTracks.filter((i=>{let{user:n,kind:s}=i;return void 0!==t?n.uid===e.uid&&t===s:n.uid===e.uid}));if(n.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),this.recvConnection||i||n.forEach((t=>{let{kind:i}=t;var n;if(i===Yi.AUDIO)null===(n=e._audioTrack)||void 0===n||n._destroy(),e._audioTrack=void 0;else if(i===Yi.VIDEO){var s;null===(s=e._videoTrack)||void 0===s||s._destroy(),e._videoTrack=void 0}})),!this.recvConnection)return;const s=this.filterTobeUnSubscribedTracks(e,t);0!==s.length&&(await this.recvConnection.stopReceiving(s.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawRemoteTracks(s),0===this.remoteUserMap.size&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),s.forEach((e=>{let[t,{kind:n}]=e;var s,o;n===Yi.VIDEO&&t._videoSSRC&&(null===(s=this.recvConnection)||void 0===s||s.setStatsRemoteVideoIsReady(t._videoSSRC,!1));if(n===Yi.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),i||(null===(o=t._videoTrack)||void 0===o||o._destroy(),t._videoTrack=void 0);else if(n===Yi.AUDIO){var a;if(this.unbindRemoteTrackEvents(t._audioTrack),!i)null===(a=t._audioTrack)||void 0===a||a._destroy(),t._audioTrack=void 0}})),s.forEach((e=>{let[,{kind:t}]=e;oe(this,Zi.RequestP2PMuteRemote,t)})))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const e=()=>Array.from(this.remoteUserMap.entries()).forEach((e=>{let[,t]=e;[Yi.VIDEO,Yi.AUDIO].forEach((e=>{t.has(e)?oe(this,Zi.RequestP2PUnmuteRemote,e):oe(this,Zi.RequestP2PMuteRemote,e)}))}));e(),this.downlinkStatsUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new h(l.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new h(l.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new h(l.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new h(l.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,i){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void t.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(i))return void t.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."));const s=i===Yi.VIDEO?e._videoSSRC:e._audioSSRC;void 0!==s&&this.recvConnection.setStatsRemoteVideoIsReady(s,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,i){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void t.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."));n.get(i)||t.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."))}getAllTracks(e){const t=this.localTrackMap.get(zi.LocalAudioTrack);if((null==t?void 0:t.track)instanceof Qe){const i=t.track;return Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return t!==zi.LocalAudioTrack})).filter((t=>{let[i]=t;return!(e&&i===zi.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t})).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter((t=>{let[i]=t;return!(e&&i===zi.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t}))}reportPublishEvent(e,t,n,s,o){if(e){const n=this.localTrackMap.get(zi.LocalAudioTrack),a=s?this.localTrackMap.get(zi.LocalVideoLowTrack):this.localTrackMap.get(zi.LocalVideoTrack);i.publish(this.store.sessionId,{eventElapse:Ls.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==n?void 0:n.track.getTrackLabel(),videoName:null==a?void 0:a.track.getTrackLabel(),screenshare:-1!==(null==a?void 0:a.track._hints.indexOf(et.SCREEN_TRACK)),audio:!!n,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}else{var a;n||(n=[]);const r=n.find((e=>e instanceof Ze)),c=s?null===(a=this.localTrackMap.get(zi.LocalVideoTrack))||void 0===a?void 0:a.track:n.find((e=>e instanceof $e));i.publish(this.store.sessionId,{eventElapse:Ls.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==r?void 0:r.getTrackLabel(),videoName:null==c?void 0:c.getTrackLabel(),screenshare:-1!==(null==c?void 0:c._hints.indexOf(et.SCREEN_TRACK)),audio:!!r,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}}reportSubscribeEvent(e,t,n,s){const o=s===Yi.VIDEO?n._videoSSRC:n._audioSSRC;o&&i.subscribe(this.store.sessionId,{succ:e,ec:t,video:s===Yi.VIDEO,audio:s===Yi.AUDIO,peerid:n.uid,subscribeRequestid:s===Yi.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:Ls.measureFromSubscribeStart(this.store.clientId,o)})}reset(){t.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new v("P2PChannel2-send-mutex"),this.sendMutex=new v("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(zi.LocalAudioTrack);if((null==e?void 0:e.track)instanceof Qe){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((e=>{t.removeAudioTrack(e)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=Qi.Disconnected}getStats(e){var t,i;return e?null===(i=this.recvConnection)||void 0===i?void 0:i.getStats():null===(t=this.sendConnection)||void 0===t?void 0:t.getStats()}getRemoteVideoIsReady(e){var t;return(null===(t=this.recvConnection)||void 0===t?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(zi.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(zi.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof $e||t&&t.track instanceof Ze?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}getRemoteMedia(e){const t=Array.from(this.remoteUserMap.keys()).find((t=>t.uid===e));return t?{audioTrack:t.audioTrack,audioSSRC:t._audioSSRC,videoTrack:t.videoTrack,videoSSRC:t._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((e=>{let[t]=e;return{uid:t.uid,level:t.audioTrack?100*t.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(zi.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=e.sort(((e,t)=>e.level-t.level)),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(t.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=Qi.Reconnecting,f("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var i;t._videoTrack&&t._videoTrack._player&&(null===(i=t._videoTrack._player.getVideoElement())||void 0===i||i.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;switch(t){case zi.LocalVideoTrack:i._hints.includes(et.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case zi.LocalAudioTrack:i instanceof Qe?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case zi.LocalVideoLowTrack:}})),this.emit(Zi.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;Array.from(i.keys()).forEach((e=>{this.setPendingRemoteMedia(t,e)})),this.emit(Zi.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),t.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,t){for(const i of this.pendingRemoteTracks){const{user:n,kind:s}=i;if((e instanceof Vo?e.uid:e)===n.uid&&t===s)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}async restartICE(e,t){let i,n;if(e===Ei.SEND_ONLY){if(!this.sendConnection)throw new h(l.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");i=await this.sendMutex.lock("From P2PChannel.restartICE"),n=this.sendConnection}else{if(!this.recvConnection)throw new h(l.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");i=await this.recvMutex.lock("From P2PChannel.restartICE"),n=this.recvConnection}try{if(t){const e=await n.restartICE(t);return n.isInRestartIce=!1,e}{const e=await n.restartICE();if(e){const t=await O(this,Zi.RequestP2PRestartICE,{direction:Ei.RECEIVE_ONLY,iceParameter:e});await n.restartICE(t),n.isInRestartIce=!1}}}finally{i()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const e=this.sendConnection.getStats(),t=this.localTrackMap.get(zi.LocalVideoTrack),i=this.localTrackMap.get(zi.LocalAudioTrack),n=e.videoSend.find((e=>{var i;return e.ssrc===(null==t||null===(i=t.ssrcs)||void 0===i?void 0:i[0].ssrcId)})),s=e.audioSend.find((e=>{var t;return e.ssrc===(null==i||null===(t=i.ssrcs)||void 0===t?void 0:t[0].ssrcId)}));if(!n||!s)return 1;const o=D(this,Zi.NeedSignalRTT),a=n?n.rttMs:void 0,r=s?s.rttMs:void 0,c=a&&r?(a+r)/2:a||r,d=(c&&o?(c+o)/2:c||o)||0,h=100*e.sendPacketLossRate*.7/50+.3*d/1500,l=h<.17?1:h<.36?2:h<.59?3:h<.1?4:5,u=null==t?void 0:t.track;if(u&&u._encoderConfig&&-1===u._hints.indexOf(et.SCREEN_TRACK)){const t=u._encoderConfig.bitrateMax,i=e.bitrate.actualEncoded;if(t&&i){const e=(1e3*t-i)/(1e3*t);return jt[e<.15?0:e<.3?1:e<.45?2:e<.6?3:4][l]}}return l}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const e=this.recvConnection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((i=>{let[n]=i;const s=n._audioSSRC,o=n._videoSSRC,a=e.audioRecv.find((e=>e.ssrc===s)),r=e.videoRecv.find((e=>e.ssrc===o));if(!a&&!r)return void(t+=1);const c=D(this,Zi.NeedSignalRTT),d=e.rtt,h=(d&&c?(d+c)/2:d||c)||0,l=a?a.jitterMs:void 0,u=e.recvPacketLossRate;let p=.7*u*100/50+.3*h/1500;l&&(p=.6*u*100/50+.2*h/1500+.2*l/400);t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new Promise(((t,i)=>{this.handleMuteLocalTrack(e,t,i)}))}filterTobePublishedTracks(e,t,i){const n=[],s=tt(),o=this.getAllTracks();e=e.filter((e=>-1===o.indexOf(e))),e=ae(e);let a=!1,r=!1;for(const o of e){if(o instanceof $e&&(this.localTrackMap.has(zi.LocalVideoTrack)||a?new h(l.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:o,type:zi.LocalVideoTrack}),a=!0),t)){const e=this.getLowVideoTrack(o,i);n.push({track:e,type:zi.LocalVideoLowTrack})}if(o instanceof Ze){const e=this.localTrackMap.get(zi.LocalAudioTrack);if(e){if(!(e.track instanceof Qe))throw new h(l.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new h(l.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(o),this.bindLocalAudioTrackEvents(o,!0)}else if(r){const e=n.find((e=>{let{type:t}=e;return t===zi.LocalAudioTrack}));if(!(e.track instanceof Qe))throw new h(l.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new h(l.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(o)}else{if(!s.webAudioMediaStreamDest||o instanceof Qe||o._bypassWebAudio)n.push({track:o,type:zi.LocalAudioTrack});else{const e=new Qe;e.addAudioTrack(o),n.push({track:e,type:zi.LocalAudioTrack})}r=!0}}}return n}filterTobeUnpublishedTracks(e){const t=[],i=this.getAllTracks();e=e.filter((e=>-1!==i.indexOf(e))),e=ae(e);for(const i of e){if(i instanceof Ze){const e=this.localTrackMap.get(zi.LocalAudioTrack);if(!e)continue;e.track instanceof Qe?(e.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===e.track.trackList.length&&(t.push([zi.LocalAudioTrack,e]),e.track.close())):t.push([zi.LocalAudioTrack,e])}if(i instanceof $e){const e=this.localTrackMap.get(zi.LocalVideoTrack);if(!e)continue;t.push([zi.LocalVideoTrack,e]);const i=this.localTrackMap.get(zi.LocalVideoLowTrack);i&&t.push([zi.LocalVideoLowTrack,i])}}return t}bindLocalTrackEvents(e){e.forEach((e=>{let{track:t,type:i}=e;switch(i){case zi.LocalVideoTrack:t.addListener(ht.GET_STATS,this.handleGetLocalVideoStats),t.addListener(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(ht.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(ht.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.addListener(ht.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case zi.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case zi.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof Qe?e.trackList.forEach((e=>{e.addListener(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(ht.GET_STATS,this.handleGetLocalAudioStats),e.addListener(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(ht.GET_STATS,this.handleGetLocalAudioStats),e.addListener(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(ht.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((e=>{let[t,{track:i}]=e;return{track:i,type:t}}))),e.forEach((e=>{let{track:t,type:i}=e;switch(i){case zi.LocalVideoTrack:t.off(ht.GET_STATS,this.handleGetLocalVideoStats),t.off(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(ht.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(ht.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.off(ht.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case zi.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case zi.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof Qe?e.trackList.forEach((e=>{e.off(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(ht.GET_STATS,this.handleGetLocalAudioStats),e.off(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(ht.GET_STATS,this.handleGetLocalAudioStats),e.off(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(ht.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof dt&&t.addListener(ht.GET_STATS,(t=>{t(this.handleGetRemoteVideoStats(e))})),t instanceof ct&&t.addListener(ht.GET_STATS,(t=>{t(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(ht.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;i.has(Yi.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),i.has(Yi.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((e,i)=>{let n,{track:s,type:o}=e;switch(o){case zi.LocalAudioTrack:n=Mi.Audio;break;case zi.LocalVideoTrack:n=s._hints.includes(et.SCREEN_TRACK)?Mi.Screen:Mi.High;break;case zi.LocalVideoLowTrack:n=Mi.Low}return{kind:o===zi.LocalAudioTrack?Yi.AUDIO:Yi.VIDEO,stream_type:n,mid:t[i].id,ssrcs:t[i].localSSRC,isMuted:s.muted||!s.enabled}}))}createGatewayUnpublishMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:o}]=e;switch(i){case zi.LocalVideoTrack:t=n._hints.includes(et.SCREEN_TRACK)?Mi.Screen:Mi.High;break;case zi.LocalAudioTrack:t=Mi.Audio;break;case zi.LocalVideoLowTrack:t=Mi.Low}return{stream_type:t,ssrcs:s,mid:o}}))}assignLocalTracks(e,t){e.forEach(((e,i)=>{let{track:n,type:s}=e;this.localTrackMap.set(s,{track:n,id:t[i].id,ssrcs:t[i].localSSRC})}))}withdrawLocalTracks(e){e.forEach((e=>{let[t]=e;this.localTrackMap.delete(t)}))}bindConnectionEvents(e){e.onConnectionStateChange=async i=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(e.name,".onConnectionStateChange(").concat(i,")")),this.emit(Zi.PeerConnectionStateChange,i),"connected"!==i||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===i&&(e.isInRestartIce=!1),this._restartStates.includes(i)&&!e.isInRestartIce&&("disconnected"===i&&await b(800),"disconnected"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||this.handleDisconnect(e.direction))},e.onICEConnectionStateChange=e=>{"connected"!==e||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),i.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:X.TRACER}).onSuccess(),this.emit(Zi.IceConnectionStateChange,e)},e.onICETransportStateChange=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},e.onDTLSTransportStateChange=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},e.onDTLSTransportError=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},e.onFirstAudioDecoded=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._audioSSRC===e));var o;t&&(this.store.subscribe(t.uid,"audio",void 0,void 0,void 0,Date.now()),null===(o=t.audioTrack)||void 0===o||o.emit(lt.FIRST_FRAME_DECODED),i.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_DECODE,s.FIRST_AUDIO_DECODE,{peer:t._uintid,subscribeElapse:Ls.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._audioSSRC===e));t&&i.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_RECEIVED,s.FIRST_AUDIO_RECEIVED,{peer:t._uintid,subscribeElapse:Ls.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(e,t,i)=>{this.reportVideoFirstFrameDecoded(e,t,i)},e.onFirstVideoReceived=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._videoSSRC===e));t&&i.firstRemoteFrame(this.store.sessionId,n.FIRST_VIDEO_RECEIVED,s.FIRST_VIDEO_RECEIVED,{peer:t._uintid,subscribeElapse:Ls.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(e,i)=>{const n="relay"===e.candidateType,s="relay"===i.candidateType;"unknown"!==i.candidateType&&n===s||this.emit(Zi.ConnectionTypeChange,n),t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Vn(i))," -> ").concat(JSON.stringify(Vn(e)),")"))},e.onSelectedRemoteCandidateChanged=(e,i)=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Vn(i))," -> ").concat(JSON.stringify(Vn(e)),")"))},e.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},e.onLocalCandidate=t=>{this.emit(Zi.LocalCandidate,{candidate:t,direction:e.direction})}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}async handleDisconnect(e){const i=e===Ei.SEND_ONLY?this.sendConnection:this.recvConnection;i&&!i.isInRestartIce&&(i.isInRestartIce=!0,t.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(i.name,"] start use restartICE")),e===Ei.SEND_ONLY?this.restartICE(e):O(this,Zi.RequestP2PRestartICE,{direction:Ei.SEND_ONLY}))}filterTobeMutedTracks(e){const t=[];if(-1===this.getAllTracks().indexOf(e))return t;const i=this.localTrackMap.get(zi.LocalAudioTrack);if(e instanceof Ze&&(null==i?void 0:i.track)instanceof Qe)return i.track.isActive||t.push([zi.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n&&(t.push(n),n[0]===zi.LocalVideoTrack)){const e=this.localTrackMap.get(zi.LocalVideoLowTrack);e&&t.push([zi.LocalVideoLowTrack,e])}return t}filterTobeUnmutedTracks(e){const t=[],i=this.localTrackMap.get(zi.LocalAudioTrack);if(e instanceof Ze&&(null==i?void 0:i.track)instanceof Qe)return i.track.isActive&&t.push([zi.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n)if(n[0]===zi.LocalVideoTrack){t.push(n);const e=this.localTrackMap.get(zi.LocalVideoLowTrack);e&&t.push([zi.LocalVideoLowTrack,e])}else t.push(n);return t}createMuteMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:o}]=e;switch(i){case zi.LocalAudioTrack:t=Mi.Audio;break;case zi.LocalVideoTrack:t=n._hints.includes(et.SCREEN_TRACK)?Mi.Screen:Mi.High;break;case zi.LocalVideoLowTrack:t=Mi.Low}return{stream_type:t,ssrcs:s,mid:o}}))}createUnmuteMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:o}]=e;switch(i){case zi.LocalAudioTrack:t=Mi.Audio;break;case zi.LocalVideoTrack:t=n._hints.includes(et.SCREEN_TRACK)?Mi.Screen:Mi.High;break;case zi.LocalVideoLowTrack:t=Mi.Low}return{stream_type:t,ssrcs:s,mid:o}}))}filterTobeUnSubscribedTracks(e,t){const i=[],n=this.remoteUserMap.get(e);if(!n)return i;if(t){const s=n.get(t);if(!s)return i;i.push([e,{kind:t,id:s}])}else Array.from(n.entries()).forEach((t=>{let[n,s]=t;i.push([e,{kind:n,id:s}])}));return i}createUnsubscribeMessage(e){const t=[];return e.forEach((e=>{let[i,{kind:n,id:s}]=e;switch(n){case Yi.VIDEO:return void(i._videoSSRC&&t.push({stream_type:Yi.VIDEO,ssrcId:i._videoSSRC}));case Yi.AUDIO:return void(i._audioSSRC&&t.push({stream_type:Yi.AUDIO,ssrcId:i._audioSSRC}))}})),t}withdrawRemoteTracks(e){e.forEach((e=>{let[t,{kind:i}]=e;const n=this.remoteUserMap.get(t);n&&(n.delete(i),0===Array.from(n.entries()).length&&this.remoteUserMap.delete(t))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(zi.LocalVideoTrack),i=this.localTrackMap.get(zi.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),i&&e.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const e=this.sendConnection.peerConnectionState,t=this.recvConnection.peerConnectionState;return"connected"!==e&&"connected"!==t}return!0}async tryToUnmuteAudio(e){for(let t=0;t<e.length;t++)if(e[t]instanceof Ze){const i=this.filterTobeUnmutedTracks(e[t]);if(0===i.length)continue;const n=this.createUnmuteMessage(i);return void await oe(this,Zi.RequestUnmuteLocal,n)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter((e=>{let[,{ssrcs:t}]=e;return!!t})),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!(null===(t=this.recvConnection)||void 0===t||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(Zi.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(Zi.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await b(N(this.dtlsFailedCount,Q)),this.emit(Zi.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(zi.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof $e))}throwIfTrackTypeNotMatch(e){if(e.filter((e=>e instanceof $e)).length>1)throw new h(l.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((e=>e instanceof Ze)).length>1&&(e.some((e=>e instanceof Ze&&e._bypassWebAudio))||!tt().webAudioMediaStreamDest))throw new h(l.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof $e&&this.pendingLocalTracks.some((e=>e instanceof $e)))throw new h(l.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof Ze&&this.pendingLocalTracks.some((e=>e instanceof Ze))&&(!tt().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((e=>e instanceof Ze&&e._bypassWebAudio))))throw new h(l.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const i=!f("DISABLE_DUAL_STREAM_USE_ENCODING")&&tt().supportDualStreamEncoding,n=Zt(Zt({},{width:160,height:120,framerate:15,bitrate:50}),t);let s;s=i?e._mediaStreamTrack.clone():Ro(e,n);const o=M(8,"track-low-"),a=new $e(s,Zt(Zt({},i&&{scaleResolutionDownBy:xn(n,e)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,o);return a.on(ut.TRANSCEIVER_UPDATED,(t=>{e._updateRtpTransceiver(t,pt.LOW_STREAM)})),a._hints.push(et.LOW_STREAM),e.addListener(ht.NEED_CLOSE,(()=>{a.close()})),a}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,t,o,a){const r=Array.from(this.remoteUserMap.keys()).find((t=>t._videoSSRC===e));if(r){a||this.store.subscribe(r.uid,"video",void 0,void 0,void 0,void 0,Date.now());const c=this.store.keyMetrics,d=c.subscribe.find((e=>e.userId===r.uid&&"video"===e.type));i.firstRemoteVideoDecode(this.store.sessionId,n.FIRST_VIDEO_DECODE,s.FIRST_VIDEO_DECODE,{peer:r._uintid,videowidth:t,videoheight:o,subscribeElapse:Ls.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:c.requestAPEnd||0,apStart:c.requestAPStart||0,joinGwEnd:c.joinGatewayEnd||0,joinGwStart:c.joinGatewayStart||0,pcEnd:c.peerConnectionEnd||0,pcStart:c.peerConnectionStart||0,subscriberEnd:(null==d?void 0:d.subscribeEnd)||0,subscriberStart:(null==d?void 0:d.subscribeStart)||0,videoAddNotify:(null==d?void 0:d.streamAdded)||0,state:a?1:0})}}async remoteMediaSsrcChanged(e,t,i){if(!this.recvConnection)return!1;const n=this.remoteUserMap.get(e);if(!n)return!1;const s=n.get(t);if(!s)return!1;const o=await this.recvConnection.getRemoteSSRC(s);return void 0!==o&&o!==i}resetConnection(e){t.debug("[".concat(this.store.clientId,"] [P2PChannel2] reset connection to ").concat(e)),this.state===Qi.Connected?(t.debug("[".concat(this.store.clientId,"] [P2PChannel2] fallback to websocket but P2PChannel2 state still connected, disconnect first")),this.disconnectForReconnect()):(this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0))}async publishDataChannel(e){throw new h(l.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new h(l.NOT_SUPPORTED)}async subscribeDataChannel(e,t){throw new h(l.NOT_SUPPORTED)}async unsubscribeDataChannel(e,t){throw new h(l.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,t){throw new h(l.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,t){throw new h(l.NOT_SUPPORTED)}async preConnect(e,t,i,n,s,o){throw new h(l.NOT_SUPPORTED)}getEstablishParams(){throw new h(l.NOT_SUPPORTED)}async reSubscribe(e){throw new h(l.NOT_SUPPORTED)}async updateVideoStreamParameter(e,t){throw new h(l.NOT_SUPPORTED)}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;t===zi.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,pt.LOW_STREAM):i._updateRtpTransceiver(void 0)}))}}).prototype,"p2pConnect",[Wo],Object.getOwnPropertyDescriptor(ea.prototype,"p2pConnect"),ea.prototype),ii(ea.prototype,"unpublish",[Ho],Object.getOwnPropertyDescriptor(ea.prototype,"unpublish"),ea.prototype),ii(ea.prototype,"unpublishLowStream",[Ko],Object.getOwnPropertyDescriptor(ea.prototype,"unpublishLowStream"),ea.prototype),ii(ea.prototype,"subscribe",[qo],Object.getOwnPropertyDescriptor(ea.prototype,"subscribe"),ea.prototype),ii(ea.prototype,"mockSubscribe",[Yo],Object.getOwnPropertyDescriptor(ea.prototype,"mockSubscribe"),ea.prototype),ii(ea.prototype,"unsubscribe",[Jo],Object.getOwnPropertyDescriptor(ea.prototype,"unsubscribe"),ea.prototype),ii(ea.prototype,"muteRemote",[Xo],Object.getOwnPropertyDescriptor(ea.prototype,"muteRemote"),ea.prototype),ii(ea.prototype,"unmuteRemote",[zo],Object.getOwnPropertyDescriptor(ea.prototype,"unmuteRemote"),ea.prototype),ii(ea.prototype,"hasRemoteMediaWithLock",[Qo],Object.getOwnPropertyDescriptor(ea.prototype,"hasRemoteMediaWithLock"),ea.prototype),ii(ea.prototype,"disconnectForReconnect",[Zo],Object.getOwnPropertyDescriptor(ea.prototype,"disconnectForReconnect"),ea.prototype),ii(ea.prototype,"remoteMediaSsrcChanged",[$o],Object.getOwnPropertyDescriptor(ea.prototype,"remoteMediaSsrcChanged"),ea.prototype),ea);function ia(e){return function(t,i,n){const s=t[i];if("function"!=typeof s)throw new Error("Cannot use mutex on object property.");return n.value=async function(){for(var t=arguments.length,n=new Array(t),o=0;o<t;o++)n[o]=arguments[o];switch(e){case Fo.SEND_ONLY:{const e=await this.sendMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{e()}}case Fo.RECEIVE_ONLY:{const e=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{e()}}default:{const e=await this.sendMutex.lock("From P2PChannel2.".concat(i)),t=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{e(),t()}}}},n}}class na{constructor(e){this.store=void 0,this.onStatsException=void 0,this.onUploadPublishDuration=void 0,this.onStatsChanged=void 0,this.localStats=new Map,this.remoteStats=new Map,this.updateStatsInterval=void 0,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0,this.exceptionMonitor=void 0,this.p2pChannel=void 0,this.scalabilityMode=ni.L1T1,this.updateStats=()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))},this.store=e,this.exceptionMonitor=new Ds,this.exceptionMonitor.on("exception",((e,t,i)=>{this.onStatsException&&this.onStatsException(e,t,i)}))}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(zi.LocalAudioTrack)||Zt({},_t)}getLocalVideoTrackStats(){return this.localStats.get(zi.LocalVideoTrack)||Zt({},Et)}getRemoteAudioTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const i=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return i&&(t.publishDuration=i.B_ppad+(Date.now()-this.trafficStats.timestamp)),t},i={};if(e){var n;const s=null===(n=this.remoteStats.get(e))||void 0===n?void 0:n.audioStats;s&&(i[e]=t(e,s))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[n,{audioStats:s}]=e;s&&(i[n]=t(n,s))}));return i}getRemoteNetworkQualityStats(e){const t={};if(e){var i;const n=null===(i=this.remoteStats.get(e))||void 0===i?void 0:i.networkStats;n&&(t[e]=n)}else Array.from(this.remoteStats.entries()).forEach((e=>{let[i,{networkStats:n}]=e;n&&(t[i]=n)}));return t}getRemoteVideoTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const i=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return i&&(t.publishDuration=i.B_ppvd+(Date.now()-this.trafficStats.timestamp)),t},i={};if(e){var n;const s=null===(n=this.remoteStats.get(e))||void 0===n?void 0:n.videoStats;s&&(i[e]=t(e,s))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[n,{videoStats:s}]=e;s&&(i[n]=t(n,s))}));return i}getRTCStats(){let e=0,t=0,i=0,n=0;const s=this.localStats.get(zi.LocalAudioTrack);s&&(e+=s.sendBytes,t+=s.sendBitrate);const o=this.localStats.get(zi.LocalVideoTrack);o&&(e+=o.sendBytes,t+=o.sendBitrate);const a=this.localStats.get(zi.LocalVideoLowTrack);a&&(e+=a.sendBytes,t+=a.sendBitrate),this.remoteStats.forEach((e=>{let{audioStats:t,videoStats:s}=e;t&&(i+=t.receiveBytes,n+=t.receiveBitrate),s&&(i+=s.receiveBytes,n+=s.receiveBitrate)}));let r=1;return this.trafficStats&&(r+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:r,SendBitrate:t,SendBytes:e,RecvBytes:i,RecvBitrate:n,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter((e=>void 0!==e.B_ppad||void 0!==e.B_ppvd));e.peer_delay.filter((e=>-1===this.trafficStatsPeerList.indexOf(e.peer_uid))).forEach((e=>{var t;const i=null===(t=this.p2pChannel)||void 0===t?void 0:t.getRemoteMedia(e.peer_uid),n=null!=i&&i.videoSSRC?Ls.measureFromSubscribeStart(this.store.clientId,i.videoSSRC):0,s=null!=i&&i.audioSSRC?Ls.measureFromSubscribeStart(this.store.clientId,i.audioSSRC):0;void 0!==e.B_ppad&&void 0!==e.B_ppvd&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(e.peer_uid,e.B_ppad,e.B_ppvd,n>s?n:s),this.trafficStatsPeerList.push(e.peer_uid))})),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&t.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,t,i){if(!e)return!1;const n=!!i&&t.framesDecodeFreezeTime>i.framesDecodeFreezeTime,s=!i||t.framesDecodeCount>i.framesDecodeCount;return n||!s}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&(e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3)}updateLocalStats(e){Array.from(this.localStats.entries()).forEach((i=>{let[n,s]=i;switch(n){case zi.LocalVideoTrack:case zi.LocalVideoLowTrack:{const i=s,a=Zt({},Et),r=e.getStats(),c=e.getLocalMedia(n);if(r){const n=r.videoSend.find((e=>e.ssrc===(null==c?void 0:c.ssrcs[0].ssrcId)));if(n){const s=e.getLocalVideoSize(),o=e.getEncoderConfig(zi.LocalVideoTrack);"H264"!==n.codec&&"H265"!==n.codec&&"VP8"!==n.codec&&"VP9"!==n.codec&&"AV1X"!==n.codec&&"AV1"!==n.codec||(a.codecType=n.codec),a.sendBytes=n.bytes,a.sendBitrate=i?8*Math.max(0,a.sendBytes-i.sendBytes):0,n.inputFrame?(a.captureFrameRate=n.inputFrame.frameRate,a.captureResolutionHeight=n.inputFrame.height,a.captureResolutionWidth=n.inputFrame.width):s&&(a.captureResolutionWidth=s.width,a.captureResolutionHeight=s.height),n.sentFrame?(a.sendFrameRate=n.sentFrame.frameRate,a.sendResolutionHeight=n.sentFrame.height,a.sendResolutionWidth=n.sentFrame.width):s&&(a.sendResolutionWidth=s.width,a.sendResolutionHeight=s.height),n.avgEncodeMs&&(a.encodeDelay=n.avgEncodeMs),o&&o.bitrateMax&&(a.targetSendBitrate=1e3*o.bitrateMax),a.sendPackets=n.packets,a.sendPacketsLost=n.packetsLost,a.sendJitterMs=n.jitterMs,a.sendRttMs=n.rttMs,a.totalDuration=i?i.totalDuration+1:1,a.totalFreezeTime=i?i.totalFreezeTime:0,this.isLocalVideoFreeze(n)&&(a.totalFreezeTime+=1),n.scalabilityMode&&this.scalabilityMode!==n.scalabilityMode&&(t.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(n.scalabilityMode)),this.scalabilityMode=n.scalabilityMode)}this.trafficStats&&(a.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var o;if(this.localStats.set(n,a),(null==i?void 0:i.sendResolutionWidth)!==a.sendResolutionWidth||(null==i?void 0:i.sendResolutionHeight)!==a.sendResolutionHeight)null===(o=this.onStatsChanged)||void 0===o||o.call(this,"resolution",{width:a.sendResolutionWidth,height:a.sendResolutionHeight});a&&c&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,c.track,a);break}case zi.LocalAudioTrack:{const t=s,i=Zt({},_t),o=e.getStats(),a=e.getLocalMedia(n);if(o){const n=o.audioSend.find((e=>e.ssrc===(null==a?void 0:a.ssrcs[0].ssrcId)));if(n){if("opus"!==n.codec&&"aac"!==n.codec&&"PCMU"!==n.codec&&"PCMA"!==n.codec&&"G722"!==n.codec||(i.codecType=n.codec),n.inputLevel)i.sendVolumeLevel=Math.round(32767*n.inputLevel);else{const t=e.getLocalAudioVolume();t&&(i.sendVolumeLevel=Math.round(32767*t))}i.sendBytes=n.bytes,i.sendPackets=n.packets,i.sendPacketsLost=n.packetsLost,i.sendJitterMs=n.jitterMs,i.sendRttMs=n.rttMs,i.sendBitrate=t?8*Math.max(0,i.sendBytes-t.sendBytes):0}}this.trafficStats&&(i.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(zi.LocalAudioTrack,i),i&&a&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,a.track,i);break}}}))}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach((t=>{var i,n;let[s,{videoStats:o,audioStats:a,videoPcStats:r}]=t;const c=a,d=o,h=r,l=Zt({},mt),u=Zt({},St),p=Zt({},Tt),{audioTrack:_,videoTrack:E,audioSSRC:m,videoSSRC:S}=e.getRemoteMedia(s);let T;T=e instanceof ta?e.getStats(!0):e.getStats();const C=null===(i=T)||void 0===i?void 0:i.audioRecv.find((e=>e.ssrc===m)),f=null===(n=T)||void 0===n?void 0:n.videoRecv.find((e=>e.ssrc===S)),R=this.trafficStats&&this.trafficStats.peer_delay.find((e=>e.peer_uid===s));if(C&&("opus"!==C.codec&&"aac"!==C.codec&&"PCMU"!==C.codec&&"PCMA"!==C.codec&&"G722"!==C.codec||(l.codecType=C.codec),C.outputLevel?l.receiveLevel=Math.round(32767*C.outputLevel):_&&(l.receiveLevel=Math.round(32767*_.getVolumeLevel())),l.receiveBytes=C.bytes,l.receivePackets=C.packets,l.receivePacketsLost=C.packetsLost,l.packetLossRate=l.receivePacketsLost/(l.receivePackets+l.receivePacketsLost),l.receiveBitrate=c?8*Math.max(0,l.receiveBytes-c.receiveBytes):0,l.totalDuration=c?c.totalDuration+1:1,l.totalFreezeTime=c?c.totalFreezeTime:0,l.freezeRate=l.totalFreezeTime/l.totalDuration,l.receiveDelay=C.jitterBufferMs,l.totalDuration>10&&na.isRemoteAudioFreeze(_)&&(l.totalFreezeTime+=1)),f){"H264"!==f.codec&&"H265"!==f.codec&&"VP8"!==f.codec&&"VP9"!==f.codec&&"AV1X"!==f.codec&&"AV1"!==f.codec||(u.codecType=f.codec),u.receiveBytes=f.bytes,u.receiveBitrate=d?8*Math.max(0,u.receiveBytes-d.receiveBytes):0,u.decodeFrameRate=f.decodeFrameRate<0?0:f.decodeFrameRate,u.renderFrameRate=f.decodeFrameRate<0?0:f.decodeFrameRate,f.outputFrame&&(u.renderFrameRate=f.outputFrame.frameRate),f.receivedFrame?(u.receiveFrameRate=f.receivedFrame.frameRate,u.receiveResolutionHeight=f.receivedFrame.height,u.receiveResolutionWidth=f.receivedFrame.width):E&&(u.receiveResolutionHeight=E._videoHeight||0,u.receiveResolutionWidth=E._videoWidth||0),void 0!==f.framesRateFirefox&&(u.receiveFrameRate=Math.round(f.framesRateFirefox)),u.receivePackets=f.packets,u.receivePacketsLost=f.packetsLost,u.packetLossRate=u.receivePacketsLost/(u.receivePackets+u.receivePacketsLost),u.totalDuration=d?d.totalDuration+1:1,u.totalFreezeTime=d?d.totalFreezeTime:0,u.receiveDelay=f.jitterBufferMs||0;const t=!!S&&e.getRemoteVideoIsReady(S);E&&t&&na.isRemoteVideoFreeze(E,f,h)&&(u.totalFreezeTime+=1),u.freezeRate=u.totalFreezeTime/u.totalDuration}R&&(l.end2EndDelay=R.B_ad,u.end2EndDelay=R.B_vd,l.transportDelay=R.B_ed,u.transportDelay=R.B_ed,l.currentPacketLossRate=R.B_ealr4/100,u.currentPacketLossRate=R.B_evlr4/100,p.uplinkNetworkQuality=R.B_punq?R.B_punq:0,p.downlinkNetworkQuality=R.B_pdnq?R.B_pdnq:0),this.remoteStats.set(s,{audioStats:l,videoStats:u,videoPcStats:f,networkStats:p}),_&&this.exceptionMonitor.setRemoteAudioStats(_,l),E&&this.exceptionMonitor.setRemoteVideoStats(E,u)}))}}class sa extends C{constructor(e,t,n,s){super(),this.spec=void 0,this.token=void 0,this.websocket=void 0,this.pingpongTimer=void 0,this.reconnectMode="retry",this.serviceMode=void 0,this.reqId=0,this.commandReqId=0,this.handleWebSocketOpen=()=>{this.reconnectMode="retry",this.startPingPong()},this.handleWebSocketMessage=e=>{if(!e.data)return;const t=JSON.parse(e.data);t.requestId?this.emit("@".concat(t.requestId,"-").concat(t.sid),t):this.serviceMode===fi.INJECT?this.emit(yi.INJECT_STREAM_STATUS,t):(i.workerEvent(this.spec.sid,{actionType:"status",serverCode:t.code,workerType:this.serviceMode===fi.TRANSCODE?1:2}),this.emit(yi.PUBLISH_STREAM_STATUS,t))},this.spec=t,this.token=e,this.serviceMode=s,this.websocket=new yn("live-streaming",n),this.websocket.on(mi.CONNECTED,this.handleWebSocketOpen),this.websocket.on(mi.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(mi.REQUEST_NEW_URLS,((e,t)=>{O(this,yi.REQUEST_NEW_ADDRESS).then(e).catch(t)})),this.websocket.on(mi.RECONNECTING,(()=>{this.websocket.reconnectMode=this.reconnectMode}))}init(e){return this.websocket.init(e)}async request(e,t,n,s){this.reqId+=1,"request"===e&&(this.commandReqId+=1);const o=this.commandReqId,a=this.reqId;if(!a||!this.websocket)throw new Si(l.UNEXPECTED_ERROR);const r=Zt({command:e,sdkVersion:"4.21.0"===H?"0.0.1":H,seq:a,requestId:a,allocate:n,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},t);if("closed"===this.websocket.state)throw new Si(l.WS_DISCONNECT);const c=()=>new Promise(((e,t)=>{this.websocket.once(mi.CLOSED,(()=>t(new Si(l.WS_ABORT)))),this.websocket.once(mi.CONNECTED,e)}));"connected"!==this.websocket.state&&await c(),r.clientRequest&&(r.clientRequest.workerToken=this.token);const d=new Promise(((e,t)=>{const i=()=>{t(new Si(l.WS_ABORT))};this.websocket.once(mi.RECONNECTING,i),this.websocket.once(mi.CLOSED,i),this.once("@".concat(a,"-").concat(this.spec.sid),(t=>{e(t)}))}));s&&i.workerEvent(this.spec.sid,Zt(Zt({},s),{},{requestId:o,actionType:"request",payload:JSON.stringify(t.clientRequest),serverCode:0,code:0}));const h=Date.now();this.websocket.sendMessage(r);let u=null;try{u=await d}catch(i){if("closed"===this.websocket.state)throw i;return await c(),await this.request(e,t,n)}return s&&i.workerEvent(this.spec.sid,Zt(Zt({},s),{},{requestId:o,actionType:"response",payload:JSON.stringify(u.serverResponse),serverCode:u.code,success:200===u.code,responseTime:Date.now()-h})),200!==u.code&&this.handleResponseError(u),u}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const e="4.21.0"===H?"0.0.1":H;this.reqId+=1,"connected"===this.websocket.state?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case bi.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void t.warning("live stream response already exists stream");case bi.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case bi.LIVE_STREAM_RESPONSE_BAD_STREAM:case bi.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new Si(l.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case bi.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;throw new Si(l.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case bi.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new Si(l.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case bi.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const t=new Si(l.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(yi.WARNING,t,e.serverResponse.url)}case bi.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const t=new Si(l.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(yi.WARNING,t,e.serverResponse.url)}case bi.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new Si(l.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case bi.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new Si(l.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case bi.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const t=new Si(l.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(yi.WARNING,t,e.serverResponse.url)}case bi.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new Si(l.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case bi.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new Si(l.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case bi.LIVE_STREAM_RESPONSE_WORKER_LOST:case bi.LIVE_STREAM_RESPONSE_WORKER_QUIT:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;throw new Si(l.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case bi.ERROR_FAIL_SEND_MESSAGE:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;if("UpdateTranscoding"===e.serverResponse.command||"ControlStream"===e.serverResponse.command)return new Si(l.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new Si(l.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case bi.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case bi.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case bi.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case bi.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new Si(l.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval((()=>{"connected"===this.websocket.state&&this.request("ping",{}).catch(re)}),6e3)}}class oa extends C{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Q,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Q;super(),this.onLiveStreamWarning=void 0,this.onLiveStreamError=void 0,this.onInjectStatusChange=void 0,this.spec=void 0,this.retryTimeout=1e4,this.connection=void 0,this.httpRetryConfig=void 0,this.wsRetryConfig=void 0,this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.taskMutex=new v("live-streaming"),this.cancelToken=ze.CancelToken.source(),this.transcodingConfig=void 0,this.injectConfig=Zt({},wi),this.injectLoopTimes=0,this.uapResponse=void 0,this.lastTaskId=1,this.statusError=new Map,this.spec=e,this.httpRetryConfig=i,this.wsRetryConfig=t}async setTranscodingConfig(e){const i=Zt(Zt({},Ai),e);66!==i.videoCodecProfile&&77!==i.videoCodecProfile&&100!==i.videoCodecProfile&&(t.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(i.videoCodecProfile," -> 100")),i.videoCodecProfile=100),i.transcodingUsers||(i.transcodingUsers=i.userConfigs),i.transcodingUsers&&(i.transcodingUsers=i.transcodingUsers.map((e=>Zt(Zt(Zt({},gi),e),{},{zOrder:e.zOrder?e.zOrder+1:1})))),function(e){p(e.width)||_(e.width,"config.width",0,1e4),p(e.height)||_(e.height,"config.height",0,1e4),p(e.videoBitrate)||_(e.videoBitrate,"config.videoBitrate",1,1e6),p(e.videoFrameRate)||_(e.videoFrameRate,"config.videoFrameRate"),p(e.lowLatency)||E(e.lowLatency,"config.lowLatency"),p(e.audioSampleRate)||m(e.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),p(e.audioBitrate)||_(e.audioBitrate,"config.audioBitrate",1,128),p(e.audioChannels)||m(e.audioChannels,"config.audioChannels",[1,2,3,4,5]),p(e.videoGop)||_(e.videoGop,"config.videoGop"),p(e.videoCodecProfile)||m(e.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),p(e.userCount)||_(e.userCount,"config.userCount",0,17),p(e.backgroundColor)||_(e.backgroundColor,"config.backgroundColor",0,16777215),p(e.userConfigExtraInfo)||S(e.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),e.transcodingUsers&&!p(e.transcodingUsers)&&(T(e.transcodingUsers,"config.transcodingUsers"),e.transcodingUsers.forEach(((e,t)=>{Ci(e.uid),p(e.x)||_(e.x,"transcodingUser[".concat(t,"].x"),0,1e4),p(e.y)||_(e.y,"transcodingUser[".concat(t,"].y"),0,1e4),p(e.width)||_(e.width,"transcodingUser[".concat(t,"].width"),0,1e4),p(e.height)||_(e.height,"transcodingUser[".concat(t,"].height"),0,1e4),p(e.zOrder)||_(e.zOrder-1,"transcodingUser[".concat(t,"].zOrder"),0,100),p(e.alpha)||_(e.alpha,"transcodingUser[".concat(t,"].alpha"),0,1,!1)}))),p(e.watermark)||vi(e.watermark,"watermark"),p(e.backgroundImage)||vi(e.backgroundImage,"backgroundImage"),e.images&&!p(e.images)&&(T(e.images,"config.images"),e.images.forEach(((e,t)=>{vi(e,"images[".concat(t,"]"))})))}(i);const n=[];i.images&&n.push(...i.images.map((e=>Zt(Zt(Zt({},Ii),e),{},{zOrder:255})))),i.backgroundImage&&(n.push(Zt(Zt(Zt({},Ii),i.backgroundImage),{},{zOrder:0})),delete i.backgroundImage),i.watermark&&(n.push(Zt(Zt(Zt({},Ii),i.watermark),{},{zOrder:255})),delete i.watermark),i.images=n,i.transcodingUsers&&(i.userConfigs=i.transcodingUsers.map((e=>Zt({},e))),i.userCount=i.transcodingUsers.length,delete i.transcodingUsers);const s=(i.userConfigs||[]).map((e=>"number"==typeof e.uid?Promise.resolve(e.uid):gs(e.uid,this.spec,this.cancelToken.token,this.httpRetryConfig)));if((await Promise.all(s)).forEach(((e,t)=>{i.userConfigs&&i.userConfigs[t]&&(i.userConfigs[t].uid=e)})),this.transcodingConfig=i,this.connection)try{const e=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(this.streamingTasks.values()).map((e=>e.taskId)).join("#")});t.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(e.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(e){if(!e.data||!e.data.retry)throw e;e.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach((i=>{t.warning("[".concat(this.spec.clientId,"] live streaming receive error"),e.toString(),"try to republish",i.url),this.startLiveStreamingTask(i.url,i.mode,e).then((()=>{t.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(i.url," success"))})).catch((e=>{t.error("[".concat(this.spec.clientId,"] live streaming republish failed"),i.url,e.toString()),this.onLiveStreamError&&this.onLiveStreamError(i.url,e)}))}))}}setInjectStreamConfig(e,t){this.injectConfig=Object.assign({},this.injectConfig,e),this.injectLoopTimes=t}async startLiveStreamingTask(e,i,n){if(Array.from(this.streamingTasks.values()).find((e=>e.mode===fi.INJECT))&&i===fi.INJECT)return new Si(l.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&i===fi.TRANSCODE)throw new Si(l.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let s={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};t.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(i));const o=await this.taskMutex.lock();if(!this.connection&&n)return void o();if(this.streamingTasks.get(e)&&!n)return o(),new Si(l.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(i))}catch(e){throw o(),e}switch(i){case fi.TRANSCODE:s.transcodingConfig=Zt({},this.transcodingConfig);break;case fi.RAW:break;case fi.INJECT:s={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:e,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(s.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const a=this.lastTaskId++;try{const r=new Promise(((t,i)=>{b(this.retryTimeout).then((()=>{if(n)return i(n);const t=this.statusError.get(e);return t?(this.statusError.delete(e),i(t)):void 0}))})),c=await Promise.race([this.connection.request("request",{clientRequest:s},!0,{url:e,command:"PublishStream",workerType:i===fi.TRANSCODE?1:2,requestByUser:!n,tid:a.toString()}),r]);this.isStartingStreamingTask=!1,t.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(c.code)),this.streamingTasks.set(e,{clientRequest:s,mode:i,url:e,taskId:a}),o()}catch(t){if(o(),this.isStartingStreamingTask=!1,!t.data||!t.data.retry||n)throw t;return t.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,i,t)):await this.startLiveStreamingTask(e,i,t)}}stopLiveStreamingTask(e){return new Promise(((i,n)=>{const s=this.streamingTasks.get(e);if(!s||!this.connection)return new Si(l.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const o=s.mode;s.abortTask=()=>{t.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),i()},this.connection.request("request",{clientRequest:{command:o===fi.INJECT?"UninjectStream":"UnpublishStream",url:s.url}},!1,{url:e,command:"UnPublishStream",workerType:o===fi.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then((n=>{t.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(n.code)),this.streamingTasks.delete(e),0===this.streamingTasks.size&&o!==fi.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),i(),o===fi.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(Ri.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,e)})).catch(n)}))}async controlInjectStream(e,t,i,n){const s=this.streamingTasks.get(e);if(!s||!this.connection||s.mode!==fi.INJECT)throw new Si(l.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:e,control:t,audioVolume:i,position:n}})).serverResponse}resetAllTask(){const e=Array.from(this.streamingTasks.values());this.terminate();for(const t of e)this.startLiveStreamingTask(t.url,t.mode).catch((e=>{this.onLiveStreamError&&this.onLiveStreamError(t.url,e)}))}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=ze.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new Si(l.UNEXPECTED_ERROR,"live streaming connection has already connected");const t=await O(this,Ni.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=t,this.connection=new sa(t.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(yi.WARNING,((e,t)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(t,e))),this.connection.on(yi.PUBLISH_STREAM_STATUS,(e=>this.handlePublishStreamServer(e))),this.connection.on(yi.INJECT_STREAM_STATUS,(e=>this.handleInjectStreamServerStatus(e))),this.connection.on(yi.REQUEST_NEW_ADDRESS,((t,i)=>{if(!this.connection)return i(new Si(l.UNEXPECTED_ERROR,"can not get new live streaming address list"));O(this,Ni.REQUEST_WORKER_MANAGER_LIST,e).then((e=>{this.uapResponse=e,t(e.addressList)})).catch(i)})),await this.connection.init(t.addressList),this.connection}handlePublishStreamServer(e){const i=e.serverStatus&&e.serverStatus.url||"empty_url",n=this.streamingTasks.get(i),s=e.reason;switch(e.code){case bi.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case bi.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case bi.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case bi.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const s=new Si(l.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(n)return t.error(s.toString()),this.onLiveStreamError&&this.onLiveStreamError(i,s);if(!this.isStartingStreamingTask)return;this.statusError.set(i,s)}case bi.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const e=new Si(l.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,s);return this.onLiveStreamWarning&&this.onLiveStreamWarning(i,e)}case bi.LIVE_STREAM_RESPONSE_WORKER_LOST:case bi.LIVE_STREAM_RESPONSE_WORKER_QUIT:{if(!this.connection)return;this.connection.tryNextAddress();const i=Array.from(this.streamingTasks.values());for(const n of i)n.abortTask?n.abortTask():(t.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",n.url),this.startLiveStreamingTask(n.url,n.mode,new Si(l.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then((()=>{t.debug("[".concat(this.spec.clientId,"] republish live stream success"),n.url)})).catch((e=>{t.error(e.toString()),this.onLiveStreamError&&this.onLiveStreamError(n.url,e)})));return}}}handleInjectStreamServerStatus(e){const i=Number(e.uid),n=e.serverStatus&&e.serverStatus.url;switch(e.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(Ri.INJECT_STREAM_STATUS_START_SUCCESS,i,n));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(Ri.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,i,n),void this.streamingTasks.delete(n);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(Ri.INJECT_STREAM_STATUS_START_UNAUTHORIZED,i,n),void this.streamingTasks.delete(n);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(Ri.INJECT_STREAM_STATUS_BROKEN,i,n),void this.streamingTasks.delete(n);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(Ri.INJECT_STREAM_STATUS_START_TIMEOUT,i,n),void this.streamingTasks.delete(n);default:return void t.debug("inject stream server status",e)}}hasUrl(e){return this.streamingTasks.has(e)}}class aa{constructor(){this.destChannelMediaInfos=new Map,this.srcChannelMediaInfo=void 0}setSrcChannelInfo(e){Oi(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){Oi(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){Ti(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function ra(e){if(!(e instanceof aa)){return new Si(l.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw()}const t=e.getSrcChannelMediaInfo(),i=e.getDestChannelMediaInfo();if(!t){return new Si(l.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw()}if(0===i.size){return new Si(l.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}}class ca extends C{constructor(e,t,i){super(),this.ws=void 0,this.requestId=1,this.heartBeatTimer=void 0,this.joinInfo=void 0,this.clientId=void 0,this.onOpen=()=>{this.emit("open"),this.startHeartBeatCheck()},this.onClose=e=>{this.emit("close"),this.dispose()},this.onMessage=e=>{const t=JSON.parse(e.data);if(!t||"serverResponse"!==t.command||!t.requestId)return t&&"serverStatus"===t.command&&t.serverStatus&&t.serverStatus.command?(this.emit("status",t.serverStatus),void this.emit(t.serverStatus.command,t.serverStatus)):void 0;this.emit("req_".concat(t.requestId),t)},this.joinInfo=e,this.clientId=t,this.ws=new yn("cross-channel-".concat(this.clientId),i),this.ws.on(mi.RECONNECTING,(()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")})),this.ws.on(mi.CONNECTED,this.onOpen),this.ws.on(mi.ON_MESSAGE,this.onMessage),this.ws.on(mi.CLOSED,this.onClose)}isConnect(){return"connected"===this.ws.state}sendMessage(e){const t=this.requestId++;return e.requestId=t,e.seq=t,this.ws.sendMessage(e),t}waitStatus(e){return new Promise(((t,i)=>{const n=window.setTimeout((()=>{i(new Si(l.TIMEOUT,"wait status timeout, status: ".concat(e)))}),5e3);this.once(e,(s=>{window.clearTimeout(n),s.state&&0!==s.state?i(new Si(l.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):t(void 0)})),this.once("dispose",(()=>{window.clearTimeout(n),i(new Si(l.WS_ABORT))}))}))}async request(e){if("closed"===this.ws.state)throw new Si(l.WS_DISCONNECT);const t=()=>new Promise(((e,t)=>{this.ws.once(mi.CLOSED,(()=>t(new Si(l.WS_ABORT)))),this.ws.once(mi.CONNECTED,e)}));"connected"!==this.ws.state&&await t();const i=this.sendMessage(e),n=new Promise(((e,t)=>{const n=()=>{t(new Si(l.WS_ABORT))};this.ws.once(mi.RECONNECTING,n),this.ws.once(mi.CLOSED,n),this.once("req_".concat(i),e),b(3e3).then((()=>{this.removeAllListeners("req_".concat(i)),this.ws.off(mi.RECONNECTING,n),this.ws.off(mi.CLOSED,n),t(new Si(l.TIMEOUT,"cross channel ws request timeout"))}))})),s=await n;if(!s||200!==s.code)throw new Si(l.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(s)));return s}async connect(e){this.ws.removeAllListeners(mi.REQUEST_NEW_URLS),this.ws.on(mi.REQUEST_NEW_URLS,(t=>{t(e)})),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){const t=this.requestId++;return e.requestId=t,this.ws.sendMessage(e),t}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval((()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})}),3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class da extends C{set state(e){e!==this._state&&(e!==Li.RELAY_STATE_FAILURE&&(this.errorCode=ki.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,i,n,s,o){super(),this.joinInfo=void 0,this.sid=void 0,this.clientId=void 0,this.cancelToken=ze.CancelToken.source(),this.workerToken=void 0,this.requestId=0,this.signal=void 0,this.prevChannelMediaConfig=void 0,this.httpRetryConfig=void 0,this._resolution=void 0,this._state=Li.RELAY_STATE_IDLE,this.errorCode=ki.RELAY_OK,this.onStatus=e=>{t.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(e))),e&&e.command&&("onAudioPacketReceived"===e.command&&this.emit("event",Pi.PACKET_RECEIVED_AUDIO_FROM_SRC),"onVideoPacketReceived"===e.command&&this.emit("event",Pi.PACKET_RECEIVED_VIDEO_FROM_SRC),"onSrcTokenPrivilegeDidExpire"===e.command&&(this.errorCode=ki.SRC_TOKEN_EXPIRED,this.state=Li.RELAY_STATE_FAILURE),"onDestTokenPrivilegeDidExpire"===e.command&&(this.errorCode=ki.DEST_TOKEN_EXPIRED,this.state=Li.RELAY_STATE_FAILURE))},this.onReconnect=async()=>{t.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",Pi.NETWORK_DISCONNECTED),this.state=Li.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch((e=>{this.state!==Li.RELAY_STATE_IDLE&&(t.error("auto restart channel media relay failed",e.toString()),this.errorCode=ki.SERVER_CONNECTION_LOST,this.state=Li.RELAY_STATE_FAILURE)}))},this.joinInfo=e,this.clientId=i,this.sid=ce(),this.signal=new ca(this.joinInfo,this.clientId,n),this.httpRetryConfig=s,this._resolution=o}async startChannelMediaRelay(e){if(this.state!==Li.RELAY_STATE_IDLE)throw new Si(l.INVALID_OPERATION);this.state=Li.RELAY_STATE_CONNECTING,await this.connect(),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(e){if(e.data&&e.data.serverResponse&&"SetSourceChannel"===e.data.serverResponse.command)throw new Si(l.CROSS_CHANNEL_FAILED_JOIN_SRC);if(e.data&&e.data.serverResponse&&"SetDestChannelStatus"===e.serverResponse.command)throw new Si(l.CROSS_CHANNEL_FAILED_JOIN_DEST);if(e.data&&e.data.serverResponse&&"StartPacketTransfer"===e.serverResponse.command)throw new Si(l.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST);throw e}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==Li.RELAY_STATE_RUNNING)throw new Si(l.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async setVideoProfile(e){if(this._resolution=e,this.state!==Li.RELAY_STATE_RUNNING)throw new Si(l.INVALID_OPERATION);const i=this.genMessage(Di.SetVideoProfile);await this.signal.request(i),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),t.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=Li.RELAY_STATE_IDLE,this.dispose()}dispose(){t.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=ze.CancelToken.source(),this.state=Li.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const e=await Ns(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",Pi.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){const i=this.genMessage(Di.StopPacketTransfer);await this.signal.request(i),await this.signal.waitStatus("Normal Quit"),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const n=this.genMessage(Di.SetSdkProfile,e);await this.signal.request(n),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const s=this.genMessage(Di.SetSourceChannel,e);await this.signal.request(s),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",Pi.PACKET_JOINED_SRC_CHANNEL),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const o=this.genMessage(Di.SetSourceUserId,e);await this.signal.request(o),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const a=this.genMessage(Di.SetDestChannel,e);await this.signal.request(a),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",Pi.PACKET_JOINED_DEST_CHANNEL),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const r=this.genMessage(Di.StartPacketTransfer,e);await this.signal.request(r),this.emit("event",Pi.PACKET_SENT_TO_DEST_CHANNEL),this.state=Li.RELAY_STATE_RUNNING,t.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(e){const i=this.genMessage(Di.UpdateDestChannel,e);await this.signal.request(i),this.emit("event",Pi.PACKET_UPDATE_DEST_CHANNEL),t.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const e=this.genMessage(Di.StopPacketTransfer);await this.signal.request(e),t.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,t){const i=[],n=[],s=[];this.requestId+=1;const o={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:H,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};"4.21.0"===o.sdkVersion&&(o.sdkVersion="0.0.1");let a=null,r=null;switch(e){case Di.SetSdkProfile:return o.clientRequest={command:"SetSdkProfile",type:"multi_channel"},o;case Di.SetSourceChannel:if(r=t&&t.getSrcChannelMediaInfo(),!r)throw new Si(l.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceChannel",uid:"0",channelName:r.channelName,token:r.token||this.joinInfo.appId},o;case Di.SetSourceUserId:if(r=t&&t.getSrcChannelMediaInfo(),!r)throw new Si(l.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceUserId",uid:r.uid+""},o;case Di.SetDestChannel:if(a=t&&t.getDestChannelMediaInfo(),!a)throw new Si(l.UNEXPECTED_ERROR,"can not find dest config");return a.forEach((e=>{i.push(e.channelName),n.push(e.uid+""),s.push(e.token||this.joinInfo.appId)})),o.clientRequest={command:"SetDestChannel",channelName:i,uid:n,token:s},o;case Di.StartPacketTransfer:return o.clientRequest={command:"StartPacketTransfer"},o;case Di.Reconnect:return o.clientRequest={command:"Reconnect"},o;case Di.StopPacketTransfer:return o.clientRequest={command:"StopPacketTransfer"},o;case Di.UpdateDestChannel:if(a=t&&t.getDestChannelMediaInfo(),!a)throw new Si(l.UNEXPECTED_ERROR,"can not find dest config");return a.forEach((e=>{i.push(e.channelName),n.push(e.uid+""),s.push(e.token||this.joinInfo.appId)})),o.clientRequest={command:"UpdateDestChannel",channelName:i,uid:n,token:s},o;case Di.SetVideoProfile:o.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return o}}var ha;let la=(ha=class e extends qi{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(de).includes(e))))]}constructor(t,i){super(t,i),this.store=void 0,this.peerConnection=void 0,this.remoteSDP=void 0,this.initialOffer=void 0,this.statsFilter=void 0,this.useRTX=!1,this.localCapabilities=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.establishPromise=void 0,this.mutex=new v("P2PConnection-mutex"),this.store=i,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=Xs(this.peerConnection,f("STATS_UPDATE_INTERVAL"),void 0,I()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=Qs(e.sdp),i=zs(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:f("FILTER_VIDEO_FEC"),filterAudioFec:f("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=i,this.initialOffer=e,Zt(Zt({},t),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:e.sdp})}catch(e){throw new h(l.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,i,n,s,o){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(e){this.sessionDesc=void 0,this.localCapabilities=void 0,this.rtpCapabilities=void 0,this.candidates=void 0,this.iceParameters=void 0,this.dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,e=$(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:a,sdkCodec:r,cname:c}=e,d=Ms.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE audio video\na=msid-semantic: WMS\na=ice-lite\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:audio\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:video\n");this.rtpCapabilities=s,this.candidates=n,this.iceParameters=t,this.dtlsParameters=i,this.setup=o,this.localCapabilities=a,this.cname=c;for(let e=0;e<d.mediaDescriptions.length;e++){const a=d.mediaDescriptions[e];if(a.attributes.iceUfrag=t.iceUfrag,a.attributes.icePwd=t.icePwd,a.attributes.fingerprints=i.fingerprints,a.attributes.candidates=n,a.attributes.setup=o,"video"===a.media.mediaType){a.media.fmts=s.videoCodecs.map((e=>e.payloadType.toString(10)));let e=s.videoCodecs.filter((e=>{var t;return null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase().includes(r)}));0===e.length&&(e=s.videoCodecs),a.attributes.payloads=e,a.attributes.extmaps=s.videoExtensions}"audio"===a.media.mediaType&&(a.media.fmts=s.audioCodecs.map((e=>e.payloadType.toString(10))),a.attributes.payloads=s.audioCodecs,a.attributes.extmaps=s.audioExtensions),d.mediaDescriptions[e]=this.mungMediaDesc(a)}this.sessionDesc=d,this.currentMidIndex=d.mediaDescriptions.length-1}toString(){return Ms.print(this.sessionDesc)}send(e,t,i){const{ssrcs:n,ssrcGroups:s}=eo(t,this.cname),o=this.sessionDesc.mediaDescriptions.find((t=>e===Yi.VIDEO?"video"===t.media.mediaType:"audio"===t.media.mediaType)),a=n[0].attributes.label,r=n[0].attributes.mslabel;return o.attributes.ssrcs=o.attributes.ssrcs.concat(n),o.attributes.ssrcGroups=o.attributes.ssrcGroups.concat(s),{id:a,mslabel:r}}batchSend(e){return e.map((e=>{let{kind:t,ssrcMsg:i}=e;return this.send(t,i,void 0)}))}stopSending(e){this.sessionDesc.mediaDescriptions.forEach((t=>{const i=[],n=[],s=[];t.attributes.ssrcs.forEach((t=>{e.includes(t.attributes.label||"")?s.push(t):i.push(t)})),t.attributes.ssrcGroups.forEach((e=>{s.map((e=>e.ssrcId)).includes(e.ssrcIds[0])||n.push(e)})),t.attributes.ssrcs=i,t.attributes.ssrcGroups=n}))}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}receive(e,t,i){e.forEach(((e,t)=>{const i=e._mediaStreamTrack,n=this.sessionDesc.mediaDescriptions.findIndex((e=>e.attributes.mid===i.kind)),s=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],e);this.sessionDesc.mediaDescriptions[n]=s}))}stopReceiving(e){}updateCandidates(e){e===Ji.TCP?this.candidates.forEach((e=>{-1===this.candidates.findIndex((t=>"tcp"===t.transport&&t.connectionAddress===e.connectionAddress&&t.port===e.port))&&this.candidates.push(Zt(Zt({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})):this.candidates=this.candidates.filter((e=>"tcp"!==e.transport));for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(e){e=$(e),this.iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}mungRecvMediaDsec(e,t){const i=$(e);return to(i,t),no(i,t),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}updateTrackLabel(e,t,i){const n=this.sessionDesc.mediaDescriptions.find((t=>e===Yi.VIDEO?"video"===t.attributes.mid:"audio"===t.attributes.mid));if(n){const e=n.attributes.ssrcs.find((e=>e.attributes.label===t));var s;e&&(e.attributes.label=i,null===(s=e.attributes.msid)||void 0===s||s.replace(t,i))}}mungMediaDesc(e){const t=$(e);return io(t),function(e){const t=e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));t&&e.attributes.extmaps.splice(e.attributes.extmaps.indexOf(t),1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}(t),t}getSSRC(e){for(const t of this.sessionDesc.mediaDescriptions)for(const i of t.attributes.ssrcs)if(i.attributes.label===e)return[i]}}({remoteIceParameters:e,remoteDtlsParameters:t,candidates:i,remoteRTPCapabilities:n.send,remoteSetup:s,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:o});const a=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}async updateRemoteRTPCapabilities(e,t){throw new h(l.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}send(e,t){var i=this;return $t((function*(){const n=yield zt(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=e.map((e=>i.peerConnection.addTrack(e._mediaStreamTrack))),o=yield zt(i.peerConnection.createOffer()),a=Ms.parse(o.sdp),r=e.map((e=>{const t=e._mediaStreamTrack,n=a.mediaDescriptions.find((e=>e.attributes.mid===t.kind));if(!n)throw new Error("Cannot extract ssrc from mediaDescription.");return function(e,t,i){const n=e.attributes.ssrcs.filter((e=>e.attributes.label===t)),s=e.attributes.ssrcGroups;if(0===n.length)throw new Error("Cannot extract ssrc from plan-b SDP.");if(s&&n.length>1){const e=s.find((e=>-1!==e.ssrcIds.indexOf(n[0].ssrcId)));return e?[{ssrcId:e.ssrcIds[0],rtx:i?e.ssrcIds[1]:void 0}]:[{ssrcId:n[0].ssrcId}]}return[{ssrcId:n[0].ssrcId}]}(n,t.id,i.useRTX)}));let c;try{c=yield r}catch(e){throw s.forEach((e=>{he()&&e.replaceTrack(null),i.peerConnection.removeTrack(e)})),e}const d=i.mungSendOfferSDP(o.sdp,e);i.remoteSDP.receive(e,t,c);const h=i.remoteSDP.toString();return yield zt(i.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield zt(i.applySendEncodings(s,e)),yield zt(i.peerConnection.setRemoteDescription({type:"answer",sdp:h})),e.map(((e,t)=>{const i=e._mediaStreamTrack.id;return{localSSRC:r[t],id:i}}))}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{n()}}))()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{he()&&e.replaceTrack(null),this.peerConnection.removeTrack(e)}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}}async receive(e,t,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{id:i,mslabel:s}=this.remoteSDP.send(e,t,n),o=new Promise(((t,n)=>{const o=setTimeout((()=>{n(new Error("Cannot receive track, id: ".concat(i)))}),1e4),a=n=>{const r=Z();if(("Safari"===r.name&&11===Number(r.version)||le())&&n.track.id!==i&&n.streams[0].id===s){var c;const s=n.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(e,i,n.track.id),this.peerConnection.removeEventListener("track",a),clearTimeout(o),void t(s)}if(n.track.id===i)return this.peerConnection.removeEventListener("track",a),clearTimeout(o),void t(n.track)};this.peerConnection.addEventListener("track",a)})),a=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:a});const r=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(r);return{track:await o,id:i}}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i)}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("sender' length doesn't match mids' length.");t.map((e=>{if(he()&&e.track)e.track.enabled=!1;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!1)),e.setParameters(t)}}))}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");t.map((async e=>{if(he()&&e.track)e.track.enabled=!0;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!0)),await e.setParameters(t)}}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var i=this;return $t((function*(){const n=yield zt(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(tt().supportPCSetConfiguration){const n=i.peerConnection.getConfiguration(),s=e===Ji.RELAY?"relay":"all";n.iceTransportPolicy!==s&&(t.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(n.iceTransportPolicy,"] to [").concat(s,"]")),n.iceTransportPolicy=s,i.peerConnection.setConfiguration(n))}else if(e===Ji.RELAY)return;e!==Ji.RELAY&&i.remoteSDP.updateCandidates(e);const s=yield zt(i.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=Qs(s.sdp),{remoteIceParameters:a}=yield o.iceParameters;i.remoteSDP.restartICE(a);const r=i.remoteSDP.toString();yield zt(i.peerConnection.setLocalDescription(s)),yield zt(i.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(e){t.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),e)}finally{n()}}))()}close(){var e;this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const e=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(e.sdp,[t]);this.remoteSDP.updateRecvMedia(t._mediaStreamTrack.kind,t);const n=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getSenders().filter((t=>{var i;return(null===(i=t.track)||void 0===i?void 0:i.id)===e}));1===i.length&&await this.applySendEncodings(i,[t])}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getSenders().find((e=>{var i;return(null===(i=e.track)||void 0===i?void 0:i.id)===t}));i&&await i.replaceTrack(e._mediaStreamTrack)}createDataChannels(e,t){throw new h(l.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new h(l.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),f("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const i={iceServers:[],sdpSemantics:"plan-b"};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(ne(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),f("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(i.iceTransportPolicy="relay")})))),i}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}async updateRtpSenderEncodings(e,i){var n;if(!i){i=this.peerConnection.getSenders().find((t=>{var i;return(null===(i=t.track)||void 0===i?void 0:i.id)===e._mediaStreamTrack.id}))}if(!i)return t.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!tt().supportSetRtpSenderParameters)return t.warn("Browser not support set rtp-sender parameters");const s={},o={};if(e instanceof $e)switch(e._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;default:s.degradationPreference="balanced"}if(f("DSCP_TYPE")&&se()){const e=f("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(o.networkPriority=e)}const a=i.getParameters(),r=null===(n=a.encodings)||void 0===n?void 0:n[0];r&&Object.assign(r,o),Object.assign(a,s),t.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await i.setParameters(a)}async applySendEncodings(e,i){try{if(!tt().supportSetRtpSenderParameters)return;if(e.length!==i.length)return;for(let t=0;t<e.length;t++){const n=e[t],s=i[t];n&&s&&await this.updateRtpSenderEncodings(s,n)}}catch(e){t.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t){const i=Ms.parse(e);return t.forEach(((e,t)=>{const n=e._mediaStreamTrack,s=i.mediaDescriptions.find((e=>e.attributes.mid===n.kind));s&&to(s,e)})),Ms.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const t=this.remoteSDP.batchSend(e).map(((t,i)=>{let{id:n,mslabel:s}=t;const{kind:o}=e[i];return new Promise(((e,t)=>{const i=setTimeout((()=>{t(new Error("Cannot receive track, id: ".concat(n)))}),1e4),a=t=>{const r=Z();if("Safari"===r.name&&11===Number(r.version)&&t.track.id!==n&&t.streams[0].id===s){var c;const s=t.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(o,n,t.track.id),this.peerConnection.removeEventListener("track",a),clearTimeout(i),void e({track:s,id:n})}if(t.track.id===n)return this.peerConnection.removeEventListener("track",a),clearTimeout(i),void e({track:t.track,id:n})};this.peerConnection.addEventListener("track",a)}))})),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const n=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(n),await Promise.all(t)}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(t){if(tt().supportPCSetConfiguration){const i=e.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}},ii(ha.prototype,"connect",[ua],Object.getOwnPropertyDescriptor(ha.prototype,"connect"),ha.prototype),ii(ha.prototype,"stopSending",[ua],Object.getOwnPropertyDescriptor(ha.prototype,"stopSending"),ha.prototype),ii(ha.prototype,"receive",[ua],Object.getOwnPropertyDescriptor(ha.prototype,"receive"),ha.prototype),ii(ha.prototype,"stopReceiving",[ua],Object.getOwnPropertyDescriptor(ha.prototype,"stopReceiving"),ha.prototype),ii(ha.prototype,"muteRemote",[ua],Object.getOwnPropertyDescriptor(ha.prototype,"muteRemote"),ha.prototype),ii(ha.prototype,"unmuteRemote",[ua],Object.getOwnPropertyDescriptor(ha.prototype,"unmuteRemote"),ha.prototype),ii(ha.prototype,"muteLocal",[ua],Object.getOwnPropertyDescriptor(ha.prototype,"muteLocal"),ha.prototype),ii(ha.prototype,"unmuteLocal",[ua],Object.getOwnPropertyDescriptor(ha.prototype,"unmuteLocal"),ha.prototype),ii(ha.prototype,"close",[ua],Object.getOwnPropertyDescriptor(ha.prototype,"close"),ha.prototype),ii(ha.prototype,"updateEncoderConfig",[ua],Object.getOwnPropertyDescriptor(ha.prototype,"updateEncoderConfig"),ha.prototype),ii(ha.prototype,"updateSendParameters",[ua],Object.getOwnPropertyDescriptor(ha.prototype,"updateSendParameters"),ha.prototype),ii(ha.prototype,"replaceTrack",[ua],Object.getOwnPropertyDescriptor(ha.prototype,"replaceTrack"),ha.prototype),ii(ha.prototype,"getRemoteSSRC",[ua],Object.getOwnPropertyDescriptor(ha.prototype,"getRemoteSSRC"),ha.prototype),ha);function ua(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("Locking from P2PConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];return await n.apply(this,o)}finally{i()}},i}const pa="9",_a=4e4;let Ea=function(e){return e.BANDWIDTH="bandwidth",e.CPU="cpu",e.NONE="none",e.OTHER="other",e}({});var ma=function(e){return e[e.DOWN=0]="DOWN",e[e.UP=1]="UP",e}(ma||{});const Sa=new Map;function Ta(e,t,i,n){let{scale:s}=e;if(0===s&&n===ma.UP||s>=t.length-1&&n===ma.DOWN)return e;let o=Zt(Zt({},e),{},{scale:n===ma.DOWN?++s:--s});switch(i){case"maintain-framerate":o=Zt(Zt({},o),t[s].motion);break;case"maintain-resolution":o=Zt(Zt({},o),t[s].detail);break;case"balanced":o=Zt(Zt({},o),t[s].balanced)}return o}function Ca(e,t){if(t){const i={overUse:0,underUse:0,adaptationList:fa(t)};Sa.set(e,i)}else Sa.delete(e)}function fa(e){const t=Zt({},e),{bitrateMax:i,frameRate:n,scaleResolutionDownBy:s,bitrateMin:o}=t,{MIN_FRAME_RATE:a,MAX_THRESHOLD_FRAMERATE:r,MAX_SCALE:c,BITRATE_MIN_THRESHOLD:d,BITRATE_MAX_THRESHOLD:h,BWE_SCALE_UP_THRESHOLD:l,BWE_SCALE_DOWN_THRESHOLD:u,PERF_SCALE_DOWN_THRESHOLD:p,PERF_SCALE_UP_THRESHOLD:_,BALANCE_BITRATE_FACTOR:E,BALANCE_FRAMERATE_FACTOR:m,BALANCE_RESOLUTION_FACTOR:S,MOTION_RESOLUTION_FACTOR:T,MOTION_BITRATE_FACTOR:C,DETAIL_FRAMERATE_FACTOR:f,DETAIL_BITRATE_FACTOR:R}=_e,g=Math.min(t.frameRate,r),I=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(u,1)*i),bwe_up:i,fps_down:Math.round(Math.pow(p,1)*g),fps_up:n},balanced:{scaleResolutionDownBy:1,frameRate:n,bitrateMax:i,bitrateMin:o},motion:{scaleResolutionDownBy:1,frameRate:n,bitrateMax:i,bitrateMin:o},detail:{scaleResolutionDownBy:1,frameRate:n,bitrateMax:i,bitrateMin:o}}];for(let e=1;e<=c;e++){const t={bwe_up:Math.round(Math.pow(l,e)*i),bwe_down:Math.round(Math.pow(u,e+1)*i),fps_up:Math.round(Math.pow(_,e)*g),fps_down:Math.round(Math.pow(p,e+1)*g)},r={scaleResolutionDownBy:s/Math.pow(S,e),frameRate:Math.max(Math.round(Math.pow(m,e)*n),a),bitrateMax:Math.max(Math.round(Math.pow(E,e)*i),h),bitrateMin:Math.max(Math.round(Math.pow(E,e)*o),d)},c={scaleResolutionDownBy:s/Math.pow(T,e),frameRate:n,bitrateMax:Math.max(Math.round(Math.pow(C,e)*i),h),bitrateMin:Math.max(Math.round(Math.pow(C,e)*o),d)},v={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(f,e)*n),a),bitrateMax:Math.max(Math.round(Math.pow(R,e)*i),h),bitrateMin:Math.max(Math.round(Math.pow(R,e)*o),d)};I.push({scale:e,threshold:t,balanced:r,motion:c,detail:v})}return I}function Ra(e,t,i,n,s,o){const a=Sa.get(e)||{overUse:0,underUse:0,adaptationList:fa(s)},{adaptationList:r}=a;Sa.set(e,a);const{OVERUSE_TIMES_THRESHOLD:c,UNDERUSE_TIMES_THRESHOLD:d}=_e,{scale:h}=n;let l,u;return"number"==typeof t&&t>0&&function(e,t,i,n){if(t>=i.length)return!1;let{threshold:{fps_down:s}}=i[t];return f("FORCE_AG_HIGH_FRAMERATE")&&"maintain-framerate"===n&&(s=i[0].threshold.fps_down),e<s}(t,h,r,o)&&(a.overUse++,u=Ea.CPU,a.overUse>c)||"number"==typeof i&&i>0&&function(e,t,i){if(t>=i.length)return!1;const{threshold:{bwe_down:n}}=i[t];return e<n}(i,h,r)&&(a.overUse++,u=Ea.BANDWIDTH,a.overUse>c)?(a.overUse=0,a.underUse=0,l=Ta(n,r,o,ma.DOWN),[l,u]):("number"==typeof t&&t>0&&"number"==typeof i&&i>0&&function(e,t,i,n){if(0===t)return;let{threshold:{fps_up:s}}=i[t];return f("FORCE_AG_HIGH_FRAMERATE")&&"maintain-framerate"===n&&(s=i[1].threshold.fps_up),e>s}(t,h,r,o)&&function(e,t,i){if(0===t)return;const{threshold:{bwe_up:n}}=i[t];return e>n}(i,h,r)&&(a.underUse++,a.underUse>d&&(a.overUse=0,a.underUse=0,l=Ta(n,r,o,ma.UP),0===l.scale&&(u=Ea.NONE))),[l,u])}const ga=new Map;function Ia(e){const t=ga.get(e);if(t){const{timer:i,adaptationFunc:n,originConfig:s}=t;window.clearTimeout(i),n(s),ga.delete(e)}Ca(e)}var va;let Aa=(va=class e extends qi{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(de).includes(e))))]}constructor(t,i){super(t,i),this.store=void 0,this.peerConnection=void 0,this.id=M(5,"connection-"),this.remoteSDP=void 0,this.initialOffer=void 0,this.transportEventReceiver=void 0,this.statsFilter=void 0,this.useXR=f("USE_XR"),this.localCapabilities=void 0,this.remoteCodecs=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.dataStreamChannelMap=new Map,this.establishPromise=void 0,this.recoveredDataChannelIds=[],this.currentDataChannelId=1,this.mutex=new v("P2PConnection-mutex"),this.qualityLimitationReason=Ea.NONE,this.store=i,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=Xs(this.peerConnection,f("STATS_UPDATE_INTERVAL"),void 0,I()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async updateRemoteRTPCapabilities(e,i){if(this.remoteCodecs=i,!this.remoteSDP)return void t.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(i));if(this.remoteSDP.updateRemoteCodec(e,i,this.store.codec)){const e=await this.peerConnection.createOffer(),t=this.logSDPExchange(e.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(e);const i=this.remoteSDP.toString();null==t||t(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}else t.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=Qs(e.sdp),i=await ro({filterRTX:!f("USE_PUB_RTX")&&!f("USE_SUB_RTX"),filterVideoFec:f("FILTER_VIDEO_FEC"),filterAudioFec:f("FILTER_AUDIO_FEC"),filterVideoCodec:f("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=lo(i),this.initialOffer=e,Zt(Zt({},t),{},{rtpCapabilities:i,offerSDP:e.sdp})}catch(e){throw new h(l.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,i,n,s,o,a){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return $(this._localCapabilities)}get rtpCapabilities(){return $(this._rtpCapabilities)}get candidates(){return $(this._candidates)}get iceParameters(){return $(this._iceParameters)}get dtlsParameters(){return $(this._dtlsParameters)}constructor(e){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,this.firefoxSsrcMidMap=new Map,e=$(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:a,cname:r}=e,c=Ms.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=ice-lite\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n");this._rtpCapabilities=s,this._candidates=n,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=a,this.setup=o,this.cname=r;const d=this.rtpCapabilities.send;for(const e of c.mediaDescriptions){if(e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=i.fingerprints,e.attributes.candidates=n,e.attributes.setup=o,"video"===e.media.mediaType&&(e.media.fmts=d.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.videoCodecs,e.attributes.extmaps=d.videoExtensions,f("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=eo([{ssrcId:_a,rtx:f("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType&&(e.media.fmts=d.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.audioCodecs,e.attributes.extmaps=d.audioExtensions,uo(e),f("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=eo([{ssrcId:2e4}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}preloadRemoteMedia(){const e=f("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;const t=this.candidates,i=this.dtlsParameters,n=this.iceParameters,s=this.rtpCapabilities.send;for(let o=1;o<e;o++){const e=2*o+2e4,a=2*o+_a,{ssrcs:r,ssrcGroups:c}=eo([{ssrcId:e}],this.cname),{ssrcs:d,ssrcGroups:h}=eo([{ssrcId:a,rtx:f("USE_SUB_RTX")?a+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:pa,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:h,rtcpFeedbackWildcards:[],payloads:s.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:pa,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:r,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:s.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return Ms.print(this.sessionDesc)}send(e,t,i,n){const{ssrcs:s,ssrcGroups:o}=eo(t,this.cname,f("SYNC_GROUP")?i:void 0),a=this.findPreloadMediaDesc(s);if(a){if(I()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,a.attributes.mid),n&&(n.twcc||n.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(a,n),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,s);let i;return-1===t||1===t&&(he()||ue())||0===t&&f("USE_SUB_RTX")||pe()?(i=this.createOrRecycleSendMedia(e,s,o,"sendonly",n),this.updateBundleMids()):(i=$(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=s,i.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,n)),I()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:e,needExchangeSDP:t}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:e.attributes.mid,needExchangeSDP:t}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:i,mslabel:n}=e;return this.send(t,i,n)})),i=[];let n=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:s}=e;s&&(n=!0),i.push(t)})),{mids:i,needExchangeSDP:n}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||I()||pe()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,i,n){e.forEach(((e,s)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,i,n[s])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(e){const t=this._candidates.filter((e=>"udp"===e.transport));if(e===Ji.TCP){if(0===t.length)return;if(f("TCP_CANDIDATE_ONLY")){const e=this._candidates.filter((e=>"tcp"===e.transport));t.forEach((t=>{-1===e.findIndex((e=>e.connectionAddress===t.connectionAddress))&&e.push(Zt(Zt({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})),this._candidates=e}else{const e=[];t.forEach((t=>{e.push(Zt(Zt({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})),this._candidates=[...t,...e]}}else if(e===Ji.RELAY){if(0!==t.length)return;{const e=this._candidates.filter((e=>"tcp"===e.transport));e.forEach((e=>{t.push(Zt(Zt({},e),{},{foundation:"udpcandidate",priority:Number(e.priority)+1+"",transport:"udp",port:Number(e.port)-90+""}))})),this._candidates=[...t,...e]}}else 0===t.length?(this._candidates.filter((e=>"tcp"===e.transport)).forEach((e=>{t.push(Zt(Zt({},e),{},{foundation:"udpcandidate",priority:Number(e.priority)+1+"",transport:"udp",port:Number(e.port)-90+""}))})),this._candidates=t):this._candidates=this._candidates.filter((e=>"tcp"!==e.transport));for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(e){e=$(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const n=i.media.mediaType===e&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(I()){if(n){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!e||e!==i.attributes.mid)}return!1}return n}))}createOrRecycleDataChannel(){for(const e of this.sessionDesc.mediaDescriptions)if("application"===e.media.mediaType)return{mediaDesc:e,needExchangeSDP:!1};this.currentMidIndex+=1;const e="".concat(this.currentMidIndex),t={media:{mediaType:"application",port:pa,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(e),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(t),{mediaDesc:t,needExchangeSDP:!0}}createOrRecycleRecvMedia(e,t,i,n,s,o){const a=e._mediaStreamTrack.kind,r=this.rtpCapabilities.recv,c=_o(a,r,this.localCapabilities.send,a===Yi.VIDEO?n:s),d=a===Yi.VIDEO?r.videoExtensions:r.audioExtensions;this.currentMidIndex+=1;const h="".concat(this.currentMidIndex);let l={media:{mediaType:a,port:pa,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(h)}};l=this.mungRecvMediaDsec(l,e,o);const u=this.findFirstClosedMedia(a);if(u){const e=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[e]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}updateRemoteCodec(e,i,n){const s=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(de).includes(e))))],o=new Set(i);if(s.every((e=>o.has(e))))return t.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(i)),!1;const a=this._rtpCapabilities.recv.videoCodecs.filter((e=>i.some((t=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes(t)))));if(0===a.length)return t.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(s," codecs: ").concat(i)),!1;const r=[...new Set(a.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")))];let c;if(t.debug("updateRemoteCodec, from ".concat(s," to ").concat(r)),0===e.length)c=this.sessionDesc.mediaDescriptions.filter((e=>"video"===e.media.mediaType&&"recvonly"===e.attributes.direction));else if(c=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&e.includes(t.attributes.mid)&&"recvonly"===t.attributes.direction)),c.length!==e.length)return t.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(i)),!1;if(f("USE_PUB_RTX")||f("USE_SUB_RTX")){const e=Eo(a,this.rtpCapabilities.recv.videoCodecs);a.push(...e)}this._rtpCapabilities.recv.videoCodecs=a;const d=this.localCapabilities.send,h=this.rtpCapabilities.recv,l=_o(Yi.VIDEO,h,d,n);return c.forEach((e=>{const i=l.map((e=>e.payloadType.toString(10)));t.debug("updateRemoteCodec mid: ".concat(e.attributes.mid,", from ").concat(e.attributes.payloads," to ").concat(l)),e.attributes.payloads=l,e.media.fmts=i})),!0}createOrRecycleSendMedia(e,t,i,n,s){const o=this.rtpCapabilities.send,a=e===Yi.VIDEO?o.videoCodecs:o.audioCodecs,r=e===Yi.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:pa,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:r,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,s);const h=this.findFirstClosedMedia(e);if(h){const e=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,i){const n=$(e);return io(n),to(n,t),no(n,t),so(n),oo(n,i,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const i=$(e);return oo(i,t,this.localCapabilities.recv),uo(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>I()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i;return(null===(i=t.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}({remoteIceParameters:e,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:this.localCapabilities,cname:a}),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const r=this.remoteSDP.toString(),c=Ms.parse(this.initialOffer.sdp),d=c.mediaDescriptions.find((e=>"audio"===e.media.mediaType));d&&uo(d),this.useXR&&po(c);const h=Ms.print(c),l=this.logSDPExchange(h||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:h}),null==l||l(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r});const u=this.peerConnection.getTransceivers()[0];if(null!=u&&u.receiver&&this.tryBindTransportEvents(u.receiver),f("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const t=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(t)}}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}send(e,t,i){var n=this;return $t((function*(){const s=yield zt(n.mutex.lock("From P2PConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[];e.forEach((e=>{const t=n.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});o.push(t),e._updateRtpTransceiver(t)})),I()&&!0===f("SIMULCAST")&&(yield zt(n.applySimulcastForFirefox(o,e)));const a=yield zt(n.peerConnection.createOffer()),r=n.remoteSDP.predictReceivingMids(e.length),c=n.mungSendOfferSDP(a.sdp,e,r),d=Ms.parse(c),h=r.map((e=>{const t=d.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return Zs(t,f("USE_PUB_RTX"))}));let l;try{l=yield h}catch(s){l=[],n.remoteSDP.receive(e,t,i,l);const o=n.remoteSDP.toString();throw yield zt(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield zt(n.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield zt(n.stopSending(r,!0)),s}n.remoteSDP.receive(e,t,i,l);const u=n.remoteSDP.toString(),p=n.logSDPExchange(c,"offer","local","send");return yield zt(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield zt(n.applySimulcastEncodings(o,e)),yield zt(n.applySendEncodings(o,e)),null==p||p(u),yield zt(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),o.map(((e,t)=>{const i=r[t];return{localSSRC:h[t],id:i,transceiver:e}}))}catch(e){throw e instanceof h?e:new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{s()}}))()}async createDataChannels(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(e);if(n&&"open"===n.readyState)t.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const t=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if("number"!=typeof t)throw new Error("create DataChannel error, because cannot get dc id");n=this.peerConnection.createDataChannel("datastream-channel",{id:t,negotiated:!0,ordered:!1,maxRetransmits:f("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,n)}i.forEach((e=>{e._updateOriginDataChannel(n)}));const{needExchangeSDP:s}=this.remoteSDP.sendDataChannel();if(s){const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i),t.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else t.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(e){throw e instanceof h?e:new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return t&&(t.id&&this.recoveredDataChannelIds.push(t.id),t.close()),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof h?e:new h(l.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(e.toString()))}}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{var t;Ia(this.id+e.mid),e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const o=this.remoteSDP.toString();null==s||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async receive(e,i,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:a}=this.remoteSDP.send(e,i,n,s);if(a){const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const s=await this.peerConnection.createAnswer(),a=this.mungReceiveAnswerSDP(s.sdp,o,e);null==n||n(a||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:a}),t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const r=this.peerConnection.getTransceivers().find((e=>e.mid===o));if(!r)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:r.receiver.track,id:o,transceiver:r}}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:i,needExchangeSDP:n}=this.remoteSDP.batchSend(e);if(n){const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n),t.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else t.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return i.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e,transceiver:t}}))}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var i=this;return $t((function*(){const n=yield zt(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(tt().supportPCSetConfiguration){const n=i.peerConnection.getConfiguration(),s=e===Ji.RELAY?"relay":"all";n.iceTransportPolicy!==s&&(t.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(n.iceTransportPolicy,"] to [").concat(s,"]")),n.iceTransportPolicy=s,i.peerConnection.setConfiguration(n))}else if(e===Ji.RELAY)return;i.remoteSDP.updateCandidates(e);const s=yield zt(i.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=Qs(s.sdp),{remoteIceParameters:a}=yield o.iceParameters;i.remoteSDP.restartICE(a);const r=i.remoteSDP.toString(),c=i.logSDPExchange(s.sdp||"","offer","local","restartICE");i.store.descriptionStart(),yield zt(i.peerConnection.setLocalDescription(s)),null==c||c(r),yield zt(i.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(e){t.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),e)}finally{n()}}))()}close(){var e;this.peerConnection.getTransceivers().forEach((e=>{Ia(this.id+e.mid)})),this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return Zt(Zt({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const s=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==o||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new h(l.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?I()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:i,remote:n}=t.getSelectedCandidatePair();return{local:Zt(Zt({},Fs),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:Zt(Zt({},Fs),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),f("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(ne(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),f("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),f("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(i.iceTransportPolicy="relay")})))),f("ENABLE_ENCODED_TRANSFORM")&&tt().supportWebRTCEncodedTransform&&(i.encodedInsertableStreams=!0),i}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(On(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!f("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}tryBindTransportEvents(e){const i=e.transport;if(i){this.transportEventReceiver=e,i.onstatechange=()=>{var e;null!=i&&i.state&&(null===(e=this.onDTLSTransportStateChange)||void 0===e||e.call(this,i.state))},i.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const n=i.iceTransport;n&&(n.onstatechange=()=>{const e=null==i?void 0:i.iceTransport.state;var t;e&&(null===(t=this.onICETransportStateChange)||void 0===t||t.call(this,e))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:e,remote:i}=n.getSelectedCandidatePair();t.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol}),", remote ").concat(JSON.stringify({candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,i){var n;if(!i){const t=this.peerConnection.getSenders();i=t.find((t=>t.track===e._mediaStreamTrack))}if(!i)return t.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return t.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!tt().supportSetRtpSenderParameters)return t.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},o={};switch(e._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;case"balanced":s.degradationPreference="balanced"}const a=function(e,t){return e.getTransceivers().find((e=>e.sender.track===t||e.receiver.track===t))}(this.peerConnection,e._mediaStreamTrack),r=ft(e);if(function(e){return!(!f("ENABLE_AG_ADAPTATION")||!(e instanceof Ct||e._hints.includes(et.CUSTOM_TRACK))||!f("FORCE_SUPPORT_AG_ADAPTATION")&&!(Ee(14)&&me(17,4,!0)||Se(14)&&Te(17,4,!0)))}(e)&&a&&i&&r&&this.getLocalVideoStats&&["vp8","vp9"].includes(this.store.codec)){const n=s.degradationPreference||(e._hints.includes(et.CUSTOM_TRACK)?f("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");!function(e,i,n,s,o,a){if(Ia(e),"balanced"!==s&&"maintain-framerate"!==s&&"maintain-resolution"!==s)return;let r=-1;Ca(e,i);const c=window.setInterval((()=>{const c=ga.get(e);if(!f("ENABLE_AG_ADAPTATION")||!c)return void Ia(e);const d=a();if(d.sendPackets>0&&d.OutgoingAvailableBandwidth>0){if(-1===r)return void(r=Date.now());if(Date.now()-r<1e3)return;const a=d.sendFrameRate,h=d.OutgoingAvailableBandwidth,[l,u]=Ra(e,a,h,c.adaptationConfig,i,s);u&&(n.qualityLimitationReason=u),l&&c.adaptationConfig.scale!==l.scale&&(t.debug("[".concat(e,"] applyAdaptation: ").concat(n.qualityLimitationReason,"\n           sendFps ").concat(a,", bwe ").concat(h,", switch from ").concat(c.adaptationConfig.scale," to ").concat(l.scale," ")),c.adaptationConfig=Zt(Zt({},c.adaptationConfig),l),o(l))}}),f("CHECK_LOCAL_STATS_INTERVAL")),d=Zt({},i);ga.set(e,{timer:c,adaptationConfig:d,originConfig:i,adaptationFunc:o}),t.debug("[".concat(e,"] start adaptation, originConfig: ").concat(JSON.stringify(i),", degradationPreference: ").concat(s))}(this.id+a.mid,r,this,n,(e=>{i&&this.updateAdaptation(i,e)}),this.getLocalVideoStats.bind(this))}if(e._encoderConfig){const{bitrateMax:t,frameRate:i,scaleResolutionDownBy:n}=e._encoderConfig;t&&(o.maxBitrate=1e3*t),(e._hints.includes(et.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(i&&(o.maxFramerate=Pn(i)),n&&n>=1&&(o.scaleResolutionDownBy=n))}const{maxFramerate:c}=f("ENCODER_CONFIG_LIMIT");if(c&&"number"==typeof c&&(o.maxFramerate=o.maxFramerate?Math.min(o.maxFramerate,c):c),f("DSCP_TYPE")&&se()){const e=f("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(o.networkPriority=e)}const d=i.getParameters(),h=null===(n=d.encodings)||void 0===n?void 0:n[0];I()&&!h&&(s.encodings=[o]),h&&Object.assign(h,o),Object.assign(d,s),t.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(d.encodings))),await i.setParameters(d)}async updateAdaptation(e,i){var n;if(!e)return t.debug("[updateAdaptation] no rtpSender found");if(!tt().supportSetRtpSenderParameters)return t.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const s={},{bitrateMax:o,frameRate:a,scaleResolutionDownBy:r}=i;o&&(s.maxBitrate=1e3*o),a&&(s.maxFramerate=Pn(a)),r&&r>=1&&["vp8","vp9"].includes(this.store.codec)&&(s.scaleResolutionDownBy=r);const c=e.getParameters(),d=null===(n=c.encodings)||void 0===n?void 0:n[0];d&&Object.assign(d,s),Object.assign(c,{});try{await e.setParameters(c),t.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(c.encodings)))}catch(i){!("transport"in e)||e.transport&&"connected"===e.transport.state?"connected"!==this.peerConnectionState?t.debug("[updateAdaptation] peerConnection not connected}"):t.debug("[updateAdaptation] updateRtpSenderEncodings failed",i):t.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(e,i){try{if(!tt().supportSetRtpSenderParameters)return;if(e.length!==i.length)return;for(let t=0;t<e.length;t++){const n=e[t],s=i[t];s instanceof $e&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,n.sender)}}catch(e){t.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,i){const n=Ms.parse(e);return t.forEach(((e,t)=>{const s=i[t],o=n.mediaDescriptions.find((e=>e.attributes.mid===s));o&&(to(o,e),ao(o,e,this.store.codec))})),Ms.print(n)}mungReceiveAnswerSDP(e,t,i){const n=Ms.parse(e),s=n.mediaDescriptions.find((e=>e.attributes.mid===t));return s&&(i===Yi.AUDIO&&"audio"===s.media.mediaType&&uo(s),this.useXR&&po(n)),Ms.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var i,n,s,o;const r=e[a],c=t[a];if(c instanceof $e&&!c._hints.includes(et.LOW_STREAM)&&null!==(i=c._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=c._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=c._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=c._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=r.sender.getParameters();await r.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!I()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof $e&&this.isVP8Simulcast(n)){const t=e[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const a=t.sender.getParameters();await t.sender.setParameters(Object.assign(a,s))}}}isVP8Simulcast(e){var t,i,n,s;return!!(e instanceof $e&&f("SIMULCAST")&&"vp8"===this.store.codec&&!e._hints.includes(et.LOW_STREAM)&&null!==(t=e._encoderConfig)&&void 0!==t&&t.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(n=e._scalabilityMode)&&void 0!==n&&n.numSpatialLayers&&(null===(s=e._scalabilityMode)||void 0===s?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,i,n,s){if(f("SDP_LOGGING"))return t.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(i," SDP during P2PConnection.").concat(s,"\n"),e),"offer"===i?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",s)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(t){if(tt().supportPCSetConfiguration){const i=e.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}},ii(va.prototype,"updateRemoteRTPCapabilities",[wa],Object.getOwnPropertyDescriptor(va.prototype,"updateRemoteRTPCapabilities"),va.prototype),ii(va.prototype,"connect",[wa],Object.getOwnPropertyDescriptor(va.prototype,"connect"),va.prototype),ii(va.prototype,"createDataChannels",[wa],Object.getOwnPropertyDescriptor(va.prototype,"createDataChannels"),va.prototype),ii(va.prototype,"receive",[wa],Object.getOwnPropertyDescriptor(va.prototype,"receive"),va.prototype),ii(va.prototype,"batchReceive",[wa],Object.getOwnPropertyDescriptor(va.prototype,"batchReceive"),va.prototype),ii(va.prototype,"stopReceiving",[wa],Object.getOwnPropertyDescriptor(va.prototype,"stopReceiving"),va.prototype),ii(va.prototype,"muteRemote",[wa],Object.getOwnPropertyDescriptor(va.prototype,"muteRemote"),va.prototype),ii(va.prototype,"unmuteRemote",[wa],Object.getOwnPropertyDescriptor(va.prototype,"unmuteRemote"),va.prototype),ii(va.prototype,"muteLocal",[wa],Object.getOwnPropertyDescriptor(va.prototype,"muteLocal"),va.prototype),ii(va.prototype,"unmuteLocal",[wa],Object.getOwnPropertyDescriptor(va.prototype,"unmuteLocal"),va.prototype),ii(va.prototype,"close",[wa],Object.getOwnPropertyDescriptor(va.prototype,"close"),va.prototype),ii(va.prototype,"updateEncoderConfig",[wa],Object.getOwnPropertyDescriptor(va.prototype,"updateEncoderConfig"),va.prototype),ii(va.prototype,"updateSendParameters",[wa],Object.getOwnPropertyDescriptor(va.prototype,"updateSendParameters"),va.prototype),ii(va.prototype,"replaceTrack",[wa],Object.getOwnPropertyDescriptor(va.prototype,"replaceTrack"),va.prototype),ii(va.prototype,"updateAdaptation",[wa],Object.getOwnPropertyDescriptor(va.prototype,"updateAdaptation"),va.prototype),ii(va.prototype,"getRemoteSSRC",[wa],Object.getOwnPropertyDescriptor(va.prototype,"getRemoteSSRC"),va.prototype),va);function wa(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];return await n.apply(this,o)}finally{i()}},i}const ya="v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0\na=msid-semantic: WMS\na=ice-lite\nm=application 9 UDP/DTLS/SCTP webrtc-datachannel\nc=IN IP4 127.0.0.1\na=mid:0\n",Na="9",ba=2e4,Oa=4e4;class Da{get localCapabilities(){return $(this._localCapabilities)}get rtpCapabilities(){return $(this._rtpCapabilities)}get candidates(){return $(this._candidates)}get iceParameters(){return $(this._iceParameters)}get dtlsParameters(){return $(this._dtlsParameters)}constructor(e){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,this.firefoxSsrcMidMap=new Map,e=$(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:a,cname:r}=e,c=Ms.parse(ya);this._rtpCapabilities=s,this._candidates=n,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=a,this.setup=o,this.cname=r;const d=this.rtpCapabilities.send;for(const e of c.mediaDescriptions){if(e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=i.fingerprints,e.attributes.candidates=n,e.attributes.setup=o,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType&&(e.media.fmts=d.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.videoCodecs,e.attributes.extmaps=d.videoExtensions,f("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=eo([{ssrcId:Oa,rtx:f("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType&&(e.media.fmts=d.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.audioCodecs,e.attributes.extmaps=d.audioExtensions,uo(e),f("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=eo([{ssrcId:ba}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}updateRemoteRTPCapabilities(e){const t=Ms.parse(ya);this._rtpCapabilities=e;const i=this.rtpCapabilities.send;for(const e of t.mediaDescriptions){if(e.attributes.iceUfrag=this._iceParameters.iceUfrag,e.attributes.icePwd=this._iceParameters.icePwd,e.attributes.fingerprints=this._dtlsParameters.fingerprints,e.attributes.candidates=this._candidates,e.attributes.setup=this.setup,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType&&(e.media.fmts=i.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=i.videoCodecs,e.attributes.extmaps=i.videoExtensions,f("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=eo([{ssrcId:Oa,rtx:f("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType&&(e.media.fmts=i.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=i.audioCodecs,e.attributes.extmaps=i.audioExtensions,f("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=eo([{ssrcId:ba}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}this.sessionDesc=t,this.currentMidIndex=t.mediaDescriptions.length-1}preloadRemoteMedia(e){this.rtpCapabilities;const t=this.candidates,i=this.dtlsParameters,n=this.iceParameters,s=this.rtpCapabilities.send;for(let o=1;o<e;o++){const e=2*o+ba,a=2*o+Oa,{ssrcs:r,ssrcGroups:c}=eo([{ssrcId:e}],this.cname),{ssrcs:d,ssrcGroups:h}=eo([{ssrcId:a,rtx:f("USE_SUB_RTX")?a+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:Na,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:h,rtcpFeedbackWildcards:[],payloads:s.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:Na,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:r,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:s.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return Ms.print(this.sessionDesc)}send(e,t,i,n){const{ssrcs:s,ssrcGroups:o}=eo(t,this.cname,f("SYNC_GROUP")?i:void 0),a=this.findPreloadMediaDesc(s);if(a){if(I()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,a.attributes.mid),n&&(n.twcc||n.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(a,n),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,s);let i;return-1===t||he()||le()||ue()||0===t&&f("USE_SUB_RTX")?(i=this.createOrRecycleSendMedia(e,s,o,"sendonly",n),this.updateBundleMids()):(i=$(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=s,i.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,n)),I()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:i,mslabel:n}=e;return this.send(t,i,n)})),i=[];let n=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:s}=e;s&&(n=!0),i.push(t)})),{mids:i,needExchangeSDP:n}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||I()||he()||le()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,i,n){e.forEach(((e,s)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,i,n[s])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(e){e===Ji.TCP?this._candidates.forEach((e=>{-1===this._candidates.findIndex((t=>"tcp"===t.transport&&t.connectionAddress===e.connectionAddress&&t.port===e.port))&&this._candidates.push(Zt(Zt({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})):this._candidates=this._candidates.filter((e=>"tcp"!==e.transport));for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(e){e=$(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const n=i.media.mediaType===e&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(I()){if(n){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!e||e!==i.attributes.mid)}return!1}return n}))}createOrRecycleRecvMedia(e,t,i,n,s,o){const a=e._mediaStreamTrack.kind,r=this.rtpCapabilities.recv,c=_o(a,r,this.localCapabilities.send,a===Yi.VIDEO?n:s),d=a===Yi.VIDEO?r.videoExtensions:r.audioExtensions;this.currentMidIndex+=1;const h="".concat(this.currentMidIndex);let l={media:{mediaType:a,port:Na,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(h)}};l=this.mungRecvMediaDsec(l,e,o);const u=this.findFirstClosedMedia(a);if(u){const e=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[e]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}updateRemoteCodec(e,i,n){const s=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(de).includes(e))))],o=new Set(i);if(s.every((e=>o.has(e))))return t.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(i)),!1;const a=this._rtpCapabilities.recv.videoCodecs.filter((e=>i.some((t=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes(t)))));if(0===a.length)return t.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(s," codecs: ").concat(i)),!1;const r=[...new Set(a.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")))];let c;if(t.debug("updateRemoteCodec, from ".concat(s," to ").concat(r)),0===e.length)c=this.sessionDesc.mediaDescriptions.filter((e=>"video"===e.media.mediaType&&"recvonly"===e.attributes.direction));else if(c=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&e.includes(t.attributes.mid)&&"recvonly"===t.attributes.direction)),c.length!==e.length)return t.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(i)),!1;this._rtpCapabilities.recv.videoCodecs=a;const d=this.localCapabilities.send,h=this.rtpCapabilities.recv,l=_o(Yi.VIDEO,h,d,n);return c.forEach((e=>{const i=l.map((e=>e.payloadType.toString(10)));t.debug("updateRemoteCodec mid: ".concat(e.attributes.mid,", from ").concat(e.attributes.payloads," to ").concat(l)),e.attributes.payloads=l,e.media.fmts=i})),!0}createOrRecycleSendMedia(e,t,i,n,s){const o=this.rtpCapabilities.send,a=e===Yi.VIDEO?o.videoCodecs:o.audioCodecs,r=e===Yi.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:Na,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:r,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,s);const h=this.findFirstClosedMedia(e);if(h){const e=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,i){const n=$(e);return io(n),to(n,t),no(n,t),so(n),oo(n,i,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const i=$(e);return oo(i,t,this.localCapabilities.recv),uo(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>I()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i;return(null===(i=t.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}var Pa;let La=(Pa=class e extends qi{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){let e;return this.localCapabilities&&(e=lo(this.localCapabilities)),[...new Set(e&&e.send.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(de).includes(e))))]}constructor(e,t,i){super(e,t),this.store=void 0,this.peerConnection=void 0,this.remoteSDP=void 0,this.initialOffer=void 0,this.transportEventReceiver=void 0,this.statsFilter=void 0,this.useXR=f("USE_XR"),this.localCapabilities=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.remoteCodecs=void 0,this.dataStreamChannelMap=new Map,this.establishPromise=void 0,this.mutex=new v("NVExtentionsConnection-mutex"),this.rtcMedia=void 0,this.store=t,this.peerConnection=i,this.statsFilter=Xs(this.peerConnection,f("STATS_UPDATE_INTERVAL"),void 0,I()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(e){try{const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=Qs(e.sdp),i=await ro({filterRTX:!f("USE_PUB_RTX")&&!f("USE_SUB_RTX"),filterVideoFec:f("FILTER_VIDEO_FEC"),filterAudioFec:f("FILTER_AUDIO_FEC"),filterVideoCodec:f("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=i,this.initialOffer=e,Zt(Zt({},t),{},{rtpCapabilities:i,offerSDP:e.sdp})}catch(e){throw new Si(l.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,i,n,s,o){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new Da({remoteIceParameters:e,remoteDtlsParameters:t,candidates:i,remoteRTPCapabilities:n,remoteSetup:s,localCapabilities:lo(this.localCapabilities),cname:o});const a=this.remoteSDP.toString(),r=Ms.parse(this.initialOffer.sdp),c=r.mediaDescriptions.find((e=>"audio"===e.media.mediaType));c&&uo(c),this.useXR&&po(r);const d=Ms.print(r),h=this.logSDPExchange(d||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:d}),null==h||h(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(e){throw new Si(l.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(e.toString()))}}async updateRemoteRTPCapabilities(e,i){if(this.remoteCodecs=i,!this.remoteSDP)return void t.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(i));if(this.remoteSDP.updateRemoteCodec(e,i,this.store.codec)){const e=await this.peerConnection.createOffer(),t=this.logSDPExchange(e.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(e);const i=this.remoteSDP.toString();null==t||t(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}else t.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async updateRemoteConnect(e){var i,n,s,o;(null===(i=this.remoteSDP)||void 0===i||i.updateRemoteRTPCapabilities(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0)&&(null===(o=this.remoteSDP)||void 0===o||o.updateRemoteCodec([],this.remoteCodecs,this.store.codec));null===(n=this.remoteSDP)||void 0===n||n.preloadRemoteMedia(2);const a=null===(s=this.remoteSDP)||void 0===s?void 0:s.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:a});const r=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(r),t.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(e,t,i){var n=this;return $t((function*(){const s=yield zt(n.mutex.lock("From NVExtentionsConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");const o=[];e.forEach((e=>{const t=n.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});o.push(t)})),I()&&!0===f("SIMULCAST")&&(yield zt(n.applySimulcastForFirefox(o,e)));const a=yield zt(n.peerConnection.createOffer()),r=n.remoteSDP.predictReceivingMids(e.length),c=n.mungSendOfferSDP(a.sdp,e,r),d=Ms.parse(c),h=r.map((e=>{const t=d.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return Zs(t,f("USE_PUB_RTX"))}));let l;try{l=yield h}catch(s){l=[],n.remoteSDP.receive(e,t,i,l);const o=n.remoteSDP.toString();throw yield zt(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield zt(n.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield zt(n.stopSending(r,!0)),s}n.remoteSDP.receive(e,t,i,l);const u=n.remoteSDP.toString(),p=n.logSDPExchange(c,"offer","local","send");return yield zt(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield zt(n.applySimulcastEncodings(o,e)),yield zt(n.applySendEncodings(o,e)),null==p||p(u),yield zt(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),o.map(((e,t)=>{const i=r[t];return{localSSRC:h[t],id:i,transceiver:e}}))}catch(e){throw e instanceof Si?e:new Si(l.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(e.toString()))}finally{s()}}))()}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const o=this.remoteSDP.toString();null==s||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new Si(l.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async createDataChannels(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(e);return n&&"open"===n.readyState?t.debug("[P2PConnection] Channels are already available and can be reused directly."):(n=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:f("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,n)),void i.forEach((e=>{e._updateOriginDataChannel(n)}))}catch(e){throw e instanceof Si?e:new Si(l.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return null==t||t.close(),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof Si?e:new Si(l.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(e.toString()))}}async receive(e,i,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:a}=this.remoteSDP.send(e,i,n,s);if(a){const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const s=await this.peerConnection.createAnswer(),a=this.mungReceiveAnswerSDP(s.sdp,o,e);null==n||n(a||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:a}),t.debug("[NVExtentionsConnection] receive ".concat(e," by exchanging SDP."))}else t.debug("[NVExtentionsConnection] receive ".concat(e," no need to exchange SDP."));const r=this.peerConnection.getTransceivers().find((e=>e.mid===o));if(!r)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:r.receiver.track,id:o}}catch(e){throw new Si(l.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");const{mids:i,needExchangeSDP:n}=this.remoteSDP.batchSend(e);if(n){const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n),t.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else t.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return i.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e}}))}catch(e){throw new Si(l.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new Si(l.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new Si(l.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new Si(l.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new Si(l.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new Si(l.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var i=this;return $t((function*(){const n=yield zt(i.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(tt().supportPCSetConfiguration){const n=i.peerConnection.getConfiguration(),s=e===Ji.RELAY?"relay":"all";n.iceTransportPolicy!==s&&(t.debug("restartICE change iceTransportPolicy from [".concat(n.iceTransportPolicy,"] to [").concat(s,"]")),n.iceTransportPolicy=s,i.peerConnection.setConfiguration(n))}else if(e===Ji.RELAY)return;e!==Ji.RELAY&&i.remoteSDP.updateCandidates(e);const s=yield zt(i.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=Qs(s.sdp),{remoteIceParameters:a}=yield o.iceParameters;i.remoteSDP.restartICE(a);const r=i.remoteSDP.toString(),c=i.logSDPExchange(s.sdp||"","offer","local","restartICE");yield zt(i.peerConnection.setLocalDescription(s)),null==c||c(r),yield zt(i.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(e){t.warning("restart ICE failed, abort operation",e)}finally{n()}}))()}close(){var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const s=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==o||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new Si(l.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?I()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}getP2PConnectionParams(){var e;if(null===(e=this.peerConnection.currentLocalDescription)||void 0===e||!e.sdp||!this.localCapabilities)throw new Error;return Zt(Zt({},Qs(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,t.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,t.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),f("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(ne(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),f("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),f("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(i.iceTransportPolicy="relay")})))),i}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(On(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!f("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}async applySendEncodings(e,i){try{if(!tt().supportSetRtpSenderParameters)return;if(e.length!==i.length)return;for(let t=0;t<e.length;t++){const d=e[t],h=i[t];if(h&&h instanceof $e){var n,s;if(this.isVP8Simulcast(h))continue;const e={},t={};switch(h._optimizationMode){case"motion":e.degradationPreference="maintain-framerate";break;case"detail":e.degradationPreference="maintain-resolution";break;default:e.degradationPreference="balanced"}var o,a,r,c;if(null!==(n=h._encoderConfig)&&void 0!==n&&n.bitrateMax)t.maxBitrate=1e3*(null===(o=h._encoderConfig)||void 0===o?void 0:o.bitrateMax);if(h._hints.includes(et.LOW_STREAM))null!==(a=h._encoderConfig)&&void 0!==a&&a.frameRate&&(t.maxFramerate=Pn(h._encoderConfig.frameRate)),null!==(r=h._encoderConfig)&&void 0!==r&&r.scaleResolutionDownBy&&(null===(c=h._encoderConfig)||void 0===c?void 0:c.scaleResolutionDownBy)>1&&(t.scaleResolutionDownBy=h._encoderConfig.scaleResolutionDownBy);if(f("DSCP_TYPE")&&se()){const e=f("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(t.networkPriority=e)}const i=d.sender.getParameters(),l=null===(s=i.encodings)||void 0===s?void 0:s[0];I()&&!l&&(e.encodings=[t]),l&&Object.assign(l,t),Object.assign(i,e),await d.sender.setParameters(i)}}}catch(e){t.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(e,t,i){const n=Ms.parse(e);return t.forEach(((e,t)=>{const s=i[t],o=n.mediaDescriptions.find((e=>e.attributes.mid===s));o&&(to(o,e),ao(o,e,this.store.codec))})),Ms.print(n)}mungReceiveAnswerSDP(e,t,i){const n=Ms.parse(e),s=n.mediaDescriptions.find((e=>e.attributes.mid===t));return s&&i===Yi.AUDIO&&"audio"===s.media.mediaType&&uo(s),this.useXR&&po(n),Ms.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var i,n,s,o;const r=e[a],c=t[a];if(c instanceof $e&&!c._hints.includes(et.LOW_STREAM)&&null!==(i=c._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=c._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=c._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=c._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=r.sender.getParameters();await r.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!I()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof $e&&this.isVP8Simulcast(n)){const t=e[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const a=t.sender.getParameters();await t.sender.setParameters(Object.assign(a,s))}}}isVP8Simulcast(e){var t,i,n,s;return!!(e instanceof $e&&f("SIMULCAST")&&"vp8"===this.store.codec&&!e._hints.includes(et.LOW_STREAM)&&null!==(t=e._encoderConfig)&&void 0!==t&&t.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(n=e._scalabilityMode)&&void 0!==n&&n.numSpatialLayers&&(null===(s=e._scalabilityMode)||void 0===s?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,i,n,s){if(f("SDP_LOGGING"))return t.upload("exchanging ".concat(n," ").concat(i," SDP during NVExtentionsConnection.").concat(s,"\n"),e),"offer"===i?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",s)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(t){if(tt().supportPCSetConfiguration){const i=e.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}},ii(Pa.prototype,"connect",[ka],Object.getOwnPropertyDescriptor(Pa.prototype,"connect"),Pa.prototype),ii(Pa.prototype,"updateRemoteRTPCapabilities",[ka],Object.getOwnPropertyDescriptor(Pa.prototype,"updateRemoteRTPCapabilities"),Pa.prototype),ii(Pa.prototype,"updateRemoteConnect",[ka],Object.getOwnPropertyDescriptor(Pa.prototype,"updateRemoteConnect"),Pa.prototype),ii(Pa.prototype,"createDataChannels",[ka],Object.getOwnPropertyDescriptor(Pa.prototype,"createDataChannels"),Pa.prototype),ii(Pa.prototype,"receive",[ka],Object.getOwnPropertyDescriptor(Pa.prototype,"receive"),Pa.prototype),ii(Pa.prototype,"batchReceive",[ka],Object.getOwnPropertyDescriptor(Pa.prototype,"batchReceive"),Pa.prototype),ii(Pa.prototype,"stopReceiving",[ka],Object.getOwnPropertyDescriptor(Pa.prototype,"stopReceiving"),Pa.prototype),ii(Pa.prototype,"muteRemote",[ka],Object.getOwnPropertyDescriptor(Pa.prototype,"muteRemote"),Pa.prototype),ii(Pa.prototype,"unmuteRemote",[ka],Object.getOwnPropertyDescriptor(Pa.prototype,"unmuteRemote"),Pa.prototype),ii(Pa.prototype,"muteLocal",[ka],Object.getOwnPropertyDescriptor(Pa.prototype,"muteLocal"),Pa.prototype),ii(Pa.prototype,"unmuteLocal",[ka],Object.getOwnPropertyDescriptor(Pa.prototype,"unmuteLocal"),Pa.prototype),ii(Pa.prototype,"close",[ka],Object.getOwnPropertyDescriptor(Pa.prototype,"close"),Pa.prototype),ii(Pa.prototype,"updateEncoderConfig",[ka],Object.getOwnPropertyDescriptor(Pa.prototype,"updateEncoderConfig"),Pa.prototype),ii(Pa.prototype,"updateSendParameters",[ka],Object.getOwnPropertyDescriptor(Pa.prototype,"updateSendParameters"),Pa.prototype),ii(Pa.prototype,"replaceTrack",[ka],Object.getOwnPropertyDescriptor(Pa.prototype,"replaceTrack"),Pa.prototype),ii(Pa.prototype,"getRemoteSSRC",[ka],Object.getOwnPropertyDescriptor(Pa.prototype,"getRemoteSSRC"),Pa.prototype),Pa);function ka(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From NVExtentionsConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];return await n.apply(this,o)}finally{i()}},i}var Ma;let Ua=(Ma=class e extends qi{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(t,i){super(t,i),this.store=void 0,this.peerConnection=void 0,this.cname=void 0,this.mutex=new v("DataChannelConnection-mutex"),this.dataChannel=void 0,this._p2pConnection=void 0,this.establishPromise=void 0,this._nvMedia=void 0,this.store=i,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new La(t,i,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var e;const t=null===(e=this._nvMedia)||void 0===e?void 0:e.getLocalRtpCapabilities();return await this._p2pConnection.establish(t)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(e,t,i,n,s,o){return this.cname=o,await this._p2pConnection.connect(e,t,i,n,s,o),await new Promise(((e,t)=>{const n=setTimeout((()=>{this.closeSignal(),t(new Si(l.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(i))))}),2e3);this.dataChannel.onopen=()=>{if("open"===this.dataChannel.readyState)return clearTimeout(n),void e()},this.dataChannel.onerror=e=>{this.closeSignal(),t(e)}})),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(e,t){return this._p2pConnection.updateRemoteRTPCapabilities(e,t)}send(e,t,i){var n=this;return $t((function*(){const s=yield zt(n.mutex.lock("From DataChannelConnection.send"));try{return yield*Yt(Jt(n._p2pConnection.send(e,t,i)))}finally{s()}}))()}async stopSending(e,t){return this._p2pConnection.stopSending(e,t)}async createDataChannels(e,t){return this._p2pConnection.createDataChannels(e,t)}async stopDataChannels(e){return this._p2pConnection.stopDataChannels(e)}async receive(e,i,n,s){return this._nvMedia?(t.debug("[DataChannelConnection] receive ".concat(e," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(e,i,this.cname)):(t.debug("[DataChannelConnection] receive ".concat(e," by WebRTC.")),await this._p2pConnection.receive(e,i,n,s))}async batchReceive(e){return[...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(e){var t=this;return $t((function*(){return yield*Yt(Jt(t._p2pConnection.restartICE(e)))}))()}close(){var e;null===(e=this._nvMedia)||void 0===e||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var t;null===(t=this._nvMedia)||void 0===t||t.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e)}async updateEncoderConfig(e,t){return await this._p2pConnection.updateEncoderConfig(e,t)}async updateSendParameters(e,t){return await this._p2pConnection.updateSendParameters(e,t)}setStatsRemoteVideoIsReady(e,t){this._p2pConnection.setStatsRemoteVideoIsReady(e,t)}async replaceTrack(e,t){return await this._p2pConnection.replaceTrack(e,t)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(e,i,n,s){if(f("SDP_LOGGING"))return t.upload("exchanging ".concat(n," ").concat(i," SDP during DataChannelConnection.").concat(s,"\n"),e),"offer"===i?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",s)}:void 0}static resolvePCConfiguration(t){const i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(ne(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),f("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),f("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(i.iceTransportPolicy="relay")})))),i}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(On(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!f("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var t;return null===(t=this.onICEConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var t;return null===(t=this.onConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var t;return null===(t=this.onDTLSTransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var t;return null===(t=this.onDTLSTransportError)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var t;return null===(t=this.onICETransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var t;return null===(t=this.onFirstAudioReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var t;return null===(t=this.onFirstVideoReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var t;return null===(t=this.onFirstAudioDecoded)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,t,i)=>{var n;return null===(n=this.onFirstVideoDecoded)||void 0===n?void 0:n.call(this,e,t,i)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var t;return null===(t=this.onFirstVideoDecodedTimeout)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,t)=>{var i;return null===(i=this.onSelectedLocalCandidateChanged)||void 0===i?void 0:i.call(this,e,t)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,t)=>{var i;return null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i?void 0:i.call(this,e,t)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}setConfiguration(e){this._p2pConnection.setConfiguration(e)}},ii(Ma.prototype,"connect",[xa],Object.getOwnPropertyDescriptor(Ma.prototype,"connect"),Ma.prototype),ii(Ma.prototype,"updateRemoteRTPCapabilities",[xa],Object.getOwnPropertyDescriptor(Ma.prototype,"updateRemoteRTPCapabilities"),Ma.prototype),ii(Ma.prototype,"createDataChannels",[xa],Object.getOwnPropertyDescriptor(Ma.prototype,"createDataChannels"),Ma.prototype),ii(Ma.prototype,"receive",[xa],Object.getOwnPropertyDescriptor(Ma.prototype,"receive"),Ma.prototype),ii(Ma.prototype,"stopReceiving",[xa],Object.getOwnPropertyDescriptor(Ma.prototype,"stopReceiving"),Ma.prototype),ii(Ma.prototype,"muteRemote",[xa],Object.getOwnPropertyDescriptor(Ma.prototype,"muteRemote"),Ma.prototype),ii(Ma.prototype,"unmuteRemote",[xa],Object.getOwnPropertyDescriptor(Ma.prototype,"unmuteRemote"),Ma.prototype),ii(Ma.prototype,"muteLocal",[xa],Object.getOwnPropertyDescriptor(Ma.prototype,"muteLocal"),Ma.prototype),ii(Ma.prototype,"unmuteLocal",[xa],Object.getOwnPropertyDescriptor(Ma.prototype,"unmuteLocal"),Ma.prototype),ii(Ma.prototype,"close",[xa],Object.getOwnPropertyDescriptor(Ma.prototype,"close"),Ma.prototype),ii(Ma.prototype,"updateEncoderConfig",[xa],Object.getOwnPropertyDescriptor(Ma.prototype,"updateEncoderConfig"),Ma.prototype),ii(Ma.prototype,"updateSendParameters",[xa],Object.getOwnPropertyDescriptor(Ma.prototype,"updateSendParameters"),Ma.prototype),ii(Ma.prototype,"replaceTrack",[xa],Object.getOwnPropertyDescriptor(Ma.prototype,"replaceTrack"),Ma.prototype),ii(Ma.prototype,"getRemoteSSRC",[xa],Object.getOwnPropertyDescriptor(Ma.prototype,"getRemoteSSRC"),Ma.prototype),Ma);function xa(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From DataChannelConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];return await n.apply(this,o)}finally{i()}},i}var Va;let Fa=(ii((Va=class extends C{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(Zi.StateChange,t,this._state)}constructor(e,i){super(),this.store=void 0,this.statsUploader=void 0,this.connection=void 0,this.localTrackMap=new Map,this.remoteUserMap=new Map,this.localDataChannels=[],this.remoteDataChannelMap=new Map,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.statsCollector=void 0,this.isPlanB=!1,this.shouldForwardP2PCreation=void 0,this.iceFailedCount=0,this.dtlsFailedCount=0,this.mutex=new v("P2PChannel-mutex"),this._state=Qi.Disconnected,this._pcStatsUploadType=f("NEW_ICE_RESTART")?Xi.FIRST_CONNECTION:Xi.OLD_FIRST_CONNECTION,this._isInRestartIce=!1,this._isStartRestartIce=!1,this._restartStates=["disconnected","failed"],this._restartTimer=void 0,this._isFirstConnected=!0,this.handleMuteLocalTrack=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==Qi.Connected)return void i(new h(l.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const s=this.filterTobeMutedTracks(e);if(0===s.length)return void t();const o=s.find((e=>"videoLowTrack"===e[0]));if(o){o[1].track._originMediaStreamTrack.stop()}await this.connection.muteLocal(s.map((e=>{let[,{id:t}]=e;return t})));const a=this.createMuteMessage(s);await oe(this,Zi.RequestMuteLocal,a),t()}catch(e){i(e)}finally{n()}},this.handleUnmuteLocalTrack=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==Qi.Connected)return void i(new h(l.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const s=this.filterTobeUnmutedTracks(e);if(0===s.length)return void t();const o=s.find((e=>"videoLowTrack"===e[0]));if(o){const t=o[1];if(t.track._originMediaStreamTrack.stop(),!f("DISABLE_DUAL_STREAM_USE_ENCODING")&&tt().supportDualStreamEncoding){const i=e._mediaStreamTrack.clone();t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i}else{const i=Ro(e,U(this,Zi.RequestLowStreamParameter));t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i}await new Promise(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}await this.connection.unmuteLocal(s.map((e=>{let[,{id:t}]=e;return t})));const a=this.createUnmuteMessage(s);await oe(this,Zi.RequestUnmuteLocal,a),t()}catch(e){i(e)}finally{n()}},this.handleUpdateVideoEncoder=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const i=this.localTrackMap.get(zi.LocalVideoTrack);if(!this.connection||!i||i.track!==e||this.state!==Qi.Connected)return void t();const{id:s,track:o}=i;await this.connection.updateSendParameters(s,o),await this.connection.updateEncoderConfig(s,o),this.emit(Zi.UpdateVideoEncoder,o),t()}catch(e){i(e)}finally{n()}},this.handleUpdateVideoSendParameters=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{const i=this.localTrackMap.get(zi.LocalVideoTrack);if(!this.connection||!i||i.track!==e||this.state!==Qi.Connected)return void t();const{id:s,track:o}=i;await this.connection.updateSendParameters(s,o),t()}catch(e){i(e)}finally{n()}},this.handleReplaceMixingTrack=async(e,i,n,s)=>{if(!this.connection||this.state!==Qi.Connected)return void i();const o=jo([e]);let a;t.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(o.getTrackId(),"]")),"boolean"==typeof s&&s||(a=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(e,o),i()}catch(e){n(e)}finally{var r;null===(r=a)||void 0===r||r()}},this.handleReplaceTrack=async(e,i,n,s)=>{let o;t.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(e.getTrackId(),"]")),"boolean"==typeof s&&s||(o=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var a;const t=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(!this.connection||!t||this.state!==Qi.Connected)return void i();if(await(null===(a=this.connection)||void 0===a?void 0:a.replaceTrack(e,t[1].id)),this.isPlanB){const i=t[1];i.id=e._mediaStreamTrack.id,this.localTrackMap.set(t[0],i)}if(t[0]===zi.LocalVideoTrack&&!f("DISABLE_DUAL_STREAM_USE_ENCODING")&&tt().supportDualStreamEncoding){const t=this.localTrackMap.get(zi.LocalVideoLowTrack);if(t){const i=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i,await new Promise(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}}i()}catch(e){n(e)}finally{var r;null===(r=o)||void 0===r||r()}},this.handleGetRTCStats=e=>{e(this.statsCollector.getRTCStats())},this.handleGetLocalVideoStats=e=>{e(this.statsCollector.getLocalVideoTrackStats())},this.handleGetLocalAudioStats=e=>{e(this.statsCollector.getLocalAudioTrackStats())},this.handleGetRemoteVideoStats=e=>this.statsCollector.getRemoteVideoTrackStats(e.uid)[e.uid],this.handleGetRemoteAudioStats=e=>this.statsCollector.getRemoteAudioTrackStats(e.uid)[e.uid],this.store=e,this.statsCollector=i,this.statsCollector.addP2PChannel(this),this.statsUploader=new xo(this.store),this.bindStatsUploaderEvents(),this.isPlanB=!tt().supportUnifiedPlan||f("CHROME_FORCE_PLAN_B")&&se(),this.shouldForwardP2PCreation=f("FORWARD_P2P_CREATION")&&tt().supportPCSetConfiguration&&Ce(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Ua({},this.store):this.isPlanB?new la({},this.store):new Aa({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(e,i){var n;this.state=Qi.New;const s=this.shouldForwardP2PCreation&&"closed"===(null===(n=this.connection)||void 0===n?void 0:n.peerConnectionState);if(this.shouldForwardP2PCreation&&!s||(s&&this.connection&&(t.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new Ua(e,this.store):this.isPlanB?new la(e,this.store):new Aa(e,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new h(l.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=f("NEW_ICE_RESTART")?Xi.FIRST_CONNECTION:Xi.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e,t,i,n,s,o){if(!this.connection)throw new h(l.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof Ua?this.connection.updateRemoteConnect(n):(this.store.peerConnectionStart(),await this.connection.connect(e,t,i,n,s,o),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Qi.Connected)}updateRemoteRTPCapabilities(e){const n=Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return[zi.LocalVideoLowTrack,zi.LocalVideoTrack].includes(t)})),s=n.map((e=>{let[,{id:t}]=e;return t})),o=n.map((e=>{let[t]=e;return t}));if(this.connection instanceof Aa){if(i.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(o),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(e)}),!e.includes(this.store.codec)){const i=["vp9","vp8","h264"].find((t=>e.includes(t)));i&&(this.store.codec=i,t.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(i,".")))}this.connection.updateRemoteRTPCapabilities(s,e)}}async preConnect(e,t,i,n,s,o){if(!this.connection)throw new h(l.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();const a=await this.connection.connect(e,t,i,n,s,o);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Qi.Connected,a}getEstablishParams(){if(this.connection instanceof Ua)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(e){if(!this.connection||this.state!==Qi.Connected){if(this.state===Qi.Disconnected)throw new h(l.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return void e.forEach((e=>{this.pendingLocalDataChannels.includes(e)||this.pendingLocalDataChannels.push(e)}))}const t=this.filterTobePublishedDataChannels(e);0!==t.length&&(t.forEach((e=>{const t=Date.now();this.store.publish(e.id.toString(),"datachannel",t)})),await this.connection.createDataChannels(this.store.uid,t),t.forEach((e=>{this.localDataChannels.push(e);const t=Date.now();this.store.publish(e.id+"","datachannel",void 0,t)})))}publish(e,t,i){var n=this;return $t((function*(){const s=yield zt(n.mutex.lock("From P2PChannel.publish"));try{if(!n.connection||n.state!==Qi.Connected){if(n.state===Qi.Disconnected)throw new h(l.UNEXPECTED_ERROR,"PeerConnection already disconnected.");n.throwIfTrackTypeNotMatch(e);const t=e.filter((e=>-1===n.pendingLocalTracks.indexOf(e)));return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(t))}n.store.pubId=n.store.pubId+1,Ls.markPublishStart(n.store.clientId,n.store.pubId);const o=n.filterTobePublishedTracks(e,t,i);if(0===o.length)return void(yield zt(n.tryToUnmuteAudio(e)));yield*Yt(Jt(n.doPublish(n.connection,o)))}finally{s()}}))()}doPublish(e,t){var i=this;return $t((function*(){t.forEach((e=>{let{track:t,type:n}=e;const s=Date.now();i.store.publish(t.getTrackId(),n===zi.LocalAudioTrack?"audio":"video",s)})),i.bindLocalTrackEvents(t);const n=t.map((e=>{let{track:t}=e;return t})),s=yield zt(e.send(t.map((e=>{let{track:t}=e;return t})),i.store.codec,i.store.audioCodec)),o=(yield zt(s.next())).value,a=i.createGatewayPublishMessage(t,o);let r;try{r=yield a}catch(e){throw s.throw(e),(null==e?void 0:e.code)===l.WS_ABORT&&t.forEach((e=>{let{track:t}=e;-1===i.pendingLocalTracks.indexOf(t)&&i.pendingLocalTracks.push(t)})),i.unbindLocalTrackEvents(t),e}const c=i.mapPubResToRemoteConfig(a,r),d=(yield zt(s.next(c))).value,h=f("ENABLE_VIDEO_SEI");n.forEach((async e=>{const t=e.getRTCRtpTransceiver();t&&h&&(e.trackMediaType===Yi.VIDEO?await It(t.sender,e):e.trackMediaType===Yi.AUDIO&&await vt(t.sender))})),t.forEach((e=>{let{type:t}=e;i.statsCollector.addLocalStats(t)})),i.assignLocalTracks(t,d),i.statsUploader.startUploadOutboundStats(),t.forEach((e=>{let{track:t,type:n}=e;const s=Date.now();i.store.publish(t.getTrackId(),n===zi.LocalAudioTrack?"audio":"video",void 0,s)}))}))()}async updateVideoStreamParameter(e,i){const n=this.localTrackMap.get(i);if(!n)return;if(!(n.track instanceof $e))return t.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof Aa||this.connection instanceof la))return t.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:s}=n,o=function(e,t){const i={};return e.height&&e.width&&(i.scaleResolutionDownBy=xn(e,t)),i.maxFramerate=e.framerate?Pn(e.framerate):void 0,i.maxBitrate=e.bitrate?1e3*e.bitrate:void 0,i}(e,s);if(s._encoderConfig||(s._encoderConfig={}),i!==zi.LocalVideoLowTrack||!f("DISABLE_DUAL_STREAM_USE_ENCODING")&&tt().supportDualStreamEncoding)null!=o.scaleResolutionDownBy&&(s._encoderConfig.scaleResolutionDownBy=o.scaleResolutionDownBy);else{const i=s._originMediaStreamTrack;if(!i.canvas)return t.warn("[".concat(s.getTrackId(),"] no canvas on track"));!function(e,t){const i=e.canvas;t.width&&(i.width=Pn(t.width)),t.height&&(i.height=Pn(t.height)),t.framerate&&(i.stopCapture&&i.stopCapture(),i.stopCapture=it((()=>{!i.startCapture&&i.stopCapture&&i.stopCapture(),i.startCapture&&i.startCapture()}),Pn(t.framerate)))}(i,e)}null!=o.maxBitrate&&(s._encoderConfig.bitrateMax=o.maxBitrate/1e3),null!=o.maxFramerate&&(s._encoderConfig.frameRate&&"object"==typeof s._encoderConfig.frameRate?s._encoderConfig.frameRate.max=o.maxFramerate:s._encoderConfig.frameRate={max:o.maxFramerate}),t.debug("[".concat(s.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(s._encoderConfig))),await this.connection.updateRtpSenderEncodings(s)}publishLowStream(e){var t=this;return $t((function*(){if(!t.connection||t.state!==Qi.Connected)return;const i=yield zt(t.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const s=t.localTrackMap.get(zi.LocalVideoTrack);if(!s)throw new h(l.UNEXPECTED_ERROR,"Could not find high stream");if(t.localTrackMap.has(zi.LocalVideoLowTrack))throw new h(l.UNEXPECTED_ERROR,"[".concat(t.store.clientId,"] Can't publish low stream when stream already publish"));const o=[{track:t.getLowVideoTrack(s.track,e),type:zi.LocalVideoLowTrack}];if(yield*Yt(Jt(t.doPublish(t.connection,o))),s.track.muted||!s.track.enabled){var n;const e=null===(n=t.localTrackMap.get(zi.LocalVideoLowTrack))||void 0===n?void 0:n.id;void 0!==e&&(yield zt(t.connection.muteLocal([e])))}}finally{i()}}))()}async republish(){this.pendingLocalTracks.length>0&&(t.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await O(this,Zi.RequestRePublish,this.pendingLocalTracks),this.emit(Zi.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(t.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await O(this,Zi.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(e){for(let e=this.pendingRemoteTracks.length-1;e>=0;e--){const{user:t,kind:i}=this.pendingRemoteTracks[e];(i!==Yi.AUDIO||t._audio_added_&&t._audioSSRC)&&(i!==Yi.VIDEO||t._video_added_&&t._videoSSRC)||this.pendingRemoteTracks.splice(e,1)}if(e)await O(this,Zi.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:e,kind:t}of this.pendingRemoteTracks)await this.subscribe(e,t,t===Yi.VIDEO?e._videoSSRC:e._audioSSRC);this.pendingRemoteTracks.forEach((e=>{let{user:t}=e;this.emit(Zi.MediaReconnectEnd,t.uid)})),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==Qi.Connected)return void e.forEach((e=>{const t=this.pendingLocalTracks.indexOf(e);-1!==t&&this.pendingLocalTracks.splice(t,1)}));const t=this.filterTobeUnpublishedTracks(e);if(0===t.length)return;const i=t.find((e=>"videoLowTrack"===e[0]));if(i){i[1].track.close()}return this.doUnpublish(this.connection,t)}async unpublishDataChannel(e){if(!this.connection||this.state!==Qi.Connected)return void e.forEach((e=>{const t=this.pendingLocalDataChannels.indexOf(e);-1!==t&&this.pendingLocalDataChannels.splice(t,1)}));const t=this.filterTobeUnpublishedDataChannels(e);return 0!==t.length?(t.forEach((e=>{const t=this.localDataChannels.indexOf(e);-1!==t&&this.localDataChannels.splice(t,1)})),0===this.localDataChannels.length&&await this.connection.stopDataChannels(this.store.uid),t.map((e=>e.id))):void 0}async unpublishLowStream(){if(!this.connection||this.state!==Qi.Connected)return;const e=this.localTrackMap.get(zi.LocalVideoLowTrack);if(!e)return;e.track.close();const t=[[zi.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,t)}async doUnpublish(e,t){const i=this.createGatewayUnpublishMessage(t);return await e.stopSending(t.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:i}]=e;return{type:t,track:i}}))),t.forEach((e=>{let[t]=e;this.statsCollector.removeLocalStats(t)})),0===this.localTrackMap.size&&this.statsUploader.stopUploadOutboundStats(),i}async subscribeDataChannel(e,t){if(!this.connection||this.state!==Qi.Connected)throw new h(l.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const i=t.filter((t=>{var i;return!(null!==(i=this.remoteDataChannelMap.get(e))&&void 0!==i&&i.get(t.id))}));if(0!==i.length)return await this.connection.createDataChannels(e.uid,i),i.forEach((t=>{var i;this.remoteDataChannelMap.has(e)?null===(i=this.remoteDataChannelMap.get(e))||void 0===i||i.set(t.id,t):this.remoteDataChannelMap.set(e,new Map([[t.id,t]]));const n=this.pendingRemoteDataChannels.findIndex((i=>{let{user:n,id:s}=i;return n.uid===e.uid&&s===t.id}));-1!==n&&this.pendingRemoteDataChannels.splice(n,1)})),i.map((e=>e.id))}async subscribe(e,i,n,s,o){var a;if(!this.connection||this.state!==Qi.Connected)throw new h(l.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if(null!==(a=this.remoteUserMap.get(e))&&void 0!==a&&a.has(i))return;let r,c,d;if(o){const t=o.find((e=>{let{stream_type:t}=e;return t===i}));if(!t)throw new h(l.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(i," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(i,"."));const n=await this.connection.receive(i,t.ssrcs,String(e._uintid),t.attributes);this.connection instanceof Aa&&(d=n.transceiver),r=n.track,c=n.id}else{const t=await this.connection.receive(i,[{ssrcId:n,rtx:s}],String(e._uintid),void 0);this.connection instanceof Aa&&(d=t.transceiver),r=t.track,c=t.id}i===Yi.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(r):(e._audioTrack=new ct(r,e.uid,e._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),d&&e._audioTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(r):(e._videoTrack=new dt(r,e.uid,e._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),d&&e._videoTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(e,e._videoTrack)),f("ENABLE_VIDEO_SEI")&&d&&(i==Yi.VIDEO?await Rt(d.receiver,{onSei:t=>{var i;null===(i=e._videoTrack)||void 0===i||i._onSei(t)}}):i==Yi.AUDIO&&await gt(d.receiver));const u=this.remoteUserMap.get(e);u?u.set(i,c):this.remoteUserMap.set(e,new Map([[i,c]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats();const p=this.pendingRemoteTracks.findIndex((t=>{let{user:n,kind:s}=t;return n.uid===e.uid&&i===s}));-1!==p&&(this.pendingRemoteTracks.splice(p,1),this.emit(Zi.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==Qi.Connected)throw new h(l.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter((e=>{var t;let{user:i,mediaType:n}=e;return!(null!==(t=this.remoteUserMap.get(i))&&void 0!==t&&t.has(n))}));const i=await this.connection.batchReceive(e.map((e=>{let{user:t,mediaType:i,ssrcId:n,rtxSsrcId:s}=e;return{kind:i,ssrcMsg:[{ssrcId:n,rtx:s}],mslabel:String(t._uintid)}})));e.forEach(((e,n)=>{let{user:s,mediaType:o}=e;const{track:a,id:r,transceiver:c}=i[n];o===Yi.AUDIO?(s._audioTrack?s._audioTrack._updateOriginMediaStreamTrack(a):(s._audioTrack=new ct(a,s.uid,s._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(s._audioTrack.getTrackId()))),c&&s._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(s,s._audioTrack)):(s._videoTrack?s._videoTrack._updateOriginMediaStreamTrack(a):(s._videoTrack=new dt(a,s.uid,s._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(s._videoTrack.getTrackId()))),c&&s._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(s,s._videoTrack));const d=this.remoteUserMap.get(s);d?d.set(o,r):this.remoteUserMap.set(s,new Map([[o,r]])),this.statsCollector.addRemoteStats(s.uid),this.statsUploader.startUploadInboundStats();const h=this.pendingRemoteTracks.findIndex((e=>{let{user:t,kind:i}=e;return t.uid===s.uid&&o===i}));-1!==h&&(this.pendingRemoteTracks.splice(h,1),this.emit(Zi.MediaReconnectEnd,s.uid))}))}async unsubscribe(e,t,i){const n=this.pendingRemoteTracks.filter((i=>{let{user:n,kind:s}=i;return void 0!==t?n.uid===e.uid&&t===s:n.uid===e.uid}));if(n.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),this.connection&&this.state===Qi.Connected||i||n.forEach((t=>{let{kind:i}=t;var n;if(i===Yi.AUDIO)null===(n=e._audioTrack)||void 0===n||n._destroy(),e._audioTrack=void 0;else if(i===Yi.VIDEO){var s;null===(s=e._videoTrack)||void 0===s||s._destroy(),e._videoTrack=void 0}})),!this.connection||this.state!==Qi.Connected)return;const s=this.filterTobeUnSubscribedTracks(e,t);if(0===s.length)return;await this.connection.stopReceiving(s.map((e=>{let[,{id:t}]=e;return t})));const o=this.createUnsubscribeMessage(s);return this.withdrawRemoteTracks(s),0===this.remoteUserMap.size&&this.statsUploader.stopUploadInboundStats(),s.forEach((e=>{let[t,{kind:n}]=e;var s,o;n===Yi.VIDEO&&t._videoSSRC&&(null===(s=this.connection)||void 0===s||s.setStatsRemoteVideoIsReady(t._videoSSRC,!1));if(n===Yi.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),i||(null===(o=t._videoTrack)||void 0===o||o._destroy(),t._videoTrack=void 0);else if(n===Yi.AUDIO){var a;if(this.unbindRemoteTrackEvents(t._audioTrack),!i)null===(a=t._audioTrack)||void 0===a||a._destroy(),t._audioTrack=void 0}})),o}async unsubscribeDataChannel(e,t){if(t.forEach((e=>{const t=this.pendingRemoteDataChannels.findIndex((t=>t.id===e.id));-1!==t&&this.pendingRemoteDataChannels.splice(t,1)})),!this.connection)return;const i=this.filterTobeUnSubscribedDataChannels(e,t);if(0===i.length)return;t.forEach((e=>{e._close()}));const n=this.remoteDataChannelMap.get(e);return i.forEach((e=>{n&&n.delete(e.id)})),n&&0===n.size&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),i.map((e=>e.id))}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let t=[];for(const{user:i,mediaType:n}of e){const e=this.pendingRemoteTracks.filter((e=>{let{user:t,kind:s}=e;return void 0!==n?t.uid===i.uid&&n===s:t.uid===i.uid}));e.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),t=t.concat(e)}if(!this.connection||this.state!==Qi.Connected)return void t.forEach((e=>{let{user:t,kind:i}=e;var n;if(i===Yi.AUDIO)null===(n=t._audioTrack)||void 0===n||n._destroy(),t._audioTrack=void 0;else if(i===Yi.VIDEO){var s;null===(s=t._videoTrack)||void 0===s||s._destroy(),t._videoTrack=void 0}}));const i=e.reduce(((e,t)=>{let{user:i,mediaType:n}=t;const s=this.filterTobeUnSubscribedTracks(i,n);return e.concat(s)}),[]);if(0===i.length)return;await this.connection.stopReceiving(i.map((e=>{let[,{id:t}]=e;return t})));const n=this.createUnsubscribeAllMessage(i);return this.withdrawRemoteTracks(i),0===this.remoteUserMap.size&&this.statsUploader.stopUploadInboundStats(),i.forEach((e=>{let[t,{kind:i}]=e;var n,s;i===Yi.VIDEO&&t._videoSSRC&&(null===(n=this.connection)||void 0===n||n.setStatsRemoteVideoIsReady(t._videoSSRC,!1));if(i===Yi.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),null===(s=t._videoTrack)||void 0===s||s._destroy(),t._videoTrack=void 0;else if(i===Yi.AUDIO){var o;this.unbindRemoteTrackEvents(t._audioTrack),null===(o=t._audioTrack)||void 0===o||o._destroy(),t._audioTrack=void 0}})),n}async muteRemote(e,i){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void t.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(i))return void t.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."));const s=i===Yi.VIDEO?e._videoSSRC:e._audioSSRC;void 0!==s&&this.connection.setStatsRemoteVideoIsReady(s,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,i){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void t.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid,"."));n.get(i)||t.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."))}getAllTracks(e){const t=this.localTrackMap.get(zi.LocalAudioTrack);if((null==t?void 0:t.track)instanceof Qe){const i=t.track;return Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return t!==zi.LocalAudioTrack})).filter((t=>{let[i]=t;return!(e&&i===zi.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t})).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter((t=>{let[i]=t;return!(e&&i===zi.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t}))}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,t,n,s,o){if(e){const n=this.localTrackMap.get(zi.LocalAudioTrack),a=s?this.localTrackMap.get(zi.LocalVideoLowTrack):this.localTrackMap.get(zi.LocalVideoTrack);i.publish(this.store.sessionId,{eventElapse:Ls.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==n?void 0:n.track.getTrackLabel(),videoName:null==a?void 0:a.track.getTrackLabel(),screenshare:-1!==(null==a?void 0:a.track._hints.indexOf(et.SCREEN_TRACK)),audio:!!n,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}else{var a;n||(n=[]);const r=n.find((e=>e instanceof Ze)),c=s?null===(a=this.localTrackMap.get(zi.LocalVideoTrack))||void 0===a?void 0:a.track:n.find((e=>e instanceof $e));i.publish(this.store.sessionId,{eventElapse:Ls.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==r?void 0:r.getTrackLabel(),videoName:null==c?void 0:c.getTrackLabel(),screenshare:-1!==(null==c?void 0:c._hints.indexOf(et.SCREEN_TRACK)),audio:!!r,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}}reportSubscribeEvent(e,t,n,s){const o=s===Yi.VIDEO?n._videoSSRC:n._audioSSRC;o&&i.subscribe(this.store.sessionId,{succ:e,ec:t,video:s===Yi.VIDEO,audio:s===Yi.AUDIO,peerid:n.uid,subscribeRequestid:s===Yi.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:Ls.measureFromSubscribeStart(this.store.clientId,o)})}reset(){t.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new v("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Ua({},this.store):this.isPlanB?new la({},this.store):new Aa({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(zi.LocalAudioTrack);if((null==e?void 0:e.track)instanceof Qe){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((e=>{t.removeAudioTrack(e)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=Qi.Disconnected}getStats(){var e;return null===(e=this.connection)||void 0===e?void 0:e.getStats()}getRemoteVideoIsReady(e){var t;return(null===(t=this.connection)||void 0===t?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(zi.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(zi.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof $e||t&&t.track instanceof Ze?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}getRemoteMedia(e){const t=Array.from(this.remoteUserMap.keys()).find((t=>t.uid===e));return t?{audioTrack:t.audioTrack,audioSSRC:t._audioSSRC,videoTrack:t.videoTrack,videoSSRC:t._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((e=>{let[t]=e;return{uid:t.uid,level:t.audioTrack?100*t.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(zi.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=e.sort(((e,t)=>e.level-t.level)),e}async disconnectForReconnect(){this.connection&&(t.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=Qi.Reconnecting,f("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var i;t._videoTrack&&t._videoTrack._player&&(null===(i=t._videoTrack._player.getVideoElement())||void 0===i||i.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Ua({},this.store):this.isPlanB?new la({},this.store):new Aa({},this.store),this.bindConnectionEvents(this.connection)),0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;switch(t){case zi.LocalVideoTrack:i._hints.includes(et.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case zi.LocalAudioTrack:i instanceof Qe?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case zi.LocalVideoLowTrack:}})),this.emit(Zi.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;Array.from(i.keys()).forEach((e=>{this.setPendingRemoteMedia(t,e)})),this.emit(Zi.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),0!==this.localDataChannels.length&&(this.localDataChannels.forEach((e=>{this.pendingLocalDataChannels.push(e)})),this.localDataChannels.length=0),0!==this.remoteDataChannelMap.size&&(Array.from(this.remoteDataChannelMap.entries()).forEach((e=>{let[t,i]=e;Array.from(i.keys()).forEach((e=>{this.setPendingRemoteDataChannel(t,e)}))})),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),t.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,t){for(const i of this.pendingRemoteDataChannels){const{user:n,id:s}=i;if((e instanceof Vo?e.uid:e)===n.uid&&s===t)return!0}return!1}setPendingRemoteDataChannel(e,t){this.hasPendingRemoteDataChannel(e,t)||this.pendingRemoteDataChannels.push({user:e,id:t})}hasPendingRemoteMedia(e,t){for(const i of this.pendingRemoteTracks){const{user:n,kind:s}=i;if((e instanceof Vo?e.uid:e)===n.uid&&t===s)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}restartICE(e){var t=this;return $t((function*(){if(!t.connection||t.state!==Qi.Connected||t.connection instanceof Ua)return;const i=yield zt(t.mutex.lock("From P2PChannel.restartICE"));let n;try{n=yield zt(t.connection.restartICE(e));const s=yield zt(n.next());if(s.done)return;const o=s.value,a=yield o;switch(t.reportPCDisconnectedOrFailed(e),e){case Ji.TCP:t._pcStatsUploadType=Xi.TCP_RESTART;break;case Ji.RELAY:t._pcStatsUploadType=Xi.RELAY_RESTART;break;default:t._pcStatsUploadType=Xi.OLD_RESTART}t._isInRestartIce=!0,n.next(a)}catch(e){var s;null===(s=n)||void 0===s||s.throw(e)}finally{i()}}))()}getUplinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats(),t=this.localTrackMap.get(zi.LocalVideoTrack),i=this.localTrackMap.get(zi.LocalAudioTrack),n=e.videoSend.find((e=>e.ssrc===(null==t?void 0:t.ssrcs[0].ssrcId))),s=e.audioSend.find((e=>e.ssrc===(null==i?void 0:i.ssrcs[0].ssrcId)));if(!n||!s)return 1;const o=D(this,Zi.NeedSignalRTT),a=n?n.rttMs:void 0,r=s?s.rttMs:void 0,c=a&&r?(a+r)/2:a||r,d=(c&&o?(c+o)/2:c||o)||0,h=100*e.sendPacketLossRate*.7/50+.3*d/1500,l=h<.17?1:h<.36?2:h<.59?3:h<.1?4:5,u=null==t?void 0:t.track;if(u&&u._encoderConfig&&-1===u._hints.indexOf(et.SCREEN_TRACK)){const t=u._encoderConfig.bitrateMax,i=e.bitrate.actualEncoded;if(t&&i){const e=(1e3*t-i)/(1e3*t);return jt[e<.15?0:e<.3?1:e<.45?2:e<.6?3:4][l]}}return l}getDownlinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((i=>{let[n]=i;const s=n._audioSSRC,o=n._videoSSRC,a=e.audioRecv.find((e=>e.ssrc===s)),r=e.videoRecv.find((e=>e.ssrc===o));if(!a&&!r)return void(t+=1);const c=D(this,Zi.NeedSignalRTT),d=e.rtt,h=(d&&c?(d+c)/2:d||c)||0,l=a?a.jitterMs:void 0,u=e.recvPacketLossRate;let p=.7*u*100/50+.3*h/1500;l&&(p=.6*u*100/50+.2*h/1500+.2*l/400);t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new Promise(((t,i)=>{this.handleMuteLocalTrack(e,t,i)}))}async replaceTrack(e,i){var n;if(t.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(e.getTrackId(),"] to [").concat(i.getTrackId(),"]")),!this.connection||this.state!==Qi.Connected)return;const s=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(!s)return;const o=s[0];if(e!==i&&(this.unbindLocalTrackEvents([{track:e,type:o}]),this.bindLocalTrackEvents([{track:i,type:o}]),s[1].track=i),await(null===(n=this.connection)||void 0===n?void 0:n.replaceTrack(i,s[1].id)),this.isPlanB){const e=s[1];e.id=i._mediaStreamTrack.id,this.localTrackMap.set(o,e)}if(o===zi.LocalVideoTrack&&!f("DISABLE_DUAL_STREAM_USE_ENCODING")&&tt().supportDualStreamEncoding){const t=this.localTrackMap.get(zi.LocalVideoLowTrack);if(t){const i=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i,await new Promise(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}}}filterTobePublishedTracks(e,i,n){const s=[],o=this.getAllTracks();e=e.filter((e=>-1===o.indexOf(e))),e=ae(e);let a,r=!1;const c=this.localTrackMap.get(zi.LocalAudioTrack);for(const o of e){if(o instanceof $e&&(this.localTrackMap.has(zi.LocalVideoTrack)||r?new h(l.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(s.push({track:o,type:zi.LocalVideoTrack}),r=!0),i)){const e=this.getLowVideoTrack(o,n);s.push({track:e,type:zi.LocalVideoLowTrack})}if(o instanceof Ze)if(c){const e=c.track;if(e instanceof Qe)Go([o]),e.addAudioTrack(o),this.bindLocalAudioTrackEvents(o,!0);else{const i=jo([e,o]);t.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(i.getTrackId(),"]")),this.replaceTrack(e,i)}}else if(a instanceof Qe)Go([o]),a.addAudioTrack(o);else if(a||!o._useAudioElement&&tt().webAudioMediaStreamDest&&!o._bypassWebAudio){a=jo(a?[o,a]:[o])}else a=o}return a&&(t.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(a.getTrackId(),"]")),s.push({track:a,type:zi.LocalAudioTrack})),s}filterTobeUnpublishedTracks(e){const t=[],i=this.getAllTracks();e=e.filter((e=>-1!==i.indexOf(e))),e=ae(e);for(const i of e){if(i instanceof Ze){const e=this.localTrackMap.get(zi.LocalAudioTrack);if(!e)continue;e.track instanceof Qe?(e.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===e.track.trackList.length&&(t.push([zi.LocalAudioTrack,e]),e.track.close())):t.push([zi.LocalAudioTrack,e])}if(i instanceof $e){const e=this.localTrackMap.get(zi.LocalVideoTrack);if(!e)continue;t.push([zi.LocalVideoTrack,e]);const i=this.localTrackMap.get(zi.LocalVideoLowTrack);i&&t.push([zi.LocalVideoLowTrack,i])}}return t}filterTobePublishedDataChannels(e){return e=(e=ae(e)).filter((e=>-1===this.localDataChannels.findIndex((t=>t.id===e.id))))}filterTobeUnpublishedDataChannels(e){return e=(e=(e=ae(e)).filter((e=>-1!==this.localDataChannels.indexOf(e)))).filter((e=>e._originDataChannel))}bindLocalTrackEvents(e){e.forEach((e=>{let{track:t,type:i}=e;switch(i){case zi.LocalVideoTrack:t.addListener(ht.GET_STATS,this.handleGetLocalVideoStats),t.addListener(ht.GET_RTC_STATS,this.handleGetRTCStats),t.addListener(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(ht.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(ht.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.addListener(ht.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case zi.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case zi.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof Qe?e.trackList.forEach((e=>{e.addListener(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(ht.GET_STATS,this.handleGetLocalAudioStats),e.addListener(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(ht.GET_STATS,this.handleGetLocalAudioStats),e.addListener(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||(e.addListener(ht.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.addListener(ht.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((e=>{let[t,{track:i}]=e;return{track:i,type:t}}))),e.forEach((e=>{let{track:t,type:i}=e;switch(i){case zi.LocalVideoTrack:t.off(ht.GET_STATS,this.handleGetLocalVideoStats),t.off(ht.GET_RTC_STATS,this.handleGetRTCStats),t.off(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(ht.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(ht.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),t.off(ht.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case zi.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case zi.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof Qe?e.trackList.forEach((e=>{e.off(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(ht.GET_STATS,this.handleGetLocalAudioStats),e.off(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(ht.GET_STATS,this.handleGetLocalAudioStats),e.off(ht.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(ht.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(ht.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(ht.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),e.off(ht.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(ht.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof dt&&t.addListener(ht.GET_STATS,(t=>{t(this.handleGetRemoteVideoStats(e))})),t instanceof ct&&t.addListener(ht.GET_STATS,(t=>{t(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(ht.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;i.has(Yi.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),i.has(Yi.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((e,i)=>{let n,s,{track:o,type:a}=e;switch(a){case zi.LocalAudioTrack:n=Mi.Audio,s={dtx:o instanceof rt&&o._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case zi.LocalVideoTrack:n=o._hints.includes(et.SCREEN_TRACK)?Mi.Screen:Mi.High,s=Zt(Zt({},Ln(o)),{},{codec:this.store.codec});break;case zi.LocalVideoLowTrack:n=Mi.Low,s=Zt(Zt({},Ln(o)),{},{codec:this.store.codec})}return{stream_type:n,attributes:s,ssrcs:t[i]}}))}createGatewayUnpublishMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:o}]=e;switch(i){case zi.LocalVideoTrack:t=n._hints.includes(et.SCREEN_TRACK)?Mi.Screen:Mi.High;break;case zi.LocalAudioTrack:t=Mi.Audio;break;case zi.LocalVideoLowTrack:t=Mi.Low}return{stream_type:t,ssrcs:s,mid:o}}))}assignLocalTracks(e,t){e.forEach(((e,i)=>{let{track:n,type:s}=e;this.localTrackMap.set(s,{track:n,id:t[i].id,ssrcs:t[i].localSSRC})}))}withdrawLocalTracks(e){e.forEach((e=>{let[t]=e;this.localTrackMap.delete(t)}))}bindConnectionEvents(e){e.onConnectionStateChange=async i=>{if(t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(i,")")),this.emit(Zi.PeerConnectionStateChange,i),"connected"!==i||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===i&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),f("NEW_ICE_RESTART")){if(this._restartStates.includes(i)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const i=i=>{if("disconnected"===e.iceConnectionState||"checking"===e.iceConnectionState||"failed"===e.iceConnectionState){t.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(i));"CONNECTED"===D(this,Zi.QueryClientConnectionState)&&this.emit(Zi.RequestRestartICE,i)}},n=()=>{"disconnected"!==e.iceConnectionState&&"checking"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),t.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout((()=>this.emit(Zi.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())},s=f("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout((()=>{if(f("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&tt().supportPCSetConfiguration)i(Ji.RELAY),this._restartTimer=window.setTimeout(n,s);else if(I())i(Ji.UDP),this._restartTimer=window.setTimeout(n,4e3);else{if(i(Ji.TCP),tt().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout((()=>{i(Ji.RELAY),this._restartTimer=window.setTimeout(n,s)}),s));this._restartTimer=window.setTimeout(n,s)}}),800))}}else{if("disconnected"===i&&"disconnected"===e.iceConnectionState)return setTimeout((()=>{if("disconnected"===e.iceConnectionState&&f("ICE_RESTART")){"CONNECTED"===D(this,Zi.QueryClientConnectionState)&&this.emit(Zi.RequestRestartICE)}}),800),void setTimeout((()=>{"disconnected"===e.peerConnectionState&&(t.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout((()=>this.emit(Zi.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())}),4e3);"failed"===i&&(t.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout((()=>this.emit(Zi.P2PLost)),0),this.iceFailedCount+=1,await this.requestReconnect())}},e.onICEConnectionStateChange=e=>{"connected"!==e||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),i.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:X.TRACER}).onSuccess(),this.emit(Zi.IceConnectionStateChange,e)},e.onICETransportStateChange=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},e.onDTLSTransportStateChange=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},e.onDTLSTransportError=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},e.onFirstAudioDecoded=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._audioSSRC===e));var o;t&&(this.store.subscribe(t.uid,"audio",void 0,void 0,void 0,Date.now()),null===(o=t.audioTrack)||void 0===o||o.emit(lt.FIRST_FRAME_DECODED),i.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_DECODE,s.FIRST_AUDIO_DECODE,{peer:t._uintid,subscribeElapse:Ls.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._audioSSRC===e));t&&i.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_RECEIVED,s.FIRST_AUDIO_RECEIVED,{peer:t._uintid,subscribeElapse:Ls.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(e,t,i)=>{this.reportVideoFirstFrameDecoded(e,t,i)},e.onFirstVideoReceived=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._videoSSRC===e));t&&i.firstRemoteFrame(this.store.sessionId,n.FIRST_VIDEO_RECEIVED,s.FIRST_VIDEO_RECEIVED,{peer:t._uintid,subscribeElapse:Ls.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(e,i)=>{const n="relay"===e.candidateType,s="relay"===i.candidateType;"unknown"!==i.candidateType&&n===s||this.emit(Zi.ConnectionTypeChange,n),t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Vn(i))," -> ").concat(JSON.stringify(Vn(e)),")"))},e.onSelectedRemoteCandidateChanged=(e,i)=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Vn(i))," -> ").concat(JSON.stringify(Vn(e)),")"))},e.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},e.getLocalVideoStats=()=>{const e=this.statsCollector.getLocalVideoTrackStats(),t=this.statsCollector.getRTCStats();return Zt(Zt({},e),t)}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.getLocalVideoStats=void 0}filterTobeMutedTracks(e){const t=[];if(-1===this.getAllTracks().indexOf(e))return t;const i=this.localTrackMap.get(zi.LocalAudioTrack);if(e instanceof Ze&&(null==i?void 0:i.track)instanceof Qe)return i.track.isActive||t.push([zi.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n&&(t.push(n),n[0]===zi.LocalVideoTrack)){const e=this.localTrackMap.get(zi.LocalVideoLowTrack);e&&t.push([zi.LocalVideoLowTrack,e])}return t}filterTobeUnmutedTracks(e){const t=[],i=this.localTrackMap.get(zi.LocalAudioTrack);if(e instanceof Ze&&(null==i?void 0:i.track)instanceof Qe)return i.track.isActive&&t.push([zi.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n)if(n[0]===zi.LocalVideoTrack){t.push(n);const e=this.localTrackMap.get(zi.LocalVideoLowTrack);e&&t.push([zi.LocalVideoLowTrack,e])}else t.push(n);return t}createMuteMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:o}]=e;switch(i){case zi.LocalAudioTrack:t=Mi.Audio;break;case zi.LocalVideoTrack:t=n._hints.includes(et.SCREEN_TRACK)?Mi.Screen:Mi.High;break;case zi.LocalVideoLowTrack:t=Mi.Low}return{stream_type:t,ssrcs:s,mid:o}}))}createUnmuteMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:o}]=e;switch(i){case zi.LocalAudioTrack:t=Mi.Audio;break;case zi.LocalVideoTrack:t=n._hints.includes(et.SCREEN_TRACK)?Mi.Screen:Mi.High;break;case zi.LocalVideoLowTrack:t=Mi.Low}return{stream_type:t,ssrcs:s,mid:o}}))}filterTobeUnSubscribedTracks(e,t){const i=[],n=this.remoteUserMap.get(e);if(!n)return i;if(t){const s=n.get(t);if(!s)return i;i.push([e,{kind:t,id:s}])}else Array.from(n.entries()).forEach((t=>{let[n,s]=t;i.push([e,{kind:n,id:s}])}));return i}filterTobeUnSubscribedDataChannels(e,t){const i=[];return t.forEach((t=>{var n;null!==(n=this.remoteDataChannelMap.get(e))&&void 0!==n&&n.has(t.id)&&i.push(t)})),i}createUnsubscribeMessage(e){const t=[];return e.forEach((e=>{let[i,{kind:n,id:s}]=e;switch(n){case Yi.VIDEO:return void(i._videoSSRC&&t.push({stream_type:Yi.VIDEO,ssrcId:i._videoSSRC}));case Yi.AUDIO:return void(i._audioSSRC&&t.push({stream_type:Yi.AUDIO,ssrcId:i._audioSSRC}))}})),t}createUnsubscribeAllMessage(e){const t=new Map;return e.forEach((e=>{let[i,{kind:n}]=e;if(t.has(i)){let e=t.get(i);n===Yi.VIDEO?e|=Vi.Video:e|=Vi.Audio,t.set(i,e)}else n===Yi.VIDEO?t.set(i,Vi.Video):t.set(i,Vi.Audio)})),{users:Array.from(t.entries()).map((e=>{let[t,i]=e;return{stream_id:t.uid,stream_type:i}}))}}withdrawRemoteTracks(e){e.forEach((e=>{let[t,{kind:i}]=e;const n=this.remoteUserMap.get(t);n&&(n.delete(i),0===Array.from(n.entries()).length&&this.remoteUserMap.delete(t))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(zi.LocalVideoTrack),i=this.localTrackMap.get(zi.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),i&&e.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.connection){return"connected"!==this.connection.peerConnectionState}return!0}mapPubResToRemoteConfig(e,t){return e.map(((e,i)=>{var n;let{stream_type:s}=e;return null===(n=t.find((e=>{let{stream_type:t}=e;return s===t})))||void 0===n?void 0:n.attributes}))}async tryToUnmuteAudio(e){for(let i=0;i<e.length;i++)if(e[i]instanceof Ze){var t;const n=this.filterTobeUnmutedTracks(e[i]);if(0===n.length)continue;await(null===(t=this.connection)||void 0===t?void 0:t.unmuteLocal(n.map((e=>{let[,{id:t}]=e;return t}))));const s=this.createUnmuteMessage(n);return void await oe(this,Zi.RequestUnmuteLocal,s)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!(null===(t=this.connection)||void 0===t||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(Zi.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(Zi.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await b(N(this.dtlsFailedCount,Q)),this.emit(Zi.RequestReconnect)}async reconnectP2P(){const e=Array.from(this.localTrackMap.entries()),t=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),t.length>0&&await O(this,Zi.RequestUnpublishForReconnectPC,t),this.disconnectForReconnect(),this.emit(Zi.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(zi.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof $e))}throwIfTrackTypeNotMatch(e){if(e.filter((e=>e instanceof $e)).length>1)throw new h(l.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((e=>e instanceof Ze)).length>1&&(e.some((e=>e instanceof Ze&&e._bypassWebAudio))||!tt().webAudioMediaStreamDest))throw new h(l.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof $e&&this.pendingLocalTracks.some((e=>e instanceof $e)))throw new h(l.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof Ze&&this.pendingLocalTracks.some((e=>e instanceof Ze))&&(!tt().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((e=>e instanceof Ze&&e._bypassWebAudio))))throw new h(l.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const i=!f("DISABLE_DUAL_STREAM_USE_ENCODING")&&tt().supportDualStreamEncoding,n=Zt(Zt({},{width:160,height:120,framerate:15,bitrate:50}),t);let s;s=i?e._mediaStreamTrack.clone():Ro(e,n);const o=M(8,"track-low-"),a=new $e(s,Zt(Zt({},i&&{scaleResolutionDownBy:xn(n,e)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,o);return a.on(ut.TRANSCEIVER_UPDATED,(t=>{e._updateRtpTransceiver(t,pt.LOW_STREAM)})),a._hints.push(et.LOW_STREAM),e.on("sei-to-send",(e=>{a.emit("sei-to-send",e)})),e.addListener(ht.NEED_CLOSE,(()=>{a.close()})),a}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,t,n){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(this.connection&&this.connection instanceof Aa){var o,a,r,c;const d=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:h,dtlsTransportState:l,peerConnectionState:u}=this.connection,{local:p,remote:_}=await this.connection.getSelectedCandidatePair();i.pcStats(this.store.sessionId,{startTime:d,eventElapse:e-d||0,iceconnectionsate:h,dtlsstate:l,connectionstate:u,intSucc:t?1:2,error:s,selectedLocalCandidateProtocol:null!==(o=null==p?void 0:p.protocol)&&void 0!==o?o:"",selectedLocalCandidateType:null!==(a=p.candidateType)&&void 0!==a?a:"",selectedLocalCandidateAddress:"".concat(p.address,":").concat(p.port),selectedRemoteCandidateProtocol:null!==(r=_.protocol)&&void 0!==r?r:"",selectedRemoteCandidateType:null!==(c=_.candidateType)&&void 0!==c?c:"",selectedRemoteCandidateAddress:"".concat(_.address,":").concat(_.port),restartCnt:n})}}reportVideoFirstFrameDecoded(e,t,o,a){const r=Array.from(this.remoteUserMap.keys()).find((t=>t._videoSSRC===e));if(r){a||this.store.subscribe(r.uid,"video",void 0,void 0,void 0,void 0,Date.now());const c=this.store.keyMetrics,d=c.subscribe.find((e=>e.userId===r.uid&&"video"===e.type));i.firstRemoteVideoDecode(this.store.sessionId,n.FIRST_VIDEO_DECODE,s.FIRST_VIDEO_DECODE,{peer:r._uintid,videowidth:t,videoheight:o,subscribeElapse:Ls.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:c.requestAPEnd||0,apStart:c.requestAPStart||0,joinGwEnd:c.joinGatewayEnd||0,joinGwStart:c.joinGatewayStart||0,pcEnd:c.peerConnectionEnd||0,pcStart:c.peerConnectionStart||0,subscriberEnd:(null==d?void 0:d.subscribeEnd)||0,subscriberStart:(null==d?void 0:d.subscribeStart)||0,videoAddNotify:(null==d?void 0:d.streamAdded)||0,state:a?1:0})}}async remoteMediaSsrcChanged(e,t,i){if(!this.connection)return!1;const n=this.remoteUserMap.get(e);if(!n)return!1;const s=n.get(t);if(!s)return!1;const o=await this.connection.getRemoteSSRC(s);return void 0!==o&&o!==i}resetConnection(e){t.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(e)),this.state===Qi.Connected?(t.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=e===Fi.datachannel?new Ua({},this.store):this.isPlanB?new la({},this.store):new Aa({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;t===zi.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,pt.LOW_STREAM):i._updateRtpTransceiver(void 0)}))}reportPCDisconnectedOrFailed(e){this.connection&&this.connection instanceof Aa&&("disconnected"!==this.connection.iceConnectionState&&"checking"!==this.connection.iceConnectionState&&"failed"!==this.connection.iceConnectionState||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===Xi.TCP_RESTART&&e===Ji.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,Xi.DISCONNECTED_OR_FAILED)))}}).prototype,"startP2PConnection",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"startP2PConnection"),Va.prototype),ii(Va.prototype,"connect",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"connect"),Va.prototype),ii(Va.prototype,"updateRemoteRTPCapabilities",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"updateRemoteRTPCapabilities"),Va.prototype),ii(Va.prototype,"preConnect",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"preConnect"),Va.prototype),ii(Va.prototype,"publishDataChannel",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"publishDataChannel"),Va.prototype),ii(Va.prototype,"unpublish",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"unpublish"),Va.prototype),ii(Va.prototype,"unpublishDataChannel",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"unpublishDataChannel"),Va.prototype),ii(Va.prototype,"unpublishLowStream",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"unpublishLowStream"),Va.prototype),ii(Va.prototype,"subscribeDataChannel",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"subscribeDataChannel"),Va.prototype),ii(Va.prototype,"subscribe",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"subscribe"),Va.prototype),ii(Va.prototype,"massSubscribe",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"massSubscribe"),Va.prototype),ii(Va.prototype,"unsubscribe",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"unsubscribe"),Va.prototype),ii(Va.prototype,"unsubscribeDataChannel",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"unsubscribeDataChannel"),Va.prototype),ii(Va.prototype,"massUnsubscribe",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"massUnsubscribe"),Va.prototype),ii(Va.prototype,"muteRemote",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"muteRemote"),Va.prototype),ii(Va.prototype,"unmuteRemote",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"unmuteRemote"),Va.prototype),ii(Va.prototype,"hasRemoteMediaWithLock",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"hasRemoteMediaWithLock"),Va.prototype),ii(Va.prototype,"disconnectForReconnect",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"disconnectForReconnect"),Va.prototype),ii(Va.prototype,"updateBitrateLimit",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"updateBitrateLimit"),Va.prototype),ii(Va.prototype,"remoteMediaSsrcChanged",[Ba],Object.getOwnPropertyDescriptor(Va.prototype,"remoteMediaSsrcChanged"),Va.prototype),Va);function Ba(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PChannel.".concat(t));try{for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];return await n.apply(this,o)}finally{i()}},i}function Ga(e){let t=Za();return function(e,t){let i=e.appId;void 0!==i&&(ur(t,10),or(t,i));let n=e.cid;void 0!==n&&(ur(t,16),ur(t,n));let s=e.cname;void 0!==s&&(ur(t,26),or(t,s));let o=e.deviceId;void 0!==o&&(ur(t,34),or(t,o));let a=e.elapse;void 0!==a&&(ur(t,40),pr(t,a));let r=e.fileSize;void 0!==r&&(ur(t,48),pr(t,za(r)));let c=e.height;void 0!==c&&(ur(t,56),pr(t,za(c)));let d=e.jpg;void 0!==d&&(ur(t,66),ur(t,d.length),function(e,t){let i=ir(e,t.length);e.bytes.set(t,i)}(t,d));let h=e.networkType;void 0!==h&&(ur(t,72),pr(t,za(h)));let l=e.osType;void 0!==l&&(ur(t,80),pr(t,za(l)));let u=e.requestId;void 0!==u&&(ur(t,90),or(t,u));let p=e.sdkVersion;void 0!==p&&(ur(t,98),or(t,p));let _=e.sequence;void 0!==_&&(ur(t,104),pr(t,za(_)));let E=e.sid;void 0!==E&&(ur(t,114),or(t,E));let m=e.timestamp;void 0!==m&&(ur(t,120),pr(t,m));let S=e.uid;void 0!==S&&(ur(t,128),ur(t,S));let T=e.vid;void 0!==T&&(ur(t,136),ur(t,T));let C=e.width;void 0!==C&&(ur(t,144),pr(t,za(C)));let f=e.service;void 0!==f&&(ur(t,152),ur(t,f));let R=e.callbackData;void 0!==R&&(ur(t,162),or(t,R));let g=e.jpgEncryption;void 0!==g&&(ur(t,168),ur(t,g));let I=e.requestType;void 0!==I&&(ur(t,176),ur(t,I));let v=e.scorePorn;void 0!==v&&(ur(t,185),hr(t,v));let A=e.scoreSexy;void 0!==A&&(ur(t,193),hr(t,A));let w=e.scoreNeutral;void 0!==w&&(ur(t,201),hr(t,w));let y=e.scene;void 0!==y&&(ur(t,208),ur(t,y));let N=e.ossFilePrefix;void 0!==N&&(ur(t,218),or(t,N));let b=e.serviceVendor;if(void 0!==b)for(let e of b){ur(t,226);let i=Za();Ha(e,i),ur(t,i.limit),ar(t,i),$a(i)}}(e,t),function(e){let t=e.bytes,i=e.limit;return t.length===i?t:t.subarray(0,i)}(t)}function ja(e){return function(e){let t={};e:for(;!tr(e);){let i=lr(e);switch(i>>>3){case 0:break e;case 1:t.code=lr(e);break;case 2:t.msg=sr(e,lr(e));break;case 3:{let i=Ka(e);t.data=Wa(e),e.limit=i;break}default:qa(e,7&i)}}return t}({bytes:t=e,offset:0,limit:t.length});var t}function Wa(e){let t={};e:for(;!tr(e);){let i=lr(e);switch(i>>>3){case 0:break e;case 1:t.requestId=sr(e,lr(e));break;case 2:t.requestType=lr(e)>>>0;break;case 3:t.scorePorn=dr(e);break;case 4:t.scoreSexy=dr(e);break;case 5:t.scoreNeutral=dr(e);break;case 6:t.requestScene=lr(e)>>>0;break;case 7:t.scene=lr(e)>>>0;break;default:qa(e,7&i)}}return t}function Ha(e,t){let i=e.service;void 0!==i&&(ur(t,8),ur(t,i));let n=e.vendor;void 0!==n&&(ur(t,16),ur(t,n));let s=e.token;void 0!==s&&(ur(t,26),or(t,s));let o=e.callbackUrl;void 0!==o&&(ur(t,34),or(t,o))}function Ka(e){let t=lr(e),i=e.limit;return e.limit=e.offset+t,i}function qa(e,t){switch(t){case 0:for(;128&rr(e););break;case 2:er(e,lr(e));break;case 5:er(e,4);break;case 1:er(e,8);break;default:throw new Error("Unimplemented type: "+t)}}let Ya=new Float32Array(1);new Uint8Array(Ya.buffer);let Ja=new Float64Array(1),Xa=new Uint8Array(Ja.buffer);function za(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let Qa=[];function Za(){const e=Qa.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}function $a(e){Qa.push(e)}function er(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function tr(e){return e.offset>=e.limit}function ir(e,t){let i=e.bytes,n=e.offset,s=e.limit,o=n+t;if(o>i.length){let t=new Uint8Array(2*o);t.set(i),e.bytes=t}return e.offset=o,o>s&&(e.limit=o),n}function nr(e,t){let i=e.offset;if(i+t>e.limit)throw new Error("Read past limit");return e.offset+=t,i}function sr(e,t){let i=nr(e,t),n=String.fromCharCode,s=e.bytes,o="�",a="";for(let e=0;e<t;e++){let r,c,d,h,l=s[e+i];0==(128&l)?a+=n(l):192==(224&l)?e+1>=t?a+=o:(r=s[e+i+1],128!=(192&r)?a+=o:(h=(31&l)<<6|63&r,h<128?a+=o:(a+=n(h),e++))):224==(240&l)?e+2>=t?a+=o:(r=s[e+i+1],c=s[e+i+2],32896!=(49344&(r|c<<8))?a+=o:(h=(15&l)<<12|(63&r)<<6|63&c,h<2048||h>=55296&&h<=57343?a+=o:(a+=n(h),e+=2))):240==(248&l)?e+3>=t?a+=o:(r=s[e+i+1],c=s[e+i+2],d=s[e+i+3],8421504!=(12632256&(r|c<<8|d<<16))?a+=o:(h=(7&l)<<18|(63&r)<<12|(63&c)<<6|63&d,h<65536||h>1114111?a+=o:(h-=65536,a+=n(55296+(h>>10),56320+(1023&h)),e+=3))):a+=o}return a}function or(e,t){let i=t.length,n=0;for(let e=0;e<i;e++){let s=t.charCodeAt(e);s>=55296&&s<=56319&&e+1<i&&(s=(s<<10)+t.charCodeAt(++e)-56613888),n+=s<128?1:s<2048?2:s<65536?3:4}ur(e,n);let s=ir(e,n),o=e.bytes;for(let e=0;e<i;e++){let n=t.charCodeAt(e);n>=55296&&n<=56319&&e+1<i&&(n=(n<<10)+t.charCodeAt(++e)-56613888),n<128?o[s++]=n:(n<2048?o[s++]=n>>6&31|192:(n<65536?o[s++]=n>>12&15|224:(o[s++]=n>>18&7|240,o[s++]=n>>12&63|128),o[s++]=n>>6&63|128),o[s++]=63&n|128)}}function ar(e,t){let i=ir(e,t.limit),n=e.bytes,s=t.bytes;for(let e=0,o=t.limit;e<o;e++)n[e+i]=s[e]}function rr(e){return e.bytes[nr(e,1)]}function cr(e,t){let i=ir(e,1);e.bytes[i]=t}function dr(e){let t=nr(e,8),i=e.bytes;return Xa[0]=i[t++],Xa[1]=i[t++],Xa[2]=i[t++],Xa[3]=i[t++],Xa[4]=i[t++],Xa[5]=i[t++],Xa[6]=i[t++],Xa[7]=i[t++],Ja[0]}function hr(e,t){let i=ir(e,8),n=e.bytes;Ja[0]=t,n[i++]=Xa[0],n[i++]=Xa[1],n[i++]=Xa[2],n[i++]=Xa[3],n[i++]=Xa[4],n[i++]=Xa[5],n[i++]=Xa[6],n[i++]=Xa[7]}function lr(e){let t,i=0,n=0;do{t=rr(e),i<32&&(n|=(127&t)<<i),i+=7}while(128&t);return n}function ur(e,t){for(t>>>=0;t>=128;)cr(e,127&t|128),t>>>=7;cr(e,t)}function pr(e,t){let i=t.low>>>0,n=(t.low>>>28|t.high<<4)>>>0,s=t.high>>>24,o=0===s?0===n?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:s<128?9:10,a=ir(e,o),r=e.bytes;switch(o){case 10:r[a+9]=s>>>7&1;case 9:r[a+8]=9!==o?128|s:127&s;case 8:r[a+7]=8!==o?n>>>21|128:n>>>21&127;case 7:r[a+6]=7!==o?n>>>14|128:n>>>14&127;case 6:r[a+5]=6!==o?n>>>7|128:n>>>7&127;case 5:r[a+4]=5!==o?128|n:127&n;case 4:r[a+3]=4!==o?i>>>21|128:i>>>21&127;case 3:r[a+2]=3!==o?i>>>14|128:i>>>14&127;case 2:r[a+1]=2!==o?i>>>7|128:i>>>7&127;case 1:r[a]=1!==o?128|i:127&i}}const _r=new Map([["moderation",1],["supervise",2]]);class Er extends C{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const t=this._connectionState;this._connectionState=e,this.emit(tn.CONNECTION_STATE_CHANGE,t,e)}get inspectType(){return this._inspectType}set inspectType(e){this._inspectMode=e.map((e=>_r.get(e)||0)).reduce(((e,t)=>e+t)),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this.qualityRatio}),6e4))}constructor(e){super(),this.name="AgoraRTCVideoContentInspect",this._connectionState=$i.CONNECTING,this._innerConnectionState=void 0,this.sequence=0,this.inspectStartTime=void 0,this.workerManagerConnection=void 0,this.workerConnection=void 0,this.workerMessageLengthLimit=void 0,this.inspectIntervalMinimum=void 0,this.qualityRatio=void 0,this._connectInfo=void 0,this._cancelTokenSource=ze.CancelToken.source(),this._retryConfig=void 0,this.wmSequence=0,this.inspectInterval=void 0,this.inspectTimer=null,this.ossFilePrefix=void 0,this.extraInfo=void 0,this._inspectType=void 0,this._inspectMode=void 0,this._quality=1,this.qualityTimer=null,this._inspectId=void 0,this._needWorkUrlOnly=!1,this.inspectImage=()=>{if(this.connectionState!==$i.CONNECTED)throw new Si(l.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval((()=>{this.connectionState===$i.CONNECTED?this.requestToInspectImage():t.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)}),this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()},this._inspectId=M(5,"inspect-"),this.workerMessageLengthLimit=f("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=f("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=f("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new yn("worker-manager-"+this._inspectId,Q),this.on(tn.STATE_CHANGE,((e,i)=>{this._innerConnectionState=e,t.debug("[".concat(this._inspectId,"] Inspect operation :").concat(en[e]," ").concat(i||""))})),this.handleWorkerManagerEvents(),this.workerConnection=new yn("worker-"+this._inspectId,Q),this.handleWorkerEvents()}async init(e,t){this.emit(tn.STATE_CHANGE,en.CONNECT_AP),this._connectInfo=e;const i=this._cancelTokenSource.token;return this._retryConfig=t,new Promise(((n,s)=>{this.on(tn.CONNECTION_STATE_CHANGE,((e,t)=>{t===$i.CONNECTED&&n()})),this.requestAP(e,i,t).then((e=>{this.connectWorkerManager(e)})).catch((e=>{s(e)}))}))}async requestAP(e,n,s){const o=f("WEBCS_DOMAIN").map((e=>"https://".concat(e,"/api/v1"))),a=await function(e,n,s,o){let{appId:a,areaCode:r,cname:c,sid:d,token:h,uid:u}=n;ms++;const p="image_moderation_api",_={service_name:p,json_body:JSON.stringify({appId:a,areaCode:r,cname:c,command:"allocateEdge",requestId:ms,seq:ms,sid:d,token:h,ts:Date.now(),uid:u+""})};let E,m,S=e[0];return z((async()=>{E=Date.now();const e=await zn(S,{data:_,cancelToken:s,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(m=Date.now()-E,0!==e.code){const i=new Si(l.UNEXPECTED_RESPONSE,"image inspect ap error, code"+e.code,{retry:!0,responseTime:m});throw t.error(i.toString()),i}const i=JSON.parse(e.json_body);if(200!==i.code){const e=new Si(l.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(i.code,", reason: ").concat(i.reason),{code:i.code,responseTime:m});throw t.error(e.toString()),e}if(!i.servers||!Array.isArray(i.servers)||0===i.servers.length){const e=new Si(l.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:i.code,responseTime:m});throw t.error(e.toString()),e}const n=f("VIDEO_INSPECT_WORKER_MANAGER_HOST"),o=f("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:i.servers.map((e=>{let{address:t,wss:i}=e;if(t&&i)return"wss://".concat(t.replace(/\./g,"-"),".").concat(n,":").concat(o||i)})).filter((e=>!!e)),workerToken:i.workerToken,vid:i.vid,responseTime:m}}),((t,n)=>(i.apworkerEvent(d,{success:!0,sc:200,serviceName:p,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===n,responseTime:m,serverIp:e[n%e.length]}),!1)),((t,n)=>(i.apworkerEvent(d,{success:!1,sc:t.data&&t.data.code||200,serviceName:p,responseTime:m,serverIp:e[n%e.length]}),!!(t.code!==l.OPERATION_ABORTED&&t.code!==l.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(S=e[(n+1)%e.length],!0))),o)}(o,e,n,s);this.emit(tn.STATE_CHANGE,en.AP_CONNECTED);const{addressList:r}=a;return this.wmSequence++,r}async connectWorkerManager(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._needWorkUrlOnly=t,this.emit(tn.STATE_CHANGE,en.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on(mi.CONNECTED,(async()=>{this.emit(tn.STATE_CHANGE,en.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.21.0",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)})),this.workerManagerConnection.on(mi.CLOSED,(()=>{this._innerConnectionState<en.GET_WORKER_MANAGER_RESPONSE&&t.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))})),this.workerManagerConnection.on(mi.FAILED,(()=>{this._innerConnectionState<en.GET_WORKER_MANAGER_RESPONSE&&t.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))})),this.workerManagerConnection.on(mi.RECONNECTING,(()=>{this._innerConnectionState<en.GET_WORKER_MANAGER_RESPONSE&&t.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))})),this.workerManagerConnection.on(mi.ON_MESSAGE,(async e=>{this.emit(tn.STATE_CHANGE,en.GET_WORKER_MANAGER_RESPONSE);const i=this.workerManagerConnection.url;this.workerManagerConnection.close();const n=JSON.parse(e.data);if(200!==n.code)throw t.error("[".concat(this._inspectId,"] Unexpected code ").concat(n.code," from worker manager")),new Si(l.UNEXPECTED_RESPONSE,"response code of worker is unexpected",n);if(!(n.serverResponse&&n.serverResponse.portWss&&i))throw t.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(n))),new Si(l.UNEXPECTED_RESPONSE,"response content of worker is unexpected",n);{const e=f("VIDEO_INSPECT_WORKER_PORT")||n.serverResponse.portWss,t=i.replace(/:\d+\/?$/,":".concat(e));this.emit(tn.STATE_CHANGE,en.CONNECT_WORKER,t),this._needWorkUrlOnly?this.emit(tn.REQUEST_NEW_WORKER_URL,t):await this.connectWorker(t)}})),this.workerManagerConnection.on(mi.WILL_RECONNECT,((e,t,i)=>{i(e)})),this.workerManagerConnection.on(mi.REQUEST_NEW_URLS,((e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)}))}handleWorkerEvents(){this.workerConnection.on(mi.CONNECTED,(async()=>{this.emit(tn.STATE_CHANGE,en.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=$i.CONNECTED})),this.workerConnection.on(mi.ON_MESSAGE,(async e=>{if(e.data instanceof ArrayBuffer){const i=ja(new Uint8Array(e.data));if(f("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&t.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(i)),200===i.code){if(Array.isArray(this.inspectType)&&1===this.inspectType.length&&"supervise"===this.inspectType[0])return void this.emit(tn.INSPECT_RESULT,void 0,void 0);if(i.data&&i.data.scorePorn&&i.data.scoreSexy&&i.data.scoreNeutral){const e={porn:i.data.scorePorn,sexy:i.data.scoreSexy,neutral:i.data.scoreNeutral},t=Object.keys(e).reduce(((t,i)=>e[t]>e[i]?t:i),"porn"),n=Object.keys(e).find((e=>e===t));this.emit(tn.INSPECT_RESULT,n)}else this.emit(tn.INSPECT_RESULT,void 0,new Si(l.UNEXPECTED_RESPONSE,i.code+"","There is an unexpected data on message"))}else this.emit(tn.INSPECT_RESULT,void 0,new Si(l.UNEXPECTED_RESPONSE,i.code+"",i.msg))}else t.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(tn.INSPECT_RESULT,void 0,new Si(l.UNEXPECTED_RESPONSE,"invalid worker message type"))})),this.workerConnection.on(mi.CLOSED,(()=>{this.connectionState=$i.CLOSED})),this.workerConnection.on(mi.FAILED,(()=>{this.connectionState=$i.CLOSED})),this.workerConnection.on(mi.RECONNECTING,(()=>{this.connectionState=this.connectionState===$i.CONNECTED?$i.RECONNECTING:$i.CONNECTING})),this.workerConnection.on(mi.WILL_RECONNECT,((e,t,i)=>{"recover"===e&&i(e),i("tryNext")})),this.workerConnection.on(mi.REQUEST_NEW_URLS,((e,t)=>{this.workerManagerConnection.close(),this.once(tn.REQUEST_NEW_WORKER_URL,(t=>{e([t])})),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then((e=>{this.connectWorkerManager(e,!0)})).catch((e=>{t(e)}))}))}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){this.sequence++;const e=D(this,tn.CLIENT_LOCAL_VIDEO_TRACK),t={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(tn.INSPECT_RESULT,void 0,new Si(l.INVALID_OPERATION,"Only the track being played can be inspected"));const i=await this.generateRequestData(e,t);this.workerConnection.sendMessage(i,!0,!0)}else this.emit(tn.INSPECT_RESULT,void 0,new Si(l.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(e,i){let{appId:n,cname:s,cid:o,vid:a,sid:r,uid:c}=i;const d=Date.now(),h=await e.getCurrentFrameImage("image/jpeg",this.quality),l=await At(h,n,s),u=this.sequence+"-"+o+"-"+c+"-"+d+"-"+M(12,""),p={appId:n,cid:o,cname:s,deviceId:"",elapse:Er.intToLong(Number(d-this.inspectStartTime)),fileSize:l.byteLength,jpgEncryption:2,height:h.height,width:h.width,jpg:l,networkType:6,osType:7,requestId:u,sdkVersion:"4.21.0",sequence:this.sequence,sid:r,timestamp:Er.intToLong(d),uid:c,vid:a,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};void 0===this.extraInfo&&delete p.callbackData,void 0===this.ossFilePrefix&&delete p.ossFilePrefix;const _=Ga(p);if(_.byteLength<this.workerMessageLengthLimit){if(f("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const e=Zt({},p);delete e.jpg,t.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(e))}return _}{const t=this.quality*this.qualityRatio;return this.quality=t,await this.generateRequestData(e,{appId:n,cname:s,cid:o,vid:a,sid:r,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=ze.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=$i.CLOSED,this.emit(tn.STATE_CHANGE,en.CLOSED)}}function mr(e){let t=function(){const e=fr.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(e,t){let i=e.appId;void 0!==i&&(Dr(t,10),yr(t,i));let n=e.cid;void 0!==n&&(Dr(t,16),Dr(t,n));let s=e.cname;void 0!==s&&(Dr(t,26),yr(t,s));let o=e.deviceId;void 0!==o&&(Dr(t,34),yr(t,o));let a=e.elapse;void 0!==a&&(Dr(t,40),Lr(t,a));let r=e.fileSize;void 0!==r&&(Dr(t,48),Lr(t,Cr(r)));let c=e.height;void 0!==c&&(Dr(t,56),Lr(t,Cr(c)));let d=e.jpg;void 0!==d&&(Dr(t,66),Dr(t,d.length),Ar(t,d));let h=e.networkType;void 0!==h&&(Dr(t,72),Lr(t,Cr(h)));let l=e.osType;void 0!==l&&(Dr(t,80),Lr(t,Cr(l)));let u=e.requestId;void 0!==u&&(Dr(t,90),yr(t,u));let p=e.sdkVersion;void 0!==p&&(Dr(t,98),yr(t,p));let _=e.sequence;void 0!==_&&(Dr(t,104),Lr(t,Cr(_)));let E=e.sid;void 0!==E&&(Dr(t,114),yr(t,E));let m=e.timestamp;void 0!==m&&(Dr(t,120),Lr(t,m));let S=e.uid;void 0!==S&&(Dr(t,128),Dr(t,S));let T=e.vid;void 0!==T&&(Dr(t,136),Dr(t,T));let C=e.width;void 0!==C&&(Dr(t,144),Lr(t,Cr(C)));let f=e.service;void 0!==f&&(Dr(t,152),Dr(t,f));let R=e.callbackData;void 0!==R&&(Dr(t,162),Dr(t,R.length),Ar(t,R));let g=e.ticket;void 0!==g&&(Dr(t,170),yr(t,g));let I=e.vendorConfigs;void 0!==I&&(Dr(t,178),yr(t,I))}(e,t),function(e){let t=e.bytes,i=e.limit;return t.length===i?t:t.subarray(0,i)}(t)}function Sr(e){return function(e){let t={};e:for(;!gr(e);){let i=Or(e);switch(i>>>3){case 0:break e;case 1:t.code=Or(e);break;case 2:t.msg=wr(e,Or(e));break;case 3:t.requestId=wr(e,Or(e));break;case 4:t.timestamp=Pr(e,!1);break;default:Tr(e,7&i)}}return t}({bytes:t=e,offset:0,limit:t.length});var t}function Tr(e,t){switch(t){case 0:for(;128&Nr(e););break;case 2:Rr(e,Or(e));break;case 5:Rr(e,4);break;case 1:Rr(e,8);break;default:throw new Error("Unimplemented type: "+t)}}function Cr(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let fr=[];function Rr(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function gr(e){return e.offset>=e.limit}function Ir(e,t){let i=e.bytes,n=e.offset,s=e.limit,o=n+t;if(o>i.length){let t=new Uint8Array(2*o);t.set(i),e.bytes=t}return e.offset=o,o>s&&(e.limit=o),n}function vr(e,t){let i=e.offset;if(i+t>e.limit)throw new Error("Read past limit");return e.offset+=t,i}function Ar(e,t){let i=Ir(e,t.length);e.bytes.set(t,i)}function wr(e,t){let i=vr(e,t),n=String.fromCharCode,s=e.bytes,o="�",a="";for(let e=0;e<t;e++){let r,c,d,h,l=s[e+i];0==(128&l)?a+=n(l):192==(224&l)?e+1>=t?a+=o:(r=s[e+i+1],128!=(192&r)?a+=o:(h=(31&l)<<6|63&r,h<128?a+=o:(a+=n(h),e++))):224==(240&l)?e+2>=t?a+=o:(r=s[e+i+1],c=s[e+i+2],32896!=(49344&(r|c<<8))?a+=o:(h=(15&l)<<12|(63&r)<<6|63&c,h<2048||h>=55296&&h<=57343?a+=o:(a+=n(h),e+=2))):240==(248&l)?e+3>=t?a+=o:(r=s[e+i+1],c=s[e+i+2],d=s[e+i+3],8421504!=(12632256&(r|c<<8|d<<16))?a+=o:(h=(7&l)<<18|(63&r)<<12|(63&c)<<6|63&d,h<65536||h>1114111?a+=o:(h-=65536,a+=n(55296+(h>>10),56320+(1023&h)),e+=3))):a+=o}return a}function yr(e,t){let i=t.length,n=0;for(let e=0;e<i;e++){let s=t.charCodeAt(e);s>=55296&&s<=56319&&e+1<i&&(s=(s<<10)+t.charCodeAt(++e)-56613888),n+=s<128?1:s<2048?2:s<65536?3:4}Dr(e,n);let s=Ir(e,n),o=e.bytes;for(let e=0;e<i;e++){let n=t.charCodeAt(e);n>=55296&&n<=56319&&e+1<i&&(n=(n<<10)+t.charCodeAt(++e)-56613888),n<128?o[s++]=n:(n<2048?o[s++]=n>>6&31|192:(n<65536?o[s++]=n>>12&15|224:(o[s++]=n>>18&7|240,o[s++]=n>>12&63|128),o[s++]=n>>6&63|128),o[s++]=63&n|128)}}function Nr(e){return e.bytes[vr(e,1)]}function br(e,t){let i=Ir(e,1);e.bytes[i]=t}function Or(e){let t,i=0,n=0;do{t=Nr(e),i<32&&(n|=(127&t)<<i),i+=7}while(128&t);return n}function Dr(e,t){for(t>>>=0;t>=128;)br(e,127&t|128),t>>>=7;br(e,t)}function Pr(e,t){let i,n=0,s=0,o=0;return i=Nr(e),n=127&i,128&i&&(i=Nr(e),n|=(127&i)<<7,128&i&&(i=Nr(e),n|=(127&i)<<14,128&i&&(i=Nr(e),n|=(127&i)<<21,128&i&&(i=Nr(e),s=127&i,128&i&&(i=Nr(e),s|=(127&i)<<7,128&i&&(i=Nr(e),s|=(127&i)<<14,128&i&&(i=Nr(e),s|=(127&i)<<21,128&i&&(i=Nr(e),o=127&i,128&i&&(i=Nr(e),o|=(127&i)<<7))))))))),{low:n|s<<28,high:s>>>4|o<<24,unsigned:t}}function Lr(e,t){let i=t.low>>>0,n=(t.low>>>28|t.high<<4)>>>0,s=t.high>>>24,o=0===s?0===n?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:s<128?9:10,a=Ir(e,o),r=e.bytes;switch(o){case 10:r[a+9]=s>>>7&1;case 9:r[a+8]=9!==o?128|s:127&s;case 8:r[a+7]=8!==o?n>>>21|128:n>>>21&127;case 7:r[a+6]=7!==o?n>>>14|128:n>>>14&127;case 6:r[a+5]=6!==o?n>>>7|128:n>>>7&127;case 5:r[a+4]=5!==o?128|n:127&n;case 4:r[a+3]=4!==o?i>>>21|128:i>>>21&127;case 3:r[a+2]=3!==o?i>>>14|128:i>>>14&127;case 2:r[a+1]=2!==o?i>>>7|128:i>>>7&127;case 1:r[a]=1!==o?128|i:127&i}}const kr={},Mr={},Ur=4294967296,xr=Ur*Ur,Vr=xr/2,Fr=Hr(0,!0),Br=Hr(0),Gr=Kr(0,-2147483648,!1),jr=Kr(-1,2147483647,!1),Wr=Kr(-1,-1,!0);function Hr(e,t){let i,n,s;return t?(s=0<=(e>>>=0)&&e<256)&&(n=Mr[e],n)?n:(i=Kr(e,0,!0),s&&(Mr[e]=i),i):(s=-128<=(e|=0)&&e<128)&&(n=kr[e],n)?n:(i=Kr(e,e<0?-1:0,!1),s&&(kr[e]=i),i)}function Kr(e,t,i){return{low:0|e,high:0|t,unsigned:!!i}}function qr(e,t){if(isNaN(e))return t?Fr:Br;if(t){if(e<0)return Fr;if(e>=xr)return Wr}else{if(e<=-Vr)return Gr;if(e+1>=Vr)return jr}return e<0?t?Fr:Br:Kr(e%Ur|0,e/Ur|0,t)}class Yr extends C{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const t=this._connectionState;this._connectionState=e,this.emit(rn.CONNECTION_STATE_CHANGE,e,t)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this._qualityRatio}),6e4))}constructor(e){var i;super(),this.name="AgoraRTCImageModeration",this._connectionState=an.CONNECTING,this._sequence=0,this._moderationStartTime=void 0,this._workerConnection=void 0,this._workerMessageLengthLimit=void 0,this._qualityRatio=void 0,this._connectInfo=void 0,this._cancelTokenSource=ze.CancelToken.source(),this._retryConfig=void 0,this._moderationInterval=void 0,this._moderationTimer=null,this._moderationMode=1,this._quality=1,this._qualityTimer=null,this._ticket=void 0,this._moderationIntervalMinimum=void 0,this._uploadFailedNum=0,this._uploadNum=0,this._uploadTimer=null,this._extraInfo=void 0,this._vendor="",this._encoder=new TextEncoder,this._moderationId=void 0,this.inspectImage=()=>{if(this.connectionState!==an.CONNECTED)throw new Si(l.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval((()=>{this.connectionState===an.CONNECTED?this.requestToInspectImage():t.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)}),this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()},this._moderationId=M(5,"image-moderation-"),this._workerMessageLengthLimit=f("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=f("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=null!==(i=e.interval)&&void 0!==i?i:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),this._qualityRatio=f("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new yn("worker-"+this._moderationId,Q),this.on(rn.STATE_CHANGE,((e,i)=>{t.debug("[".concat(this._moderationId,"] Moderation operation :").concat(cn[e]," ").concat(i||""))})),this.handleWorkerEvents()}async init(e,t){this.emit(rn.STATE_CHANGE,cn.CONNECT_AP),this._connectInfo=e;const i=this._cancelTokenSource.token;return this._retryConfig=t,new Promise(((n,s)=>{this.on(rn.CONNECTION_STATE_CHANGE,((e,t)=>{e===an.CONNECTED&&n()})),this.requestAP(e,i,t).then((e=>{this.connectWorker(e)})).catch((e=>{s(e)}))}))}updateConfig(e){var i;this._moderationInterval=null!==(i=e.interval)&&void 0!==i?i:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),t.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===an.CONNECTED&&this.inspectImage()}async requestAP(e,n,s){const o=f("WEBCS_DOMAIN").map((e=>"https://".concat(e,"/api/v1"))),a=await function(e,n,s,o){let{appId:a,areaCode:r,cname:c,sid:d,token:h,uid:u}=n;ms++;const p="moderation_plugin",_={service_name:p,json_body:JSON.stringify({appId:a,areaCode:r,cname:c,command:"allocateEdge",requestId:ms,seq:ms,sid:d,appToken:h,ts:Date.now(),uid:u+""})};let E,m,S=e[0];return z((async()=>{E=Date.now();const e=await zn(S,{data:_,cancelToken:s,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(m=Date.now()-E,0!==e.code){const i=new Si(l.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+e.code,{retry:!0,responseTime:m});throw t.error(i.toString()),i}const i=JSON.parse(e.json_body);if(200!==i.code){const e=new Si(l.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(i.code,", reason: ").concat(i.reason),{code:i.code,responseTime:m});throw t.error(e.toString()),e}if(!i.servers||!Array.isArray(i.servers)||0===i.servers.length){const e=new Si(l.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:i.code,responseTime:m});throw t.error(e.toString()),e}if(!i.servers.some((e=>!!e.wss))){const e=new Si(l.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:i.code,responseTime:m});throw t.error(e.toString()),e}const n=f("IMAGE_MODERATION_WORKER_HOST");return{addressList:i.servers.map((e=>{let{address:t,wss:i}=e;if(t&&i)return"wss://".concat(t.replace(/\./g,"-"),".").concat(n,":").concat(i,"/moderation")})).filter((e=>!!e)),workerToken:i.workerToken,vid:i.vid,ticket:i.appTicket,responseTime:m}}),((t,n)=>(i.apworkerEvent(d,{success:!0,sc:200,serviceName:p,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===n,responseTime:m,serverIp:e[n%e.length]}),!1)),((t,n)=>(i.apworkerEvent(d,{success:!1,sc:t.data&&t.data.code||200,serviceName:p,responseTime:m,serverIp:e[n%e.length]}),!!(t.code!==l.OPERATION_ABORTED&&t.code!==l.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(S=e[(n+1)%e.length],!0))),o)}(o,e,n,s);this.emit(rn.STATE_CHANGE,cn.AP_CONNECTED);const{addressList:r,ticket:c}=a;return this._ticket=c,r}async connectWorker(e){this.emit(rn.STATE_CHANGE,cn.CONNECT_WORKER),await this._workerConnection.init(e,1e4)}handleWorkerEvents(){this._workerConnection.on(mi.CONNECTED,(async()=>{this.emit(rn.STATE_CHANGE,cn.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=an.CONNECTED})),this._workerConnection.on(mi.CLOSED,(()=>{this.connectionState=an.CLOSED})),this._workerConnection.on(mi.FAILED,(()=>{this.connectionState=an.CLOSED})),this._workerConnection.on(mi.RECONNECTING,(()=>{this.connectionState=this.connectionState===an.CONNECTED?an.RECONNECTING:an.CONNECTING})),this._workerConnection.on(mi.ON_MESSAGE,(async e=>{if(e.data instanceof ArrayBuffer){const n=Sr(new Uint8Array(e.data));f("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&t.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(n)),this._uploadNum++,void 0===n.code||0===n.code||(this._uploadFailedNum++,t.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(n.code,", msg is ").concat(n.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout((()=>{i.reportApiInvoke(this._connectInfo.sid||null,{name:J.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,n.code],tag:X.TRACER}).onError(new Si(l.IMAGE_MODERATION_UPLOAD_FAILED,n.msg)),this._uploadTimer=null}),f("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else t.error("[".concat(this._moderationId,"] Unexpected message type from worker"))})),this._workerConnection.on(mi.WILL_RECONNECT,((e,t,i)=>{"recover"===e&&i(e),i("tryNext")})),this._workerConnection.on(mi.REQUEST_NEW_URLS,((e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)}))}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){const e=D(this,rn.CLIENT_LOCAL_VIDEO_TRACK),i={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(f("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&t.debug("Only the track being played can be inspected"));this._sequence++;const n=await this.generateRequestData(e,i);this._workerConnection.sendMessage(n,!0,!0)}else f("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&t.debug("Only the track being published can be inspected")}async generateRequestData(e,i){let{appId:n,cname:s,cid:o,vid:a,sid:r,uid:c}=i;const d=Date.now(),h=await e.getCurrentFrameImage("image/jpeg",this.quality),l=await At(h,n,s),u=this._sequence+"-"+o+"-"+c+"-"+d+"-"+M(12,""),p={appId:n,cid:o,cname:s,deviceId:"",elapse:Yr.intToLong(Number(d-this._moderationStartTime)),fileSize:h.buffer.byteLength,height:h.height,width:h.width,jpg:l,networkType:6,osType:7,requestId:u,sdkVersion:"4.21.0",sequence:this._sequence,sid:r,timestamp:qr(d),uid:c,vid:a,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};void 0===this._extraInfo&&delete p.callbackData;const _=mr(p);if(_.byteLength<this._workerMessageLengthLimit){if(f("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const e=Zt({},p);delete e.jpg,t.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(e))}return _}{const t=this.quality*this._qualityRatio;return this.quality=t,await this.generateRequestData(e,{appId:n,cname:s,cid:o,vid:a,sid:r,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=ze.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=an.CLOSED,this.emit(rn.STATE_CHANGE,cn.CLOSED)}}const Jr=Date.now(),Xr=20,zr=new Map,Qr=new Map;async function Zr(e){const t=zr.get(e),i=Array.isArray(t)&&t[t.length-1],n=Qr.get(e);if(!i)return void(n.isSyncing=!1);const s={uid:i.uid,payload:i.payload};0===n.firstRecvTs&&(n.firstRecvTs=i.recvTs,n.firstSendTs=i.sendTs);const o=i.sendTs-n.firstSendTs,a=o-(Date.now()-n.firstRecvTs);a>0&&(n.firstRecvTs=Date.now()-o);let r=i.mediaDelay+a;r<=0?(t.pop(),$r(i.context,s),r=0):r=Math.min(r,Xr),setTimeout((()=>t.length&&Zr(e)),r)}function $r(e,t){e.safeEmit(fe.STREAM_MESSAGE,t.uid,t.payload),e.onStreamMessage&&e.onStreamMessage(t)}function ec(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0;if(!e.syncWithAudio)return $r(i,{uid:e.uid,payload:e.payload});const n="".concat(i.id,"-").concat(e.uid),s=zr.get(n)||[],o=s.findIndex((t=>e.sendTs>=t.sendTs)),a=Zt(Zt({},e),{},{context:i,mediaDelay:t,recvTs:Date.now()});-1===o?s.push(a):s.splice(o,0,a),zr.set(n,s);let r=!1;var c;Qr.has(n)?r=!(null===(c=Qr.get(n))||void 0===c||!c.isSyncing):Qr.set(n,{isSyncing:r,firstRecvTs:0,firstSendTs:0});r||Zr(n)}const tc=Z().name;async function ic(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const s=i.reportApiInvoke(null,{tag:X.TRACER,name:J.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[n]});if(!(e instanceof $e||e instanceof dt)){const e=new Si(l.INVALID_TRACK,"the parameter is not a video track");return s.onError(e),e.throw()}n&&n<1e3&&(n=1e3);const o=e instanceof $e?e.getTrackLabel():"remote_track",a=e.getMediaStreamTrack(!0),r=document.createElement("video");r.style.width="1px",r.style.height="1px",r.setAttribute("muted",""),r.muted=!0,r.setAttribute("playsinline",""),r.controls=!1,(he()||Re())&&(r.style.opacity="0.01",r.style.position="fixed",r.style.left="0",r.style.top="0",document.body.appendChild(r)),r.srcObject=new MediaStream([a]),r.play();const c=document.createElement("canvas");c.width=160,c.height=120;let d=0,h=0;try{const e=Date.now();d=await function(e,i,n,s){let o,a=0,r=null;return new Promise(((c,d)=>{function h(){a>s&&o&&(o(),c(a));const i=n.getContext("2d");if(!i){const e=new Si(l.UNEXPECTED_ERROR,"can not get canvas 2d context.");return t.error(e.toString()),void d(e)}i.drawImage(e,0,0,160,120);const h=i.getImageData(0,0,n.width,n.height),u=Math.floor(h.data.length/3);if(r){for(let e=0;e<u;e+=3)if(h.data[e]!==r[e])return a+=1,void(r=h.data);r=h.data}else r=h.data}setTimeout((()=>{o&&(o(),c(a))}),i),o=it((()=>{h()}),30)}))}(r,n,c,4),h=Date.now()-e}catch(e){throw s.onError(e),e}tc===ee.SAFARI&&(r.pause(),r.remove()),r.srcObject=null;const u=d>4,p={duration:h,changedPicNum:d,deviceLabel:o,result:u};return t.info("[track-".concat(e.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(p))),s.onSuccess(p),u}async function nc(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const s=i.reportApiInvoke(null,{tag:X.TRACER,name:J.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[n]});if(!(e instanceof Ze||e instanceof ct)){const e=new Si(l.INVALID_TRACK,"the parameter is not a audio track");return s.onError(e),e.throw()}n&&n<1e3&&(n=1e3);const o=e instanceof Ze?e.getTrackLabel():"remote_track",a=e.getVolumeLevel();let r=a,c=a;const d=Date.now();return new Promise((i=>{const a=setInterval((()=>{const h=e.getVolumeLevel();r=h>r?h:r,c=h<c?h:c;const l=r-c>1e-4,u=Date.now()-d;if(l||u>n){clearInterval(a);const n=l,c={duration:u,deviceLabel:o,maxVolumeLevel:r,result:n};t.info("[track-".concat(e.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(c))),s.onSuccess(c),i(n)}}),200)}))}const sc="websdk_ng_cache_parameter",oc=f("MAX_PRELOAD_ASYNC_LENGTH"),ac=1e4,rc=new Map,cc=[];let dc=null,hc=0,lc=0;const uc=new Map,pc=function(e,t){const i=[];let n=0;const s=async()=>{const e=i.shift();e&&await e(),i.length>0&&n<t?s():n--};return async function(){for(var o=arguments.length,a=new Array(o),r=0;r<o;r++)a[r]=arguments[r];return new Promise((async(o,r)=>{i.push((async()=>{try{const t=await e(...a);o(t)}catch(e){r(e)}})),n<t&&(n++,s())}))}}(mc,oc),_c=ze.CancelToken.source();async function Ec(e,t,i,n){return mc(e,t,i,n)}async function mc(e,n,s,o,a){try{if(!f("ENABLE_PRELOAD"))return;if(!tt().supportWebCrypto)return void ge((()=>{t.warn("Your browser does not support preloading, this feature  be run in a secure environment")}),"preload_webcrypto_not_supported");if(!s&&null!==s)throw new h(l.INVALID_PARAMS,"Invalid token: ".concat(s,". If you don not use token, set it to null"));s&&S(s,"token",1,2047),S(e,"appid",1,2047),Ti(n),o&&Ci(o);const i=ce();t.debug("preload channel ".concat(n,", uid is ").concat(o));const r={appId:e,cname:n,token:s||e,uid:"string"!=typeof o?o:null,sid:i,proxyServer:a};let c,d;"string"==typeof o?(r.stringUid=o,[d,c]=await Promise.all([Is(o,{sid:i,appId:e},_c.token),As(Zt(Zt({},r),{},{token:s||e,uid:0}),_c.token)]),r.uid=d.uid,c.gatewayInfo.uid=r.uid,c.gatewayInfo.res.uid=r.uid):c=await As(r,_c.token);const u={sid:i,appId:e,cname:n,token:s||e,uid:r.stringUid||o,intUid:r.uid||c.gatewayInfo.uid,stringUid:r.stringUid,ts:Date.now(),sua:d,ap:c};await async function(e){let i;try{e.uid&&Tc({appId:e.appId,cname:e.cname,token:e.token,uid:e.uid,stringUid:e.stringUid});const t=vc(e),n=await async function(e,t){try{const i=await window.crypto.subtle.importKey("raw",ve(t),"AES-GCM",!1,["encrypt"]),n=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(1)},i,G(window.btoa(JSON.stringify(e))));return B(new Uint8Array(n))}catch(e){return}}(e,e.token||e.appId);if(!n)return;i=gc(sc);const s=i?JSON.parse(i):[];s.push({[t]:n}),s.length>f("AP_CACHE_NUM")&&s.shift(),Ic(sc,JSON.stringify(s))}catch(e){t.warn("Error caching server parameters:",e.message),Ic(sc,"")}}(u),hc++}catch(e){throw lc++,function(e){dc||(dc=window.setTimeout((()=>{let t="";uc.forEach(((e,i)=>{t+="".concat(i,": ").concat(e," ;")})),i.reportApiInvoke(null,{name:J.PRELOAD,options:{success:hc,failed:lc,err:t}}).onError(e),hc=0,lc=0,uc.clear(),dc=null}),ac));const t=uc.get(e.code)||0;uc.set(e.code,t+1)}(e),e}}async function Sc(e){try{const t=Tc(e);if(!t||"disabled"!==e.cloudProxyServer)return;const i=await async function(e,t){try{const i=await window.crypto.subtle.importKey("raw",ve(t),"AES-GCM",!1,["decrypt"]),n=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(1)},i,G(e));return JSON.parse(window.atob(B(new Uint8Array(n))))}catch(e){return}}(t,e.token||e.appId);if(!i)return;if(!function(e,t){const i=e.cname===t.cname&&e.appId===t.appId&&e.token===t.token;if(!i)return!1;return t.stringUid?e.stringUid===t.stringUid:"number"==typeof t.uid?e.uid===t.uid:e.uid==t.uid}(i,e))return;if(i&&Date.now()-i.ts<f("AP_CACHE_LIFETIME"))return i}catch(e){t.warn("Error get preloadInfo",e.message)}}function Tc(e){let i;try{if(i=gc(sc),!i)return;const t=JSON.parse(i),n=vc(e),s=function(e,t){for(let i=e.length-1;i>=0;i--)if(t(e[i]))return i;return-1}(t,(e=>n in e));if(-1===s)return;const o=t.splice(s,1)[0];return Ic(sc,JSON.stringify(t)),o[n]}catch(e){t.warn("Error delete preload info: ".concat(i),e.message),Ic(sc,"")}}function Cc(e){if(e){let t=rc.get(e);t&&(window.clearTimeout(t),t=null,rc.delete(e)),cc.includes(e)||"disabled"!==e.cloudProxyServer||cc.push(e)}if(rc.size<f("AP_CACHE_NUM")&&cc.length>0){const e=cc.shift();rc.set(e,window.setTimeout((async()=>{const{appId:i,cname:n,token:s,uid:o,proxyServer:a}=e;try{await pc(i,n,s,o,a),rc.has(e)&&Cc(e)}catch(i){t.warn("update preload failed",i.message),fc(e)}}),f("AP_UPDATE_INTERVAL")))}}function fc(e){const t=cc.indexOf(e);-1!==t&&cc.splice(t,1);let i=rc.get(e);i&&(window.clearTimeout(i),i=null,rc.delete(e),Cc())}function Rc(e,t){const n=e.sua,s=e.ap;t&&n&&i.reqUserAccount(e.sid,{lts:n.requestTime,elapse:n.elapse,success:!0,serverAddr:n.url,stringUid:t,uid:e.intUid,errorCode:null,extend:n.req}),i.reportResourceTiming(e.ap.url,e.sid),i.joinWebProxyAP(e.sid,{lts:s.requestTime,elapse:s.elapse,sucess:1,apServerAddr:s.url,turnServerAddrList:s.proxyInfo.addresses.map((e=>e.ip)).join(","),eventType:"disabled",unilbsServerIds:[bn.CHOOSE_SERVER,bn.CLOUD_PROXY_FALLBACK].toString()}),i.joinChooseServer(e.sid,{lts:s.requestTime,elapse:s.elapse,succ:!0,csAddr:s.url,opid:s.opid,serverList:s.gatewayInfo.gatewayAddrs.map((e=>e.address)),ec:null,cid:s.gatewayInfo.cid.toString(),uid:s.gatewayInfo.uid.toString(),csIp:s.gatewayInfo.csIp,unilbsServerIds:[bn.CHOOSE_SERVER].toString(),isHttp3:s.isHttp3})}function gc(e){return window.atob(window.localStorage.getItem(e)||"")}function Ic(e,t){window.localStorage.setItem(e,window.btoa(t))}function vc(e){let t="".concat(e.appId,"_").concat(e.cname);return"string"==typeof e.uid&&(t+="_s_".concat(e.uid)),"number"==typeof e.uid&&(t+="_".concat(e.uid)),e.token&&(t+="_".concat(e.token)),Ie(t)}var Ac,wc,yc,Nc,bc,Oc,Dc,Pc,Lc,kc,Mc,Uc,xc,Vc,Fc,Bc,Gc,jc,Wc,Hc,Kc,qc,Yc,Jc,Xc,zc,Qc,Zc,$c,ed,td,id,nd,sd,od,ad,rd,cd,dd,hd,ld,ud,pd;v.setLogger(t);let _d=(Ac=o(),wc=o({argsMap:(e,t)=>{if(!Array.isArray(t)){if(!(t instanceof wt))return[t];t=[t]}return t.map((e=>e?Object(e).toString():"null"))}}),yc=o({argsMap:(e,t)=>(t||(t=[]),t instanceof yt?[t.getChannelId()]:(Array.isArray(t)||(t=[t]),t.map((e=>e.getTrackId()))))}),Nc=o({argsMap:(e,t,i,n)=>["object"==typeof t?t.uid:t,i,n]}),bc=o({argsMap:(e,t,i)=>[t,i]}),Oc=o({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:i}=e;return[null==t?void 0:t.uid,i]}))}),Dc=o({argsMap:(e,t,i,n)=>["object"==typeof t?t.uid:t,i,n]}),Pc=o({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:i}=e;return{uid:null==t?void 0:t.uid,mediaType:i}}))}),Lc=o(),kc=o(),Mc=o(),Uc=o(),xc=o(),Vc=o(),Fc=o(),Bc=o(),Gc=o(),jc=o(),Wc=o(),Hc=o(),Kc=o(),qc=o(),Yc=o({argsMap:(e,t)=>[t]}),Jc=o(),Xc=o(),zc=o(),Qc=o(),Zc=o(),$c=o(),ed=o(),td=o(),id=o(),nd=o(),sd=o({argsMap:(e,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),od=o(),ad=o(),rd=o(),cd=o(),dd=o(),hd=o(),ld=o({reportResult:!0}),ud=o(),ii((pd=class extends C{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return(null===(e=this._config)||void 0===e?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e){let o;if(super(),this.store=void 0,this._uid=void 0,this._channelName=void 0,this._uintUid=void 0,this._users=[],this._config=void 0,this._clientId=void 0,this._appId=void 0,this._sessionId=null,this._key=void 0,this._rtmConfig={},this._joinInfo=void 0,this._gateway=void 0,this._statsCollector=void 0,this._configDistribute=void 0,this._leaveMutex=new v("client-leave"),this._publishMutex=new v("client-publish"),this._renewTokenMutex=new v("client-renewtoken"),this._subscribeMutex=new v("client-subscribe"),this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStream=!1,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._proxyServer=void 0,this._turnServer={servers:[],mode:"auto"},this._cloudProxyServerMode="disabled",this._isDualStreamEnabled=!1,this._defaultStreamFallbackType=void 0,this._lowStreamParameter=void 0,this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._axiosCancelSource=ze.CancelToken.source(),this._audioVolumeIndicationInterval=void 0,this._networkQualityInterval=void 0,this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0,this._injectStreamingClient=void 0,this._liveTranscodeStreamingClient=void 0,this._liveRawStreamingClient=void 0,this._channelMediaRelayClient=void 0,this._networkQualitySensitivity="normal",this._p2pChannel=void 0,this._useLocalAccessPoint=!1,this._setLocalAPVersion=void 0,this._joinAndNotLeaveYet=!1,this._numberOfJoinCount=0,this._remoteDefaultVideoStreamType=void 0,this._inspect=void 0,this._moderation=void 0,this._license=void 0,this._pendingPublishedUsers=[],this.ntpAlignErrorCount=0,this.remoteInboundOffset=0,this._handleLocalTrackEnable=(e,t,i)=>{this.publish(e,!1).then(t).catch(i)},this._handleLocalTrackDisable=(e,t,i)=>{this.unpublish(e).then(t).catch(i)},this._handleUserOnline=e=>{if(f("BLOCK_LOCAL_CLIENT")&&Ht(e.uid,this.channelName))return void t.debug("[".concat(e.uid,"] will be ignored in local"));this.isStringUID&&"string"!=typeof e.uid&&t.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const i=this._users.find((t=>t.uid===e.uid));if(i)i._trust_in_room_=!0,i._is_pre_created&&(i._is_pre_created=!1,this.safeEmit(fe.USER_JOINED,i));else{const i=new Vo(e.uid,e.uint_id||e.uid);this._users.push(i),t.debug("[".concat(this._clientId,"] user online"),e.uid),this.safeEmit(fe.USER_JOINED,i)}},this._handleUserOffline=e=>{if(f("BLOCK_LOCAL_CLIENT")&&Ht(e.uid,this.channelName))return;const i=this._users.find((t=>t.uid===e.uid));i&&(this._handleRemoveStream(e),this._handleRemoveDataChannels(e),i._audio_pre_subscribed||i._video_pre_subscribed?i._is_pre_created=!0:Ae(this._users,i),this._remoteStreamTypeCacheMap.delete(i.uid),this._streamFallbackTypeCacheMap.delete(i.uid),t.debug("[".concat(this._clientId,"] user offline"),e.uid,"reason:",e.reason),this.safeEmit(fe.USER_LEAVED,i,e.reason))},this._handleAddAudioOrVideoStream=(e,o,a,r,c,d,h)=>{if(f("BLOCK_LOCAL_CLIENT")&&Ht(o,this.channelName))return;const l=this._users.find((e=>e.uid===o));if(!l)return void t.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));t.debug("[".concat(this._clientId,"] stream added with uid ").concat(o,", type ").concat(e)),this.store.subscribe(l.uid,e,void 0,void 0,void 0,Date.now());const u="audio"===e?l.hasAudio:l.hasVideo;l._uintid||(l._uintid=c||o),"audio"===e?l._trust_audio_stream_added_state_=!0:l._trust_video_stream_added_state_=!0,"audio"===e?(l._audio_added_=!0,void 0!==a&&(l._audioSSRC=a),void 0!==r&&(l._cname=r),d&&(l._audioOrtc=d)):(l._video_added_=!0,void 0!==a&&(l._videoSSRC=a),void 0!==r&&(l._cname=r),void 0!==h&&(l._rtxSsrcId=h),d&&(l._videoOrtc=d)),("audio"===e?l.hasAudio:l.hasVideo)&&!u&&(t.info("[".concat(this._clientId,"] remote user ").concat(l.uid," published ").concat(e)),this.safeEmit(fe.USER_PUBLISHED,l,e)),"video"===e?i.onGatewayStream(this._sessionId,n.ON_ADD_VIDEO_STREAM,s.ON_ADD_VIDEO_STREAM,{peer:c||o,ssrc:l._videoSSRC}):i.onGatewayStream(this._sessionId,n.ON_ADD_AUDIO_STREAM,s.ON_ADD_AUDIO_STREAM,{peer:c||o,ssrc:l._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(l,e,a).then((i=>{if(i&&(t.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(l.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof Fa))return this._p2pChannel.unsubscribe(l,e,!0).then((()=>this._subscribe(l,e,!0).catch((e=>{t.error("[".concat(this._clientId,"] resubscribe error"),e.toString())}))))})),this._p2pChannel.hasPendingRemoteMedia(l,e)&&(t.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(l.uid," after reconnect.")),this._subscribe(l,e,!0).catch((e=>{t.error("[".concat(this._clientId,"] resubscribe error"),e.toString())})))},this._handleRemoveStream=e=>{if(f("BLOCK_LOCAL_CLIENT")&&Ht(e.uid,this.channelName))return;const o=this._users.find((t=>t.uid===e.uid));if(!o)return void t.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));t.debug("[".concat(this._clientId,"] stream removed with uid ").concat(e.uid));let a=()=>{};o.hasAudio&&o.hasVideo?a=()=>{t.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(fe.USER_UNPUBLISHED,o,"audio"),t.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(fe.USER_UNPUBLISHED,o,"video")}:o.hasVideo?a=()=>{t.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(fe.USER_UNPUBLISHED,o,"video")}:o.hasAudio&&(a=()=>{t.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(fe.USER_UNPUBLISHED,o,"audio")}),o._video_pre_subscribed||o._audio_pre_subscribed||(o._trust_audio_stream_added_state_=!0,o._trust_video_stream_added_state_=!0,o._audio_added_=!1,o._video_added_=!1,this._p2pChannel instanceof Fa&&this._p2pChannel.unsubscribe(o).then((e=>{if(e)return this._gateway.unsubscribe(e,o.uid)})),o._audioSSRC=void 0,o._videoSSRC=void 0,o._audioOrtc=void 0,o._videoOrtc=void 0,o._rtxSsrcId=void 0),i.onGatewayStream(this._sessionId,n.ON_REMOVE_STREAM,s.ON_REMOVE_STREAM,{peer:e.uint_id||e.uid}),a()},this._handleSetStreamLocalEnable=(e,i,n)=>{if(f("BLOCK_LOCAL_CLIENT")&&Ht(i,this.channelName))return;const s=this._users.find((e=>e.uid===i));if(!s)return void t.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));t.debug("[".concat(this._clientId,"] local ").concat(e," ").concat(n?"enabled":"disabled"," with uid ").concat(i));const o="audio"===e?s.hasAudio:s.hasVideo;if("audio"===e){s._trust_audio_enabled_state_=!0;const e=s._audio_enabled_;if(s._audio_enabled_=n,s._audio_enabled_===e)return;{const e=s._audio_enabled_?"enable-local-audio":"disable-local-audio";t.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(i,", msg: ").concat(e)),this.safeEmit(fe.USER_INFO_UPDATED,i,e)}}else{s._trust_video_enabled_state_=!0;const e=s._video_enabled_;if(s._video_enabled_=n,s._video_enabled_===e)return;{const e=s._video_enabled_?"enable-local-video":"disable-local-video";t.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(e)),this.safeEmit(fe.USER_INFO_UPDATED,i,e)}}const a="audio"===e?s.hasAudio:s.hasVideo;return o!==a?!o&&a?(t.info("[".concat(this._clientId,"] remote user ").concat(i," published ").concat(e)),void this.safeEmit(fe.USER_PUBLISHED,s,e)):("video"===e&&s._videoTrack&&s._videoTrack._destroy(),"audio"===e&&s._audioTrack,this._p2pChannel.muteRemote(s,e),t.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished ").concat(e)),void this.safeEmit(fe.USER_UNPUBLISHED,s,e)):void 0},this._handleMuteStream=(e,i,n)=>{if(f("BLOCK_LOCAL_CLIENT")&&Ht(e,this.channelName))return;t.debug("[".concat(this._clientId,"] receive mute message"),e,i,n);const s=this._users.find((t=>t.uid===e));if(!s)return void t.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(e));const o="audio"===i?s.hasAudio:s.hasVideo;if("audio"===i){s._trust_audio_mute_state_=!0;const i=s._audio_muted_;if(s._audio_muted_=n,s._audio_muted_===i)return;{const i=s._audio_muted_?"mute-audio":"unmute-audio";t.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(i)),this.safeEmit(fe.USER_INFO_UPDATED,e,i)}}else{s._trust_video_mute_state_=!0;const i=s._video_muted_;if(s._video_muted_=n,s._video_muted_===i)return;{const i=s._video_muted_?"mute-video":"unmute-video";t.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(i)),this.safeEmit(fe.USER_INFO_UPDATED,e,i)}}const a="audio"===i?s.hasAudio:s.hasVideo;if(o!==a){if(!o&&a){return("audio"===i?s._audioSSRC:s._videoSSRC)?(t.info("[".concat(this._clientId,"] remote user ").concat(e," published ").concat(i)),void this.safeEmit(fe.USER_PUBLISHED,s,i)):void t.warning("[".concat(this._clientId,"] remote user ").concat(e," receive ").concat(i," unmute message  before add stream message, ").concat(i," SSRC doesn't exist yet."))}"video"===i&&s._videoTrack&&!s._video_pre_subscribed&&s._videoTrack._destroy(),"audio"===i&&s._audioTrack,this._p2pChannel.muteRemote(s,i),t.info("[".concat(this._clientId,"] remote user ").concat(e," unpublished ").concat(i)),this.safeEmit(fe.USER_UNPUBLISHED,s,i)}},this._handleP2PLost=async e=>{t.debug("[".concat(this._clientId,"] receive p2p lost"),e),parseInt(e.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():t.warning("[".concat(this._clientId,"] P2PLost stream not found"),e)},this._handleTokenWillExpire=()=>{t.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(fe.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)},this._handleBeforeUnload=e=>{"beforeunload"===e.type&&void 0!==e.returnValue&&""!==e.returnValue||(this.leave(),t.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))},this._handleUpdateNetworkQuality=()=>{if("normal"===this._networkQualitySensitivity)return;if(navigator&&void 0!==navigator.onLine&&!navigator.onLine)return void this.safeEmit(fe.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const e={downlinkNetworkQuality:0,uplinkNetworkQuality:0};e.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),e.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(fe.NETWORK_QUALITY,e)},this._handleP2PAddAudioOrVideoStream=(e,i,n,s)=>{const o=this._users.find((e=>e.uid===i));if(!o)return void t.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));t.debug("[".concat(this._clientId,"] stream added with uid ").concat(i,", type ").concat(e)),this.store.subscribe(o.uid,e,void 0,void 0,void 0,Date.now());const a="audio"===e?o.hasAudio:o.hasVideo;"audio"===e?o._trust_audio_stream_added_state_=!0:o._trust_video_stream_added_state_=!0,"audio"===e?(o._audio_added_=!0,void 0!==n&&(o._audioSSRC=n),void 0!==s&&(o._audioMid=s)):(o._video_added_=!0,void 0!==n&&(o._videoSSRC=n),void 0!==s&&(o._videoMid=s)),("audio"===e?o.hasAudio:o.hasVideo)&&!a&&(t.info("[".concat(this._clientId,"] remote user ").concat(o.uid," published ").concat(e)),this.safeEmit(fe.USER_PUBLISHED,o,e)),this._p2pChannel.hasPendingRemoteMedia(o,e)&&(t.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(o.uid," after reconnect.")),this._subscribe(o,e,!0).catch((e=>{t.error("[".concat(this._clientId,"] resubscribe error"),e.toString())})))},this._config=e,this._clientId=M(5,"client-"),this.store=new we(e.codec,e.audioCodec,e.mode,this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),t.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(H," build: ").concat(ye,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),e.clientRoleOptions)try{Ne(e.clientRoleOptions),o=Object.assign({},e.clientRoleOptions)}catch(e){t.warning("[".concat(this._clientId,"] ").concat(e.toString()))}this._statsCollector=new na(this.store),this._statsCollector.onStatsException=(e,i,n)=>{t.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(e,", msg: ").concat(i,", uid: ").concat(n)),this.safeEmit(fe.EXCEPTION,{code:e,msg:i,uid:n})},this._statsCollector.onUploadPublishDuration=(e,t,n,s)=>{const o=this._users.find((t=>t.uid===e));o&&i.peerPublishStatus(this._sessionId,{subscribeElapse:s,audioPublishDuration:t,videoPublishDuration:n,peer:o._uintid})},this.store.useDataChannel=tt().supportDataChannel&&f("SIGNAL_CHANNEL"),this.store.useP2P="p2p"===e.mode,this._gateway=new Yn(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:e.websocketRetryConfig||Q,httpRetryConfig:e.httpRetryConfig||Q,forceWaitGatewayResponse:void 0===e.forceWaitGatewayResponse||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:o}),this._configDistribute=new Os,this.store.useP2P?(this._p2pChannel=new ta(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new Fa(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(e,t,i,n,s){let o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],a=arguments.length>6&&void 0!==arguments[6]&&arguments[6];K("JOIN_GATEWAY_USE_443PORT_ONLY",o),K("JOIN_GATEWAY_USE_DUAL_DOMAIN",a);const r=this._gateway.signal.websocket;return r instanceof wn&&(r.use443PortOnly=o,r.tryDoubleDomain=a),be("client.join",f("JOIN_MAX_CONCURRENCY"),this.join.bind(this),e,t,i,n,s)}async join(e,n,s,o,a){const r=++this._numberOfJoinCount;this.store.joinStart(),o&&(this.store.uid=o);const c=Oe(),d=De()?window.isSecureContext:"Browser Not Support";if(!De()&&!c||!window.isSecureContext){const e="The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser";t.warning(e)}"DISCONNECTED"===this.connectionState&&(this.store.avoidJoinStart=Math.round(Date.now()),t.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart))),i.setAppId(e);try{if(!s&&null!==s)throw new Si(l.INVALID_PARAMS,"Invalid token: ".concat(s,". If you don not use token, set it to null"));s&&S(s,"token",1,2047),S(e,"appid",1,2047),Ti(n),o&&Ci(o),a&&S(a,"optionalInfo",1,2047)}catch(t){throw i.reportApiInvoke(ce(),{name:J.JOIN,options:[e,n,s,o],states:{isHttps:c,isSecureContext:d},tag:X.TRACER}).onError(t),t}const h=await Sc({appId:e,cname:n,uid:o,stringUid:"string"==typeof o?o:void 0,token:s||e,cloudProxyServer:this._cloudProxyServerMode}),u=(null==h?void 0:h.sid)||ce(),p=i.reportApiInvoke(u,{name:J.JOIN,options:[e,n,s,o],states:{isHttps:c,isSecureContext:d},tag:X.TRACER});if(t.info("[".concat(this._clientId,"] start join channel ").concat(n,", join number: ").concat(r)),this._leaveMutex.isLocked){t.debug("[".concat(this._clientId,"] join: waiting leave operation"));(await this._leaveMutex.lock())(),t.debug("[".concat(this._clientId,"] join: continue"))}if(this._joinAndNotLeaveYet=!0,"DISCONNECTED"!==this.connectionState){const e=new Si(l.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw p.onError(e),e}this._sessionId||(this._sessionId=u,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";const _=Zt(Zt({},this._rtmConfig),{},{clientId:this._clientId,appId:e,sid:this._sessionId,cname:n,uid:"string"!=typeof o?o:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:s||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:a,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!h},void 0!==this._remoteDefaultVideoStreamType&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(_.setLocalAPVersion=this._setLocalAPVersion),"string"==typeof o&&(_.stringUid=o,this._uintUid?(_.uid=this._uintUid,this._uintUid=void 0):_.uid=0),"none"!==this._encryptionMode&&this._encryptionSecret){if(_.aesmode=this._encryptionMode,_.aespassword=await Pe(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new Si(l.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(_.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&("aes-128-gcm2"===this._encryptionMode||"aes-256-gcm2"===this._encryptionMode))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const e=new TextEncoder,t=f("USE_PURE_ENCRYPTION_MASTER_KEY")?e.encode(_.appId+this._encryptionSecret+this._encryptionSecret):e.encode(_.appId+_.cname+this._encryptionSecret);this._encryptDataStreamIv=await Le(this._encryptionMode,t,G(this._encryptionSalt)),this._encryptDataStreamKey=await ke(this._encryptionMode,t,G(this._encryptionSalt))}else d?t.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):t.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,t.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:n,appId:e,stringUid:_.stringUid,preload:_.preload});const E=this._sessionId;setTimeout((()=>{"CONNECTING"===this.connectionState&&E===this._sessionId&&i.joinChannelTimeout(this._sessionId,5)}),5e3);try{let o;const a=_.cloudProxyServer;if(["proxy3","proxy4","proxy5"].includes(a)){const e=f("PROXY_SERVER_TYPE3");Array.isArray(e)?_.proxyServer=e[0]:_.proxyServer=e}if(i.setProxyServer(_.proxyServer),t.setProxyServer(_.proxyServer),this.store.requestAPStart(),h){if(t.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(_.stringUid?", ".concat(_.stringUid," => ").concat(h.intUid):""," ")),_.stringUid&&!_.uid&&(_.uid=h.intUid),o={gatewayInfo:h.ap.gatewayInfo},f("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&"auto"===_.turnServer.mode)if(0===h.ap.proxyInfo.addresses.length)t.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{const e=(await Un(h.ap.proxyInfo,h.ap.gatewayInfo.uid)).map((e=>({turnServerURL:e.address,tcpport:e.tcpport||Gt.tcpport,udpport:e.udpport||Gt.udpport,username:e.username||Gt.username,password:e.password||Gt.password,forceturn:!1,security:!0})));_.turnServer={mode:"manual",servers:e}}Rc(h,_.stringUid)}else{if(_.stringUid&&!_.uid){let e;[e,o]=await Promise.all([gs(_.stringUid,_,this._axiosCancelSource.token,this._config.httpRetryConfig||Q,this.store),Rs(_,this._axiosCancelSource.token,this._config.httpRetryConfig||Q,!0,this.store)]),t.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(_.stringUid," => ").concat(e)),_.uid=e,o.gatewayInfo.uid=e,o.gatewayInfo.res.uid=e}else o=await Rs(_,this._axiosCancelSource.token,this._config.httpRetryConfig||Q,!0,this.store);if(!this._joinAndNotLeaveYet)throw new Si(l.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout((()=>{this._configDistribute.startGetConfigDistribute(_,this._axiosCancelSource.token),this._configDistribute.on(Hi.UPDATE_BITRATE_LIMIT,(e=>{this._p2pChannel.updateBitrateLimit(e)}))}),0),this._key=s||e;const r=o.gatewayInfo,c=_.uid?_.uid:r.uid;this._joinInfo=Zt(Zt({},_),{},{cid:r.cid,uid:c,vid:r.vid,apResponse:r.res,uni_lbs_ip:r.uni_lbs_ip,gatewayAddrs:r.gatewayAddrs}),this.store.intUid=c;const d=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new Si(l.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));p.onSuccess(d),this._appId=e,this._channelName=_.cname,this._uid=d,this.store.uid=d,setTimeout((()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(he()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()}),0);const u=_.stringUid?"string uid: ".concat(_.stringUid,",uid: ").concat(_.uid):"uid: ".concat(this._uid);return t.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(n,",").concat(u)),setTimeout((()=>{t.startUpload()}),5e3),this.store.joinEnd(),m=this,Wt.includes(m)||Wt.push(m),"disabled"===this._cloudProxyServerMode&&tt().supportWebCrypto&&f("ENABLE_PRELOAD")&&Cc(this._joinInfo),d}catch(e){const i=Array.isArray(e)?e[0]:e;throw i&&i.code===l.OPERATION_ABORTED?t.warning("[".concat(this._clientId,"] join number: ").concat(r,", Joining channel failed, rollback"),i):t.error("[".concat(this._clientId,"] join number: ").concat(r,", Joining channel failed, rollback"),i),i.code!==l.OPERATION_ABORTED&&this._numberOfJoinCount===r&&(this._gateway.state="DISCONNECTED",this._reset()),p.onError(i),i}var m}_joinGateway(){if(!this._joinInfo||!this._key)throw new Si(l.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!("disabled"!==this._joinInfo.cloudProxyServer||this._joinInfo.proxyServer||!f("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then((e=>e)).catch((e=>{if(e.code===l.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,L.FALLBACK),e;if(e.code===l.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,L.FALLBACK),e;throw e})).then((e=>{if(e instanceof Si){if(e.code===l.INIT_WEBSOCKET_TIMEOUT){if(t.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new Si(l.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";const e=f("PROXY_SERVER_TYPE3");if(Array.isArray(e))if(this._joinInfo.apUrl){const t=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),i=t.slice(t.length-2).join(".");e.forEach((e=>{this._joinInfo&&e.includes(i)&&(this._joinInfo.proxyServer=e)})),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=e[0])}else this._joinInfo.proxyServer=e[0];else this._joinInfo.proxyServer=e;const n=f("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);n&&n[1]&&"443"!==n[1]&&t.setProxyServer(this._joinInfo.proxyServer),"443"!==f("STATS_COLLECTOR_PORT").toString()&&i.setProxyServer(this._joinInfo.proxyServer);return i.reportApiInvoke(this._sessionId,{name:J.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:X.TRACER}).onSuccess(),this.safeEmit(fe.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),f("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach((e=>{"forceturn"in e&&(e.forceturn=!0)})),this._gateway.join(this._joinInfo,this._key)}if(t.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new Si(l.INVALID_OPERATION);return i.reportApiInvoke(this._sessionId,{name:J.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:X.TRACER}).onSuccess(),this._joinGateway()}return e})).then((e=>e))}async leave(){t.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(he()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(e){const t=Wt.indexOf(e);-1!==t&&Wt.splice(t,1)}(this),this._statsCollector.stopUpdateStats();const e=await this._leaveMutex.lock();if("DISCONNECTED"===this.connectionState)return t.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void e();await this._gateway.leave("CONNECTED"!==this.connectionState),t.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),e()}async publish(e){let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!Array.isArray(e)){if(!(e instanceof wt))return this._publishDataChannel(e);e=[e]}if(0===e.length)throw new Si(l.INVALID_PARAMS,"param list is empty");const n=e;if("audience"===this._gateway.role)throw new Si(l.INVALID_OPERATION,"audience can not publish stream");for(const e of n){if(!(e instanceof wt))throw new Si(l.INVALID_PARAMS,"parameter is not local track");if(!e._enabled&&i)throw new Si(l.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(e.getTrackId()))}t.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map((e=>"".concat(e.getTrackId()," ")))));const s=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),i&&n.forEach((e=>{const t=this._configDistribute.getBitrateLimit();e instanceof $e&&t&&e.setBitrateLimit(t.uplink)}));try{await this._publishHighStream(n),t.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map((e=>"".concat(e.getTrackId()," ")))))}catch(e){throw t.error("[".concat(this._clientId,"] publish error"),e.toString()),e}finally{s()}}async _publishDataChannel(e){_(e.id,"id",0,65535,!0),E(e.ordered,"ordered"),S(e.metadata,"metadata",0,512),t.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(e.id));const i=await this._publishMutex.lock();try{if(-1!==this._p2pChannel.getAllDataChannels().findIndex((t=>t.id===e.id)))throw new Si(l.INVALID_PARAMS,"Invalid id: ".concat(e.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||void 0===this._uid)throw new Si(l.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Si(l.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&f("FORCE_TURN")&&!f("TURN_ENABLE_TCP")&&!f("TURN_ENABLE_UDP"))throw new Si(l.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const n=new yt(e);if(await this._p2pChannel.publishDataChannel([n]),!this._p2pChannel.isP2PDisconnected()){if("number"!=typeof n._originDataChannelId)throw t.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new Si(l.CREATE_DATACHANNEL_ERROR);try{const t={streamId:e.id,ordered:e.ordered,maxRetransmits:f("DATASTREAM_MAX_RETRANSMITS"),metadata:e.metadata,channelId:n._originDataChannelId};await this._gateway.publishDataChannel(this._uid,t,!0),await n._waitTillOpen()}catch(e){if(e.code!==l.DISCONNECT_P2P)throw e}}return t.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(n.id)),n}catch(e){throw t.error("[".concat(this._clientId,"] publish datachannels error"),e.toString()),e}finally{i()}}async unpublish(e){if(!this._joinInfo||void 0===this._uid)throw new Si(l.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let i=[];if(e)if(Array.isArray(e))i=e;else{if(!(e instanceof wt))return this._unpublishDataChannel([e]);i=[e]}else this.store.useP2P||await this._unpublishDataChannel(),i=this._p2pChannel.getAllTracks(!0);t.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(i.map((e=>"".concat(e.getTrackId()," ")))," "));const n=await this._publishMutex.lock();try{if(this._p2pChannel instanceof ta){const e=await this._p2pChannel.unpublish(i);e&&await this._gateway.sendExtensionMessage(dn.UNPUBLISH,{unpubMsg:e},!0)}else{const e=await this._p2pChannel.unpublish(i);e&&await this._gateway.unpublish(e,this._uid),t.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(i.map((e=>"".concat(e.getTrackId())))))}}catch(e){throw t.error("[".concat(this._clientId,"] unpublish error"),e.toString()),e}finally{n&&n()}}async _unpublishDataChannel(e){void 0!==e&&0!==e.length||(e=this._p2pChannel.getAllDataChannels()),t.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(e.map((e=>"".concat(e.id," ")))," "));const i=await this._publishMutex.lock();try{const n=await this._p2pChannel.unpublishDataChannel(e);n&&await this._gateway.unpublishDataChannel(n),t.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(e.map((e=>"".concat(e.id)))))}catch(e){throw t.error("[".concat(this._clientId,"] unpublish dataChannel error"),e.toString()),e}finally{i&&i()}}async subscribe(e,t,i){if(!(e instanceof Vo)){const t=this.remoteUsers.find((t=>t.uid===e));if(!t)throw new Si(l.INVALID_REMOTE_USER,"user is not in the channel");e=t}return"datachannel"===t?this._subscribeDataChannel(e,i):this._subscribe(e,t)}async presubscribe(e,i){if(m(i,"mediaType",["audio","video"]),this._p2pChannel instanceof ta)throw new Si(l.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new Si(l.INVALID_OPERATION,"can't presub when not join");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Si(l.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const n=i===Yi.AUDIO,s=i===Yi.VIDEO,o=await this._subscribeMutex.lock();try{const{ssrcId:a,ortc:r,rtxSsrcId:c,cname:d,uint_id:h}=await this._gateway.presubscribe(e,i,!0);if(null==a)throw new Si(l.UNEXPECTED_RESPONSE,"no ssrc id");let u=this._users.find((t=>t.uid===e));u||(u=new Vo(e,h||e),u._is_pre_created=!0,this._users.push(u)),d&&(u._cname=d),u._uintid||(u._uintid=h||e),n&&(u._audioSSRC=a,u._audio_pre_subscribed=!0,r&&(u._audioOrtc=r)),s&&(u._videoSSRC=a,u._video_pre_subscribed=!0,r&&(u._videoOrtc=r),null!=c&&(u._rtxSsrcId=c)),t.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(a)),await this._p2pChannel.subscribe(u,i,a,c,r);const p=n?u._audioTrack:u._videoTrack;if(!p)throw new Si(l.UNEXPECTED_ERROR,"can not find remote track in user");return n&&(u._trust_audio_stream_added_state_=!0,u._audio_added_=!0),s&&(u._trust_video_stream_added_state_=!0,u._video_added_=!0),p}catch(i){throw t.error("[".concat(this._clientId,"] presub user ").concat(e," error"),i),i}finally{o()}}async _subscribeDataChannel(e,i){var n;if(_(i,"channelId",0,65535,!0),!this._joinInfo)throw new Si(l.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Si(l.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e)))throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),new Si(l.INVALID_REMOTE_USER,"user is not in the channel");if(!e.hasAudio&&!e.hasVideo&&0===e._dataChannels.length)throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),new Si(l.INVALID_REMOTE_USER,"user is not published");const s=null===(n=e._dataChannels)||void 0===n?void 0:n.find((e=>e.id===i));if(!s)throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, remote datachannel is not published")),new Si(l.REMOTE_USER_IS_NOT_PUBLISHED);const o=await this._subscribeMutex.lock();t.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: datachannel"));try{const i=await this._p2pChannel.subscribeDataChannel(e,[s]);if(i&&i.includes(s.id))try{var a;if("number"!=typeof s._originDataChannelId)throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, cannot get RTCDatachannel")),new Si(l.CREATE_DATACHANNEL_ERROR);const i={id:s.id,datachannelId:s._originDataChannelId,ordered:s.ordered,maxRetransmits:s.maxRetransmits,metadata:null!==(a=s.metadata)&&void 0!==a?a:""};await this._gateway.subscribeDataChannel(e.uid,i,!0),await s._waitTillOpen()}catch(t){if((null==t?void 0:t.code)!==l.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(e,[s]),t;await this._p2pChannel.unsubscribeDataChannel(e,[s]),this._p2pChannel.setPendingRemoteDataChannel(e,s.id)}return t.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: datachannel")),s}finally{o()}}async _p2pSubscribe(e,i,n){if(m(i,"mediaType",["audio","video"]),!this._joinInfo)throw new Si(l.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Si(l.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e))){const i=new Si(l.INVALID_REMOTE_USER,"user is not in the channel");throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),i}if(!e.hasAudio&&!e.hasVideo){const i=new Si(l.INVALID_REMOTE_USER,"user is not published");throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),i}if(!n&&("audio"===i&&!e.hasAudio||"video"===i&&!e.hasVideo)){const n=new Si(l.REMOTE_USER_IS_NOT_PUBLISHED);throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(i,", remote track is not published")),n}const s=await this._subscribeMutex.lock();t.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(i));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,i))await this._p2pChannel.unmuteRemote(e,i);else try{const t="audio"===i?e._audioSSRC:e._videoSSRC,n="audio"===i?e._audioMid:e._videoMid;this.store.subscribe(e.uid,i,Date.now()),this._p2pChannel instanceof ta&&await this._p2pChannel.subscribe(e,i,t,n)}catch(e){throw e}t.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(i)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((e=>{t.warning("[".concat(this._clientId,"] auto set fallback failed"),e)}));const n="audio"===i?e._audioTrack:e._videoTrack;if(!n)throw new Si(l.UNEXPECTED_ERROR,"can not find remote track in user object");return n}catch(i){throw t.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),i),i}finally{s()}}async _subscribe(e,i,n){if(this._p2pChannel instanceof ta)return this._p2pSubscribe(e,i);if(m(i,"mediaType",["audio","video"]),!this._joinInfo)throw new Si(l.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Si(l.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e))){const i=new Si(l.INVALID_REMOTE_USER,"user is not in the channel");throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),i}if(!e.hasAudio&&!e.hasVideo){const i=new Si(l.INVALID_REMOTE_USER,"user is not published");throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),i}if(!(n||("audio"!==i||e.hasAudio&&void 0!==e._audioSSRC)&&("video"!==i||e.hasVideo&&void 0!==e._videoSSRC))){const n=new Si(l.REMOTE_USER_IS_NOT_PUBLISHED);throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(i,", remote track is not published")),n}let s="audio"===i?e._audioSSRC:e._videoSSRC,o="audio"===i?e._audioOrtc:e._videoOrtc,a="video"===i?e._rtxSsrcId:void 0,r={stream_type:"audio"===i?Yi.AUDIO:Yi.VIDEO,ssrcId:s};const c=await this._subscribeMutex.lock();t.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(i));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,i))await this._p2pChannel.unmuteRemote(e,i);else try{const t="audio"===i?e._audioSSRC:e._videoSSRC;void 0!==t&&t!==s&&(s=t,o="audio"===i?e._audioOrtc:e._videoOrtc,a="video"===i?e._rtxSsrcId:void 0,r={stream_type:"audio"===i?Yi.AUDIO:Yi.VIDEO,ssrcId:s}),Ls.markSubscribeStart(this.store.clientId,s),this.store.subscribe(e.uid,i,Date.now()),await this._p2pChannel.subscribe(e,i,s,a,o);try{await this._gateway.subscribe(e.uid,r,!0)}catch(t){if((null==t?void 0:t.code)!==l.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,i),t;await this._p2pChannel.unsubscribe(e,i,!0),this._p2pChannel.setPendingRemoteMedia(e,i)}this.store.subscribe(e.uid,i,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,i)}catch(t){throw this._p2pChannel.reportSubscribeEvent(!1,null==t?void 0:t.code,e,i),t}t.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(i)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((e=>{t.warning("[".concat(this._clientId,"] auto set fallback failed"),e)}));const n="audio"===i?e._audioTrack:e._videoTrack;if(!n)throw new Si(l.UNEXPECTED_ERROR,"can not find remote track in user object");return n}catch(i){throw t.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),i),i}finally{c()}}async massSubscribe(e){if(T(e,"subscribeList"),!this._joinInfo)throw new Si(l.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Si(l.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const n=Date.now(),s=new Map,o=await this._subscribeMutex.lock();t.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i)})).join("; ")));const a=(e=[...e]).map((e=>{let{user:t,mediaType:i}=e;return{user:t,mediaType:i}})),r=await this._p2pChannel.globalLock();try{for(let i=e.length-1;i>=0;i--){const n=e[i],{user:o,mediaType:r}=n;if(m(r,"mediaType",["audio","video"]),!o){const e=new Si(l.INVALID_PARAMS,"user property does not exist in subscribeList item");throw t.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),e}if(!this._users.find((e=>e===o))){const n=new Si(l.INVALID_REMOTE_USER,"user is not in the channel");t.error("[".concat(this._clientId,"] can not massSubscribe ").concat(o.uid,", this user is not in the channel")),a[i].error=n,e.splice(i,1);continue}if("audio"===r&&(!o.hasAudio||void 0===o._audioSSRC)||"video"===r&&(!o.hasVideo||void 0===o._videoSSRC)){const n=new Si(l.REMOTE_USER_IS_NOT_PUBLISHED);t.error("[".concat(this._clientId,"] can not subscribe ").concat(o.uid," with mediaType ").concat(r,", remote user is not published")),a[i].error=n,e.splice(i,1);continue}const c=Vi.Video|Vi.LwoVideo,d=s.get(o);if(d){if("video"===r?d&c:d&Vi.Audio){e.splice(i,1),t.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(o.uid,", mediaType:").concat(r," twice"));continue}s.set(o,d|("video"===r?c:Vi.Audio))}else s.set(o,"video"===r?c:Vi.Audio)}for(let t=e.length-1;t>=0;t--){const i=e[t],{user:n,mediaType:o}=i,a=Vi.Video|Vi.LwoVideo;if(this._p2pChannel.hasRemoteMedia(n,o)){await this._p2pChannel.unmuteRemoteNoLock(n,o);const i=s.get(n);s.set(n,"video"===o?i^a:i^Vi.Audio),e.splice(t,1)}}this.store.massSubscribe(e.map((e=>({userId:e.user.uid,type:e.mediaType}))),n);const c=Array.from(s.entries()).reduce(((e,t)=>{let[i,n]=t;if(0===n)return e;const s={stream_id:i.uid,stream_type:n};return n&Vi.Audio&&(s.audio_ssrc=i._audioSSRC),n&Vi.Video&&(s.video_ssrc=i._videoSSRC),e.push(s),e}),[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map((e=>{let{user:t,mediaType:i}=e;return{user:t,mediaType:i,ssrcId:i===Yi.VIDEO?t._videoSSRC:t._audioSSRC,rtxSsrcId:i===Yi.VIDEO?t._rtxSsrcId:void 0}})));const s=new Map;if(c.length>0){const e=await this._gateway.subscribeAll(c,!0);((null==e?void 0:e.users)||[]).forEach((e=>{let{stream_id:t,video_error_code:i,audio_error_code:n,error_code:o}=e;(i||n||o)&&s.set(t,{video_error_code:i,audio_error_code:n,error_code:o})}))}if(Array.from(s.entries()).length>0){const e=[];Array.from(s.entries()).forEach((t=>{let[i,n]=t;const s=this.remoteUsers.find((e=>e.uid===i));if(s){let t;n.error_code||n.video_error_code&&n.audio_error_code?t=void 0:n.video_error_code?t=Yi.VIDEO:n.audio_error_code&&(t=Yi.AUDIO),e.push({user:s,mediaType:t})}})),e.length>0&&await this._p2pChannel.massUnsubscribeNoLock(e)}for(const e of a){const i=s.get(e.user.uid);if(i){const n=i.error_code||"audio"===e.mediaType&&i.audio_error_code||"video"===e.mediaType&&i.video_error_code;if(n){const i=mn(n);t.error("user:".concat(e.user.uid," mediaType:").concat(e.mediaType," has massSubscribe error ").concat(i.desc)),e.error=new Si(l.SUBSCRIBE_FAILED,"code ".concat(n,": ").concat(i.desc))}}e.error||("video"===e.mediaType?e.track=e.user.videoTrack:e.track=e.user.audioTrack)}return this.store.massSubscribe(a.filter((e=>!e.error)).map((e=>({userId:e.user.uid,type:e.mediaType}))),void 0,Date.now()),a.forEach((e=>{var t;i.subscribe(this.store.sessionId,{succ:!!e.error,ec:(null===(t=e.error)||void 0===t?void 0:t.code)||null,video:e.mediaType===Yi.VIDEO,audio:e.mediaType===Yi.AUDIO,peerid:e.user.uid,subscribeRequestid:e.mediaType===Yi.VIDEO?e.user._videoSSRC:e.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-n)},!0)})),t.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i)})).join("; "))),a}catch(t){throw await this._p2pChannel.massUnsubscribeNoLock(e),t}}finally{r(),o()}}async unsubscribe(e,i,n){if(!(e instanceof Vo)){const t=this.remoteUsers.find((t=>t.uid===e));if(!t)throw new Si(l.INVALID_REMOTE_USER,"user is not in the channel");e=t}if(i||this.store.useP2P){if("datachannel"===i)return this._unsubscribeDataChannel(e,n)}else await this._unsubscribeDataChannel(e,n);if(i&&m(i,"mediaType",["audio","video"]),!this._joinInfo)throw new Si(l.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find((t=>t===e))){const i=new Si(l.INVALID_REMOTE_USER,"user is not in the channel");throw t.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),i}t.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(i));const s=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof ta)await this._p2pChannel.unsubscribe(e,i);else{const n=await this._p2pChannel.unsubscribe(e,i);n&&await this._gateway.unsubscribe(n,e.uid),i&&"audio"!==i||(e._audio_pre_subscribed=!1),i&&"video"!==i||(e._video_pre_subscribed=!1),e._is_pre_created&&Ae(this._users,e),t.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(i))}}catch(i){if(i.code===l.DISCONNECT_P2P)return void t.warning("disconnecting p2p, abort unsubscribe request.");throw t.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),i.toString()),i}finally{s()}}async _unsubscribeDataChannel(e,i){if(i&&_(i,"id",0,65535,!0),!this._joinInfo)throw new Si(l.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find((t=>t===e))){const i=new Si(l.INVALID_REMOTE_USER,"user is not in the channel");throw t.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),i}let n;if("number"==typeof i){const t=e._dataChannels.find((e=>e.id===i));t&&(n=[t])}else n=e._dataChannels;if(void 0===n){const n=new Si(l.REMOTE_USER_IS_NOT_PUBLISHED);throw t.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid," with channelId ").concat(i,", remote datachannel is not published")),n}t.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(n.map((e=>e.id))));try{const i=await this._p2pChannel.unsubscribeDataChannel(e,n);i&&await this._gateway.unsubscribeDataChannel(i,e.uid),t.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(i))}catch(i){if(i.code===l.DISCONNECT_P2P)return void t.warning("disconnecting p2p, abort unsubscribe request.");throw t.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),i.toString()),i}}async massUnsubscribe(e){if(T(e,"unsubscribeList"),!this._joinInfo)throw new Si(l.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");t.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i,";")})).join())),e=[...e];const i=new Map;for(let n=e.length-1;n>=0;n--){const{user:s,mediaType:o}=e[n];if(!s){const e=new Si(l.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw t.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),e}m(o,"mediaType",["video","audio",void 0]);if(!this._users.find((e=>e===s))){t.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(s.uid,", user is not in the channel")),e.splice(n,1);continue}const a=Vi.Video|Vi.LwoVideo;if(i.has(s)){const r=i.get(s);let c;switch(o){case"video":c=r&a;break;case"audio":c=r&Vi.Audio;break;default:c=r&(Vi.Audio|a)}if(c){t.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(s.uid,",mediaType:").concat(o," twice.")),e.splice(n,1);continue}o?"audio"===o?i.set(s,r|Vi.Audio):"video"===o&&i.set(s,r|a):i.set(s,r|Vi.Audio|a)}else o?"audio"===o?i.set(s,Vi.Audio):"video"===o&&i.set(s,a):i.set(s,Vi.Audio|a)}try{const i=await this._p2pChannel.massUnsubscribe(e);i&&await this._gateway.massUnsubscribe(i),t.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i,";")})).join()))}catch(e){if(e.code===l.DISCONNECT_P2P)return void t.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw t.error("[".concat(this._clientId,"] massUnsubscribe error"),e.toString()),e}}async setLowStreamParameter(e){Nt(e),(!e.width&&e.height||e.width&&!e.height)&&t.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),t.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));const i=this._configDistribute.getLowStreamConfigDistribute();if(i&&i.bitrate&&e.bitrate&&i.bitrate<e.bitrate&&(e.bitrate=i.bitrate),this._lowStreamParameter=e,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(e,zi.LocalVideoLowTrack)}async enableDualStream(){if(!tt().supportDualStream)throw i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new Si(l.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new Si(l.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),t.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new Si(l.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(zi.LocalVideoLowTrack))try{const e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),t.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,i){if(Me(e),i&&Ne(i),"rtc"===this.mode||"p2p"===this.mode)throw t.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new Si(l.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(i&&i.level&&"host"===e)throw new Si(l.INVALID_OPERATION,"host mode can not set audience latency level");if("audience"===e&&this._p2pChannel.hasLocalMedia())throw new Si(l.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(e,i),this._config.role=e,t.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(i&&i.level))}getRemoteInboundOffset(){var e;const t=null===(e=this._p2pChannel.getStats())||void 0===e?void 0:e.audioSend[0];if(!t||!t.timestamp)return 0;const i=t.timestamp-Date.now();return Math.abs(i)>1e3+t.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?i:0}getNtpWallTimeInMs(){return"visible"===document.visibilityState&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(e,n){if(S(e,"proxyServer"),!n){if("DISCONNECTED"!==this.connectionState)throw new Si(l.INVALID_OPERATION,"Set proxy server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new Si(l.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,i.setProxyServer(this._proxyServer),t.setProxyServer(this._proxyServer),t.info("[".concat(this._clientId,"] Set proxy server ").concat(n?"by initialize call":""," success."))}setTurnServer(e,i){if(Array.isArray(e)||(e=[e]),!i){if("DISCONNECTED"!==this.connectionState)throw new Si(l.INVALID_OPERATION,"Set turn server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new Si(l.INVALID_OPERATION,"You have already set the proxy")}if(ne(e))return this._turnServer={servers:e,mode:"original-manual"},void t.info("[".concat(this._clientId,"] Set original turnserver ").concat(i?"by initialize call":""," success: ").concat(e.map((e=>e.urls)).join(","),"."));e.forEach((e=>Ue(e))),this._turnServer={servers:e,mode:"manual"},t.info("[".concat(this._clientId,"] Set turnserver ").concat(i?"by initialize call":""," success."))}setLicense(e){if("DISCONNECTED"!==this.connectionState){throw new Si(l.INVALID_OPERATION,"you should set license before join channel")}if(S(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new Si(l.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,t.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if("DISCONNECTED"!==this.connectionState)throw new Si(l.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||"manual"===this._turnServer.mode||this._useLocalAccessPoint)throw new Si(l.INVALID_OPERATION,"You have already set the proxy");const i=[3,4,5];let n;switch(void 0===e&&(e=3),e){case 1:case 2:throw new Si(l.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new Si(l.INVALID_PARAMS,"proxy server mode must be ".concat(i.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,t.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if("DISCONNECTED"!==this.connectionState)throw new Si(l.INVALID_OPERATION,"Stop proxy server after leave channel");i.setProxyServer(),t.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",t.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new Si(l.INVALID_PARAMS,"accessPoints is required.");T(e.accessPoints.serverList,"accessPoints.serverList"),S(e.accessPoints.domain,"accessPoints.domain");const i=(e,t)=>{_(e,t,0,65535,!0)};let n=443;if(e.accessPoints.port&&(i(e.accessPoints.port,"accessPoints.port"),n=e.accessPoints.port),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new Si(l.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");f("CLOSE_AFB_FOR_LOCAL_AP")&&(K("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),K("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const s=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,o=e.accessPoints.domain,a=e.accessPoints.serverList.map((e=>s.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(o):e)),r=a.map((e=>"".concat(e,":").concat(n)));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,K("WEBCS_DOMAIN",r),K("WEBCS_DOMAIN_BACKUP_LIST",r),K("GATEWAY_DOMAINS",[o]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(T(e.report.hostname,"report.hostname"),K("EVENT_REPORT_DOMAIN",e.report.hostname[0]),K("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(K("EVENT_REPORT_DOMAIN",a[0]),K("EVENT_REPORT_BACKUP_DOMAIN",a[1]||a[0]));let c=6443;e.report&&e.report.port&&(i(e.report.port,"report.port"),c=e.report.port),K("STATS_COLLECTOR_PORT",c),e.report?K("ENABLE_EVENT_REPORT",!0):K("ENABLE_EVENT_REPORT",!1);let d="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(T(e.log.hostname,"log.hostname"),d=e.log.hostname[0]):d=a[0];let h=6444;e.log&&e.log.port&&(i(e.log.port,"log.port"),h=e.log.port),K("LOG_UPLOAD_SERVER","".concat(d,":").concat(h));let u=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(T(e.cds.hostname,"cds.hostname"),u=e.cds.hostname):u=a;let p=443;e.cds&&e.cds.port&&(i(e.cds.port,"cds.port"),p=e.cds.port),K("CDS_AP",u.map((e=>"".concat(e,":").concat(p)))),e.cds?K("ENABLE_CONFIG_DISTRIBUTE",!0):K("ENABLE_CONFIG_DISTRIBUTE",!1),t.info("set local access point v2 success")}setLocalAccessPoints(e,i){if(T(e,"serverList"),S(i,"domain"),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new Si(l.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map((e=>n.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(i):e)),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,K("WEBCS_DOMAIN",e),K("WEBCS_DOMAIN_BACKUP_LIST",e),K("GATEWAY_DOMAINS",[i]),K("EVENT_REPORT_DOMAIN",e[0]),K("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),K("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),t.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(e){if(m(e,"streamType",[0,1]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw t.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else t.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(e))}async setRemoteVideoStreamType(e,i){m(i,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(e,i),setTimeout((()=>{const t=this._users.find((t=>t.uid===e));t&&t.videoTrack&&t.videoTrack.updateMediaStreamTrackResolution()}),2e3)}catch(e){throw t.error("[".concat(this._clientId,"] set remote video stream type error"),e.toString()),e}t.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(i)),this._remoteStreamTypeCacheMap.set(e,i)}async setStreamFallbackOption(e,i){m(i,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(e,i)}catch(e){throw t.error("[".concat(this._clientId,"] set stream fallback option"),e.toString()),e}t.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(i)),this._streamFallbackTypeCacheMap.set(e,i)}setEncryptionConfig(e,i,n,s){xe(e),S(i,"secret");const o=["aes-128-gcm2","aes-256-gcm2"];if(o.includes(e)){if(!n||!(n instanceof Uint8Array&&32===n.length))throw new Si(l.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new Si(l.INVALID_PARAMS,"current encrypt mode does not need salt");if(s){if(E(s,"encryptDataStream"),!o.includes(e))throw new Si(l.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'\"|{}\\[\\]])(?=.{8,})").test(i)||t.warning("The secret is not strong:\n      The secret must contain at least 1 lowercase alphabetical character,\n      The secret must contain at least 1 uppercase alphabetical character,\n      The secret must contain at least 1 numeric character,\n      The secret must contain at least one special character,\n      The secret must be eight characters or longer.\n      "),this._encryptionMode=e,this._encryptionSecret=i,n&&(this._encryptionSalt=B(n))}async renewToken(e){if(S(e,"token",1,2047),!this._key||!this._joinInfo)throw new Si(l.INVALID_OPERATION,"renewToken should not be called before user join");const i=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);const n=await this._renewTokenMutex.lock();try{if(f("USE_NEW_TOKEN")){t.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const i=await bs(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Q);t.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:i})}else t.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:e});t.debug("[".concat(this._clientId,"] renewToken success"))}catch(e){throw this._key=i,this._joinInfo.token=i,t.error("[".concat(this._clientId,"] renewToken failed"),e.toString()),e}finally{n()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?t.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval((()=>{const e=this._p2pChannel.getAudioLevels();this.safeEmit(fe.VOLUME_INDICATOR,e)}),f("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const e=this._statsCollector.getRTCStats(),t=this._gateway.getInChannelInfo();return e.Duration=Math.round(t.duration/1e3),e}async startLiveStreaming(e,t){if(!t){if("h264"!==this.codec)throw new Si(l.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new Si(l.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new Si(l.LIVE_STREAMING_TASK_CONFLICT);const i=t?fi.TRANSCODE:fi.RAW;return this._createLiveStreamingClient(i).startLiveStreamingTask(e,i)}setLiveTranscoding(e){return this._createLiveStreamingClient(fi.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){const t=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter((t=>t&&t.hasUrl(e)));if(!t.length)throw new Si(l.INVALID_PARAMS,"can not find live streaming url to stop");await Promise.all(t.map((t=>t&&t.stopLiveStreamingTask(e))))}async addInjectStreamUrl(e,t){if(!this._joinInfo)throw new Si(l.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");const i=this._createLiveStreamingClient(fi.INJECT);i.setInjectStreamConfig(t,0),await i.startLiveStreamingTask(e,fi.INJECT)}async removeInjectStreamUrl(){const e=this._createLiveStreamingClient(fi.INJECT),t=Array.from(e.streamingTasks.values()).find((e=>e.mode===fi.INJECT));if(!this._joinInfo||!t)throw new Si(l.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await e.stopLiveStreamingTask(t.url)}async startChannelMediaRelay(e){ra(e);const t=this._createChannelMediaRelayClient();await t.startChannelMediaRelay(e)}async updateChannelMediaRelay(e){ra(e);const t=this._createChannelMediaRelayClient();await t.updateChannelMediaRelay(e)}async stopChannelMediaRelay(){const e=this._createChannelMediaRelayClient();await e.stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}async sendStreamMessage(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this._joinInfo)throw new Si(l.INVALID_OPERATION,"can not send data stream, not joined");if(("string"==typeof e||e instanceof Uint8Array)&&(e={payload:e}),"string"==typeof e.payload){const t=new TextEncoder;e.payload=t.encode(e.payload)}let i=!1;this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&["aes-128-gcm2","aes-256-gcm2"].includes(this._encryptionMode)&&(i=!0,e.payload=await Ve(this._encryptDataStreamIv,this._encryptDataStreamKey,e.payload));if(new Blob([e.payload]).size>1024)throw new Si(l.INVALID_PARAMS,i?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(ui.DATA_STREAM,{payload:B(e.payload),syncWithAudio:e.syncWithAudio,sendTs:Date.now()-Jr},!t)}sendMetadata(e){if(!this._joinInfo)throw new Si(l.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new Si(l.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(ui.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:B(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(a),!this._joinInfo)throw new Si(l.INVALID_OPERATION,"can not send custom report, not joined");await i.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(e,i){m(i.spatialLayer,"spatialLayer",[0,1,2,3]),m(i.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,i)}catch(e){throw t.error("[".concat(this._clientId,"] pick SVC layer failed"),e.toString()),e}}async setRTMConfig(e){const{apRTM:i=!1,rtmFlag:n}=e;if(E(i,"apRTM"),_(n,"rtmFlag",0),this._rtmConfig.apRTM=i,this._rtmConfig.rtmFlag=n,t.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(e)," in ").concat(this.connectionState," state")),("CONNECTED"===this.connectionState||"RECONNECTING"===this.connectionState)&&this._joinInfo)return this._joinInfo.apRTM=i,this._joinInfo.rtmFlag=n,this._gateway.setRTM2Flag(n)}_reset(){if(t.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=ze.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&fc(this._joinInfo),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach((e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach((e=>e._close())),e._dataChannels.length=0)})),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),"fallback"===this._cloudProxyServerMode&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new v("client-publish"),this._subscribeMutex=new v("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch(e){}if(this._moderation)try{this.setImageModeration(!1)}catch(e){}}_startSession(e,n){var s;const o=e||ce();e?t.debug("[".concat(this._clientId,"] new Session ").concat(o)):t.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(o));const a=e?"":this._sessionId||"";this._sessionId=o,this.store.sessionId=o;const r={lts:(new Date).getTime(),mode:this.mode,buildFormat:3,stringUid:(null==n?void 0:n.stringUid)||(null===(s=this._joinInfo)||void 0===s?void 0:s.stringUid),channelProfile:"live"===this.mode?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:a,clientRole:"audience"===this.role?2:1};n?i.sessionInit(this._sessionId,Zt({cname:n.channel,appid:n.appId,preload:n.preload},r)):this._joinInfo?i.sessionInit(this._sessionId,Zt({cname:this._joinInfo.cname,appid:this._joinInfo.appId,preload:!!this._joinInfo.recoverPreloadCache},r)):this._gateway.joinInfo&&i.sessionInit(this._sessionId,Zt({cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId},r)),this._joinInfo&&(this._joinInfo.sid=o),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=o)}async _publishHighStream(e){if(!this._joinInfo||void 0===this._uid)throw new Si(l.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Si(l.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&f("FORCE_TURN")&&!f("TURN_ENABLE_TCP")&&!f("TURN_ENABLE_UDP"))throw new Si(l.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");t.debug("[".concat(this._clientId,"] publish high stream"));try{const t=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter);if(this._p2pChannel instanceof ta){const e=(await t.next()).value;if(e){try{await this._gateway.sendExtensionMessage(dn.PUBLISH,e,!0)}catch(e){throw t.throw(e),e}await t.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const n=(await t.next()).value;if(n){var i;let e;try{e=await this._gateway.publish(this._uid,n,!0)}catch(e){if(e.code!==l.DISCONNECT_P2P)throw t.throw(e),e}await t.next((null===(i=e)||void 0===i?void 0:i.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const t of e)t instanceof $e&&t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig),!t.muted&&t.enabled||await this._p2pChannel.muteLocalTrack(t)}}catch(t){if(this._p2pChannel.reportPublishEvent(!1,null==t?void 0:t.code,e),(null==t?void 0:t.code)===l.WS_ABORT)return;throw t}}async _publishLowStream(){if(!this._joinInfo||void 0===this._uid)throw new Si(l.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new Si(l.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));t.debug("[".concat(this._clientId,"] publish low stream"));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{const e=await this._p2pChannel.publishLowStream(this._lowStreamParameter),t=(await e.next()).value;if(t){var i;let n;try{n=await this._gateway.publish(this._uid,t,!0)}catch(t){if(t.code!==l.DISCONNECT_P2P)throw e.throw(t),t}e.next((null===(i=n)||void 0===i?void 0:i.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(e){if(this._p2pChannel.reportPublishEvent(!1,null==e?void 0:e.code,void 0,!0),(null==e?void 0:e.code)===l.WS_ABORT)return;throw e}}_createLiveStreamingClient(e){if(!this._joinInfo||!this._appId){return new Si(l.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw()}const t=()=>new oa(this._joinInfo,this._config.websocketRetryConfig||Q,this._config.httpRetryConfig||Q),n=e=>{e.onLiveStreamError=(e,t)=>{i.reportApiInvoke(this._sessionId,{name:J.ON_LIVE_STREAM_ERROR,options:[e,t],tag:X.TRACER}).onSuccess(),this.safeEmit(fe.LIVE_STREAMING_ERROR,e,t)},e.onLiveStreamWarning=(e,t)=>{i.reportApiInvoke(this._sessionId,{name:J.ON_LIVE_STREAM_WARNING,options:[e,t],tag:X.TRACER}).onSuccess(),this.safeEmit(fe.LIVE_STREAMING_WARNING,e,t)},e.on(Ni.REQUEST_WORKER_MANAGER_LIST,((e,t,i)=>{if(!this._joinInfo)return i(new Si(l.INVALID_OPERATION,"can not find join info to get worker manager"));ys(e,this._joinInfo,this._axiosCancelSource.token,Q).then(t).catch(i)}))};switch(e){case fi.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=t(),n(this._liveRawStreamingClient)),this._liveRawStreamingClient;case fi.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=t(),n(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case fi.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=t(),this._injectStreamingClient.on(Ni.REQUEST_WORKER_MANAGER_LIST,((e,t,i)=>{if(!this._joinInfo)return i(new Si(l.INVALID_OPERATION,"can not find join info to get worker manager"));ys(e,this._joinInfo,this._axiosCancelSource.token,Q).then(t).catch(i)})),this._injectStreamingClient.onInjectStatusChange=(e,t,i)=>{this.safeEmit(fe.INJECT_STREAM_STATUS,e,t,i)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo){return new Si(l.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw()}if(!this._channelMediaRelayClient){const{sendResolutionWidth:e,sendResolutionHeight:t}=this.getLocalVideoStats(),i={width:e,height:t};this._channelMediaRelayClient=new da(this._joinInfo,this._clientId,this._config.websocketRetryConfig||Q,this._config.httpRetryConfig||Q,i),this._channelMediaRelayClient.on("state",(e=>{e===Li.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(fe.CHANNEL_MEDIA_RELAY_STATE,e)})),this._channelMediaRelayClient.on("event",(e=>{this.safeEmit(fe.CHANNEL_MEDIA_RELAY_EVENT,e)})),this._statsCollector.onStatsChanged=(e,t)=>{var i;"resolution"===e&&(null===(i=this._channelMediaRelayClient)||void 0===i||i.setVideoProfile(t))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(e,i){const{added:n,deleted:s}=e;Array.isArray(n)&&n.length>0&&n.forEach((e=>{const{uid:n,stream_id:s,ordered:o,max_retrans_times:a,metadata:r}=e,c=this._users.find((e=>e._uintid===n));if(!c)return void t.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));t.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(n)),c._uintid||(c._uintid=n);if(!(-1!==c._dataChannels.findIndex((t=>t.id===e.stream_id)))){const e={id:s,ordered:!!o,maxRetransmits:a,metadata:r},n=new bt(e);c._dataChannels.push(n),t.info("[".concat(this._clientId,"] remote user ").concat(c.uid," published datachannel")),i||this.safeEmit(fe.USER_PUBLISHED,c,"datachannel",e)}this._p2pChannel.hasPendingRemoteDataChannel(c,e.stream_id)&&(t.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(c.uid," after reconnect.")),this._subscribeDataChannel(c,e.stream_id).catch((e=>{t.error("[".concat(this._clientId,"] resubscribe datachannel error"),e.toString())})))})),i&&(this.safeEmit(fe.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(s)&&s.length>0&&s.forEach((e=>{const{uid:i,stream_id:n}=e,s=this._users.find((e=>e._uintid===i));if(!s)return void t.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const o=s._dataChannels.find((t=>t.id===e.stream_id));o&&(t.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(i)),this._p2pChannel.unsubscribeDataChannel(s,[o]).then((e=>{if(s._dataChannels=s._dataChannels.filter((e=>e!==o)),e)return this._gateway.unsubscribeDataChannel(e,s.uid)})),t.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished datachannel ,id:").concat(o.id)),this.safeEmit(fe.USER_UNPUBLISHED,s,"datachannel",o._config))}))}_handleRemoveDataChannels(e){const i=this._users.find((t=>t.uid===e.uid));if(i){if(void 0!==i._dataChannels&&i._dataChannels.length>0){t.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(e.uid));const n=()=>{t.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished datachannel")),i._dataChannels.forEach((e=>{this.safeEmit(fe.USER_UNPUBLISHED,i,"datachannel",e._config)}))};this._p2pChannel.unsubscribeDataChannel(i,i._dataChannels).then((e=>{if(e)return this._gateway.unsubscribeDataChannel(e,i.uid)})),n()}}else t.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(Ui.DISCONNECT_P2P,(async()=>{await this._p2pChannel.disconnectForReconnect()})),this._gateway.on(Ui.CONNECTION_STATE_CHANGE,((e,n,s)=>{var o;if(s===L.FALLBACK)return;const a=()=>{this.safeEmit(fe.CONNECTION_STATE_CHANGE,e,n,s)};if(i.reportApiInvoke(this._sessionId||(null===(o=this._gateway.joinInfo)||void 0===o?void 0:o.sid)||null,{name:J.CONNECTION_STATE_CHANGE,options:[e,n,s],tag:X.TRACER}).onSuccess(JSON.stringify({cur:e,prev:n,reason:s})),t.info("[".concat(this._clientId,"] connection state change: ").concat(n," -> ").concat(e)),"DISCONNECTED"===e)return this._reset(),void a();if("RECONNECTING"===e)this._users.forEach((e=>{e._trust_in_room_=!1,e._trust_audio_enabled_state_=!1,e._trust_video_enabled_state_=!1,e._trust_audio_mute_state_=!1,e._trust_video_mute_state_=!1,e._trust_audio_stream_added_state_=!1,e._trust_video_stream_added_state_=!1,e._is_pre_created||(e._audio_pre_subscribed||(e._audioSSRC=void 0,e._audioOrtc=void 0),e._video_pre_subscribed||(e._videoSSRC=void 0,e._videoOrtc=void 0,e._rtxSsrcId=void 0),e._cname=void 0)})),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if("CONNECTED"===e){var r;this._streamFallbackTypeCacheMap.forEach(((e,i)=>{this._gateway.setStreamFallbackOption(i,e).catch((e=>{t.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),e)}))})),this._remoteStreamTypeCacheMap.forEach(((e,i)=>{this._gateway.setRemoteVideoStreamType(i,e).catch((e=>{t.warning("[".concat(this._clientId,"] auto set remote stream type failed"),e)}))})),void 0!==this._remoteDefaultVideoStreamType&&void 0===(null===(r=this._joinInfo)||void 0===r?void 0:r.defaultVideoStream)&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then((()=>{t.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))})).catch((e=>{t.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(e))})),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout((()=>{if("CONNECTED"!==this.connectionState)return;this._userOfflineTimeout=void 0;this._users.filter((e=>!e._trust_in_room_)).forEach((e=>{t.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(e.uid)),this._handleUserOffline({uid:e.uid})}))}),3e3),this._streamRemovedTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._streamRemovedTimeout=void 0,this._users.forEach((e=>{e._trust_audio_mute_state_||(t.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(e.uid)),this._handleMuteStream(e.uid,Yi.AUDIO,!1)),e._trust_video_mute_state_||(t.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(e.uid)),this._handleMuteStream(e.uid,Yi.VIDEO,!1)),e._trust_audio_enabled_state_||(t.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(e.uid)),this._handleSetStreamLocalEnable("audio",e.uid,!0)),e._trust_video_enabled_state_||(t.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(e.uid)),this._handleSetStreamLocalEnable("video",e.uid,!0)),e._trust_video_stream_added_state_||(t.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(e.uid)),this._handleResetAddStream(e,"video")),e._trust_audio_stream_added_state_||(t.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(e.uid)),this._handleResetAddStream(e,"audio")),e._video_added_||e._audio_added_||(t.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(e.uid)),this._handleRemoveStream({uid:e.uid,uint_id:e._uintid}))})))}),1e3))}a()})),this._gateway.on(Ui.REQUEST_NEW_GATEWAY_LIST,(async(e,t)=>{if(!this._joinInfo)return t(new Si(l.UNEXPECTED_ERROR,"can not recover, no join info"));try{let t;this._joinInfo.recoverPreloadCache?(t=this._joinInfo.recoverPreloadCache.ap,Rc(this._joinInfo.recoverPreloadCache),this._joinInfo.recoverPreloadCache=void 0):t=await fs(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Q,this.store),this._joinInfo&&(this._joinInfo.apResponse=t.gatewayInfo.res,this._joinInfo.gatewayAddrs=t.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=t.gatewayInfo.uni_lbs_ip);const i=[];t.gatewayInfo.gatewayAddrs.forEach((e=>{let{address:t}=e;const[n,s]=t.split(":");this._joinInfo&&this._joinInfo.proxyServer?i.push({proxy:this._joinInfo.proxyServer,host:n,port:s}):i.push({host:n,port:s})})),e(i)}catch(e){t(e)}})),this._gateway.on(Ui.NETWORK_QUALITY,(e=>{"normal"===this._networkQualitySensitivity&&this.safeEmit(fe.NETWORK_QUALITY,e)})),this._gateway.on(Ui.STREAM_TYPE_CHANGE,((e,t)=>{this.safeEmit(fe.STREAM_TYPE_CHANGED,e,t);i.reportApiInvoke(this._sessionId,{name:J.STREAM_TYPE_CHANGE,options:[e,t],tag:X.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:t}))})),this._gateway.on(Ui.IS_P2P_DISCONNECTED,(e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)})),this._gateway.on(Ui.NEED_RENEW_SESSION,(async e=>{if("recover"===e&&this._joinInfo){const e=await Sc(Zt(Zt({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));this._joinInfo.recoverPreloadCache=e,this._startSession(null==e?void 0:e.sid)}else this._startSession()})),this._gateway.on(Ui.REQUEST_P2P_CONNECTION_PARAMS,(async(e,t,i)=>{try{t(await this._p2pChannel.startP2PConnection(e))}catch(e){i(e)}})),this._gateway.on(Ui.JOIN_RESPONSE,((e,t)=>{if(this.store.useP2P)return;const{dtlsParameters:i,iceParameters:n,candidates:s,rtpCapabilities:o,setup:a,cname:r}=$s(e.ortc,t);this._p2pChannel.connect(n,i,s,o,a,r)})),this._gateway.on(Ui.REQUEST_DC_CONNECTION_PARAMS,(e=>{e(this._p2pChannel.getEstablishParams())})),this._gateway.on(Ui.RESET_SIGNAL,(e=>{this._p2pChannel.resetConnection(e),this._handleGatewaySignalEvents()})),this._gateway.on(Ui.DATACHANNEL_FAILBACK,(()=>{this._joinGateway()})),this._gateway.on(Ui.DATACHANNEL_PRECONNECT,(async(e,i,n,s)=>{var o,a,r,c,d,h;await this._p2pChannel.startP2PConnection({turnServer:null===(o=this._joinInfo)||void 0===o?void 0:o.turnServer},!0);const l=function(e,i){let n;return i&&i.ip&&"number"==typeof i.port?(n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:i.ip,port:i.port.toString(),type:"host",extension:{}}],t.debug("Using remote candidate from AP ".concat(i.ip,":").concat(i.port)),i.ip6&&(n.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:i.ip6,port:i.port.toString(),type:"host",extension:{}}),t.debug("Using IPV6 remote candidate from AP ".concat(i.ip6,":").concat(i.port)))):n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],n}(e,i);return this._p2pChannel.preConnect({iceUfrag:"".concat(null===(a=this._joinInfo)||void 0===a?void 0:a.apResponse.cid,"_").concat(null===(r=this._joinInfo)||void 0===r?void 0:r.apResponse.cert),icePwd:"".concat(null===(c=this._joinInfo)||void 0===c?void 0:c.apResponse.cid,"_").concat(null===(d=this._joinInfo)||void 0===d?void 0:d.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:null!==(h=f("FINGERPRINT"))&&void 0!==h?h:e.fingerprint}]},l,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(n).catch(s)}))}_handleGatewaySignalEvents(){this._gateway.signal.on(_i.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(_i.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(_i.ON_ADD_AUDIO_STREAM,(e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc))),this._gateway.signal.on(_i.ON_ADD_VIDEO_STREAM,(e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc,e.rtxSsrcId))),this._gateway.signal.on(_i.ON_REMOTE_DATASTREAM_UPDATE,(e=>{this._handleUpdateDataChannel(e)})),this._gateway.signal.on(_i.ON_REMOTE_FULL_DATASTREAM_INFO,(e=>{this._handleUpdateDataChannel({added:e.datastreams,deleted:[]},!0)})),this._gateway.signal.on(_i.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(_i.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(_i.MUTE_AUDIO,(e=>this._handleMuteStream(e.uid,Yi.AUDIO,!0))),this._gateway.signal.on(_i.UNMUTE_AUDIO,(e=>this._handleMuteStream(e.uid,Yi.AUDIO,!1))),this._gateway.signal.on(_i.MUTE_VIDEO,(e=>this._handleMuteStream(e.uid,Yi.VIDEO,!0))),this._gateway.signal.on(_i.UNMUTE_VIDEO,(e=>this._handleMuteStream(e.uid,Yi.VIDEO,!1))),this._gateway.signal.on(_i.RECEIVE_METADATA,(e=>{const t=G(e.metadata);this.safeEmit(fe.RECEIVE_METADATA,e.uid,t)})),this._gateway.signal.on(_i.ON_DATA_STREAM,(async e=>{if(!e)return;let t=G(e.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&["aes-128-gcm2","aes-256-gcm2"].includes(this._encryptionMode)){if(e.payload.length<Fe)throw new Si(l.UNEXPECTED_RESPONSE,"payload length ".concat(e.payload.length," is less than header length ").concat(Fe));t=await Be(this._encryptDataStreamIv,this._encryptDataStreamKey,t)}let i=0;if(e.ordered||e.syncWithAudio){const t=this._p2pChannel.getStats(),n=this.remoteUsers.find((t=>t.uid===e.uid)),s=null==t?void 0:t.audioRecv.find((e=>e.ssrc===(null==n?void 0:n._audioSSRC)));i=null==s?void 0:s.jitterBufferMs}null==i&&(i=0),ec(Zt(Zt({},e),{},{payload:t}),i,{id:this._clientId,onStreamMessage:"function"==typeof this.onStreamMessage?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})})),this._gateway.signal.on(_i.ON_CRYPT_ERROR,(()=>{ge((()=>{t.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(fe.CRYPT_ERROR)}),this._sessionId)})),this._gateway.signal.on(_i.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(_i.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{t.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,L.TOKEN_EXPIRE),this.safeEmit(fe.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()})),this._gateway.signal.on(_i.ON_STREAM_FALLBACK_UPDATE,(e=>{t.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(fe.STREAM_FALLBACK,e.stream_id,1===e.stream_type?"fallback":"recover")})),this._gateway.signal.on(_i.ON_PUBLISH_STREAM,(e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),t.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))})),this._gateway.signal.on(_i.ENABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)})),this._gateway.signal.on(_i.DISABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)})),this._gateway.signal.on(li.REQUEST_TIMEOUT,((e,t)=>{if(this._joinInfo)switch(e){case ui.PUBLISH:{if(!t)return;const e=t.ortc;if(e){var n,s;const o=e.some((e=>{let{stream_type:t}=e;return t===Mi.Audio})),a=e.some((e=>{let{stream_type:t}=e;return t!==Mi.Audio})),r=e.some((e=>{let{stream_type:t}=e;return t===Mi.Screen||t===Mi.ScreenLow}));"offer"===t.state&&i.publish(this._joinInfo.sid,{eventElapse:Ls.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:l.TIMEOUT,audio:o,video:a,p2pid:t.p2p_id,publishRequestid:this.store.pubId,screenshare:r,audioName:o?null===(n=e.find((e=>{let{stream_type:t}=e;return t===Mi.Audio})))||void 0===n||null===(n=n.ssrcs[0])||void 0===n?void 0:n.ssrcId.toString():void 0,videoName:a?null===(s=e.find((e=>{let{stream_type:t}=e;return t!==Mi.Audio})))||void 0===s||null===(s=s.ssrcs[0])||void 0===s?void 0:s.ssrcId.toString():void 0})}break}case ui.SUBSCRIBE:t&&i.subscribe(this._joinInfo.sid,{succ:!1,ec:l.TIMEOUT,audio:t.stream_type===Yi.AUDIO,video:t.stream_type===Yi.VIDEO,peerid:t.stream_id,subscribeRequestid:t.ssrcId,p2pid:this.store.p2pId,eventElapse:Ls.measureFromSubscribeStart(this.store.clientId,t.ssrcId)})}})),this._gateway.signal.on(_i.ON_P2P_OK,(e=>{this.uid,this._uid})),this._gateway.signal.on(_i.ON_PUBLISHED_USER_LIST,(e=>{if(null==e||!e.users)return;f("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter((e=>!Ht(e.string_id||e.stream_id,this.channelName))));const i=[],n=[];for(const s of e.users){let e=this._users.find((e=>e._uintid===s.stream_id));e?e._trust_in_room_=!0:(e=new Vo(s.string_id||s.stream_id,s.stream_id),this._users.push(e),0===this.getListeners(fe.PUBLISHED_USER_LIST).length&&(t.debug("[".concat(this._clientId,"] user online"),s.stream_id),this.safeEmit(fe.USER_JOINED,e)));const o=Vi.Audio&s.stream_type,a=(Vi.Video|Vi.LwoVideo)&s.stream_type,r=0!=(65280&s.stream_type),c=o&&e.hasAudio,d=a&&e.hasVideo;a&&(e._trust_video_stream_added_state_=!0,e._video_added_=!0,e._videoSSRC=s.video_ssrc,e._rtxSsrcId=s.video_rtx),o&&(e._trust_audio_stream_added_state_=!0,e._audio_added_=!0,e._audioSSRC=s.audio_ssrc),o&&!c&&0===this.getListeners(fe.PUBLISHED_USER_LIST).length&&(t.info("[".concat(this._clientId,"] remote user ").concat(e.uid," published audio")),this.safeEmit(fe.USER_PUBLISHED,e,"audio")),a&&!d&&0===this.getListeners(fe.PUBLISHED_USER_LIST).length&&(t.info("[".concat(this._clientId,"] remote user ").concat(e.uid," published video")),this.safeEmit(fe.USER_PUBLISHED,e,"video")),(o&&!c||a&&!d||r)&&i.push(e),a&&this._p2pChannel.hasPendingRemoteMedia(e,"video")&&n.push({user:e,mediaType:"video"}),o&&this._p2pChannel.hasPendingRemoteMedia(e,"audio")&&n.push({user:e,mediaType:"audio"})}n.length>0&&(t.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(n.map((e=>"user: ".concat(e.user.uid,", mediaType: ").concat(e.mediaType))).join("; ")," ")),this.massSubscribe(n).catch((e=>{t.error("[".concat(this._clientId,"] mass resubscribe error"),e.toString())}))),this.getListeners(fe.PUBLISHED_USER_LIST).length>0?f("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=i:(t.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(i.map((e=>e.uid)).join(", "))),this.safeEmit(fe.PUBLISHED_USER_LIST,i)):t.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(i.map((e=>e.uid)).join(", ")))})),this._gateway.signal.on(_i.ON_RTP_CAPABILITY_CHANGE,(e=>{const{video_codec:t}=e;this._p2pChannel instanceof Fa&&this._p2pChannel.updateRemoteRTPCapabilities(t.map((e=>e.toLowerCase())).filter((e=>Object.keys(de).includes(e))))}))}_handleP2PEvents(){this._gateway.signal.on(_i.ON_USER_OFFLINE,(()=>{this._p2pChannel.disconnectForReconnect()})),this._gateway.signal.on(dn.PUBLISH,((e,t,i)=>{const{uid:n}=e;e.forEach((e=>{const{kind:s,ssrcs:o,mid:a,isMuted:r}=e;this._handleP2PAddAudioOrVideoStream(s,n,o[0].ssrcId,a);const c=this._users.find((e=>e.uid===n));return c&&this._p2pChannel instanceof ta?this._p2pChannel.mockSubscribe(c,s,o[0].ssrcId,a).then((()=>{t()})).catch(i):t(),this._handleMuteStream(n,s,!!r)}))})),this._gateway.signal.on(dn.CALL,(async(e,t,i)=>{if(this._p2pChannel instanceof ta)try{var n;t(await this._p2pChannel.startP2P({turnServer:null===(n=this._joinInfo)||void 0===n?void 0:n.turnServer},e))}catch(e){i(e)}})),this._gateway.signal.on(li.P2P_CONNECTION,(async e=>{this._p2pChannel instanceof ta&&await this._p2pChannel.p2pConnect(e)})),this._gateway.signal.on(dn.UNPUBLISH,(async(e,i,n)=>{if(this._p2pChannel instanceof ta){const{unpubMsg:s,uid:o}=e,a=this._users.find((e=>e.uid===o));if(!a)return t.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(o)),void i();try{s.forEach((async e=>{let{stream_type:t}=e;const i=t===Mi.Audio?Yi.AUDIO:Yi.VIDEO;await this._p2pChannel.unsubscribe(a,i),this._handleMuteStream(o,i,!0)})),i()}catch(e){n(e)}}})),this._gateway.signal.on(dn.CONTROL,(async(e,t)=>{const{action:i}=e;switch(i){case ln.MUTE_LOCAL_VIDEO:this._handleMuteStream(t,Yi.VIDEO,!0);break;case ln.MUTE_LOCAL_AUDIO:this._handleMuteStream(t,Yi.AUDIO,!0);break;case ln.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",t),this._handleMuteStream(t,Yi.VIDEO,!1);break;case ln.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",t),this._handleMuteStream(t,Yi.AUDIO,!1)}})),this._gateway.signal.on(dn.RESTART_ICE,(async(e,t,i)=>{if(this._p2pChannel instanceof ta)try{const{direction:i,iceParameter:n}=e;if(i!==Ei.SEND_ONLY||n){t(await this._p2pChannel.restartICE(i,n))}else this._p2pChannel.handleDisconnect(i),t()}catch(e){i(e)}})),this._gateway.signal.on(dn.CANDIDATE,(e=>{if(this._p2pChannel instanceof ta){const{candidate:t,direction:i}=e;this._p2pChannel.addRemoteCandidate(t,i)}})),this._p2pChannel.on(Zi.RequestP2PRestartICE,(async(e,t,i)=>{try{const{direction:i}=e;t(await this._gateway.sendExtensionMessage(dn.RESTART_ICE,e,i===Ei.SEND_ONLY))}catch(e){i(e)}})),this._p2pChannel.on(Zi.LocalCandidate,(e=>{this._gateway.sendExtensionMessage(dn.CANDIDATE,JSON.stringify(e),!0)})),this._p2pChannel.on(Zi.RequestP2PMuteLocal,(async(e,t,i)=>{try{await this._gateway.sendExtensionMessage(dn.CONTROL,e,!0),t()}catch(e){i(e)}})),this._p2pChannel.on(Zi.RequestP2PUnmuteRemote,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===l.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(Zi.RequestP2PMuteRemote,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.muteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===l.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(Zi.StateChange,((e,t)=>{t===Qi.Connected&&this._p2pChannel.republish()}))}_handleP2PChannelEvents(){this._p2pChannel.on(Zi.RequestMuteLocal,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===l.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(Zi.RequestUnmuteLocal,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===l.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(Zi.RequestRePublish,((e,t,i)=>{this.publish(e,!1).then(t).catch(i)})),this._p2pChannel.on(Zi.RequestRePublishDataChannel,((e,t,i)=>{Promise.all(e.map((async e=>{await this._p2pChannel.publishDataChannel([e]);const t={streamId:e.id,ordered:e.ordered,maxRetransmits:e.maxRetransmits,metadata:e.metadata,channelId:e._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,t,!0)}catch(e){if(e.code!==l.DISCONNECT_P2P)throw e}}))).then(t).catch(i)})),this._p2pChannel.on(Zi.RequestReSubscribe,(async(e,t,i)=>{try{for(const{user:t,kind:i}of e)i===Yi.VIDEO?await this.subscribe(t,"video"):await this.subscribe(t,"audio");t()}catch(e){i(e)}})),this._p2pChannel.on(Zi.RequestUpload,((e,t)=>{this._gateway.upload(e,t)})),this._p2pChannel.on(Zi.RequestUploadStats,(e=>{this._gateway.uploadWRTCStats(e)})),this._p2pChannel.on(Zi.MediaReconnectStart,(e=>{this.safeEmit(fe.MEDIA_RECONNECT_START,e)})),this._p2pChannel.on(Zi.MediaReconnectEnd,(e=>{this.safeEmit(fe.MEDIA_RECONNECT_END,e)})),this._p2pChannel.on(Zi.NeedSignalRTT,(e=>{e(this._gateway.getSignalRTT())})),this._p2pChannel.on(Zi.RequestRestartICE,(async e=>{if(this._p2pChannel instanceof ta)return;const t=await this._p2pChannel.restartICE(e),i=await t.next();if(i.done)return;const n=i.value;let s;try{s=await this._gateway.restartICE({iceParameters:n})}catch(e){return void t.throw(e)}const{iceParameters:o}=function(e){const t=e.iceParameters;return{iceParameters:{iceUfrag:t.iceUfrag,icePwd:t.icePwd}}}(s);await t.next({remoteIceParameters:o})})),this._p2pChannel.on(Zi.RequestReconnect,(async()=>{this._gateway.reconnect()})),this._p2pChannel.on(Zi.RequestReconnectPC,(async()=>{var e;const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=await this._p2pChannel.startP2PConnection({turnServer:null===(e=this._joinInfo)||void 0===e?void 0:e.turnServer}),{gatewayEstablishParams:s,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:t,dtlsParameters:i,rtpCapabilities:n}),{dtlsParameters:a,iceParameters:r,candidates:c,rtpCapabilities:d,setup:h,cname:l}=$s(s,o);await this._p2pChannel.connect(r,a,c,d,h,l),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()})),this._p2pChannel.on(Zi.RequestUnpublishForReconnectPC,(async(e,t,i)=>{this._joinInfo&&void 0!==this._uid?(await this._gateway.unpublish(e,this._uid),t()):i()})),this._p2pChannel.on(Zi.P2PLost,(()=>{this.safeEmit(fe.P2P_LOST,this.store.uid)})),this._p2pChannel.on(Zi.UpdateVideoEncoder,(e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)})),this._p2pChannel.on(Zi.ConnectionTypeChange,(e=>{this.safeEmit(fe.IS_USING_CLOUD_PROXY,e)})),this._p2pChannel.on(Zi.RequestLowStreamParameter,(e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})})),this._p2pChannel.on(Zi.QueryClientConnectionState,(e=>{e(this.connectionState)}))}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if("CONNECTED"!==this.connectionState||!this._joinInfo)throw new Si(l.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new Si(l.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!e)throw new Si(l.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!e.inspectType||!Array.isArray(e.inspectType))throw new Si(l.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{const t=[...new Set(e.inspectType)];t.forEach((e=>{if(!["supervise","moderation"].includes(e))throw new Si(l.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(e," is not a valid inspect type."))})),e.inspectType=t}if(e&&e.extraInfo&&e.extraInfo.length>1024)throw new Si(l.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{const t=new Er(e);this._inspect=t,this.handleVideoInspectEvents(this._inspect),await t.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},Q)}catch(e){throw Array.isArray(e)?e[0]:e}}async disableContentInspect(){if(!this._inspect)throw new Si(l.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,t){if(E(e,"enabled"),e){if(!t)throw new Si(l.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(_(t.interval,"interval",1e3,1/0),t&&t.extraInfo&&t.extraInfo.length>1024)throw new Si(l.INVALID_PARAMS,"[".concat(this._clientId,"] config.extraInfo length cannot exceed 1024 bytes"));if(t&&t.vendor&&t.vendor.length>1024)throw new Si(l.INVALID_PARAMS,"[".concat(this._clientId,"] config.vendor length cannot exceed 1024 bytes"));if("CONNECTED"!==this.connectionState||!this._joinInfo)throw new Si(l.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(t);const e=new Yr(t);this._moderation=e,this.handleImageModerationEvents(this._moderation),await e.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},Q)}catch(e){throw Array.isArray(e)?e[0]:e}}else{if(!this._moderation)throw new Si(l.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}}setP2PTransport(e){if(Ge(e),"p2p"!==this.mode)throw new Si(l.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=e,t.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(e))}handleImageModerationEvents(e){e.on(rn.CONNECTION_STATE_CHANGE,((t,i)=>{if(this.safeEmit(fe.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,t,i),t===an.CONNECTED){if("CONNECTED"!==this.connectionState)throw this.setImageModeration(!1),new Si(l.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}})),e.on(rn.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((e=>"video"===e.trackMediaType))[0])}))}handleVideoInspectEvents(e){e.on(tn.CONNECTION_STATE_CHANGE,((t,i)=>{if(this.safeEmit(fe.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,t,i),i===$i.CONNECTED){if("CONNECTED"!==this.connectionState)return void this.safeEmit(fe.CONTENT_INSPECT_ERROR,new Si(l.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}})),e.on(tn.INSPECT_RESULT,((e,i)=>{var n;if((null==i?void 0:i.code)===l.INVALID_OPERATION&&"DISCONNECTED"===this.connectionState)return t.debug("Stop inspect content because that has left channel"),null==this||null===(n=this._inspect)||void 0===n||n.close(),void(this._inspect=void 0);this.safeEmit(fe.CONTENT_INSPECT_RESULT,e,i)})),e.on(tn.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((e=>"video"===e.trackMediaType))[0])}))}getJoinChannelServiceRecords(){return t.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){E(e,"enabled"),K("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_handleResetAddStream(e,t){switch(t){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}}).prototype,"leave",[Ac],Object.getOwnPropertyDescriptor(pd.prototype,"leave"),pd.prototype),ii(pd.prototype,"publish",[wc],Object.getOwnPropertyDescriptor(pd.prototype,"publish"),pd.prototype),ii(pd.prototype,"unpublish",[yc],Object.getOwnPropertyDescriptor(pd.prototype,"unpublish"),pd.prototype),ii(pd.prototype,"subscribe",[Nc],Object.getOwnPropertyDescriptor(pd.prototype,"subscribe"),pd.prototype),ii(pd.prototype,"presubscribe",[bc],Object.getOwnPropertyDescriptor(pd.prototype,"presubscribe"),pd.prototype),ii(pd.prototype,"massSubscribe",[Oc],Object.getOwnPropertyDescriptor(pd.prototype,"massSubscribe"),pd.prototype),ii(pd.prototype,"unsubscribe",[Dc],Object.getOwnPropertyDescriptor(pd.prototype,"unsubscribe"),pd.prototype),ii(pd.prototype,"massUnsubscribe",[Pc],Object.getOwnPropertyDescriptor(pd.prototype,"massUnsubscribe"),pd.prototype),ii(pd.prototype,"setLowStreamParameter",[Lc],Object.getOwnPropertyDescriptor(pd.prototype,"setLowStreamParameter"),pd.prototype),ii(pd.prototype,"enableDualStream",[kc],Object.getOwnPropertyDescriptor(pd.prototype,"enableDualStream"),pd.prototype),ii(pd.prototype,"disableDualStream",[Mc],Object.getOwnPropertyDescriptor(pd.prototype,"disableDualStream"),pd.prototype),ii(pd.prototype,"setClientRole",[Uc],Object.getOwnPropertyDescriptor(pd.prototype,"setClientRole"),pd.prototype),ii(pd.prototype,"setProxyServer",[xc],Object.getOwnPropertyDescriptor(pd.prototype,"setProxyServer"),pd.prototype),ii(pd.prototype,"setTurnServer",[Vc],Object.getOwnPropertyDescriptor(pd.prototype,"setTurnServer"),pd.prototype),ii(pd.prototype,"setLicense",[Fc],Object.getOwnPropertyDescriptor(pd.prototype,"setLicense"),pd.prototype),ii(pd.prototype,"startProxyServer",[Bc],Object.getOwnPropertyDescriptor(pd.prototype,"startProxyServer"),pd.prototype),ii(pd.prototype,"stopProxyServer",[Gc],Object.getOwnPropertyDescriptor(pd.prototype,"stopProxyServer"),pd.prototype),ii(pd.prototype,"setLocalAccessPointsV2",[jc],Object.getOwnPropertyDescriptor(pd.prototype,"setLocalAccessPointsV2"),pd.prototype),ii(pd.prototype,"setLocalAccessPoints",[Wc],Object.getOwnPropertyDescriptor(pd.prototype,"setLocalAccessPoints"),pd.prototype),ii(pd.prototype,"setRemoteDefaultVideoStreamType",[Hc],Object.getOwnPropertyDescriptor(pd.prototype,"setRemoteDefaultVideoStreamType"),pd.prototype),ii(pd.prototype,"setRemoteVideoStreamType",[Kc],Object.getOwnPropertyDescriptor(pd.prototype,"setRemoteVideoStreamType"),pd.prototype),ii(pd.prototype,"setStreamFallbackOption",[qc],Object.getOwnPropertyDescriptor(pd.prototype,"setStreamFallbackOption"),pd.prototype),ii(pd.prototype,"setEncryptionConfig",[Yc],Object.getOwnPropertyDescriptor(pd.prototype,"setEncryptionConfig"),pd.prototype),ii(pd.prototype,"renewToken",[Jc],Object.getOwnPropertyDescriptor(pd.prototype,"renewToken"),pd.prototype),ii(pd.prototype,"enableAudioVolumeIndicator",[Xc],Object.getOwnPropertyDescriptor(pd.prototype,"enableAudioVolumeIndicator"),pd.prototype),ii(pd.prototype,"startLiveStreaming",[zc],Object.getOwnPropertyDescriptor(pd.prototype,"startLiveStreaming"),pd.prototype),ii(pd.prototype,"setLiveTranscoding",[Qc],Object.getOwnPropertyDescriptor(pd.prototype,"setLiveTranscoding"),pd.prototype),ii(pd.prototype,"stopLiveStreaming",[Zc],Object.getOwnPropertyDescriptor(pd.prototype,"stopLiveStreaming"),pd.prototype),ii(pd.prototype,"addInjectStreamUrl",[$c],Object.getOwnPropertyDescriptor(pd.prototype,"addInjectStreamUrl"),pd.prototype),ii(pd.prototype,"removeInjectStreamUrl",[ed],Object.getOwnPropertyDescriptor(pd.prototype,"removeInjectStreamUrl"),pd.prototype),ii(pd.prototype,"startChannelMediaRelay",[td],Object.getOwnPropertyDescriptor(pd.prototype,"startChannelMediaRelay"),pd.prototype),ii(pd.prototype,"updateChannelMediaRelay",[id],Object.getOwnPropertyDescriptor(pd.prototype,"updateChannelMediaRelay"),pd.prototype),ii(pd.prototype,"stopChannelMediaRelay",[nd],Object.getOwnPropertyDescriptor(pd.prototype,"stopChannelMediaRelay"),pd.prototype),ii(pd.prototype,"sendCustomReportMessage",[sd],Object.getOwnPropertyDescriptor(pd.prototype,"sendCustomReportMessage"),pd.prototype),ii(pd.prototype,"pickSVCLayer",[od],Object.getOwnPropertyDescriptor(pd.prototype,"pickSVCLayer"),pd.prototype),ii(pd.prototype,"setRTMConfig",[ad],Object.getOwnPropertyDescriptor(pd.prototype,"setRTMConfig"),pd.prototype),ii(pd.prototype,"enableContentInspect",[rd],Object.getOwnPropertyDescriptor(pd.prototype,"enableContentInspect"),pd.prototype),ii(pd.prototype,"disableContentInspect",[cd],Object.getOwnPropertyDescriptor(pd.prototype,"disableContentInspect"),pd.prototype),ii(pd.prototype,"setImageModeration",[dd],Object.getOwnPropertyDescriptor(pd.prototype,"setImageModeration"),pd.prototype),ii(pd.prototype,"setP2PTransport",[hd],Object.getOwnPropertyDescriptor(pd.prototype,"setP2PTransport"),pd.prototype),ii(pd.prototype,"getJoinChannelServiceRecords",[ld],Object.getOwnPropertyDescriptor(pd.prototype,"getJoinChannelServiceRecords"),pd.prototype),ii(pd.prototype,"setPublishAudioFilterEnabled",[ud],Object.getOwnPropertyDescriptor(pd.prototype,"setPublishAudioFilterEnabled"),pd.prototype),pd);function Ed(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const n=i.reportApiInvoke(null,{name:J.CREATE_CLIENT,options:[e],tag:X.TRACER});try{je(e)}catch(e){throw n.onError(e),e}return(me(16,0,!0)||Te(16,0,!0))&&("vp9"===e.codec&&(e.codec="vp8",t.debug("browser not support vp9, force use vp8")),K("UNSUPPORTED_VIDEO_CODEC",["vp9"])),void 0===e.audioCodec&&(e.audioCodec="opus"),n.onSuccess(),new _d(Zt(Zt({forceWaitGatewayResponse:!0},e),{},{role:["rtc","p2p"].includes(e.mode)?"host":e.role||"audience"}))}async function md(){let e={audio:[],video:[]};try{let t=new RTCPeerConnection;const i=await async function(e){let t;return tt().supportUnifiedPlan?(e.addTransceiver("video",{direction:"recvonly"}),e.addTransceiver("audio",{direction:"recvonly"}),t=(await e.createOffer()).sdp):t=(await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,t}(t);if(!i)return e;t.close(),t=null,e=function(e){const t={video:[],audio:[]};return e.match(/ VP8/i)&&t.video.push("VP8"),e.match(/ VP9/i)&&t.video.push("VP9"),e.match(/ AV1/i)&&t.video.push("AV1"),e.match(/ H264/i)&&t.video.push("H264"),e.match(/ H265/i)&&t.video.push("H265"),e.match(/ opus/i)&&t.audio.push("OPUS"),e.match(/ PCMU/i)&&t.audio.push("PCMU"),e.match(/ PCMA/i)&&t.audio.push("PCMA"),e.match(/ G722/i)&&t.audio.push("G722"),t}(i)}catch(e){throw new Si(l.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return e}function Sd(){const e=i.reportApiInvoke(null,{name:J.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:X.TRACER});let n=!1;try{const e=window.RTCPeerConnection,t=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,i=window.WebSocket;n=!!(e&&t&&i),n&&Ce()&&We(75)&&(new e).close()}catch(e){return t.error("check system requirement failed: ",e),!1}let s=!1;const o=Z();o.name===ee.CHROME&&Number(o.version)>=58&&(!He()||Ke())&&(s=!0),(o.name===ee.FIREFOX&&Number(o.version)>=56||o.name===ee.OPERA&&Number(o.version)>=45||o.name===ee.SAFARI&&Number(o.version)>=11||"WebKit"===o.name&&(le()||qe())&&o.osVersion&&Number(o.osVersion.split(".")[0])>=11||Ye()||Je())&&(s=!0),t.debug("checkSystemRequirements, api:",n,"browser",s);const a=n&&s;return e.onSuccess(a),a}class Td{constructor(e,t){this.id=0,this.element=void 0,this.peerPair=void 0,this.context=void 0,this.audioPlayerElement=void 0,this.audioTrack=void 0,Td.count+=1,this.id=Td.count,this.element=e,this.context=t}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{const t=document.createElement("audio");t.srcObject=new MediaStream([e.track]),t.play(),this.audioPlayerElement=t}}async switchSdp(){if(!this.peerPair)return;const e=async(e,t)=>{const i="offer"===t?await e.createOffer():await e.createAnswer();return await e.setLocalDescription(i),"complete"===e.iceGatheringState?e.localDescription:new Promise((t=>{e.onicegatheringstatechange=()=>{"complete"===e.iceGatheringState&&t(e.localDescription)}}))},t=async(e,t)=>await e.setRemoteDescription(t);try{const i=await e(this.peerPair[0],"offer");await t(this.peerPair[1],i);const n=await e(this.peerPair[1],"answer");await t(this.peerPair[0],n)}catch(e){throw new Si(l.LOCAL_AEC_ERROR,e.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let t;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),t=this.context.createMediaStreamDestination();this.context.createMediaElementSource(e).connect(t)}catch(e){throw new Si(l.LOCAL_AEC_ERROR,e.toString()).print()}if(!t){throw new Si(l.LOCAL_AEC_ERROR,"no dest node when local aec").print()}const i=t.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const e=this.element,t=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(t),await this.switchSdp()}close(){t.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach((e=>{e.close()})),this.peerPair=void 0,this.audioPlayerElement=void 0}}var Cd,fd;Td.count=0;const Rd=window.AudioContext||window.webkitAudioContext;const gd=new(Cd=o({report:i}),ii((fd=class{constructor(){this.units=[],this.context=void 0}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return t.debug("the system does not need to process local aec"),-1;this.context||(this.context=new Rd);let i=this.units.find((t=>t&&t.getElement()===e));return i||(i=new Td(e,this.context),this.units.push(i)),i.startEchoCancellation(),t.debug("start processing local audio echo cancellation, id is",i.id),i.id}_doesEnvironmentNeedAEC(){return Z().name!==ee.SAFARI}}).prototype,"processExternalMediaAEC",[Cd],Object.getOwnPropertyDescriptor(fd.prototype,"processExternalMediaAEC"),fd.prototype),fd);const Id=window||document;function vd(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!Id)return;const i=xd._cspEventHandlerPointer;if(i&&t)return void console.error(i,t);const n=e=>{if(!(e&&e.blockedURI&&(xd.onSecurityPolicyViolation||xd.getListeners(on.SECURITY_POLICY_VIOLATION).length>0)))return;const t=e.blockedURI;f("CSP_DETECTED_HOSTNAME_LIST").some((e=>t.includes(e)))&&(xd.onSecurityPolicyViolation&&"function"==typeof xd.onSecurityPolicyViolation&&xd.onSecurityPolicyViolation(e),xd.getListeners(on.SECURITY_POLICY_VIOLATION).length>0&&xd.safeEmit(on.SECURITY_POLICY_VIOLATION,e))};i&&Id.removeEventListener("securitypolicyviolation",i),(t||e&&"function"==typeof e||xd.getListeners(on.SECURITY_POLICY_VIOLATION).length>0)&&Id.addEventListener("securitypolicyviolation",n),xd._cspEventHandlerPointer=n}function Ad(e){return Dt.enumerateDevices(!0,!0,e)}function wd(e){return Dt.getRecordingDevices(e)}function yd(e){return Dt.getCamerasDevices(e)}function Nd(e){return Dt.getSpeakers(e)}function bd(){return new aa}function Od(e){if(t.debug("setAppType: ".concat(e)),!(Number.isInteger(e)&&e>=0))throw t.debug("Invalid appType"),new Si(l.INVALID_PARAMS,"invalid app type",e);K("APP_TYPE",Math.floor(e))}function Dd(e){t.setLogLevel(e)}function Pd(){f("USE_NEW_LOG")?K("UPLOAD_LOG",!0):t.enableLogUpload()}function Ld(){f("USE_NEW_LOG")?K("UPLOAD_LOG",!1):t.disableLogUpload()}function kd(e){gd.processExternalMediaAEC(e)}function Md(e){e.forEach((e=>{const n=e;n.__registered__=!0,n.logger.hookLog=t.extLog,n.reporter.hookApiInvoke=i.extApiInvoke,n.parameters&&Object.keys(n.parameters).forEach((e=>{n.parameters[e]=f(e)}))}))}function Ud(){at.autoResumeAfterInterruption(!0)}K("PROCESS_ID",Xe()),function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void t.error("Error loading sdk config",e.message)}if(e)try{const i=JSON.parse(window.atob(e)),n=Date.now();t.debug("Loading global parameters from cache",i),Object.keys(i).forEach((e=>{if(Object.prototype.hasOwnProperty.call(c,e)){const{value:t,expires:s}=i[e];if(s&&s<=n)return;d[e]=t,c[e]=t}}))}catch(i){t.error("Error loading mutableParamsCache: ".concat(e),i.message)}}(),Array.isArray(d.AREAS)&&d.AREAS.length>0&&os(d.AREAS,!0);const xd=function(e){const t=new C,i=e,n={getListeners:t.getListeners.bind(t),on:(e,i)=>(function(e,t){e===on.SECURITY_POLICY_VIOLATION&&vd(t,!0)}(e,i),t.on.bind(t)(e,i)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return Zt(Zt({},i),n)}({});function Vd(e){Ot.onAudioAutoplayFailed=e}function Fd(e){Ot.onAutoplayFailed=e}function Bd(e){xd.onSecurityPolicyViolation=e}function Gd(e){xd.onCameraChanged=e}function jd(e){xd.onMicrophoneChanged=e}function Wd(e){xd.onAudioContextStateChanged=e}Object.defineProperties(xd,{onAudioAutoplayFailed:{get:()=>Ot.onAudioAutoplayFailed,set:Vd},onAutoplayFailed:{get:()=>Ot.onAutoplayFailed,set:Fd},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>xd._onSecurityPolicyViolation,set(e){xd._onSecurityPolicyViolation=e,vd(e)}},__CLIENT_LIST__:{get:()=>f("SHOW_GLOBAL_CLIENT_LIST")?Wt:[]}}),Dt.on(Pt.CAMERA_DEVICE_CHANGED,(e=>{t.info("camera device changed",JSON.stringify(e)),xd.onCameraChanged&&xd.onCameraChanged(e),xd.safeEmit(on.CAMERA_CHANGED,e)})),Dt.on(Pt.RECORDING_DEVICE_CHANGED,(e=>{t.info("microphone device changed",JSON.stringify(e)),xd.onMicrophoneChanged&&xd.onMicrophoneChanged(e),xd.safeEmit(on.MICROPHONE_CHANGED,e)})),Dt.on(Pt.PLAYOUT_DEVICE_CHANGED,(e=>{t.debug("playout device changed",JSON.stringify(e)),xd.onPlaybackDeviceChanged&&xd.onPlaybackDeviceChanged(e),xd.safeEmit(on.PLAYBACK_DEVICE_CHANGED,e)})),at.onAutoplayFailed=()=>{t.info("detect audio element autoplay failed"),Ot.onAudioAutoplayFailed&&Ot.onAudioAutoplayFailed()},Lt.on("autoplay-failed",(()=>{t.info("detect webaudio autoplay failed"),Ot.onAudioAutoplayFailed&&Ot.onAudioAutoplayFailed(),xd.safeEmit(on.AUTOPLAY_FAILED)})),Lt.on(kt.STATE_CHANGE,((e,i)=>{t.info("audio context state changed: ".concat(i," => ").concat(e)),xd.onAudioContextStateChanged&&xd.onAudioContextStateChanged(e,i),xd.safeEmit(on.AUDIO_CONTEXT_STATE_CHANGED,e,i)})),window&&(window.__ARTC__={ESM_BUNDLER:true,ESM:false,UMD:false,DEV:false,AgoraRTC:xd,__TRACK_LIST__:Mt}),w.on(y.NETWORK_STATE_CHANGE,((e,i)=>{t.info("[network-indicator] network state changed, ".concat(i," => ").concat(e))}));const Hd=(e,i,n)=>{t.debug("setParameter key:".concat(e,", value:").concat(JSON.stringify(i))),K(e,i,n)};export{Bi as AREAS,xd as AgoraRTC,ki as ChannelMediaRelayError,Pi as ChannelMediaRelayEvent,Li as ChannelMediaRelayState,Ft as DEV,xt as ESM,Ut as ESM_BUNDLER,Vt as UMD,Wt as __CLIENT_LIST__,nc as checkAudioTrackIsActive,Sd as checkSystemRequirements,ic as checkVideoTrackIsActive,bd as createChannelMediaRelayConfiguration,Ed as createClient,Ld as disableLogUpload,Pd as enableLogUpload,yd as getCameras,Ad as getDevices,wd as getMicrophones,Nd as getPlaybackDevices,md as getSupportedCodec,Vd as onAudioAutoplayFailed,Wd as onAudioContextStateChanged,Fd as onAutoplayFailed,Gd as onCameraChanged,jd as onMicrophoneChanged,Bd as onSecurityPolicyViolation,Ec as preload,kd as processExternalMediaAEC,Md as registerExtensions,Ud as resumeAudioContext,Od as setAppType,os as setArea,Dd as setLogLevel,Hd as setParameter};
